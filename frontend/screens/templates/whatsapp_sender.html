<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Client Notifications - BizPulse Developer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #732C3F 0%, #8B3A47 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .left-panel, .right-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }
        
        .header {
            background: linear-gradient(135deg, #732C3F 0%, #8B3A47 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .back-btn {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .section h3 {
            color: #732C3F;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #732C3F;
        }
        
        .btn {
            background: linear-gradient(135deg, #732C3F 0%, #8B3A47 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .whatsapp-link {
            display: inline-block;
            background: #25D366;
            color: white;
            padding: 12px 20px;
            text-decoration: none;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 600;
        }
        
        .whatsapp-link:hover {
            background: #128C7E;
        }
        
        .info-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-box h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .companies-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        
        .company-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .company-item:hover {
            background: #f5f5f5;
        }
        
        .company-item:last-child {
            border-bottom: none;
        }
        
        /* Additional styles for new elements */
        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: Arial, sans-serif;
        }
        
        .priority-urgent {
            border-left: 4px solid #dc3545 !important;
        }
        
        .priority-high {
            border-left: 4px solid #ffc107 !important;
        }
        
        .priority-normal {
            border-left: 4px solid #28a745 !important;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .left-panel, .right-panel {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/retail/dashboard" class="back-btn">‚Üê Back to Dashboard</a>
            <h1>üì± WhatsApp Client Notifications</h1>
            <p>Send messages, alerts, and notifications to your clients - Developer Dashboard</p>
        </div>
        
        <div class="main-content">
            <!-- Left Panel - Send Notifications -->
            <div class="left-panel">
                <h3 style="color: #732C3F; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    üì§ Send Client Notifications
                </h3>
                
                <!-- Quick Actions -->
                <div style="margin-bottom: 25px;">
                    <button class="btn" onclick="selectAllClients()" style="background: #28a745;">‚úÖ Select All</button>
                    <button class="btn btn-secondary" onclick="clearSelection()">‚ùå Clear All</button>
                    <button class="btn" onclick="loadClients()" style="background: #17a2b8;">üîÑ Refresh</button>
                </div>
                
                <!-- Message Type Selection -->
                <div class="form-group">
                    <label for="messageType">Message Type:</label>
                    <select id="messageType" onchange="updateMessageTemplate()">
                        <option value="custom">üìù Custom Message</option>
                        <option value="welcome">üéâ Welcome Message</option>
                        <option value="update">üì¢ System Update</option>
                        <option value="offer">üéÅ Special Offer</option>
                        <option value="maintenance">üîß Maintenance Alert</option>
                        <option value="reminder">‚è∞ Payment Reminder</option>
                        <option value="feature">‚ú® New Feature</option>
                        <option value="support">üÜò Support Message</option>
                    </select>
                </div>
                
                <!-- Subject -->
                <div class="form-group">
                    <label for="messageSubject">Subject:</label>
                    <input type="text" id="messageSubject" placeholder="Enter message subject" value="BizPulse Notification">
                </div>
                
                <!-- Message Content -->
                <div class="form-group">
                    <label for="messageContent">Message:</label>
                    <textarea id="messageContent" rows="8" placeholder="Enter your message here..."></textarea>
                </div>
                
                <!-- Priority Level -->
                <div class="form-group">
                    <label for="priorityLevel">Priority Level:</label>
                    <select id="priorityLevel">
                        <option value="normal">üìã Normal</option>
                        <option value="high">‚ö†Ô∏è High Priority</option>
                        <option value="urgent">üö® Urgent</option>
                    </select>
                </div>
                
                <!-- Send Buttons -->
                <div style="margin-top: 25px;">
                    <button class="btn" onclick="sendToSelected()" style="background: #25D366; font-size: 18px; padding: 15px 25px;">
                        üì± Send to Selected Clients
                    </button>
                    <button class="btn" onclick="sendToAll()" style="background: #dc3545;">
                        üì¢ Send to All Clients
                    </button>
                </div>
                
                <!-- Results -->
                <div id="sendResult" class="result"></div>
            </div>
            
            <!-- Right Panel - Client Management -->
            <div class="right-panel">
                <h3 style="color: #732C3F; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    üë• Client Management
                </h3>
                
                <!-- Client Statistics -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #e9ecef;">
                        <div style="font-size: 24px; font-weight: bold; color: #732C3F;" id="totalClients">0</div>
                        <div style="font-size: 12px; color: #666;">Total Clients</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #e9ecef;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="activeClients">0</div>
                        <div style="font-size: 12px; color: #666;">WhatsApp Ready</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #e9ecef;">
                        <div style="font-size: 24px; font-weight: bold; color: #dc3545;" id="selectedClients">0</div>
                        <div style="font-size: 12px; color: #666;">Selected</div>
                    </div>
                </div>
                
                <!-- Search and Filter -->
                <div class="form-group">
                    <label for="clientSearch">Search Clients:</label>
                    <input type="text" id="clientSearch" placeholder="Search by company name, email, or phone..." onkeyup="filterClients()">
                </div>
                
                <div class="form-group">
                    <label for="clientFilter">Filter by Status:</label>
                    <select id="clientFilter" onchange="filterClients()">
                        <option value="all">All Clients</option>
                        <option value="whatsapp">WhatsApp Ready Only</option>
                        <option value="no-phone">No Phone Number</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                    </select>
                </div>
                
                <!-- Clients List -->
                <div style="max-height: 400px; overflow-y: auto; border: 2px solid #ddd; border-radius: 8px; background: white;">
                    <div id="clientsList" style="padding: 15px;">
                        <p style="text-align: center; color: #666;">Loading clients...</p>
                    </div>
                </div>
                
                <!-- Individual Actions -->
                <div style="margin-top: 20px;">
                    <h4 style="color: #732C3F; margin-bottom: 15px;">Individual Actions:</h4>
                    <div class="form-group">
                        <label for="singleClientSelect">Select Client:</label>
                        <select id="singleClientSelect">
                            <option value="">Choose a client...</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="sendTestMessage()" style="font-size: 14px; padding: 10px 15px;">
                            üß™ Send Test
                        </button>
                        <button class="btn" onclick="sendWelcomeMessage()" style="background: #28a745; font-size: 14px; padding: 10px 15px;">
                            üéâ Welcome
                        </button>
                        <button class="btn" onclick="viewClientDetails()" style="background: #17a2b8; font-size: 14px; padding: 10px 15px;">
                            üëÅÔ∏è View Details
                        </button>
                    </div>
                </div>
                
                <!-- System Status -->
                <div style="margin-top: 25px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="color: #732C3F; margin-bottom: 10px;">üìä System Status</h4>
                    <div id="systemStatus">
                        <p style="color: #666;">Checking WhatsApp service...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Modal -->
        <div id="resultModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                <h3 style="color: #732C3F; margin-bottom: 20px;">üìä Notification Results</h3>
                <div id="modalContent"></div>
                <button class="btn btn-secondary" onclick="closeModal()" style="margin-top: 20px;">Close</button>
            </div>
        </div>
    </div>

    <script>
        let allClients = [];
        let filteredClients = [];
        
        // Message templates
        const messageTemplates = {
            custom: '',
            welcome: `üéâ Welcome to BizPulse ERP!

Dear Valued Client,

Welcome to our comprehensive business management system! Your account has been successfully set up and you can now access all our powerful features.

üöÄ Get started today and transform your business operations!

If you need any assistance, our support team is here to help.`,
            
            update: `üì¢ Important System Update

Dear Client,

We've just released exciting new features and improvements to BizPulse ERP:

‚ú® Enhanced user interface
üìä Advanced reporting capabilities  
üîí Improved security features
üì± Better mobile experience

Please log in to explore these new features!`,
            
            offer: `üéÅ Exclusive Limited-Time Offer!

Dear Valued Client,

We're excited to offer you an exclusive upgrade opportunity:

üî• 50% OFF Premium Features
‚è∞ Limited time only
üéØ Unlock advanced capabilities
üíé Priority support included

Don't miss out on this special offer!`,
            
            maintenance: `üîß Scheduled Maintenance Notice

Dear Client,

We will be performing scheduled system maintenance:

üìÖ Date: [DATE]
‚è∞ Time: [TIME] to [TIME]
‚ö†Ô∏è System may be temporarily unavailable

We apologize for any inconvenience and appreciate your patience.`,
            
            reminder: `‚è∞ Friendly Reminder

Dear Client,

This is a gentle reminder about your account:

üìã Please review your recent activities
üí≥ Ensure your payment information is up to date
üìä Check your latest reports

Thank you for being a valued BizPulse client!`,
            
            feature: `‚ú® Exciting New Feature Alert!

Dear Client,

We're thrilled to introduce a powerful new feature to BizPulse ERP:

üéØ [FEATURE NAME]
üìà Boost your productivity
üîß Easy to use
üí° Designed based on your feedback

Log in now to try it out!`,
            
            support: `üÜò Support & Assistance Available

Dear Client,

Our support team is here to help you succeed:

üìû 24/7 Support: +91 7093635305
üìß Email: bizpulse.erp@gmail.com
üí¨ Live Chat: Available in your dashboard
üìö Help Center: Comprehensive guides available

Don't hesitate to reach out if you need assistance!`
        };
        
        // Initialize page
        window.onload = function() {
            loadClients();
            checkSystemStatus();
            updateMessageTemplate();
        };
        
        // Load all clients
        async function loadClients() {
            try {
                showResult('Loading clients...', true);
                
                const response = await fetch('/api/clients');
                const data = await response.json();
                
                if (data.success) {
                    allClients = data.clients;
                    filteredClients = [...allClients];
                    displayClients();
                    updateClientStats();
                    populateSingleClientSelect();
                    showResult(`‚úÖ Loaded ${allClients.length} clients`, true);
                } else {
                    showResult(`‚ùå Failed to load clients: ${data.error}`, false);
                }
            } catch (error) {
                showResult(`‚ùå Error loading clients: ${error.message}`, false);
            }
        }
        
        // Display clients in the list
        function displayClients() {
            const clientsList = document.getElementById('clientsList');
            
            if (filteredClients.length === 0) {
                clientsList.innerHTML = '<p style="text-align: center; color: #666;">No clients found.</p>';
                return;
            }
            
            clientsList.innerHTML = filteredClients.map(client => {
                const hasPhone = client.phone_number || client.whatsapp_number;
                const phoneDisplay = client.phone_number || client.whatsapp_number || 'No phone';
                const statusColor = client.is_active ? '#28a745' : '#dc3545';
                const statusText = client.is_active ? 'Active' : 'Inactive';
                
                return `
                    <div style="display: flex; align-items: center; padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 8px; background: ${hasPhone ? '#f8fff8' : '#fff8f8'}; transition: all 0.3s;" 
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <input type="checkbox" id="client_${client.id}" value="${client.id}" 
                               ${!hasPhone ? 'disabled' : ''} 
                               onchange="updateSelectedCount()"
                               style="margin-right: 12px; transform: scale(1.2);">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #732C3F; margin-bottom: 4px;">
                                ${client.company_name}
                            </div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 2px;">
                                üìß ${client.contact_email}
                            </div>
                            <div style="font-size: 13px; color: #666;">
                                üì± ${phoneDisplay} ‚Ä¢ 
                                <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                                ${hasPhone ? ' ‚Ä¢ <span style="color: #28a745;">‚úÖ WhatsApp Ready</span>' : ' ‚Ä¢ <span style="color: #dc3545;">‚ùå No Phone</span>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update client statistics
        function updateClientStats() {
            const total = allClients.length;
            const whatsappReady = allClients.filter(c => c.phone_number || c.whatsapp_number).length;
            const selected = document.querySelectorAll('#clientsList input[type="checkbox"]:checked').length;
            
            document.getElementById('totalClients').textContent = total;
            document.getElementById('activeClients').textContent = whatsappReady;
            document.getElementById('selectedClients').textContent = selected;
        }
        
        // Update selected count
        function updateSelectedCount() {
            updateClientStats();
        }
        
        // Populate single client select
        function populateSingleClientSelect() {
            const select = document.getElementById('singleClientSelect');
            select.innerHTML = '<option value="">Choose a client...</option>';
            
            allClients.forEach(client => {
                if (client.phone_number || client.whatsapp_number) {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.company_name} (${client.phone_number || client.whatsapp_number})`;
                    select.appendChild(option);
                }
            });
        }
        
        // Filter clients
        function filterClients() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            const filterType = document.getElementById('clientFilter').value;
            
            filteredClients = allClients.filter(client => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    client.company_name.toLowerCase().includes(searchTerm) ||
                    client.contact_email.toLowerCase().includes(searchTerm) ||
                    (client.phone_number && client.phone_number.includes(searchTerm)) ||
                    (client.whatsapp_number && client.whatsapp_number.includes(searchTerm));
                
                // Status filter
                let matchesFilter = true;
                switch (filterType) {
                    case 'whatsapp':
                        matchesFilter = client.phone_number || client.whatsapp_number;
                        break;
                    case 'no-phone':
                        matchesFilter = !client.phone_number && !client.whatsapp_number;
                        break;
                    case 'active':
                        matchesFilter = client.is_active;
                        break;
                    case 'inactive':
                        matchesFilter = !client.is_active;
                        break;
                }
                
                return matchesSearch && matchesFilter;
            });
            
            displayClients();
        }
        
        // Select all clients
        function selectAllClients() {
            const checkboxes = document.querySelectorAll('#clientsList input[type="checkbox"]:not([disabled])');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedCount();
        }
        
        // Clear selection
        function clearSelection() {
            const checkboxes = document.querySelectorAll('#clientsList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedCount();
        }
        
        // Update message template
        function updateMessageTemplate() {
            const messageType = document.getElementById('messageType').value;
            const messageContent = document.getElementById('messageContent');
            const messageSubject = document.getElementById('messageSubject');
            
            messageContent.value = messageTemplates[messageType];
            
            // Update subject based on message type
            const subjects = {
                custom: 'BizPulse Notification',
                welcome: 'Welcome to BizPulse ERP!',
                update: 'Important System Update',
                offer: 'Exclusive Limited-Time Offer!',
                maintenance: 'Scheduled Maintenance Notice',
                reminder: 'Friendly Reminder',
                feature: 'Exciting New Feature Alert!',
                support: 'Support & Assistance Available'
            };
            
            messageSubject.value = subjects[messageType];
        }
        
        // Send to selected clients
        async function sendToSelected() {
            const selectedCheckboxes = document.querySelectorAll('#clientsList input[type="checkbox"]:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                showResult('‚ùå Please select at least one client', false);
                return;
            }
            
            const subject = document.getElementById('messageSubject').value.trim();
            const message = document.getElementById('messageContent').value.trim();
            const priority = document.getElementById('priorityLevel').value;
            
            if (!subject || !message) {
                showResult('‚ùå Please enter both subject and message', false);
                return;
            }
            
            await sendNotifications(selectedIds, subject, message, priority);
        }
        
        // Send to all clients
        async function sendToAll() {
            if (!confirm('Are you sure you want to send this message to ALL clients with WhatsApp numbers?')) {
                return;
            }
            
            const allWhatsAppIds = allClients
                .filter(client => client.phone_number || client.whatsapp_number)
                .map(client => client.id);
            
            if (allWhatsAppIds.length === 0) {
                showResult('‚ùå No clients with WhatsApp numbers found', false);
                return;
            }
            
            const subject = document.getElementById('messageSubject').value.trim();
            const message = document.getElementById('messageContent').value.trim();
            const priority = document.getElementById('priorityLevel').value;
            
            if (!subject || !message) {
                showResult('‚ùå Please enter both subject and message', false);
                return;
            }
            
            await sendNotifications(allWhatsAppIds, subject, message, priority);
        }
        
        // Send notifications
        async function sendNotifications(clientIds, subject, message, priority) {
            showResult(`üì± Sending notifications to ${clientIds.length} clients...`, true);
            
            try {
                const response = await fetch('/api/clients/notifications/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_ids: clientIds,
                        subject: subject,
                        message: message,
                        priority: priority
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showModalResults(data);
                    showResult(`‚úÖ ${data.summary.successful_sends}/${data.summary.total_clients} notifications sent successfully!`, true);
                } else {
                    showResult(`‚ùå Failed to send notifications: ${data.error}`, false);
                }
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, false);
            }
        }
        
        // Show detailed results in modal
        function showModalResults(data) {
            const modal = document.getElementById('resultModal');
            const content = document.getElementById('modalContent');
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #732C3F;">${data.summary.total_clients}</div>
                            <div style="font-size: 14px; color: #666;">Total</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #d4edda; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.summary.successful_sends}</div>
                            <div style="font-size: 14px; color: #666;">Successful</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8d7da; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${data.summary.failed_sends}</div>
                            <div style="font-size: 14px; color: #666;">Failed</div>
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-bottom: 15px;">Detailed Results:</h4>
                <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            data.results.forEach(result => {
                const icon = result.success ? '‚úÖ' : '‚ùå';
                const bgColor = result.success ? '#d4edda' : '#f8d7da';
                const textColor = result.success ? '#155724' : '#721c24';
                
                let resultContent = `
                    <div style="padding: 10px; margin-bottom: 8px; background: ${bgColor}; border-radius: 6px; color: ${textColor};">
                        <strong>${icon} ${result.company_name}</strong><br>
                        <small>
                            ${result.phone_number || 'No phone'} ‚Ä¢ 
                            ${result.success ? `Ready to send via ${result.method || 'WhatsApp'}` : result.error}
                        </small>`;
                
                if (result.success && result.phone_number) {
                    const cleanPhone = result.phone_number.replace(/\D/g, '');
                    const whatsappPhone = cleanPhone.startsWith('91') ? cleanPhone : '91' + cleanPhone;
                    const message = encodeURIComponent(`Hello ${result.company_name}! This is a message from BizPulse ERP system. 

üì± Sent from Developer: +91 7093635305
üìß Support: bizpulse.erp@gmail.com`);
                    
                    resultContent += `<br><a href="https://wa.me/${whatsappPhone}?text=${message}" target="_blank" style="display: inline-block; background: #25D366; color: white; padding: 4px 8px; text-decoration: none; border-radius: 4px; font-size: 12px; margin-top: 5px;">üì± Send Now</a>`;
                }
                
                resultContent += `</div>`;
                html += resultContent;
            });
            
            html += '</div>';
            content.innerHTML = html;
            modal.style.display = 'block';
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }
        
        // Send test message
        async function sendTestMessage() {
            const clientId = document.getElementById('singleClientSelect').value;
            
            if (!clientId) {
                showResult('‚ùå Please select a client', false);
                return;
            }
            
            showResult('üß™ Sending test message...', true);
            
            try {
                const response = await fetch('/api/clients/notifications/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ client_id: clientId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult(`‚úÖ Test message sent to ${data.client_name}`, true);
                } else {
                    showResult(`‚ùå Test failed: ${data.error}`, false);
                }
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, false);
            }
        }
        
        // Send welcome message
        async function sendWelcomeMessage() {
            const clientId = document.getElementById('singleClientSelect').value;
            
            if (!clientId) {
                showResult('‚ùå Please select a client', false);
                return;
            }
            
            showResult('üéâ Sending welcome message...', true);
            
            try {
                const response = await fetch(`/api/clients/notifications/welcome/${clientId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let resultHtml = `‚úÖ Welcome message prepared for ${data.client_name}<br>New Password: <strong>${data.new_password}</strong><br>`;
                    
                    if (data.whatsapp_link) {
                        resultHtml += `<br><a href="${data.whatsapp_link}" target="_blank" style="display: inline-block; background: #25D366; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; margin: 5px 0; font-weight: 600;">üì± Send via WhatsApp</a>`;
                    }
                    
                    if (data.developer_link) {
                        resultHtml += `<br><a href="${data.developer_link}" target="_blank" style="display: inline-block; background: #732C3F; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; margin: 5px 0; font-weight: 600;">üë®‚Äçüíª Send from Developer Number</a>`;
                    }
                    
                    resultHtml += `<br><small style="color: #666;">Click the WhatsApp button to send from your registered number (7093635305)</small>`;
                    
                    showResult(resultHtml, true);
                } else {
                    showResult(`‚ùå Welcome message failed: ${data.error}`, false);
                }
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, false);
            }
        }
        
        // View client details
        function viewClientDetails() {
            const clientId = document.getElementById('singleClientSelect').value;
            
            if (!clientId) {
                showResult('‚ùå Please select a client', false);
                return;
            }
            
            const client = allClients.find(c => c.id === clientId);
            if (client) {
                alert(`Client Details:

Company: ${client.company_name}
Contact: ${client.contact_name || 'N/A'}
Email: ${client.contact_email}
Phone: ${client.phone_number || 'N/A'}
WhatsApp: ${client.whatsapp_number || 'N/A'}
Business Type: ${client.business_type || 'N/A'}
Status: ${client.is_active ? 'Active' : 'Inactive'}
Created: ${new Date(client.created_at).toLocaleDateString()}
Last Login: ${client.last_login ? new Date(client.last_login).toLocaleDateString() : 'Never'}`);
            }
        }
        
        // Check system status
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/whatsapp-reports/config/validate');
                const data = await response.json();
                
                const statusDiv = document.getElementById('systemStatus');
                
                if (data.success && data.validation_result && data.validation_result.valid) {
                    statusDiv.innerHTML = `
                        <div style="color: #28a745;">
                            <strong>‚úÖ WhatsApp Service Ready</strong><br>
                            <small>Service: ${data.validation_result.service}<br>
                            Method: ${data.validation_result.method}</small>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div style="color: #dc3545;">
                            <strong>‚ùå WhatsApp Service Issues</strong><br>
                            <small>Please check service configuration</small>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = `
                    <div style="color: #dc3545;">
                        <strong>‚ùå Cannot Check Status</strong><br>
                        <small>Error: ${error.message}</small>
                    </div>
                `;
            }
        }
        
        // Show result message
        function showResult(message, isSuccess = true) {
            const result = document.getElementById('sendResult');
            result.className = `result ${isSuccess ? 'success' : 'error'}`;
            result.innerHTML = message;
            result.style.display = 'block';
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
                result.style.display = 'none';
            }, 8000);
        }
        
        // Close modal when clicking outside
        document.getElementById('resultModal').onclick = function(event) {
            if (event.target === this) {
                closeModal();
            }
        };
    </script>
</body>
</html>