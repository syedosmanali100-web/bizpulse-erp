<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizPulse Mobile</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #F7E8EC 0%, #E8D5DA 100%);
            min-height: 100vh;
        }
        
        /* Top Bar */
        .top-bar {
            background: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .menu-btn {
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            background: #732C3F;
            color: white;
            border-radius: 5px;
        }
        
        .title { color: #732C3F; font-weight: bold; }
        
        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: #732C3F;
            transition: left 0.3s;
            z-index: 200;
            overflow-y: auto;
            color: white;
        }
        
        .side-menu.open { left: 0; }
        
        .menu-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 150;
        }
        
        .overlay.show { display: block; }
        
        /* Content */
        .content {
            padding: 70px 15px 15px 15px;
        }
        
        .card {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .card h2 { 
            color: #732C3F; 
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .welcome-card {
            background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%);
            color: white;
            padding: 25px 20px;
        }
        
        .welcome-card h2 {
            color: white;
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .welcome-card p {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 0;
        }
        
        .stat-box {
            background: white;
            padding: 18px 15px;
            border-radius: 12px;
            border-left: 4px solid #732C3F;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            transition: transform 0.2s;
        }
        
        .stat-box:active {
            transform: scale(0.98);
        }
        
        .stat-box.sales { border-left-color: #4CAF50; }
        .stat-box.products { border-left-color: #2196F3; }
        .stat-box.customers { border-left-color: #FF9800; }
        .stat-box.bills { border-left-color: #9C27B0; }
        
        .stat-icon {
            font-size: 28px;
            margin-bottom: 8px;
            display: block;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .stat-change {
            font-size: 11px;
            color: #4CAF50;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .stat-change.down {
            color: #f44336;
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 0;
        }
        
        .module-box {
            background: white;
            padding: 18px 12px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            transition: all 0.2s;
        }
        
        .module-box:active { 
            transform: scale(0.95);
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        
        .module-icon { 
            font-size: 36px; 
            margin-bottom: 8px;
            display: block;
        }
        
        .module-name { 
            color: #732C3F; 
            font-weight: 600;
            font-size: 13px;
        }
        
        .recent-activity {
            margin-top: 0;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #F7E8EC;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .activity-details {
            flex: 1;
        }
        
        .activity-title {
            font-size: 14px;
            font-weight: 600;
            color: #732C3F;
            margin-bottom: 2px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #666;
        }
        
        .list-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #E8D5DA;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #732C3F;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #732C3F;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E8D5DA;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #732C3F;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #E8D5DA;
            border-radius: 10px;
            font-size: 14px;
            background: white;
        }
        
        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        /* Barcode Scanner Styles */
        .barcode-section {
            margin-bottom: 20px;
        }
        
        .btn-barcode {
            width: 100%;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .btn-barcode:active {
            transform: scale(0.98);
        }
        
        .divider-text {
            text-align: center;
            margin: 20px 0;
            position: relative;
            color: #666;
            font-size: 14px;
        }
        
        .divider-text::before,
        .divider-text::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #E8D5DA;
        }
        
        .divider-text::before { left: 0; }
        .divider-text::after { right: 0; }
        
        .camera-container {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .camera-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-camera {
            flex: 1;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-camera.secondary {
            background: #f44336;
        }
        
        .btn-upload {
            display: inline-block;
            background: #FF9800;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Products Module Styles */
        .product-card {
            background: #F7E8EC;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .product-icon {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-name {
            font-size: 16px;
            font-weight: 600;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .product-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
        }
        
        .product-stock {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .stock-good {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .stock-low {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .stock-out {
            background: #ffebee;
            color: #c62828;
        }
        
        .product-price {
            text-align: right;
        }
        
        .price-value {
            font-size: 20px;
            font-weight: bold;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .product-actions {
            display: flex;
            gap: 6px;
        }
        
        .action-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-edit {
            background: #2196F3;
            color: white;
        }
        
        .btn-delete {
            background: #f44336;
            color: white;
        }
        
        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #E8D5DA;
            background: white;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .filter-tab.active {
            background: #732C3F;
            color: white;
            border-color: #732C3F;
        }
        
        /* Customer Card Styles */
        .customer-card {
            background: #F7E8EC;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            gap: 15px;
            align-items: center;
            transition: transform 0.2s;
        }
        
        .customer-card:active {
            transform: scale(0.98);
        }
        
        .customer-avatar {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .customer-info {
            flex: 1;
            min-width: 0;
        }
        
        .customer-name {
            font-size: 16px;
            font-weight: 600;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .customer-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .customer-phone {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .customer-type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .type-regular {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .type-vip {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .type-wholesale {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .customer-stats {
            text-align: right;
        }
        
        .customer-balance {
            font-size: 18px;
            font-weight: bold;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .customer-purchases {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .customer-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }
        
        /* Sales Card Styles */
        .sale-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #732C3F;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        
        .sale-card:active {
            transform: scale(0.98);
        }
        
        .sale-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .sale-bill-info {
            flex: 1;
        }
        
        .sale-bill-number {
            font-size: 16px;
            font-weight: 600;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .sale-customer {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .sale-amount {
            text-align: right;
        }
        
        .sale-total {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 4px;
        }
        
        .sale-time {
            font-size: 11px;
            color: #999;
        }
        
        .sale-details {
            display: flex;
            gap: 15px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
            font-size: 12px;
        }
        
        .sale-detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
        }
        
        .sale-payment-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .payment-cash {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .payment-card {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .payment-upi {
            background: #f3e5f5;
            color: #6a1b9a;
        }
        
        .sale-products {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            font-size: 12px;
        }
        
        .sale-product-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            color: #666;
        }
        
        /* Earnings/Profit Styles */
        .product-profit-card {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #4CAF50;
        }
        
        .product-profit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .product-profit-name {
            font-size: 14px;
            font-weight: 600;
            color: #732C3F;
        }
        
        .product-profit-amount {
            font-size: 16px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .product-profit-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            font-size: 11px;
            color: #666;
        }
        
        .product-profit-detail {
            text-align: center;
            padding: 6px;
            background: white;
            border-radius: 6px;
        }
        
        .product-profit-detail-label {
            display: block;
            margin-bottom: 3px;
            opacity: 0.8;
        }
        
        .product-profit-detail-value {
            display: block;
            font-weight: 600;
            color: #732C3F;
        }
        
        .profit-margin-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .margin-high {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .margin-medium {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .margin-low {
            background: #ffebee;
            color: #c62828;
        }
        
        /* Loading Screen with Rainbow Gradient */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, 
                #667eea 0%, 
                #764ba2 10%, 
                #f093fb 20%, 
                #4facfe 30%, 
                #00f2fe 40%, 
                #43e97b 50%, 
                #fa709a 60%, 
                #fee140 70%,
                #667eea 80%,
                #764ba2 90%,
                #f093fb 100%
            );
            background-size: 400% 400%;
            animation: rainbowShift 8s ease infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        @keyframes rainbowShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Heartbeat Pulse Line Loader */
        .pulse-loader {
            width: 250px;
            height: 100px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .heartbeat-svg {
            width: 100%;
            height: 100%;
        }
        
        .heartbeat-path {
            stroke: white;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.8));
            animation: drawHeartbeat 3s ease-in-out infinite;
        }
        
        @keyframes drawHeartbeat {
            0% {
                stroke-dasharray: 0 1000;
                stroke-dashoffset: 0;
            }
            50% {
                stroke-dasharray: 1000 0;
                stroke-dashoffset: 0;
            }
            100% {
                stroke-dasharray: 1000 0;
                stroke-dashoffset: -1000;
            }
        }
        
        .loading-brand {
            font-size: 36px;
            font-weight: bold;
            color: white;
            margin-bottom: 40px;
            text-shadow: 0 2px 15px rgba(0,0,0,0.3);
            letter-spacing: 2px;
        }
        
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .login-screen.show { display: flex; }
        .login-screen.hidden { display: none; }
        
        .login-card {
            background: white;
            padding: 30px 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .login-logo h1 {
            color: #732C3F;
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .login-logo p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #732C3F;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E8D5DA;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #732C3F;
        }
        
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .login-btn:active {
            transform: scale(0.98);
        }
        
        .login-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
            color: #999;
            font-size: 14px;
        }
        
        .login-divider::before,
        .login-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 42%;
            height: 1px;
            background: #ddd;
        }
        
        .logout-item {
            background: rgba(255,255,255,0.1);
            margin: 10px 15px;
            border-radius: 8px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            gap: 5px;
        }
        
        .bottom-nav::-webkit-scrollbar {
            display: none;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 8px;
            transition: all 0.3s;
            flex: 1;
            max-width: 80px;
        }
        
        .nav-item:active {
            transform: scale(0.95);
            background: #F7E8EC;
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 2px;
        }
        
        .nav-label {
            font-size: 10px;
            color: #732C3F;
            font-weight: 500;
            white-space: nowrap;
        }
        
        /* Special Billing Button - Bigger & Centered */
        .nav-item.billing-btn {
            background: linear-gradient(135deg, #732C3F 0%, #8B3A47 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(114, 47, 55, 0.3);
            flex: 1.2;
            max-width: 95px;
        }
        
        .nav-item.billing-btn .nav-icon {
            font-size: 28px;
            margin-bottom: 3px;
        }
        
        .nav-item.billing-btn .nav-label {
            color: white;
            font-size: 11px;
            font-weight: 700;
        }
        
        .nav-item.billing-btn:active {
            transform: scale(0.95);
            background: linear-gradient(135deg, #8B3A47 0%, #732C3F 100%);
        }
        
        /* Add padding to content for bottom nav */
        .content {
            padding: 70px 15px 80px 15px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-brand">BizPulse</div>
        <div class="pulse-loader">
            <svg class="heartbeat-svg" viewBox="0 0 250 100" xmlns="http://www.w3.org/2000/svg">
                <path class="heartbeat-path" d="M 0,50 L 40,50 L 50,20 L 60,80 L 70,50 L 90,50 L 100,30 L 110,70 L 120,50 L 140,50 L 150,10 L 160,90 L 170,50 L 190,50 L 200,40 L 210,60 L 220,50 L 250,50"/>
            </svg>
        </div>
        <div class="loading-text">Loading...</div>
        
        <!-- Skip Button for stuck loading -->
        <div style="position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);">
            <button onclick="(function(){var ls=document.getElementById('loadingScreen'); if(ls){ ls.style.display='none'; } var l=document.getElementById('loginScreen'); if(l){ l.style.display='flex'; } })()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 25px; font-size: 14px; cursor: pointer;">
                Skip Loading ‚è≠Ô∏è
            </button>
        </div>
    </div>

    <script>
        // Fallback: ensure login screen appears even if other scripts error
        (function(){
            try {
                setTimeout(function(){
                    var ls = document.getElementById('loadingScreen');
                    var l = document.getElementById('loginScreen');
                    if (ls && l && getComputedStyle(ls).display !== 'none') {
                        console.log('Fallback: forcing login screen after timeout');
                        ls.style.display = 'none';
                        l.style.display = 'flex';
                    }
                }, 4000);
            } catch (e) {
                // If anything fails here, don't block the page
                console.log('Fallback script error', e);
            }
        })();
    </script>
    
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <h1>üè¢ BizPulse</h1>
                <p>Mobile ERP System</p>
            </div>
            
            <!-- Debug Banner (visible on JS errors) -->
            <div id="errorBanner" style="display:none; background:#ffdddd; color:#990000; padding:10px; border-radius:8px; margin-bottom:10px;"></div>

            <!-- Credential Login Form -->
            <form onsubmit="handleLogin(event)" id="credentialLoginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" value="bizpulse.erp@gmail.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" value="demo123" required>
                </div>
                <button type="submit" class="login-btn">üîê Login</button>
            </form>

        </div>
    </div>
    
    <!-- Top Bar -->
    <div class="top-bar" id="topBar" style="display: none;">
        <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
        <div class="title">BizPulse</div>
        <div>üë§</div>
    </div>
    
    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeMenu()"></div>
    
    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <h2>BizPulse ERP</h2>
            <p id="userEmail">admin@demo.com</p>
        </div>
        <div id="menuItems">Loading...</div>
        <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px;"></div>
        <div class="menu-item logout-item" onclick="handleLogout()">
            <span>üö™ Logout</span>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav" id="bottomNav" style="display: none;">
        <div class="nav-item" onclick="scrollToTop()">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">Home</div>
        </div>
        <div class="nav-item" onclick="showModule('products')">
            <div class="nav-icon">üì¶</div>
            <div class="nav-label">Products</div>
        </div>
        
        <!-- BILLING - Special Big Button in Middle -->
        <div class="nav-item billing-btn" onclick="showModule('billing')">
            <div class="nav-icon">üí≥</div>
            <div class="nav-label">BILLING</div>
        </div>
        
        <div class="nav-item" onclick="showModule('sales')">
            <div class="nav-icon">üí∞</div>
            <div class="nav-label">Sales</div>
        </div>
        <div class="nav-item" onclick="showModule('earnings')">
            <div class="nav-icon">üíé</div>
            <div class="nav-label">Earnings</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="content" id="mainContent" style="display: none;">
        <div class="card welcome-card">
            <h2>üëã Welcome Back!</h2>
            <p>Here's what's happening with your business today</p>
        </div>
        
        <div class="card">
            <h2>üìä Overview</h2>
            <div class="stats" id="stats">
                <div class="stat-box sales">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value" id="totalSales">‚Çπ0</div>
                    <div class="stat-label">Today's Sales</div>
                    <div class="stat-change">‚Üë 12%</div>
                </div>
                <div class="stat-box products">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Products</div>
                    <div class="stat-change">‚Üë 5%</div>
                </div>
                <div class="stat-box customers">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="totalCustomers">0</div>
                    <div class="stat-label">Customers</div>
                    <div class="stat-change">‚Üë 8%</div>
                </div>
                <div class="stat-box bills">
                    <div class="stat-icon">üßæ</div>
                    <div class="stat-value" id="totalBills">0</div>
                    <div class="stat-label">Bills Today</div>
                    <div class="stat-change">‚Üë 15%</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>‚ö° Quick Actions</h2>
            <div class="module-grid">
                <div class="module-box" onclick="showModule('billing')">
                    <div class="module-icon">üßæ</div>
                    <div class="module-name">New Bill</div>
                </div>
                <div class="module-box" onclick="showModule('products')">
                    <div class="module-icon">üì¶</div>
                    <div class="module-name">Products</div>
                </div>
                <div class="module-box" onclick="showModule('customers')">
                    <div class="module-icon">üë•</div>
                    <div class="module-name">Customers</div>
                </div>
                <div class="module-box" onclick="showModule('sales')">
                    <div class="module-icon">üí∞</div>
                    <div class="module-name">Sales</div>
                </div>
                <div class="module-box" onclick="showModule('inventory')">
                    <div class="module-icon">üìä</div>
                    <div class="module-name">Inventory</div>
                </div>
                <div class="module-box" onclick="showModule('reports')">
                    <div class="module-icon">üìà</div>
                    <div class="module-name">Reports</div>
                </div>
            </div>
        </div>
        
        <!-- Advanced Features Banner - Hidden by default -->
        <div id="advancedBanner" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; display: none; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">üöÄ</span>
                <div>
                    <h3 style="margin: 0; font-size: 16px;">Advanced Features Available!</h3>
                    <p style="margin: 3px 0 0 0; font-size: 13px; opacity: 0.9;">Access via Menu (‚ò∞) ‚Üí Advanced</p>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button onclick="testAdvancedModule()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">üß™ Test</button>
                <button onclick="document.getElementById('advancedBanner').style.display='none'" style="background: transparent; color: white; border: none; padding: 8px; cursor: pointer; opacity: 0.8; font-size: 18px;">‚úï</button>
            </div>
        </div>
        
        <!-- Advanced Modules Section - Hidden from dashboard -->
        <div class="card" id="advancedModulesCard" style="display: none;">
            <h2>üöÄ Advanced Management</h2>
            <div class="module-grid" id="advancedModulesGrid">
                <!-- Will be populated by JavaScript based on user role -->
            </div>
        </div>
        
        <!-- Recent Activity - Hidden from dashboard -->
        <div class="card" id="recentActivityCard" style="display: none;">
            <h2>üïê Recent Activity</h2>
            <div class="recent-activity">
                <div class="activity-item">
                    <div class="activity-icon">üí∞</div>
                    <div class="activity-details">
                        <div class="activity-title">New Sale</div>
                        <div class="activity-time">2 minutes ago</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon">üë•</div>
                    <div class="activity-details">
                        <div class="activity-title">Customer Added</div>
                        <div class="activity-time">15 minutes ago</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon">üì¶</div>
                    <div class="activity-details">
                        <div class="activity-title">Stock Updated</div>
                        <div class="activity-time">1 hour ago</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card" id="dataDisplay" style="display: none;">
            <h2 id="dataTitle">Select a module</h2>
            <div id="dataContent">Click on any module above to view data</div>
        </div>
        
        <!-- Products Module -->
        <div class="card" id="productsModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üì¶ Products</h2>
                <button onclick="showAddProductForm()" style="background: #732C3F; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px;">+ Add</button>
            </div>
            
            <!-- Search Bar -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="productSearch" placeholder="üîç Search products..." style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;" onkeyup="filterProducts()">
            </div>
            
            <!-- Filter Tabs -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto;">
                <button class="filter-tab active" onclick="filterByCategory('all')">All</button>
                <button class="filter-tab" onclick="filterByCategory('Groceries')">Groceries</button>
                <button class="filter-tab" onclick="filterByCategory('Beverages')">Beverages</button>
                <button class="filter-tab" onclick="filterByCategory('Dairy')">Dairy</button>
                <button class="filter-tab" onclick="filterByCategory('Vegetables')">Vegetables</button>
            </div>
            
            <!-- Products List -->
            <div id="productsList"></div>
        </div>
        
        <!-- Customers Module -->
        <div class="card" id="customersModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üë• Customers</h2>
                <button onclick="showAddCustomerForm()" style="background: #732C3F; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;">+ Add</button>
            </div>
            
            <!-- Search Bar -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="customerSearch" placeholder="üîç Search customers..." style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;" onkeyup="filterCustomers()">
            </div>
            
            <!-- Filter Tabs -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px;">
                <button class="filter-tab active" onclick="filterCustomersByType('all')">All</button>
                <button class="filter-tab" onclick="filterCustomersByType('regular')">Regular</button>
                <button class="filter-tab" onclick="filterCustomersByType('vip')">VIP</button>
                <button class="filter-tab" onclick="filterCustomersByType('wholesale')">Wholesale</button>
            </div>
            
            <!-- Stats Summary -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 15px; border-radius: 12px; color: white;">
                    <div style="font-size: 24px; font-weight: bold;" id="totalCustomersCount">0</div>
                    <div style="font-size: 12px; opacity: 0.9;">Total Customers</div>
                </div>
                <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); padding: 15px; border-radius: 12px; color: white;">
                    <div style="font-size: 24px; font-weight: bold;" id="activeCustomersCount">0</div>
                    <div style="font-size: 12px; opacity: 0.9;">Active This Month</div>
                </div>
            </div>
            
            <!-- Customers List -->
            <div id="customersList"></div>
        </div>
        
        <!-- Billing Module -->
        <div class="card" id="billingModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üí≥ Create Bill</h2>
                <button onclick="clearBill()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px;">Clear</button>
            </div>
            
            <!-- Barcode Scanner Section -->
            <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px; color: white; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
                <h3 style="margin-bottom: 15px; font-size: 16px; color: white; display: flex; align-items: center; gap: 10px;">
                    üì∑ Barcode Scanner
                    <span style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 12px; font-size: 11px;">MALL STYLE</span>
                </h3>
                
                <button onclick="startBarcodeScanner()" id="barcodeScanBtn" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 15px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: 600; margin-bottom: 10px;">
                    üì± Start Scanning
                </button>
                
                <!-- Camera Preview (Hidden initially) -->
                <div id="barcodeCameraContainer" style="display: none; margin-bottom: 15px;">
                    <video id="barcodeVideo" autoplay playsinline style="width: 100%; border-radius: 10px; background: #000;"></video>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="stopBarcodeScanner()" style="background: #dc3545; color: white; border: none; padding: 10px; border-radius: 8px; flex: 1; font-size: 14px;">
                            ‚ùå Stop
                        </button>
                        <button onclick="toggleFlashlight()" id="flashBtn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px; border-radius: 8px; flex: 1; font-size: 14px;">
                            üî¶ Flash
                        </button>
                    </div>
                </div>
                
                <!-- Scan Result -->
                <div id="scanResult" style="display: none; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Last Scanned:</div>
                    <div id="scannedBarcode" style="font-family: monospace; font-size: 14px; font-weight: 600;"></div>
                </div>
                
                <div style="font-size: 12px; opacity: 0.9; text-align: center;">
                    üí° Point camera at barcode to auto-add products
                </div>
            </div>
            
            <!-- Add Product Section -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <h3 style="margin-bottom: 10px; font-size: 16px; color: #732C3F;">Manual Add Product</h3>
                
                <select id="billProductSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 14px;">
                    <option value="">-- Select Product --</option>
                </select>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Quantity</label>
                        <input type="number" id="billQuantity" value="1" min="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Price</label>
                        <input type="number" id="billPrice" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f5f5f5; font-size: 14px;">
                    </div>
                </div>
                
                <button onclick="addToBillMobile()" style="background: #732C3F; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-size: 16px; font-weight: 600;">
                    ‚ûï Add to Bill
                </button>
            </div>
            
            <!-- Bill Items -->
            <div style="margin-bottom: 15px;">
                <h3 style="margin-bottom: 10px; font-size: 16px; color: #732C3F;">Bill Items</h3>
                <div id="billItemsList" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üõí</div>
                        <p>No items added yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Bill Summary -->
            <div style="background: linear-gradient(135deg, #732C3F 0%, #8B3A47 100%); padding: 20px; border-radius: 10px; color: white;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Subtotal:</span>
                    <span style="font-weight: 600;">‚Çπ<span id="billSubtotal">0</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>GST (18%):</span>
                    <span style="font-weight: 600;">‚Çπ<span id="billGST">0</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 20px; font-weight: 700;">
                    <span>Total:</span>
                    <span>‚Çπ<span id="billTotal">0</span></span>
                </div>
            </div>
            
            <!-- Payment Method -->
            <div style="margin-top: 15px;">
                <label style="font-size: 14px; color: #666; display: block; margin-bottom: 8px; font-weight: 600;">Payment Method</label>
                <select id="billPaymentMethod" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="cash">üíµ Cash</option>
                    <option value="upi">üì± UPI</option>
                    <option value="card">üí≥ Card</option>
                </select>
            </div>
            
            <!-- Generate Bill Button -->
            <button onclick="generateBillMobile()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-size: 18px; font-weight: 700; margin-top: 15px; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                üßæ Generate Bill
            </button>
        </div>
        
        <!-- Sales Module -->
        <div class="card" id="salesModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üí∞ Sales</h2>
                <button onclick="showAddSaleForm()" style="background: #732C3F; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;">+ New Sale</button>
            </div>
            
            <!-- Date Filter -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;">
                    <button class="filter-tab active" onclick="filterSalesByDate('today')">Today</button>
                    <button class="filter-tab" onclick="filterSalesByDate('yesterday')">Yesterday</button>
                    <button class="filter-tab" onclick="filterSalesByDate('week')">This Week</button>
                    <button class="filter-tab" onclick="filterSalesByDate('month')">This Month</button>
                    <button class="filter-tab" onclick="filterSalesByDate('all')">All Time</button>
                </div>
            </div>
            
            <!-- Sales Summary Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Total Revenue</div>
                    <div style="font-size: 24px; font-weight: bold;" id="totalRevenue">‚Çπ0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;" id="revenueChange">‚Üë 0%</div>
                </div>
                <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Transactions</div>
                    <div style="font-size: 24px; font-weight: bold;" id="totalTransactions">0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;" id="transactionChange">‚Üë 0%</div>
                </div>
                <div style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Avg Order Value</div>
                    <div style="font-size: 24px; font-weight: bold;" id="avgOrderValue">‚Çπ0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Per transaction</div>
                </div>
                <div style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Top Product</div>
                    <div style="font-size: 16px; font-weight: bold;" id="topProduct">-</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;" id="topProductQty">0 sold</div>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="salesSearch" placeholder="üîç Search by customer, product, bill..." style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;" onkeyup="filterSales()">
            </div>
            
            <!-- Sales List -->
            <div id="salesList"></div>
        </div>
        
        <!-- Earnings/Profit Module -->
        <div class="card" id="earningsModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üíé Earnings & Profit</h2>
                <button onclick="refreshEarnings()" style="background: #732C3F; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;">üîÑ Refresh</button>
            </div>
            
            <!-- Date Filter -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;">
                    <button class="filter-tab active" onclick="filterEarningsByDate('today')">Today</button>
                    <button class="filter-tab" onclick="filterEarningsByDate('yesterday')">Yesterday</button>
                    <button class="filter-tab" onclick="filterEarningsByDate('week')">This Week</button>
                    <button class="filter-tab" onclick="filterEarningsByDate('month')">This Month</button>
                    <button class="filter-tab" onclick="filterEarningsByDate('all')">All Time</button>
                </div>
            </div>
            
            <!-- Main Profit Summary -->
            <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px; box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);">
                <div style="text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üí∞ Total Profit</div>
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;" id="totalProfit">‚Çπ0</div>
                    <div style="font-size: 13px; opacity: 0.9;" id="profitMarginPercent">Margin: 0%</div>
                </div>
            </div>
            
            <!-- Financial Breakdown -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Total Sales</div>
                    <div style="font-size: 22px; font-weight: bold;" id="totalSalesValue">‚Çπ0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Revenue</div>
                </div>
                <div style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Total Cost</div>
                    <div style="font-size: 22px; font-weight: bold;" id="totalCostValue">‚Çπ0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Investment</div>
                </div>
            </div>
            
            <!-- Profit Metrics -->
            <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #E8D5DA;">
                <div style="font-size: 14px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üìä Profit Metrics</div>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                        <span style="color: #666; font-size: 13px;">Gross Profit</span>
                        <span style="color: #4CAF50; font-weight: 600; font-size: 14px;" id="grossProfit">‚Çπ0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                        <span style="color: #666; font-size: 13px;">Profit Margin %</span>
                        <span style="color: #2196F3; font-weight: 600; font-size: 14px;" id="profitMargin">0%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                        <span style="color: #666; font-size: 13px;">Avg Profit/Sale</span>
                        <span style="color: #FF9800; font-weight: 600; font-size: 14px;" id="avgProfitPerSale">‚Çπ0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                        <span style="color: #666; font-size: 13px;">Total Transactions</span>
                        <span style="color: #9C27B0; font-weight: 600; font-size: 14px;" id="totalTransactionsCount">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Product-wise Profit Analysis -->
            <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #E8D5DA;">
                <div style="font-size: 14px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üì¶ Product-wise Profit</div>
                <div id="productProfitList"></div>
            </div>
            
            <!-- Top Performers -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">üèÜ Most Profitable</div>
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 3px;" id="mostProfitableProduct">-</div>
                    <div style="font-size: 12px; opacity: 0.9;" id="mostProfitableAmount">‚Çπ0 profit</div>
                </div>
                <div style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">‚ö†Ô∏è Least Profitable</div>
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 3px;" id="leastProfitableProduct">-</div>
                    <div style="font-size: 12px; opacity: 0.9;" id="leastProfitableAmount">‚Çπ0 profit</div>
                </div>
            </div>
            
            <!-- Profit Trend -->
            <div style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #E8D5DA;">
                <div style="font-size: 14px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üìà Profit Trend</div>
                <div id="profitTrend"></div>
            </div>
        </div>
    </div>
    
    <!-- Add Product Modal -->
    <div class="modal" id="addProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚ûï Add New Product</div>
                <button class="modal-close" onclick="closeAddProductModal()">√ó</button>
            </div>
            
            <!-- Barcode Scanner Section -->
            <div class="barcode-section">
                <button type="button" class="btn-barcode" onclick="openBarcodeScanner()">
                    üì∑ Scan with Barcode
                </button>
                <div class="divider-text">OR</div>
            </div>
            
            <!-- Camera/Upload Section (Hidden initially) -->
            <div id="barcodeUploadSection" style="display: none;">
                <div class="camera-container">
                    <video id="barcodeVideo" autoplay playsinline style="width: 100%; border-radius: 10px; display: none;"></video>
                    <canvas id="barcodeCanvas" style="display: none;"></canvas>
                    
                    <div id="barcodePreview" style="display: none;">
                        <img id="barcodeImage" style="width: 100%; border-radius: 10px; margin-bottom: 10px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <span style="background: #4CAF50; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px;">‚úì Barcode Captured</span>
                        </div>
                    </div>
                    
                    <div class="camera-buttons" id="cameraButtons" style="display: none;">
                        <button type="button" class="btn-camera" onclick="captureBarcode()">üì∏ Capture</button>
                        <button type="button" class="btn-camera secondary" onclick="closeBarcodeScanner()">‚úï Cancel</button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px;">
                        <label for="barcodeFileInput" class="btn-upload">
                            üìÅ Upload Barcode Image
                        </label>
                        <input type="file" id="barcodeFileInput" accept="image/*" style="display: none;" onchange="handleBarcodeUpload(event)">
                    </div>
                </div>
                
                <div class="divider-text">Product Details</div>
            </div>
            
            <form id="productForm" onsubmit="saveProduct(event)">
                <div class="form-group">
                    <label class="form-label">Product Code *</label>
                    <input type="text" id="productCode" class="form-input" placeholder="e.g., P001" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Product Name *</label>
                    <input type="text" id="productName" class="form-input" placeholder="e.g., Rice (1kg)" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="productCategory" class="form-select" onchange="updateSubCategoryOptions()">
                        <option value="">Select Category (Optional)</option>
                        <option value="Dal">Dal (‡§¶‡§æ‡§≤)</option>
                        <option value="Oil">Oil (‡§§‡•á‡§≤)</option>
                        <option value="Rice">Rice (‡§ö‡§æ‡§µ‡§≤)</option>
                        <option value="Flour">Flour (‡§Ü‡§ü‡§æ)</option>
                        <option value="Spices">Spices (‡§Æ‡§∏‡§æ‡§≤‡•á)</option>
                        <option value="Beverages">Beverages (‡§™‡•á‡§Ø)</option>
                        <option value="Dairy">Dairy (‡§°‡•á‡§Ø‡§∞‡•Ä)</option>
                        <option value="Bakery">Bakery (‡§¨‡•á‡§ï‡§∞‡•Ä)</option>
                        <option value="Vegetables">Vegetables (‡§∏‡§¨‡•ç‡§ú‡•Ä)</option>
                        <option value="Fruits">Fruits (‡§´‡§≤)</option>
                        <option value="Snacks">Snacks (‡§®‡§æ‡§∂‡•ç‡§§‡§æ)</option>
                        <option value="Cleaning">Cleaning (‡§∏‡§´‡§æ‡§à)</option>
                        <option value="Personal Care">Personal Care (‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤)</option>
                        <option value="Other">Other (‡§Ö‡§®‡•ç‡§Ø)</option>
                    </select>
                </div>
                
                <div class="form-group" id="subCategoryGroup" style="display: none;">
                    <label class="form-label">Sub-Category</label>
                    <select id="productSubCategory" class="form-select" onchange="updateBrandOptions()">
                        <option value="">Select Sub-Category (Optional)</option>
                        <option value="custom">‚ûï Add Your Own</option>
                    </select>
                </div>
                
                <div class="form-group" id="customSubCategoryGroup" style="display: none;">
                    <label class="form-label">Custom Sub-Category</label>
                    <input type="text" id="customSubCategory" class="form-input" placeholder="Enter your own sub-category">
                </div>
                
                <div class="form-group" id="brandGroup" style="display: none;">
                    <label class="form-label">Brand</label>
                    <select id="productBrand" class="form-select">
                        <option value="">Select Brand (Optional)</option>
                        <option value="custom">‚ûï Add Your Own</option>
                    </select>
                </div>
                
                <div class="form-group" id="customBrandGroup" style="display: none;">
                    <label class="form-label">Custom Brand</label>
                    <input type="text" id="customBrand" class="form-input" placeholder="Enter your own brand name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Selling Price (‚Çπ) *</label>
                    <input type="number" id="productPrice" class="form-input" placeholder="e.g., 80" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Cost Price (‚Çπ) *</label>
                    <input type="number" id="productCost" class="form-input" placeholder="e.g., 70" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Current Stock *</label>
                    <input type="number" id="productStock" class="form-input" placeholder="e.g., 100" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Minimum Stock *</label>
                    <input type="number" id="productMinStock" class="form-input" placeholder="e.g., 10" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Unit *</label>
                    <select id="productUnit" class="form-select" required>
                        <option value="">Select Unit</option>
                        <option value="piece">Piece</option>
                        <option value="kg">Kilogram (kg)</option>
                        <option value="gram">Gram (g)</option>
                        <option value="liter">Liter (L)</option>
                        <option value="ml">Milliliter (ml)</option>
                        <option value="packet">Packet</option>
                        <option value="box">Box</option>
                        <option value="dozen">Dozen</option>
                    </select>
                </div>
                
                <button type="submit" class="btn-primary">üíæ Save Product</button>
            </form>
        </div>
    </div>
    
    <!-- Add Customer Modal -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üë§ Add New Customer</div>
                <button class="modal-close" onclick="closeAddCustomerModal()">√ó</button>
            </div>
            
            <form id="customerForm" onsubmit="saveCustomer(event)">
                <div class="form-group">
                    <label class="form-label">Customer Name *</label>
                    <input type="text" id="customerName" class="form-input" placeholder="e.g., Rajesh Kumar" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" id="customerPhone" class="form-input" placeholder="e.g., +91 9876543210" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="customerEmail" class="form-input" placeholder="e.g., customer@email.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea id="customerAddress" class="form-input" placeholder="e.g., 123 Main Street, City" rows="3" style="resize: vertical;"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Customer Type *</label>
                    <select id="customerType" class="form-select" required>
                        <option value="">Select Type</option>
                        <option value="regular">Regular</option>
                        <option value="vip">VIP</option>
                        <option value="wholesale">Wholesale</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Credit Limit (‚Çπ)</label>
                    <input type="number" id="customerCreditLimit" class="form-input" placeholder="e.g., 5000" step="0.01" value="0">
                </div>
                
                <button type="submit" class="btn-primary">üíæ Save Customer</button>
            </form>
        </div>
    </div>

    <!-- Settings Module -->
    <div class="card" id="settingsModule" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">‚öôÔ∏è Settings</h2>
        </div>
        
        <!-- Business Information -->
        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #E8D5DA;">
            <div style="font-size: 16px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üè¢ Business Information</div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Business Name</label>
                <input type="text" id="businessName" value="BizPulse Store" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Contact Number</label>
                <input type="tel" id="businessPhone" value="+91 7093635305" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Email</label>
                <input type="email" id="businessEmail" value="bizpulse.erp@gmail.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
        </div>
        
        <!-- GST Settings -->
        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #E8D5DA;">
            <div style="font-size: 16px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üìã GST Settings</div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">GST Number</label>
                <input type="text" id="gstNumber" placeholder="Enter GSTIN" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Default GST Rate</label>
                <select id="defaultGST" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="0">0% - Nil Rated</option>
                    <option value="5">5% - Essential Goods</option>
                    <option value="12">12% - Standard Goods</option>
                    <option value="18" selected>18% - Most Goods</option>
                    <option value="28">28% - Luxury Items</option>
                </select>
            </div>
        </div>
        
        <!-- Payment Methods -->
        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #E8D5DA;">
            <div style="font-size: 16px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üí≥ Payment Methods</div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-weight: 600; font-size: 14px;">üíµ Cash</div>
                    <div style="font-size: 12px; color: #666;">Accept cash payments</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                    <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #732C3F; transition: .4s; border-radius: 24px;"></span>
                </label>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-weight: 600; font-size: 14px;">üì± UPI</div>
                    <div style="font-size: 12px; color: #666;">PhonePe, GPay, Paytm</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                    <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #732C3F; transition: .4s; border-radius: 24px;"></span>
                </label>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px;">
                <div>
                    <div style="font-weight: 600; font-size: 14px;">üí≥ Card</div>
                    <div style="font-size: 12px; color: #666;">Credit/Debit cards</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                    <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #732C3F; transition: .4s; border-radius: 24px;"></span>
                </label>
            </div>
        </div>
        
        <!-- Notifications -->
        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #E8D5DA;">
            <div style="font-size: 16px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üîî Notifications</div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-weight: 600; font-size: 14px;">Low Stock Alerts</div>
                    <div style="font-size: 12px; color: #666;">Get notified when stock is low</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                    <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #732C3F; transition: .4s; border-radius: 24px;"></span>
                </label>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px;">
                <div>
                    <div style="font-weight: 600; font-size: 14px;">Daily Sales Report</div>
                    <div style="font-size: 12px; color: #666;">Receive daily summary</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                    <input type="checkbox" style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                </label>
            </div>
        </div>
        
        <!-- Invoice Settings -->
        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #E8D5DA;">
            <div style="font-size: 16px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üßæ Invoice Settings</div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Invoice Prefix</label>
                <input type="text" id="invoicePrefix" value="INV" placeholder="e.g., INV" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Starting Number</label>
                <input type="number" id="invoiceStartNumber" value="1001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px;">
                <div>
                    <div style="font-weight: 600; font-size: 14px;">Auto Numbering</div>
                    <div style="font-size: 12px; color: #666;">Generate invoice numbers automatically</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                    <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #732C3F; transition: .4s; border-radius: 24px;"></span>
                </label>
            </div>
        </div>
        
        <!-- Backup & Restore -->
        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #E8D5DA;">
            <div style="font-size: 16px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üíæ Backup & Restore</div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-weight: 600; font-size: 14px;">Auto Backup</div>
                    <div style="font-size: 12px; color: #666;">Automatic daily backups</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                    <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #732C3F; transition: .4s; border-radius: 24px;"></span>
                </label>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="backupData()" style="background: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600;">
                    üì• Backup Now
                </button>
                <button onclick="restoreData()" style="background: #17a2b8; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600;">
                    üì§ Restore
                </button>
            </div>
        </div>
        
        <!-- Security Settings -->
        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #E8D5DA;">
            <div style="font-size: 16px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üîí Security</div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-weight: 600; font-size: 14px;">PIN Lock</div>
                    <div style="font-size: 12px; color: #666;">Require PIN to open app</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                    <input type="checkbox" style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                </label>
            </div>
            

            
            <button onclick="changePassword()" style="background: #dc3545; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-size: 14px; font-weight: 600; margin-top: 10px;">
                üîë Change Password
            </button>
        </div>
        
        <!-- App Settings -->
        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #E8D5DA;">
            <div style="font-size: 16px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üì± App Settings</div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Language</label>
                <select id="appLanguage" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="en">English</option>
                    <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                    <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                    <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)</option>
                    <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                </select>
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Currency</label>
                <select id="appCurrency" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="INR">‚Çπ INR - Indian Rupee</option>
                    <option value="USD">$ USD - US Dollar</option>
                    <option value="EUR">‚Ç¨ EUR - Euro</option>
                    <option value="GBP">¬£ GBP - British Pound</option>
                </select>
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Date Format</label>
                <select id="dateFormat" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                </select>
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Time Format</label>
                <select id="timeFormat" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="12">12 Hour (AM/PM)</option>
                    <option value="24">24 Hour</option>
                </select>
            </div>
        </div>
        
        <!-- Advanced Settings -->
        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #E8D5DA;">
            <div style="font-size: 16px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üîß Advanced</div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-weight: 600; font-size: 14px;">Debug Mode</div>
                    <div style="font-size: 12px; color: #666;">Show console logs</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                    <input type="checkbox" style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                </label>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-weight: 600; font-size: 14px;">Offline Mode</div>
                    <div style="font-size: 12px; color: #666;">Work without internet</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                    <input type="checkbox" style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                </label>
            </div>
            
            <button onclick="clearCache()" style="background: #ffc107; color: #000; border: none; padding: 12px; border-radius: 8px; width: 100%; font-size: 14px; font-weight: 600; margin-bottom: 10px;">
                üóëÔ∏è Clear Cache
            </button>
            
            <button onclick="resetApp()" style="background: #dc3545; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-size: 14px; font-weight: 600;">
                ‚ö†Ô∏è Reset App
            </button>
        </div>
        
        <!-- Save Button -->
        <button onclick="saveSettings()" style="background: linear-gradient(135deg, #732C3F 0%, #8B3A47 100%); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: 700; box-shadow: 0 4px 15px rgba(114, 47, 55, 0.3);">
            üíæ Save Settings
        </button>
        
        <!-- About Section -->
        <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 10px; text-align: center;">
            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">BizPulse Mobile ERP</div>
            <div style="font-size: 12px; color: #999;">Version 1.0.0</div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">¬© 2025 BizPulse. All rights reserved.</div>
        </div>
    </div>
    

    


    <script>
        console.log('üöÄ Simple Mobile App Started');
        
        // Mobile Mode Functions (defined first)
        function ensureMobileMode() {
            // Set mobile session flag
            localStorage.setItem('mobileERP_active', 'true');
            
            // Add mobile viewport if not present
            let viewport = document.querySelector('meta[name="viewport"]');
            if (!viewport) {
                viewport = document.createElement('meta');
                viewport.name = 'viewport';
                viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                document.head.appendChild(viewport);
            }
            
            // Prevent desktop redirects
            window.addEventListener('beforeunload', function() {
                localStorage.setItem('mobileERP_lastPage', window.location.href);
            });
        }
        
        function checkMobileSession() {
            const isMobileSession = localStorage.getItem('mobileERP_session');
            const returnUrl = localStorage.getItem('mobileERP_returnUrl');
            
            // If we have mobile session and we're not on mobile ERP, redirect back
            if (isMobileSession && !window.location.href.includes('/mobile')) {
                // Add mobile detection to current page
                document.body.style.maxWidth = '400px';
                document.body.style.margin = '0 auto';
                document.body.style.padding = '10px';
                
                // Add back button
                const backButton = document.createElement('div');
                backButton.innerHTML = `
                    <div style="position: fixed; top: 10px; left: 10px; z-index: 9999;">
                        <button onclick="returnToMobileERP()" style="
                            background: #732C3F; 
                            color: white; 
                            border: none; 
                            padding: 10px 15px; 
                            border-radius: 8px; 
                            font-size: 14px; 
                            cursor: pointer;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        ">
                            ‚Üê Back to Mobile ERP
                        </button>
                    </div>
                `;
                document.body.appendChild(backButton);
            }
        }
        
        function returnToMobileERP() {
            const returnUrl = localStorage.getItem('mobileERP_returnUrl') || '/mobile-simple';
            localStorage.removeItem('mobileERP_session');
            localStorage.removeItem('mobileERP_returnUrl');
            window.location.href = returnUrl;
        }
        
        // Initialize mobile mode immediately
        ensureMobileMode();
        checkMobileSession();
        
        // Test function to verify advanced modules work
        window.testAdvancedModule = function() {
            console.log('üß™ Testing advanced module function...');
            openAdvancedModule('client-management');
        };
        
        // Make functions globally accessible
        window.openAdvancedModule = openAdvancedModule;
        
        // Monitor page visibility to detect when user returns
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible again
                const isMobileERP = window.location.href.includes('/mobile');
                const mobileActive = localStorage.getItem('mobileERP_active');
                
                if (mobileActive && isMobileERP) {
                    console.log('üì± Returned to Mobile ERP - ensuring mobile mode');
                    ensureMobileMode();
                }
            }
        });
        
        // Prevent accidental desktop mode switches
        window.addEventListener('resize', function() {
            const mobileActive = localStorage.getItem('mobileERP_active');
            if (mobileActive && window.innerWidth > 768) {
                // Force mobile viewport even on larger screens
                document.body.style.maxWidth = '400px';
                document.body.style.margin = '0 auto';
            }
        });
        
        // Auto-detect API Base URL
        const API_BASE_URL = window.location.origin;
        console.log('üåê API Base URL:', API_BASE_URL);
        
        // Helper function for API calls
        async function apiCall(endpoint, options = {}) {
            try {
                const url = `${API_BASE_URL}${endpoint}`;
                console.log('üì° API Call:', url, options);
                options.credentials = options.credentials || 'same-origin';
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('‚ùå API Error:', error);
                throw error;
            }
        }
        
        // Show loading screen, then login - FIXED VERSION
        window.addEventListener('load', function() {
            console.log('üöÄ Mobile Dashboard loaded, initializing...');
            
            // Hide loading screen immediately
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                loadingScreen.style.display = 'none';
            }
            
            // Hide login screen (not needed for dashboard)
            const loginScreen = document.getElementById('loginScreen');
            if (loginScreen) {
                loginScreen.style.display = 'none';
            }
            
            // Show main app immediately
            const topBar = document.getElementById('topBar');
            if (topBar) topBar.style.display = 'flex';
            const bottomNav = document.getElementById('bottomNav');
            if (bottomNav) bottomNav.style.display = 'flex';
            const mainContent = document.getElementById('mainContent');
            if (mainContent) mainContent.style.display = 'block';
            
            // Initialize mobile mode and load dashboard
            console.log('üîß Initializing mobile dashboard...');
            ensureMobileMode();
            loadMenuItems();
            loadDashboard();
        });
        
        // Backup - force show login if stuck
        setTimeout(function() {
            try {
                const loadingScreen = document.getElementById('loadingScreen');
                const loginScreen = document.getElementById('loginScreen');
                
                if (loadingScreen && loadingScreen.style.display !== 'none') {
                    console.log('üö® Loading stuck, forcing login screen...');
                    forceShowLogin();
                }
            } catch (e) {
                console.log('Backup check error', e);
            }
        }, 3000); // Backup after 3 seconds
        
        // Force show login function
        function forceShowLogin() {
            console.log('üîê Force showing login screen...');
            try {
                const loadingScreen = document.getElementById('loadingScreen');
                const loginScreen = document.getElementById('loginScreen');
                
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                    loadingScreen.classList.add('hidden');
                }
                
                if (loginScreen) {
                    loginScreen.style.display = 'flex';
                    loginScreen.classList.add('show');
                }
            } catch (e) {
                console.log('forceShowLogin error', e);
            }
        }
        
        // Login Handler
        async function handleLogin(event) {
            event.preventDefault();
            console.log('handleLogin: started');
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // Try server login first
                console.log('handleLogin: attempting server login for', email);
                const resp = await fetch('/api/auth/unified-login', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ loginId: email, password: password })
                });

                console.log('handleLogin: server response ok?', resp.ok, resp.status);
                if (resp.ok) {
                    const data = await resp.json();
                    console.log('handleLogin: server login success', data);
                    // Successful server login
                    localStorage.setItem('bizpulse_login', JSON.stringify({ email: email, loginTime: new Date().toISOString() }));
                    localStorage.setItem('userInfo', JSON.stringify(data.user));

                    // If opened via token link, confirm it for this session
                    if (window.__mobileLinkToken) {
                        try {
                            const c = await fetch('/api/mobile/confirm-link', {
                                method: 'POST',
                                credentials: 'same-origin',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ token: window.__mobileLinkToken })
                            });
                            console.log('handleLogin: confirm-link status', c.status);
                            if (c.ok) console.log('Mobile link confirmed');
                            else console.log('Failed to confirm mobile link');
                        } catch (err) {
                            console.log('Error confirming mobile link', err);
                        }
                    }

                    performLogin(email);
                    return;
                }

                // If server login failed, fall back to demo local check
                console.log('handleLogin: server login failed, falling back to local demo check');
                const savedUser = JSON.parse(localStorage.getItem('bizpulse_user') || '{"password":"demo123"}');
                if (email === 'bizpulse.erp@gmail.com' && password === savedUser.password) {
                    performLogin(email);
                } else {
                    showError('Invalid credentials.');
                }
            } catch (err) {
                console.error('handleLogin: error', err);
                // Network error ‚Äî fallback to local demo
                const savedUser = JSON.parse(localStorage.getItem('bizpulse_user') || '{"password":"demo123"}');
                if (email === 'bizpulse.erp@gmail.com' && password === savedUser.password) {
                    performLogin(email);
                } else {
                    showError('Network error. Unable to login.');
                }
            }
        }
        

        
        // Perform Login (Common function)
        function performLogin(email) {
            console.log('‚úÖ Login successful:', email);
            
            // Save login state
            localStorage.setItem('bizpulse_login', JSON.stringify({
                email: email,
                loginTime: new Date().toISOString()
            }));
            
            // Hide login screen
            const loginScreen = document.getElementById('loginScreen');
            if (loginScreen) {
                loginScreen.classList.add('hidden');
                loginScreen.style.display = 'none';
            }

            // Show main app
            const topBar = document.getElementById('topBar');
            if (topBar) topBar.style.display = 'flex';
            const bottomNav = document.getElementById('bottomNav');
            if (bottomNav) bottomNav.style.display = 'flex';
            const mainContent = document.getElementById('mainContent');
            if (mainContent) mainContent.style.display = 'block';
            
            // Update user email in menu
            const userEmailEl = document.getElementById('userEmail');
            if (userEmailEl) userEmailEl.textContent = email;
            
            // Load dashboard data
            loadDashboard().catch(err => {
                console.error('performLogin: loadDashboard failed', err);
                const errBanner = document.getElementById('errorBanner');
                if (errBanner) {
                    errBanner.textContent = 'Error loading dashboard: ' + (err.message || err);
                    errBanner.style.display = 'block';
                }
            });
        }
        
        // Logout Handler
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                console.log('üëã Logging out...');
                
                try {
                    // Call server logout endpoint
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' }
                    });
                } catch (err) {
                    console.log('Server logout error:', err);
                }
                
                // Clear local storage
                localStorage.removeItem('bizpulse_login');
                localStorage.removeItem('userInfo');
                localStorage.removeItem('mobileERP_active');
                
                // Hide main app
                document.getElementById('topBar').style.display = 'none';
                document.getElementById('bottomNav').style.display = 'none';
                document.getElementById('mainContent').style.display = 'none';
                
                // Close menu
                closeMenu();
                
                // Show login screen
                const loginScreen = document.getElementById('loginScreen');
                loginScreen.classList.remove('hidden');
                loginScreen.style.display = 'flex';
                
                // Reset form
                document.getElementById('loginPassword').value = 'demo123';
                
                console.log('‚úÖ Logout complete');
            }
        }
        
        // Toggle Menu
        function toggleMenu() {
            console.log('Menu toggle clicked');
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('overlay');
            
            if (menu.classList.contains('open')) {
                closeMenu();
            } else {
                menu.classList.add('open');
                overlay.classList.add('show');
                loadMenuItems();
            }
        }
        
        function closeMenu() {
            document.getElementById('sideMenu').classList.remove('open');
            document.getElementById('overlay').classList.remove('show');
        }
        
        // Load Menu Items
        async function loadMenuItems() {
            console.log('Loading menu items...');
            const container = document.getElementById('menuItems');
            
            try {
                console.log('üìã Loading menu...');
                const data = await apiCall('/api/modules');
                console.log('‚úÖ Menu data loaded');
                
                let html = '';
                
                // Core modules
                if (data.core_modules) {
                    html += '<div style="padding: 10px 20px; font-size: 12px; opacity: 0.7;">CORE</div>';
                    data.core_modules.forEach(m => {
                        html += `<div class="menu-item" onclick="showModule('${m.route}')">${m.icon} ${m.name}</div>`;
                    });
                }
                
                // Inventory
                if (data.inventory_modules) {
                    html += '<div style="padding: 10px 20px; font-size: 12px; opacity: 0.7;">INVENTORY</div>';
                    data.inventory_modules.forEach(m => {
                        html += `<div class="menu-item" onclick="showModule('${m.route}')">${m.icon} ${m.name}</div>`;
                    });
                }
                
                // Customer
                if (data.customer_modules) {
                    html += '<div style="padding: 10px 20px; font-size: 12px; opacity: 0.7;">CUSTOMER</div>';
                    data.customer_modules.forEach(m => {
                        html += `<div class="menu-item" onclick="showModule('${m.route}')">${m.icon} ${m.name}</div>`;
                    });
                }
                

                // Add Earnings manually (not in API yet)
                html += '<div style="padding: 10px 20px; font-size: 12px; opacity: 0.7;">ANALYTICS</div>';
                html += '<div class="menu-item" onclick="showModule(\'earnings\')">üíé Earnings & Profit</div>';
                
                // Add Settings
                html += '<div style="padding: 10px 20px; font-size: 12px; opacity: 0.7;">SYSTEM</div>';
                html += '<div class="menu-item" onclick="showModule(\'settings\')">‚öôÔ∏è Settings</div>';
                
                // Check user role and add advanced modules
                try {
                    const userResponse = await fetch('/api/auth/user-info');
                    const userInfo = await userResponse.json();
                    
                    if (userInfo.is_super_admin || userInfo.user_type === 'client') {
                        html += '<div style="padding: 10px 20px; font-size: 12px; opacity: 0.7; color: #FFD700;">üöÄ ADVANCED</div>';
                        
                        if (userInfo.is_super_admin) {
                            // Super admin modules
                            html += '<div class="menu-item" onclick="openAdvancedModule(\'client-management\')" style="background: rgba(52, 152, 219, 0.1);">üè¢ Client Management <span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 5px;">NEW</span></div>';
                            html += '<div class="menu-item" onclick="openAdvancedModule(\'whatsapp-reports\')" style="background: rgba(37, 211, 102, 0.1);">üì± WhatsApp Reports <span style="background: #25D366; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 5px;">HOT</span></div>';
                            html += '<div class="menu-item" onclick="openAdvancedModule(\'developer-tools\')" style="background: rgba(231, 76, 60, 0.1);">‚öôÔ∏è Developer Tools <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 5px;">ADMIN</span></div>';
                        }
                        
                        if (userInfo.user_type === 'client') {
                            // Business owner modules
                            html += '<div class="menu-item" onclick="openAdvancedModule(\'user-management\')" style="background: rgba(255, 193, 7, 0.1);">üë• User Management <span style="background: #ffc107; color: #212529; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 5px;">NEW</span></div>';
                            html += '<div class="menu-item" onclick="openAdvancedModule(\'staff-management\')" style="background: rgba(156, 39, 176, 0.1);">üë®‚Äçüíº Staff Management <span style="background: #9c27b0; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 5px;">NEW</span></div>';
                        }
                    }
                } catch (error) {
                    console.log('Could not load advanced modules:', error);
                }
                
                container.innerHTML = html;
                console.log('‚úÖ Menu loaded');
            } catch (error) {
                console.error('Menu load error:', error);
                container.innerHTML = '<div style="padding: 20px;">Error loading menu</div>';
            }
        }
        
        // Load Dashboard Data
        async function loadDashboard() {
            console.log('üìä Loading dashboard...');
            
            try {
                // Show loading indicator
                const loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'dashboardLoading';
                loadingIndicator.innerHTML = '<div style="text-align: center; padding: 20px; color: #732C3F;">Loading dashboard... üìä</div>';
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.insertBefore(loadingIndicator, mainContent.firstChild);
                }
                
                // Products with better error handling
                console.log('üì¶ Fetching products...');
                let products = [];
                try {
                    products = await apiCall('/api/products');
                    document.getElementById('totalProducts').textContent = products.length;
                    console.log(`‚úÖ Products loaded: ${products.length}`);
                } catch (error) {
                    console.error('‚ùå Products API failed:', error);
                    document.getElementById('totalProducts').textContent = '0';
                }
                
                // Customers with better error handling
                console.log('üë• Fetching customers...');
                let customers = [];
                try {
                    customers = await apiCall('/api/customers');
                    document.getElementById('totalCustomers').textContent = customers.length;
                    console.log(`‚úÖ Customers loaded: ${customers.length}`);
                } catch (error) {
                    console.error('‚ùå Customers API failed:', error);
                    document.getElementById('totalCustomers').textContent = '0';
                }
                
                // Sales with better error handling
                console.log('üí∞ Fetching sales...');
                let sales = {};
                try {
                    sales = await apiCall('/api/sales/summary');
                    document.getElementById('totalSales').textContent = '‚Çπ' + (sales.today?.total || 0).toFixed(0);
                    document.getElementById('totalBills').textContent = sales.today?.count || 0;
                    console.log(`‚úÖ Sales loaded: ‚Çπ${sales.today?.total || 0}`);
                } catch (error) {
                    console.error('‚ùå Sales API failed:', error);
                    document.getElementById('totalSales').textContent = '‚Çπ0';
                    document.getElementById('totalBills').textContent = '0';
                }
                
                // Remove loading indicator
                const loading = document.getElementById('dashboardLoading');
                if (loading) loading.remove();
                
                console.log('‚úÖ Dashboard loaded successfully!');
                
                // Load advanced modules based on user role
                loadAdvancedModules();
                
            } catch (error) {
                console.error('‚ùå Dashboard error:', error);
                
                // Remove loading indicator
                const loading = document.getElementById('dashboardLoading');
                if (loading) loading.remove();
                
                // Show user-friendly error
                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = `
                    <div style="background: #ffebee; color: #c62828; padding: 15px; margin: 10px; border-radius: 10px; text-align: center;">
                        <h3>‚ö†Ô∏è Dashboard Loading Failed</h3>
                        <p>Please check:</p>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>Server is running</li>
                            <li>Same WiFi network</li>
                            <li>Correct IP address</li>
                        </ul>
                        <button onclick="location.reload()" style="background: #732C3F; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.insertBefore(errorDiv, mainContent.firstChild);
                }
            }
        }
        
        // Load Advanced Modules - Only show banner, not dashboard cards
        async function loadAdvancedModules() {
            try {
                const userResponse = await fetch('/api/auth/user-info');
                const userInfo = await userResponse.json();
                
                let hasAdvancedModules = false;
                
                if (userInfo.is_super_admin || userInfo.user_type === 'client') {
                    hasAdvancedModules = true;
                }
                
                if (hasAdvancedModules) {
                    // Only show banner, not the dashboard cards
                    const advancedBanner = document.getElementById('advancedBanner');
                    if (advancedBanner) {
                        advancedBanner.style.display = 'flex';
                    }
                    
                    console.log('‚úÖ Advanced modules available for user type:', userInfo.user_type);
                    console.log('üì± Access via Menu (‚ò∞) ‚Üí Advanced section');
                }
                
            } catch (error) {
                console.log('Could not load advanced modules:', error);
            }
        }
        
        let allProducts = [];
        let currentCategory = 'all';
        
        // Advanced Module Functions - Mobile Native
        function openAdvancedModule(moduleType) {
            console.log('üöÄ Opening advanced module:', moduleType);
            
            try {
                closeMenu();
                
                // Hide dashboard content
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    const cards = mainContent.querySelectorAll('.card');
                    cards.forEach(card => {
                        if (!card.id || !card.id.includes('Module')) {
                            card.style.display = 'none';
                        }
                    });
                }
                
                // Hide all existing modules first
                const allModules = ['dataDisplay', 'productsModule', 'customersModule', 'billingModule', 'salesModule', 'earningsModule', 'settingsModule'];
                allModules.forEach(moduleId => {
                    const element = document.getElementById(moduleId);
                    if (element) element.style.display = 'none';
                });
                
                // Hide advanced modules if they exist
                const advancedModules = ['clientManagementModule', 'userManagementModule', 'staffManagementModule', 'whatsappReportsModule', 'developerToolsModule'];
                advancedModules.forEach(moduleId => {
                    const element = document.getElementById(moduleId);
                    if (element) element.style.display = 'none';
                });
                
                // Show the requested advanced module
                console.log('üì± Switching to module:', moduleType);
                switch(moduleType) {
                    case 'client-management':
                        showClientManagementModule();
                        break;
                    case 'user-management':
                        showUserManagementModule();
                        break;
                    case 'staff-management':
                        showStaffManagementModule();
                        break;
                    case 'whatsapp-reports':
                        showWhatsAppReportsModule();
                        break;
                    case 'developer-tools':
                        showDeveloperToolsModule();
                        break;
                    default:
                        console.log('‚ùå Unknown advanced module:', moduleType);
                        alert('Module not found: ' + moduleType);
                }
                
            } catch (error) {
                console.error('‚ùå Error opening advanced module:', error);
                alert('Error opening module: ' + error.message);
            }
        }
        
        // Client Management Module
        function showClientManagementModule() {
            console.log('üè¢ Loading Client Management Module...');
            
            try {
                let clientModule = document.getElementById('clientManagementModule');
                if (!clientModule) {
                    console.log('üìù Creating new client management module');
                    clientModule = document.createElement('div');
                    clientModule.id = 'clientManagementModule';
                    clientModule.className = 'card';
                    clientModule.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">üè¢ Client Management</h2>
                        <button onclick="showModule('dashboard')" style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px;">‚Üê Back</button>
                    </div>
                    
                    <!-- Client Stats -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 15px; border-radius: 12px; color: white;">
                            <div style="font-size: 24px; font-weight: bold;" id="totalClientsCount">0</div>
                            <div style="font-size: 12px; opacity: 0.9;">Total Clients</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); padding: 15px; border-radius: 12px; color: white;">
                            <div style="font-size: 24px; font-weight: bold;" id="activeClientsCount">0</div>
                            <div style="font-size: 12px; opacity: 0.9;">Active Clients</div>
                        </div>
                    </div>
                    
                    <!-- Add Client Button -->
                    <button onclick="showAddClientForm()" style="width: 100%; background: #3498db; color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 600; margin-bottom: 20px;">
                        + Add New Client
                    </button>
                    
                    <!-- Search Bar -->
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="clientSearch" placeholder="üîç Search clients..." style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;" onkeyup="filterClients()">
                    </div>
                    
                    <!-- Clients List -->
                    <div id="clientsList">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üè¢</div>
                            <h3>Loading Clients...</h3>
                            <p>Please wait while we fetch client data</p>
                        </div>
                    </div>
                `;
                document.querySelector('.content').appendChild(clientModule);
                console.log('‚úÖ Client management module created and added to DOM');
            } else {
                console.log('‚ôªÔ∏è Reusing existing client management module');
            }
            
            clientModule.style.display = 'block';
            console.log('üëÅÔ∏è Client management module made visible');
            loadClientsData();
            
            } catch (error) {
                console.error('‚ùå Error in showClientManagementModule:', error);
                alert('Error loading Client Management: ' + error.message);
            }
        }
        
        // Load Clients Data
        async function loadClientsData() {
            try {
                console.log('üìä Loading clients data...');
                
                // Mock data for now - replace with actual API call
                const mockClients = [
                    {
                        id: 1,
                        name: 'Rajesh Enterprises',
                        email: 'rajesh@example.com',
                        phone: '+91 9876543210',
                        status: 'active',
                        plan: 'Premium',
                        joined: '2024-01-15'
                    },
                    {
                        id: 2,
                        name: 'Sharma Trading Co.',
                        email: 'sharma@example.com',
                        phone: '+91 9876543211',
                        status: 'active',
                        plan: 'Basic',
                        joined: '2024-02-20'
                    },
                    {
                        id: 3,
                        name: 'Kumar Industries',
                        email: 'kumar@example.com',
                        phone: '+91 9876543212',
                        status: 'inactive',
                        plan: 'Premium',
                        joined: '2024-03-10'
                    }
                ];
                
                // Update stats
                document.getElementById('totalClientsCount').textContent = mockClients.length;
                document.getElementById('activeClientsCount').textContent = mockClients.filter(c => c.status === 'active').length;
                
                // Render clients list
                renderClientsList(mockClients);
                
            } catch (error) {
                console.error('‚ùå Error loading clients:', error);
                document.getElementById('clientsList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <h3>Error Loading Clients</h3>
                        <p>Please try again later</p>
                    </div>
                `;
            }
        }
        
        // Render Clients List
        function renderClientsList(clients) {
            const clientsList = document.getElementById('clientsList');
            
            if (!clients || clients.length === 0) {
                clientsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üè¢</div>
                        <h3>No Clients Found</h3>
                        <p>Add your first client to get started</p>
                    </div>
                `;
                return;
            }
            
            const html = clients.map(client => `
                <div class="client-card" style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid ${client.status === 'active' ? '#27ae60' : '#e74c3c'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px;">${client.name}</h3>
                            <p style="margin: 0; color: #7f8c8d; font-size: 12px;">üìß ${client.email}</p>
                            <p style="margin: 2px 0 0 0; color: #7f8c8d; font-size: 12px;">üì± ${client.phone}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${client.status === 'active' ? '#27ae60' : '#e74c3c'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; text-transform: uppercase;">
                                ${client.status}
                            </span>
                            <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 11px;">${client.plan} Plan</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button onclick="viewClientDetails(${client.id})" style="flex: 1; background: #3498db; color: white; border: none; padding: 8px; border-radius: 6px; font-size: 12px;">
                            üëÅÔ∏è View
                        </button>
                        <button onclick="editClient(${client.id})" style="flex: 1; background: #f39c12; color: white; border: none; padding: 8px; border-radius: 6px; font-size: 12px;">
                            ‚úèÔ∏è Edit
                        </button>
                        <button onclick="manageClientAccess(${client.id})" style="flex: 1; background: #9b59b6; color: white; border: none; padding: 8px; border-radius: 6px; font-size: 12px;">
                            üîê Access
                        </button>
                    </div>
                </div>
            `).join('');
            
            clientsList.innerHTML = html;
        }
        
        // Client Management Functions
        function showAddClientForm() {
            alert('üöß Add Client Form\n\nThis feature is under development.\nComing soon with full client registration!');
        }
        
        function viewClientDetails(clientId) {
            alert(`üëÅÔ∏è View Client Details\n\nClient ID: ${clientId}\n\nDetailed view coming soon!`);
        }
        
        function editClient(clientId) {
            alert(`‚úèÔ∏è Edit Client\n\nClient ID: ${clientId}\n\nEdit form coming soon!`);
        }
        
        function manageClientAccess(clientId) {
            alert(`üîê Manage Access\n\nClient ID: ${clientId}\n\nAccess management coming soon!`);
        }
        
        function filterClients() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            const clientCards = document.querySelectorAll('.client-card');
            
            clientCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // User Management Module
        function showUserManagementModule() {
            let userModule = document.getElementById('userManagementModule');
            if (!userModule) {
                userModule = document.createElement('div');
                userModule.id = 'userManagementModule';
                userModule.className = 'card';
                userModule.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">üë• User Management</h2>
                        <button onclick="showModule('dashboard')" style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px;">‚Üê Back</button>
                    </div>
                    
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üë•</div>
                        <h3>User Management</h3>
                        <p>Manage employees and their permissions</p>
                        <button onclick="alert('üöß Coming Soon!')" style="background: #ffc107; color: #212529; border: none; padding: 12px 24px; border-radius: 8px; margin-top: 15px;">
                            üöß Under Development
                        </button>
                    </div>
                `;
                document.querySelector('.content').appendChild(userModule);
            }
            userModule.style.display = 'block';
        }
        
        // Staff Management Module
        function showStaffManagementModule() {
            let staffModule = document.getElementById('staffManagementModule');
            if (!staffModule) {
                staffModule = document.createElement('div');
                staffModule.id = 'staffManagementModule';
                staffModule.className = 'card';
                staffModule.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">üë®‚Äçüíº Staff Management</h2>
                        <button onclick="showModule('dashboard')" style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px;">‚Üê Back</button>
                    </div>
                    
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üë®‚Äçüíº</div>
                        <h3>Staff Management</h3>
                        <p>Manage staff access and permissions</p>
                        <button onclick="alert('üöß Coming Soon!')" style="background: #9c27b0; color: white; border: none; padding: 12px 24px; border-radius: 8px; margin-top: 15px;">
                            üöß Under Development
                        </button>
                    </div>
                `;
                document.querySelector('.content').appendChild(staffModule);
            }
            staffModule.style.display = 'block';
        }
        
        // WhatsApp Reports Module
        function showWhatsAppReportsModule() {
            let whatsappModule = document.getElementById('whatsappReportsModule');
            if (!whatsappModule) {
                whatsappModule = document.createElement('div');
                whatsappModule.id = 'whatsappReportsModule';
                whatsappModule.className = 'card';
                whatsappModule.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">üì± WhatsApp Reports</h2>
                        <button onclick="showModule('dashboard')" style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px;">‚Üê Back</button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0;">üéâ FREE WhatsApp Service!</h3>
                        <p style="margin: 0; opacity: 0.9;">Send professional daily reports to clients via WhatsApp - No API keys required!</p>
                    </div>
                    
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì±</div>
                        <h3>WhatsApp Reports</h3>
                        <p>Send automated daily reports to clients</p>
                        <button onclick="alert('üöß Coming Soon!')" style="background: #25D366; color: white; border: none; padding: 12px 24px; border-radius: 8px; margin-top: 15px;">
                            üöß Under Development
                        </button>
                    </div>
                `;
                document.querySelector('.content').appendChild(whatsappModule);
            }
            whatsappModule.style.display = 'block';
        }
        
        // Developer Tools Module
        function showDeveloperToolsModule() {
            let devModule = document.getElementById('developerToolsModule');
            if (!devModule) {
                devModule = document.createElement('div');
                devModule.id = 'developerToolsModule';
                devModule.className = 'card';
                devModule.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">‚öôÔ∏è Developer Tools</h2>
                        <button onclick="showModule('dashboard')" style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px;">‚Üê Back</button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0;">üîí Admin Only Access</h3>
                        <p style="margin: 0; opacity: 0.9;">System management and advanced configuration tools</p>
                    </div>
                    
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚öôÔ∏è</div>
                        <h3>Developer Tools</h3>
                        <p>System management and advanced settings</p>
                        <button onclick="alert('üöß Coming Soon!')" style="background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 8px; margin-top: 15px;">
                            üöß Under Development
                        </button>
                    </div>
                `;
                document.querySelector('.content').appendChild(devModule);
            }
            devModule.style.display = 'block';
        }
        
        // Check if returning from advanced module
        function checkMobileSession() {
            const isMobileSession = localStorage.getItem('mobileERP_session');
            const returnUrl = localStorage.getItem('mobileERP_returnUrl');
            
            // If we have mobile session and we're not on mobile ERP, redirect back
            if (isMobileSession && !window.location.href.includes('/mobile')) {
                // Add mobile detection to current page
                document.body.style.maxWidth = '400px';
                document.body.style.margin = '0 auto';
                document.body.style.padding = '10px';
                
                // Add back button
                const backButton = document.createElement('div');
                backButton.innerHTML = `
                    <div style="position: fixed; top: 10px; left: 10px; z-index: 9999;">
                        <button onclick="returnToMobileERP()" style="
                            background: #732C3F; 
                            color: white; 
                            border: none; 
                            padding: 10px 15px; 
                            border-radius: 8px; 
                            font-size: 14px; 
                            cursor: pointer;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        ">
                            ‚Üê Back to Mobile ERP
                        </button>
                    </div>
                `;
                document.body.appendChild(backButton);
            }
        }
        


        // Show Module Data
        async function showModule(module) {
            console.log('Loading module:', module);
            closeMenu();
            
            // Hide all modules
            document.getElementById('dataDisplay').style.display = 'none';
            document.getElementById('productsModule').style.display = 'none';
            document.getElementById('customersModule').style.display = 'none';
            document.getElementById('billingModule').style.display = 'none';
            document.getElementById('salesModule').style.display = 'none';
            document.getElementById('earningsModule').style.display = 'none';
            document.getElementById('settingsModule').style.display = 'none';

            
            // Hide dashboard cards and advanced modules
            document.querySelectorAll('.card').forEach(card => {
                if (!card.id || card.id === 'dataDisplay' || card.id === 'productsModule') {
                    card.style.display = 'none';
                }
            });
            
            // Hide all advanced modules specifically
            const advancedModules = ['clientManagementModule', 'userManagementModule', 'staffManagementModule', 'whatsappReportsModule', 'developerToolsModule'];
            advancedModules.forEach(moduleId => {
                const element = document.getElementById(moduleId);
                if (element) element.style.display = 'none';
            });
            
            // Handle dashboard case
            if (module === 'dashboard') {
                console.log('‚úÖ Showing dashboard');
                
                // First hide ALL cards including advanced modules
                document.querySelectorAll('.card').forEach(card => {
                    card.style.display = 'none';
                });
                
                // Hide all advanced modules specifically
                const advancedModules = ['clientManagementModule', 'userManagementModule', 'staffManagementModule', 'whatsappReportsModule', 'developerToolsModule'];
                advancedModules.forEach(moduleId => {
                    const element = document.getElementById(moduleId);
                    if (element) element.style.display = 'none';
                });
                
                // Show only the main dashboard cards
                document.querySelectorAll('.card').forEach(card => {
                    // Show welcome card, overview card, and quick actions card ONLY
                    if (card.classList.contains('welcome-card') || 
                        (card.querySelector('h2') && (
                            card.querySelector('h2').textContent.includes('Overview') ||
                            card.querySelector('h2').textContent.includes('Quick Actions')
                        ))) {
                        card.style.display = 'block';
                    }
                });
                
                // Update stats without calling loadDashboard to avoid showing advanced modules
                try {
                    console.log('üìä Updating dashboard stats...');
                    
                    // Products
                    const products = await apiCall('/api/products');
                    document.getElementById('totalProducts').textContent = products.length;
                    
                    // Customers
                    const customers = await apiCall('/api/customers');
                    document.getElementById('totalCustomers').textContent = customers.length;
                    
                    // Sales
                    const sales = await apiCall('/api/sales/summary');
                    document.getElementById('totalSales').textContent = '‚Çπ' + (sales.today?.total || 0).toFixed(0);
                    document.getElementById('totalBills').textContent = sales.today?.count || 0;
                    
                    console.log('‚úÖ Dashboard stats updated!');
                } catch (error) {
                    console.error('‚ùå Dashboard stats error:', error);
                }
                
                return;
            }
            
            if (module === 'products') {
                document.getElementById('productsModule').style.display = 'block';
                await loadProducts();
                return;
            }
            
            if (module === 'billing') {
                document.getElementById('billingModule').style.display = 'block';
                await loadBillingModule();
                return;
            }
            
            if (module === 'customers') {
                document.getElementById('customersModule').style.display = 'block';
                await loadCustomers();
                return;
            }
            
            if (module === 'sales') {
                document.getElementById('salesModule').style.display = 'block';
                await loadSales();
                return;
            }
            
            if (module === 'earnings' || module === 'reports') {
                document.getElementById('earningsModule').style.display = 'block';
                await loadEarnings();
                return;
            }
            
            if (module === 'settings') {
                document.getElementById('settingsModule').style.display = 'block';
                loadSettings();
                return;
            }
            
            if (module === 'invoices') {
                await loadInvoices();
                return;
            }
            
            // For other modules, use old display
            document.getElementById('dataDisplay').style.display = 'block';
            
            const title = document.getElementById('dataTitle');
            const content = document.getElementById('dataContent');
            
            title.textContent = module.charAt(0).toUpperCase() + module.slice(1);
            content.innerHTML = '<p>Loading...</p>';
            
            try {
                let data;
                let html = '';
                
                if (module === 'customers') {
                    data = await fetch('/api/customers').then(r => r.json());
                    html = '<div>';
                    data.forEach(c => {
                        html += `<div class="list-item">
                            <div><strong>${c.name}</strong><br><small>${c.phone}</small></div>
                            <div><small>${c.email || 'No email'}</small></div>
                        </div>`;
                    });
                    html += '</div>';
                } else if (module === 'sales') {
                    data = await fetch('/api/sales/summary').then(r => r.json());
                    html = `<div>
                        <div class="stat-box" style="margin: 10px 0;">
                            <div class="stat-value">‚Çπ${(data.today?.total || 0).toFixed(2)}</div>
                            <div class="stat-label">Today's Sales</div>
                        </div>
                        <div class="stat-box" style="margin: 10px 0;">
                            <div class="stat-value">‚Çπ${(data.week?.total || 0).toFixed(2)}</div>
                            <div class="stat-label">This Week</div>
                        </div>
                        <div class="stat-box" style="margin: 10px 0;">
                            <div class="stat-value">‚Çπ${(data.month?.total || 0).toFixed(2)}</div>
                            <div class="stat-label">This Month</div>
                        </div>
                    </div>`;
                } else {
                    html = '<p>Module coming soon...</p>';
                }
                
                content.innerHTML = html;
                console.log('‚úÖ Module loaded:', module);
            } catch (error) {
                console.error('Module error:', error);
                content.innerHTML = '<p style="color: red;">Error loading data</p>';
            }
        }
        
        // Load Products
        async function loadProducts() {
            try {
                console.log('üì¶ Loading products...');
                allProducts = await apiCall('/api/products');
                console.log(`‚úÖ Products loaded: ${allProducts.length}`);
                displayProducts(allProducts);
            } catch (error) {
                console.error('‚ùå Error loading products:', error);
                document.getElementById('productsList').innerHTML = '<p style="text-align: center; color: red;">Failed to load products. Check connection.</p>';
            }
        }
        
        // Display Products
        function displayProducts(products) {
            const container = document.getElementById('productsList');
            
            if (products.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No products found</p>';
                return;
            }
            
            let html = '';
            products.forEach(product => {
                const stockStatus = product.stock === 0 ? 'out' : (product.stock <= product.min_stock ? 'low' : 'good');
                const stockClass = `stock-${stockStatus}`;
                const stockText = product.stock === 0 ? 'Out of Stock' : (product.stock <= product.min_stock ? `Low: ${product.stock}` : `Stock: ${product.stock}`);
                
                html += `
                    <div class="product-card">
                        <div class="product-icon">üì¶</div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-details">${product.category || 'General'}${product.sub_category ? ' ‚Ä¢ ' + product.sub_category : ''}${product.brand ? ' ‚Ä¢ ' + product.brand : ''} ‚Ä¢ ${product.unit}</div>
                            <span class="product-stock ${stockClass}">${stockText}</span>
                        </div>
                        <div class="product-price">
                            <div class="price-value">‚Çπ${product.price}</div>
                            <div class="product-actions">
                                <button class="action-btn btn-edit" onclick="editProduct('${product.id}')">Edit</button>
                                <button class="action-btn btn-delete" onclick="deleteProduct('${product.id}')">Del</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Filter Products by Search
        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            let filtered = allProducts;
            
            if (currentCategory !== 'all') {
                filtered = filtered.filter(p => p.category === currentCategory);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.category.toLowerCase().includes(searchTerm)
                );
            }
            
            displayProducts(filtered);
        }
        
        // Filter by Category
        function filterByCategory(category) {
            currentCategory = category;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            filterProducts();
        }
        
        let barcodeStream = null;
        let barcodeImageData = null;
        
        // Add Product Form
        function showAddProductForm() {
            document.getElementById('addProductModal').classList.add('show');
            document.getElementById('productForm').reset();
            document.getElementById('barcodeUploadSection').style.display = 'none';
            document.getElementById('barcodePreview').style.display = 'none';
            barcodeImageData = null;
        }
        
        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.remove('show');
            closeBarcodeScanner();
        }
        
        // Update Sub-Category Options based on Category
        function updateSubCategoryOptions() {
            const category = document.getElementById('productCategory').value;
            const subCategorySelect = document.getElementById('productSubCategory');
            const subCategoryGroup = document.getElementById('subCategoryGroup');
            const brandGroup = document.getElementById('brandGroup');
            const customSubCategoryGroup = document.getElementById('customSubCategoryGroup');
            const customBrandGroup = document.getElementById('customBrandGroup');
            
            // Hide all dependent fields
            subCategoryGroup.style.display = 'none';
            brandGroup.style.display = 'none';
            customSubCategoryGroup.style.display = 'none';
            customBrandGroup.style.display = 'none';
            
            // Clear existing options
            subCategorySelect.innerHTML = '<option value="">Select Sub-Category (Optional)</option><option value="custom">‚ûï Add Your Own</option>';
            
            if (!category) {
                return;
            }
            
            // Sub-category options for each category
            const subCategoryOptions = {
                'Dal': [
                    'Toor Dal (‡§§‡•Ç‡§∞ ‡§¶‡§æ‡§≤)',
                    'Masoor Dal (‡§Æ‡§∏‡•Ç‡§∞ ‡§¶‡§æ‡§≤)', 
                    'Chana Dal (‡§ö‡§®‡§æ ‡§¶‡§æ‡§≤)',
                    'Moong Dal (‡§Æ‡•Ç‡§Ç‡§ó ‡§¶‡§æ‡§≤)',
                    'Urad Dal (‡§â‡§°‡§º‡§¶ ‡§¶‡§æ‡§≤)',
                    'Arhar Dal (‡§Ö‡§∞‡§π‡§∞ ‡§¶‡§æ‡§≤)',
                    'Rajma (‡§∞‡§æ‡§ú‡§Æ‡§æ)',
                    'Kabuli Chana (‡§ï‡§¨‡•Å‡§≤‡•Ä ‡§ö‡§®‡§æ)',
                    'Kala Chana (‡§ï‡§æ‡§≤‡§æ ‡§ö‡§®‡§æ)'
                ],
                'Oil': [
                    'Sunflower Oil (‡§∏‡•Ç‡§∞‡§ú‡§Æ‡•Å‡§ñ‡•Ä ‡§§‡•á‡§≤)',
                    'Mustard Oil (‡§∏‡§∞‡§∏‡•ã‡§Ç ‡§§‡•á‡§≤)',
                    'Coconut Oil (‡§®‡§æ‡§∞‡§ø‡§Ø‡§≤ ‡§§‡•á‡§≤)',
                    'Groundnut Oil (‡§Æ‡•Ç‡§Ç‡§ó‡§´‡§≤‡•Ä ‡§§‡•á‡§≤)',
                    'Sesame Oil (‡§§‡§ø‡§≤ ‡§§‡•á‡§≤)',
                    'Olive Oil (‡§ú‡•à‡§§‡•Ç‡§® ‡§§‡•á‡§≤)',
                    'Rice Bran Oil (‡§ö‡§æ‡§µ‡§≤ ‡§ï‡•Ä ‡§≠‡•Ç‡§∏‡•Ä ‡§§‡•á‡§≤)',
                    'Palm Oil (‡§™‡§æ‡§Æ ‡§§‡•á‡§≤)'
                ],
                'Rice': [
                    'Basmati Rice (‡§¨‡§æ‡§∏‡§Æ‡§§‡•Ä ‡§ö‡§æ‡§µ‡§≤)',
                    'Sona Masoori (‡§∏‡•ã‡§®‡§æ ‡§Æ‡§∏‡•Ç‡§∞‡•Ä)',
                    'Ponni Rice (‡§™‡•ã‡§®‡•ç‡§®‡•Ä ‡§ö‡§æ‡§µ‡§≤)',
                    'Jasmine Rice (‡§ú‡•à‡§∏‡•ç‡§Æ‡§ø‡§® ‡§ö‡§æ‡§µ‡§≤)',
                    'Brown Rice (‡§¨‡•ç‡§∞‡§æ‡§â‡§® ‡§ö‡§æ‡§µ‡§≤)',
                    'Red Rice (‡§≤‡§æ‡§≤ ‡§ö‡§æ‡§µ‡§≤)',
                    'Parboiled Rice (‡§â‡§¨‡§≤‡•á ‡§ö‡§æ‡§µ‡§≤)'
                ],
                'Flour': [
                    'Wheat Flour (‡§ó‡•á‡§π‡•Ç‡§Ç ‡§Ü‡§ü‡§æ)',
                    'Rice Flour (‡§ö‡§æ‡§µ‡§≤ ‡§Ü‡§ü‡§æ)',
                    'Gram Flour (‡§¨‡•á‡§∏‡§®)',
                    'Corn Flour (‡§Æ‡§ï‡•ç‡§ï‡§æ ‡§Ü‡§ü‡§æ)',
                    'Ragi Flour (‡§∞‡§æ‡§ó‡•Ä ‡§Ü‡§ü‡§æ)',
                    'Bajra Flour (‡§¨‡§æ‡§ú‡§∞‡§æ ‡§Ü‡§ü‡§æ)',
                    'Jowar Flour (‡§ú‡•ç‡§µ‡§æ‡§∞ ‡§Ü‡§ü‡§æ)',
                    'Maida (‡§Æ‡•à‡§¶‡§æ)'
                ],
                'Spices': [
                    'Turmeric Powder (‡§π‡§≤‡•ç‡§¶‡•Ä ‡§™‡§æ‡§â‡§°‡§∞)',
                    'Red Chili Powder (‡§≤‡§æ‡§≤ ‡§Æ‡§ø‡§∞‡•ç‡§ö ‡§™‡§æ‡§â‡§°‡§∞)',
                    'Coriander Powder (‡§ß‡§®‡§ø‡§Ø‡§æ ‡§™‡§æ‡§â‡§°‡§∞)',
                    'Cumin Powder (‡§ú‡•Ä‡§∞‡§æ ‡§™‡§æ‡§â‡§°‡§∞)',
                    'Garam Masala (‡§ó‡§∞‡§Æ ‡§Æ‡§∏‡§æ‡§≤‡§æ)',
                    'Black Pepper (‡§ï‡§æ‡§≤‡•Ä ‡§Æ‡§ø‡§∞‡•ç‡§ö)',
                    'Cardamom (‡§á‡§≤‡§æ‡§Ø‡§ö‡•Ä)',
                    'Cinnamon (‡§¶‡§æ‡§≤‡§ö‡•Ä‡§®‡•Ä)',
                    'Cloves (‡§≤‡•å‡§Ç‡§ó)'
                ],
                'Beverages': [
                    'Tea (‡§ö‡§æ‡§Ø)',
                    'Coffee (‡§ï‡•â‡§´‡•Ä)',
                    'Soft Drinks (‡§∏‡•â‡§´‡•ç‡§ü ‡§°‡•ç‡§∞‡§ø‡§Ç‡§ï)',
                    'Fruit Juice (‡§´‡§≤ ‡§∞‡§∏)',
                    'Energy Drinks (‡§è‡§®‡§∞‡•ç‡§ú‡•Ä ‡§°‡•ç‡§∞‡§ø‡§Ç‡§ï)',
                    'Mineral Water (‡§Æ‡§ø‡§®‡§∞‡§≤ ‡§µ‡§æ‡§ü‡§∞)'
                ],
                'Dairy': [
                    'Milk (‡§¶‡•Ç‡§ß)',
                    'Curd (‡§¶‡§π‡•Ä)',
                    'Paneer (‡§™‡§®‡•Ä‡§∞)',
                    'Butter (‡§Æ‡§ï‡•ç‡§ñ‡§®)',
                    'Cheese (‡§ö‡•Ä‡§ú)',
                    'Ghee (‡§ò‡•Ä)'
                ],
                'Vegetables': [
                    'Onion (‡§™‡•ç‡§Ø‡§æ‡§ú)',
                    'Potato (‡§Ü‡§≤‡•Ç)',
                    'Tomato (‡§ü‡§Æ‡§æ‡§ü‡§∞)',
                    'Carrot (‡§ó‡§æ‡§ú‡§∞)',
                    'Cabbage (‡§™‡§§‡•ç‡§§‡§æ ‡§ó‡•ã‡§≠‡•Ä)',
                    'Cauliflower (‡§´‡•Ç‡§≤ ‡§ó‡•ã‡§≠‡•Ä)',
                    'Green Beans (‡§π‡§∞‡•Ä ‡§´‡§≤‡•Ä)',
                    'Spinach (‡§™‡§æ‡§≤‡§ï)'
                ],
                'Fruits': [
                    'Apple (‡§∏‡•á‡§¨)',
                    'Banana (‡§ï‡•á‡§≤‡§æ)',
                    'Orange (‡§∏‡§Ç‡§§‡§∞‡§æ)',
                    'Mango (‡§Ü‡§Æ)',
                    'Grapes (‡§Ö‡§Ç‡§ó‡•Ç‡§∞)',
                    'Pomegranate (‡§Ö‡§®‡§æ‡§∞)',
                    'Papaya (‡§™‡§™‡•Ä‡§§‡§æ)',
                    'Watermelon (‡§§‡§∞‡§¨‡•Ç‡§ú)'
                ],
                'Cleaning': [
                    'Detergent Powder (‡§°‡§ø‡§ü‡§∞‡•ç‡§ú‡•á‡§Ç‡§ü ‡§™‡§æ‡§â‡§°‡§∞)',
                    'Liquid Detergent (‡§≤‡§ø‡§ï‡•ç‡§µ‡§ø‡§° ‡§°‡§ø‡§ü‡§∞‡•ç‡§ú‡•á‡§Ç‡§ü)',
                    'Dish Wash (‡§¨‡§∞‡•ç‡§§‡§® ‡§ß‡•ã‡§®‡•á ‡§ï‡§æ ‡§∏‡§æ‡§¨‡•Å‡§®)',
                    'Floor Cleaner (‡§´‡•ç‡§≤‡•ã‡§∞ ‡§ï‡•ç‡§≤‡•Ä‡§®‡§∞)',
                    'Toilet Cleaner (‡§ü‡•â‡§Ø‡§≤‡•á‡§ü ‡§ï‡•ç‡§≤‡•Ä‡§®‡§∞)',
                    'Glass Cleaner (‡§ó‡•ç‡§≤‡§æ‡§∏ ‡§ï‡•ç‡§≤‡•Ä‡§®‡§∞)'
                ],
                'Personal Care': [
                    'Shampoo (‡§∂‡•à‡§Æ‡•ç‡§™‡•Ç)',
                    'Soap (‡§∏‡§æ‡§¨‡•Å‡§®)',
                    'Toothpaste (‡§ü‡•Ç‡§•‡§™‡•á‡§∏‡•ç‡§ü)',
                    'Face Wash (‡§´‡•á‡§∏ ‡§µ‡§æ‡§∂)',
                    'Body Lotion (‡§¨‡•â‡§°‡•Ä ‡§≤‡•ã‡§∂‡§®)',
                    'Hair Oil (‡§π‡•á‡§Ø‡§∞ ‡§ë‡§Ø‡§≤)'
                ]
            };
            
            // Add options for selected category
            if (subCategoryOptions[category]) {
                subCategoryOptions[category].forEach(subCategory => {
                    const option = document.createElement('option');
                    option.value = subCategory;
                    option.textContent = subCategory;
                    subCategorySelect.appendChild(option);
                });
                subCategoryGroup.style.display = 'block';
            }
        }
        
        // Update Brand Options based on Sub-Category
        function updateBrandOptions() {
            const subCategory = document.getElementById('productSubCategory').value;
            const brandSelect = document.getElementById('productBrand');
            const brandGroup = document.getElementById('brandGroup');
            const customSubCategoryGroup = document.getElementById('customSubCategoryGroup');
            const customBrandGroup = document.getElementById('customBrandGroup');
            
            // Handle custom sub-category
            if (subCategory === 'custom') {
                customSubCategoryGroup.style.display = 'block';
                brandGroup.style.display = 'none';
                customBrandGroup.style.display = 'none';
                return;
            } else {
                customSubCategoryGroup.style.display = 'none';
            }
            
            // Clear existing options
            brandSelect.innerHTML = '<option value="">Select Brand (Optional)</option><option value="custom">‚ûï Add Your Own</option>';
            
            if (!subCategory) {
                brandGroup.style.display = 'none';
                customBrandGroup.style.display = 'none';
                return;
            }
            
            // Popular brand options for different sub-categories
            const brandOptions = {
                // Dal Brands
                'Toor Dal (‡§§‡•Ç‡§∞ ‡§¶‡§æ‡§≤)': ['Tata Sampann', 'Ashirvaad', 'Fortune', 'Everest', 'Patanjali', 'Organic India'],
                'Masoor Dal (‡§Æ‡§∏‡•Ç‡§∞ ‡§¶‡§æ‡§≤)': ['Tata Sampann', 'Ashirvaad', 'Fortune', 'Everest', 'Patanjali'],
                'Chana Dal (‡§ö‡§®‡§æ ‡§¶‡§æ‡§≤)': ['Tata Sampann', 'Ashirvaad', 'Fortune', 'Everest', 'Patanjali'],
                'Moong Dal (‡§Æ‡•Ç‡§Ç‡§ó ‡§¶‡§æ‡§≤)': ['Tata Sampann', 'Ashirvaad', 'Fortune', 'Everest', 'Patanjali'],
                
                // Oil Brands
                'Sunflower Oil (‡§∏‡•Ç‡§∞‡§ú‡§Æ‡•Å‡§ñ‡•Ä ‡§§‡•á‡§≤)': ['Fortune', 'Sundrop', 'Saffola', 'Oleev', 'Gemini', 'Freedom'],
                'Mustard Oil (‡§∏‡§∞‡§∏‡•ã‡§Ç ‡§§‡•á‡§≤)': ['Fortune', 'Patanjali', 'Dhara', 'Nature Fresh', 'Emami Healthy'],
                'Coconut Oil (‡§®‡§æ‡§∞‡§ø‡§Ø‡§≤ ‡§§‡•á‡§≤)': ['Parachute', 'KLF Coconad', 'Patanjali', 'Dabur', 'Marico'],
                'Groundnut Oil (‡§Æ‡•Ç‡§Ç‡§ó‡§´‡§≤‡•Ä ‡§§‡•á‡§≤)': ['Dhara', 'Fortune', 'Patanjali', 'Nature Fresh'],
                
                // Rice Brands
                'Basmati Rice (‡§¨‡§æ‡§∏‡§Æ‡§§‡•Ä ‡§ö‡§æ‡§µ‡§≤)': ['India Gate', 'Daawat', 'Kohinoor', 'Fortune', 'Tilda', 'Lal Qilla'],
                'Sona Masoori (‡§∏‡•ã‡§®‡§æ ‡§Æ‡§∏‡•Ç‡§∞‡•Ä)': ['Fortune', 'India Gate', 'Kohinoor', 'Dawat'],
                
                // Flour Brands
                'Wheat Flour (‡§ó‡•á‡§π‡•Ç‡§Ç ‡§Ü‡§ü‡§æ)': ['Ashirvaad', 'Pillsbury', 'Fortune', 'Patanjali', 'Annapurna'],
                'Rice Flour (‡§ö‡§æ‡§µ‡§≤ ‡§Ü‡§ü‡§æ)': ['Patanjali', 'Organic India', 'Fortune', 'Ashirvaad'],
                
                // Spice Brands
                'Turmeric Powder (‡§π‡§≤‡•ç‡§¶‡•Ä ‡§™‡§æ‡§â‡§°‡§∞)': ['Everest', 'MDH', 'Red Label', 'Catch', 'Patanjali', 'Tata Sampann'],
                'Red Chili Powder (‡§≤‡§æ‡§≤ ‡§Æ‡§ø‡§∞‡•ç‡§ö ‡§™‡§æ‡§â‡§°‡§∞)': ['Everest', 'MDH', 'Red Label', 'Catch', 'Patanjali'],
                'Garam Masala (‡§ó‡§∞‡§Æ ‡§Æ‡§∏‡§æ‡§≤‡§æ)': ['Everest', 'MDH', 'Red Label', 'Catch', 'Patanjali'],
                
                // Cleaning Brands
                'Detergent Powder (‡§°‡§ø‡§ü‡§∞‡•ç‡§ú‡•á‡§Ç‡§ü ‡§™‡§æ‡§â‡§°‡§∞)': ['Surf Excel', 'Ariel', 'Tide', 'Rin', 'Wheel', 'Patanjali'],
                'Dish Wash (‡§¨‡§∞‡•ç‡§§‡§® ‡§ß‡•ã‡§®‡•á ‡§ï‡§æ ‡§∏‡§æ‡§¨‡•Å‡§®)': ['Vim', 'Pril', 'Exo', 'Citron', 'Patanjali'],
                
                // Personal Care Brands
                'Shampoo (‡§∂‡•à‡§Æ‡•ç‡§™‡•Ç)': ['Head & Shoulders', 'Pantene', 'Sunsilk', 'Clinic Plus', 'Patanjali', 'Dove'],
                'Soap (‡§∏‡§æ‡§¨‡•Å‡§®)': ['Lux', 'Dove', 'Pears', 'Lifebuoy', 'Dettol', 'Patanjali'],
                'Toothpaste (‡§ü‡•Ç‡§•‡§™‡•á‡§∏‡•ç‡§ü)': ['Colgate', 'Pepsodent', 'Close Up', 'Sensodyne', 'Patanjali', 'Dabur']
            };
            
            // Add brand options for selected sub-category
            if (brandOptions[subCategory]) {
                brandOptions[subCategory].forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    brandSelect.appendChild(option);
                });
            }
            
            brandGroup.style.display = 'block';
            
            // Handle custom brand selection
            brandSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customBrandGroup.style.display = 'block';
                } else {
                    customBrandGroup.style.display = 'none';
                }
            });
        }
        
        // Open Barcode Scanner
        async function openBarcodeScanner() {
            const section = document.getElementById('barcodeUploadSection');
            section.style.display = 'block';
            
            // Check if camera is supported
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showUploadOnlyOption(section);
                return;
            }
            
            // Check if we're on HTTPS or localhost (required for camera)
            const isSecure = window.location.protocol === 'https:' || 
                           window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1';
            
            if (!isSecure) {
                alert('‚ö†Ô∏è Camera requires HTTPS!\n\n' +
                      'üì± Your browser blocks camera on HTTP for security.\n\n' +
                      '‚úÖ Solution: Use "Upload Barcode Image" option below\n\n' +
                      '(Camera works on HTTPS or localhost only)');
                showUploadOnlyOption(section);
                return;
            }
            
            // Show loading message - permission popup will appear automatically
            section.innerHTML = `
                <div style="text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white; margin-bottom: 15px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üì∑</div>
                    <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Requesting Camera Access...</p>
                    <p style="font-size: 13px; opacity: 0.9;">Browser will ask for permission</p>
                    <p style="font-size: 12px; opacity: 0.8; margin-top: 10px;">üëÜ Click "Allow" when popup appears</p>
                </div>
            `;
            
            try {
                // Request camera permission - Browser automatically shows permission popup
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Use back camera on mobile
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                // Success! Show camera preview
                section.innerHTML = `
                    <div class="camera-container">
                        <video id="barcodeVideo" autoplay playsinline style="width: 100%; border-radius: 10px; background: #000;"></video>
                        <canvas id="barcodeCanvas" style="display: none;"></canvas>
                        
                        <div id="barcodePreview" style="display: none;">
                            <img id="barcodeImage" style="width: 100%; border-radius: 10px; margin-bottom: 10px;">
                            <div style="text-align: center; margin-bottom: 15px;">
                                <span style="background: #4CAF50; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px;">‚úì Barcode Captured</span>
                            </div>
                        </div>
                        
                        <div class="camera-buttons" id="cameraButtons" style="display: flex;">
                            <button type="button" class="btn-camera" onclick="captureBarcode()">üì∏ Capture</button>
                            <button type="button" class="btn-camera secondary" onclick="closeBarcodeScanner()">‚úï Cancel</button>
                        </div>
                        
                        <div style="text-align: center; margin-top: 10px;">
                            <label for="barcodeFileInput" class="btn-upload">
                                üìÅ Or Upload Image
                            </label>
                            <input type="file" id="barcodeFileInput" accept="image/*" style="display: none;" onchange="handleBarcodeUpload(event)">
                        </div>
                    </div>
                    
                    <div class="divider-text">Product Details</div>
                `;
                
                const video = document.getElementById('barcodeVideo');
                barcodeStream = stream;
                video.srcObject = stream;
                
                console.log('‚úÖ Camera access granted - live preview active');
            } catch (error) {
                console.error('Camera error:', error);
                handleCameraError(error, section);
            }
        }
        
        // Show upload-only option
        function showUploadOnlyOption(section) {
            section.innerHTML = `
                <div class="camera-container">
                    <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-size: 36px; margin-bottom: 10px;">üìÅ</div>
                        <p style="color: #856404; margin-bottom: 5px; font-weight: 600;">Camera Not Available</p>
                        <p style="font-size: 12px; color: #856404;">Use upload option below</p>
                    </div>
                    
                    <div id="barcodePreview" style="display: none;">
                        <img id="barcodeImage" style="width: 100%; border-radius: 10px; margin-bottom: 10px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <span style="background: #4CAF50; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px;">‚úì Barcode Uploaded</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <label for="barcodeFileInput" class="btn-upload" style="display: inline-block; padding: 14px 24px; font-size: 16px;">
                            üìÅ Upload Barcode Image
                        </label>
                        <input type="file" id="barcodeFileInput" accept="image/*" style="display: none;" onchange="handleBarcodeUpload(event)">
                    </div>
                </div>
                
                <div class="divider-text">Product Details</div>
            `;
        }
        
        // Handle camera errors
        function handleCameraError(error, section) {
            let title = '‚ùå Camera Access Failed';
            let message = '';
            let instructions = '';
            
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                title = 'üîí Permission Denied';
                message = 'You blocked camera access';
                instructions = `
                    <div style="text-align: left; font-size: 12px; color: #666; margin-top: 10px; padding: 10px; background: white; border-radius: 8px;">
                        <strong>To enable camera:</strong><br>
                        1. Tap address bar (üîí icon)<br>
                        2. Find "Camera" permission<br>
                        3. Change to "Allow"<br>
                        4. Refresh page & try again
                    </div>
                `;
            } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                title = 'üì∑ No Camera Found';
                message = 'No camera detected on device';
            } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                title = '‚ö†Ô∏è Camera In Use';
                message = 'Camera is being used by another app';
                instructions = '<div style="font-size: 12px; color: #666; margin-top: 8px;">Close other apps using camera</div>';
            } else {
                message = error.message || 'Unknown error occurred';
            }
            
            // Show error with upload option
            section.innerHTML = `
                <div class="camera-container">
                    <div style="text-align: center; padding: 20px; background: #ffebee; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-size: 36px; margin-bottom: 10px;">üì∑</div>
                        <p style="color: #c62828; margin-bottom: 5px; font-weight: 600;">${title}</p>
                        <p style="font-size: 13px; color: #c62828;">${message}</p>
                        ${instructions}
                    </div>
                    
                    <div id="barcodePreview" style="display: none;">
                        <img id="barcodeImage" style="width: 100%; border-radius: 10px; margin-bottom: 10px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <span style="background: #4CAF50; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px;">‚úì Barcode Uploaded</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <label for="barcodeFileInput" class="btn-upload" style="display: inline-block; padding: 14px 24px; font-size: 16px;">
                            üìÅ Upload Barcode Image Instead
                        </label>
                        <input type="file" id="barcodeFileInput" accept="image/*" style="display: none;" onchange="handleBarcodeUpload(event)">
                    </div>
                </div>
                
                <div class="divider-text">Product Details</div>
            `;
        }
        
        // Capture Barcode
        function captureBarcode() {
            const video = document.getElementById('barcodeVideo');
            const canvas = document.getElementById('barcodeCanvas');
            const preview = document.getElementById('barcodePreview');
            const image = document.getElementById('barcodeImage');
            const buttons = document.getElementById('cameraButtons');
            
            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // Get image data
            barcodeImageData = canvas.toDataURL('image/jpeg');
            
            // Show preview
            image.src = barcodeImageData;
            preview.style.display = 'block';
            video.style.display = 'none';
            buttons.style.display = 'none';
            
            // Stop camera
            if (barcodeStream) {
                barcodeStream.getTracks().forEach(track => track.stop());
                barcodeStream = null;
            }
            
            console.log('‚úÖ Barcode captured');
        }
        
        // Handle Barcode Upload
        function handleBarcodeUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('‚ùå Please select an image file');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå Image too large!\n\nPlease select an image under 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                barcodeImageData = e.target.result;
                
                const preview = document.getElementById('barcodePreview');
                const image = document.getElementById('barcodeImage');
                const section = document.getElementById('barcodeUploadSection');
                
                if (image && preview) {
                    image.src = barcodeImageData;
                    preview.style.display = 'block';
                    section.style.display = 'block';
                    
                    // Hide camera if it was showing
                    const video = document.getElementById('barcodeVideo');
                    const buttons = document.getElementById('cameraButtons');
                    if (video) video.style.display = 'none';
                    if (buttons) buttons.style.display = 'none';
                    
                    // Stop camera stream if active
                    if (barcodeStream) {
                        barcodeStream.getTracks().forEach(track => track.stop());
                        barcodeStream = null;
                    }
                    
                    console.log('‚úÖ Barcode image uploaded successfully');
                } else {
                    console.error('Preview elements not found');
                    alert('‚ùå Error displaying image. Please try again.');
                }
            };
            
            reader.onerror = function() {
                alert('‚ùå Error reading file. Please try again.');
            };
            
            reader.readAsDataURL(file);
        }
        
        // Close Barcode Scanner
        function closeBarcodeScanner() {
            const video = document.getElementById('barcodeVideo');
            const section = document.getElementById('barcodeUploadSection');
            const buttons = document.getElementById('cameraButtons');
            
            if (barcodeStream) {
                barcodeStream.getTracks().forEach(track => track.stop());
                barcodeStream = null;
            }
            
            video.style.display = 'none';
            buttons.style.display = 'none';
            section.style.display = 'none';
        }
        
        // Save Product
        async function saveProduct(event) {
            event.preventDefault();
            
            // Get sub-category (either selected or custom)
            let subCategory = document.getElementById('productSubCategory').value;
            if (subCategory === 'custom') {
                subCategory = document.getElementById('customSubCategory').value;
            }
            
            // Get brand (either selected or custom)
            let brand = document.getElementById('productBrand').value;
            if (brand === 'custom') {
                brand = document.getElementById('customBrand').value;
            }
            
            const formData = {
                code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value || '',
                sub_category: subCategory || '',
                brand: brand || '',
                price: parseFloat(document.getElementById('productPrice').value),
                cost: parseFloat(document.getElementById('productCost').value),
                stock: parseInt(document.getElementById('productStock').value),
                min_stock: parseInt(document.getElementById('productMinStock').value),
                unit: document.getElementById('productUnit').value,
                business_type: 'both',
                barcode_image: barcodeImageData // Include barcode image if captured
            };
            
            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Product added successfully!');
                    closeAddProductModal();
                    await loadProducts(); // Reload products list
                } else {
                    alert('‚ùå Error: ' + (result.message || 'Failed to add product'));
                }
            } catch (error) {
                console.error('Error saving product:', error);
                alert('‚ùå Error saving product. Please try again.');
            }
        }
        
        // Edit Product
        function editProduct(id) {
            alert('Edit product: ' + id);
        }
        
        // Delete Product
        function deleteProduct(id) {
            if (confirm('Delete this product?')) {
                alert('Delete product: ' + id);
            }
        }
        
        // ========== CUSTOMERS MODULE ==========
        
        let allCustomers = [];
        let currentCustomerType = 'all';
        
        // Load Customers
        async function loadCustomers() {
            try {
                console.log('üë• Loading customers...');
                allCustomers = await apiCall('/api/customers');
                console.log(`‚úÖ Customers loaded: ${allCustomers.length}`);
                
                // Update stats
                document.getElementById('totalCustomersCount').textContent = allCustomers.length;
                document.getElementById('activeCustomersCount').textContent = allCustomers.filter(c => c.is_active).length;
                
                displayCustomers(allCustomers);
            } catch (error) {
                console.error('Error loading customers:', error);
                document.getElementById('customersList').innerHTML = '<p style="text-align: center; color: #666;">Error loading customers</p>';
            }
        }
        
        // Display Customers
        function displayCustomers(customers) {
            const container = document.getElementById('customersList');
            
            if (customers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No customers found</p>';
                return;
            }
            
            let html = '';
            customers.forEach(customer => {
                const initials = customer.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const typeClass = `type-${customer.customer_type || 'regular'}`;
                const typeName = (customer.customer_type || 'regular').charAt(0).toUpperCase() + (customer.customer_type || 'regular').slice(1);
                
                html += `
                    <div class="customer-card">
                        <div class="customer-avatar">${initials}</div>
                        <div class="customer-info">
                            <div class="customer-name">${customer.name}</div>
                            <div class="customer-details">
                                <span class="customer-phone">üìû ${customer.phone || 'No phone'}</span>
                            </div>
                            <span class="customer-type-badge ${typeClass}">${typeName}</span>
                        </div>
                        <div class="customer-stats">
                            <div class="customer-balance">‚Çπ${(customer.current_balance || 0).toFixed(0)}</div>
                            <div class="customer-purchases">${(customer.total_purchases || 0)} purchases</div>
                            <div class="customer-actions">
                                <button class="action-btn btn-edit" onclick="editCustomer('${customer.id}')">Edit</button>
                                <button class="action-btn btn-delete" onclick="deleteCustomer('${customer.id}')">Del</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Filter Customers by Search
        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            let filtered = allCustomers;
            
            if (currentCustomerType !== 'all') {
                filtered = filtered.filter(c => (c.customer_type || 'regular') === currentCustomerType);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) || 
                    (c.phone && c.phone.toLowerCase().includes(searchTerm)) ||
                    (c.email && c.email.toLowerCase().includes(searchTerm))
                );
            }
            
            displayCustomers(filtered);
        }
        
        // Filter by Customer Type
        function filterCustomersByType(type) {
            currentCustomerType = type;
            
            // Update active tab
            const tabs = document.querySelectorAll('#customersModule .filter-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            filterCustomers();
        }
        
        // Show Add Customer Form
        function showAddCustomerForm() {
            document.getElementById('addCustomerModal').classList.add('show');
            document.getElementById('customerForm').reset();
        }
        
        // Close Add Customer Modal
        function closeAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.remove('show');
        }
        
        // Save Customer
        async function saveCustomer(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                email: document.getElementById('customerEmail').value || null,
                address: document.getElementById('customerAddress').value || null,
                customer_type: document.getElementById('customerType').value,
                credit_limit: parseFloat(document.getElementById('customerCreditLimit').value) || 0
            };
            
            try {
                const response = await fetch('/api/customers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Customer added successfully!');
                    closeAddCustomerModal();
                    await loadCustomers(); // Reload customers list
                } else {
                    alert('‚ùå Error: ' + (result.message || 'Failed to add customer'));
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                alert('‚ùå Error saving customer. Please try again.');
            }
        }
        
        // Edit Customer
        function editCustomer(id) {
            alert('Edit customer: ' + id);
        }
        
        // Delete Customer
        function deleteCustomer(id) {
            if (confirm('Delete this customer?')) {
                alert('Delete customer: ' + id);
            }
        }
        
        // ========== SALES MODULE ==========
        
        let allSales = [];
        let currentDateFilter = 'today';
        
        // Load Sales
        async function loadSales() {
            try {
                console.log('üí∞ Loading sales...');
                const data = await apiCall('/api/sales/summary');
                console.log('‚úÖ Sales summary loaded');
                
                // Update summary cards
                updateSalesSummary(data);
                
                // Load sales list
                console.log('üìã Loading sales list...');
                allSales = await apiCall('/api/sales');
                console.log(`‚úÖ Sales list loaded: ${allSales.length}`);
                
                displaySales(allSales);
            } catch (error) {
                console.error('Error loading sales:', error);
                document.getElementById('salesList').innerHTML = '<p style="text-align: center; color: #666;">Error loading sales</p>';
            }
        }
        
        // Update Sales Summary
        function updateSalesSummary(data) {
            const today = data.today || { total: 0, count: 0 };
            const yesterday = data.yesterday || { total: 0, count: 0 };
            
            // Total Revenue
            document.getElementById('totalRevenue').textContent = '‚Çπ' + (today.total || 0).toFixed(0);
            
            // Revenue Change
            const revenueChange = yesterday.total > 0 ? 
                (((today.total - yesterday.total) / yesterday.total) * 100).toFixed(1) : 0;
            document.getElementById('revenueChange').textContent = 
                (revenueChange >= 0 ? '‚Üë ' : '‚Üì ') + Math.abs(revenueChange) + '%';
            
            // Transactions
            document.getElementById('totalTransactions').textContent = today.count || 0;
            
            // Transaction Change
            const transactionChange = yesterday.count > 0 ? 
                (((today.count - yesterday.count) / yesterday.count) * 100).toFixed(1) : 0;
            document.getElementById('transactionChange').textContent = 
                (transactionChange >= 0 ? '‚Üë ' : '‚Üì ') + Math.abs(transactionChange) + '%';
            
            // Avg Order Value
            const avgValue = today.count > 0 ? (today.total / today.count) : 0;
            document.getElementById('avgOrderValue').textContent = '‚Çπ' + avgValue.toFixed(0);
            
            // Top Product
            if (data.top_products && data.top_products.length > 0) {
                const topProd = data.top_products[0];
                document.getElementById('topProduct').textContent = topProd.product_name || '-';
                document.getElementById('topProductQty').textContent = (topProd.quantity || 0) + ' sold';
            }
        }
        
        // Display Sales
        function displaySales(sales) {
            const container = document.getElementById('salesList');
            
            if (sales.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No sales found</p>';
                return;
            }
            
            let html = '';
            sales.forEach(sale => {
                const saleDate = new Date(sale.created_at);
                const timeStr = saleDate.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                const dateStr = saleDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
                
                const paymentClass = `payment-${(sale.payment_method || 'cash').toLowerCase()}`;
                const paymentMethod = (sale.payment_method || 'Cash').toUpperCase();
                
                html += `
                    <div class="sale-card">
                        <div class="sale-header">
                            <div class="sale-bill-info">
                                <div class="sale-bill-number">üßæ ${sale.bill_number || 'N/A'}</div>
                                <div class="sale-customer">üë§ ${sale.customer_name || 'Walk-in Customer'}</div>
                            </div>
                            <div class="sale-amount">
                                <div class="sale-total">‚Çπ${(sale.total_amount || 0).toFixed(0)}</div>
                                <div class="sale-time">${timeStr}</div>
                            </div>
                        </div>
                        <div class="sale-details">
                            <div class="sale-detail-item">
                                üìÖ ${dateStr}
                            </div>
                            <div class="sale-detail-item">
                                <span class="sale-payment-badge ${paymentClass}">${paymentMethod}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Filter Sales by Search
        function filterSales() {
            const searchTerm = document.getElementById('salesSearch').value.toLowerCase();
            let filtered = allSales;
            
            if (searchTerm) {
                filtered = filtered.filter(s => 
                    (s.bill_number && s.bill_number.toLowerCase().includes(searchTerm)) ||
                    (s.customer_name && s.customer_name.toLowerCase().includes(searchTerm)) ||
                    (s.product_name && s.product_name.toLowerCase().includes(searchTerm))
                );
            }
            
            displaySales(filtered);
        }
        
        // Filter Sales by Date
        async function filterSalesByDate(period) {
            currentDateFilter = period;
            
            // Update active tab
            const tabs = document.querySelectorAll('#salesModule .filter-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Reload sales with filter
            await loadSales();
        }
        
        // Show Add Sale Form
        function showAddSaleForm() {
            alert('üöß Add Sale form coming soon!\n\nFor now, use the Billing module to create new sales.');
        }
        
        // ========== BILLING MODULE ==========
        
        let billItems = [];
        let billProducts = [];
        
        // Load products for billing
        async function loadBillingProducts() {
            try {
                console.log('üì¶ Loading products for billing...');
                billProducts = await apiCall('/api/products');
                
                const select = document.getElementById('billProductSelect');
                select.innerHTML = '<option value="">-- Select Product --</option>';
                
                billProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} - ‚Çπ${product.price}`;
                    option.dataset.price = product.price;
                    option.dataset.name = product.name;
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ Loaded ${billProducts.length} products for billing`);
            } catch (error) {
                console.error('‚ùå Error loading billing products:', error);
            }
        }
        
        // Update price when product selected
        document.addEventListener('DOMContentLoaded', function() {
            const productSelect = document.getElementById('billProductSelect');
            if (productSelect) {
                productSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const price = selectedOption.dataset.price || 0;
                    document.getElementById('billPrice').value = price;
                });
            }
        });
        
        // Add product to bill
        function addToBillMobile() {
            const productSelect = document.getElementById('billProductSelect');
            const quantity = parseInt(document.getElementById('billQuantity').value) || 1;
            const price = parseFloat(document.getElementById('billPrice').value) || 0;
            
            if (!productSelect.value) {
                alert('‚ùå Please select a product!');
                return;
            }
            
            if (quantity <= 0) {
                alert('‚ùå Quantity must be greater than 0!');
                return;
            }
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const productId = productSelect.value;
            const productName = selectedOption.dataset.name;
            const total = price * quantity;
            
            // Add to bill items
            billItems.push({
                id: productId,
                name: productName,
                quantity: quantity,
                price: price,
                total: total
            });
            
            // Update display
            renderBillItems();
            calculateBillTotal();
            
            // Reset form
            productSelect.value = '';
            document.getElementById('billQuantity').value = 1;
            document.getElementById('billPrice').value = '';
            
            console.log('‚úÖ Product added to bill:', productName);
        }
        
        // Render bill items
        function renderBillItems() {
            const container = document.getElementById('billItemsList');
            
            if (billItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üõí</div>
                        <p>No items added yet</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            billItems.forEach((item, index) => {
                html += `
                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #732C3F; margin-bottom: 4px;">${item.name}</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${item.quantity} √ó ‚Çπ${item.price.toFixed(2)} = ‚Çπ${item.total.toFixed(2)}
                                </div>
                            </div>
                            <button onclick="removeBillItem(${index})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Remove item from bill
        function removeBillItem(index) {
            billItems.splice(index, 1);
            renderBillItems();
            calculateBillTotal();
            console.log('üóëÔ∏è Item removed from bill');
        }
        
        // Calculate bill total
        function calculateBillTotal() {
            const subtotal = billItems.reduce((sum, item) => sum + item.total, 0);
            const gst = subtotal * 0.18; // 18% GST
            const total = subtotal + gst;
            
            document.getElementById('billSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('billGST').textContent = gst.toFixed(2);
            document.getElementById('billTotal').textContent = total.toFixed(2);
        }
        
        // Clear bill
        function clearBill() {
            if (billItems.length === 0) {
                return;
            }
            
            if (confirm('Are you sure you want to clear the bill?')) {
                billItems = [];
                renderBillItems();
                calculateBillTotal();
                console.log('üßπ Bill cleared');
            }
        }
        
        // Generate bill
        async function generateBillMobile() {
            if (billItems.length === 0) {
                alert('‚ùå Please add at least one product to the bill!');
                return;
            }
            
            const paymentMethod = document.getElementById('billPaymentMethod').value;
            const subtotal = billItems.reduce((sum, item) => sum + item.total, 0);
            const gst = subtotal * 0.18;
            const total = subtotal + gst;
            
            const billData = {
                business_type: 'retail',
                items: billItems.map(item => ({
                    product_id: item.id,
                    product_name: item.name,
                    quantity: item.quantity,
                    unit_price: item.price,
                    total_price: item.total
                })),
                subtotal: subtotal,
                tax_amount: gst,
                total_amount: total,
                payment_method: paymentMethod
            };
            
            try {
                console.log('üìù Generating bill...', billData);
                
                const response = await fetch('/api/bills', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(billData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Bill Generated Successfully!\n\nBill Number: ${result.bill_number}\nTotal: ‚Çπ${total.toFixed(2)}`);
                    
                    // Clear bill
                    billItems = [];
                    renderBillItems();
                    calculateBillTotal();
                    
                    console.log('‚úÖ Bill generated:', result.bill_number);
                } else {
                    alert('‚ùå Failed to generate bill: ' + result.error);
                    console.error('‚ùå Bill generation failed:', result);
                }
            } catch (error) {
                alert('‚ùå Error generating bill: ' + error.message);
                console.error('‚ùå Error generating bill:', error);
            }
        }
        
        // ========== BARCODE SCANNER MODULE ==========
        
        let barcodeStream = null;
        let barcodeScanner = null;
        let flashlightOn = false;
        
        // Start Barcode Scanner
        async function startBarcodeScanner() {
            try {
                console.log('üì∑ Starting barcode scanner...');
                
                // Check if browser supports camera
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('‚ùå Camera not supported on this device');
                    return;
                }
                
                // Show camera container
                document.getElementById('barcodeCameraContainer').style.display = 'block';
                document.getElementById('barcodeScanBtn').textContent = 'üì∑ Scanning...';
                document.getElementById('barcodeScanBtn').disabled = true;
                
                // Get camera stream
                barcodeStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Use back camera
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                const video = document.getElementById('barcodeVideo');
                video.srcObject = barcodeStream;
                
                // Start barcode detection
                startBarcodeDetection();
                
                console.log('‚úÖ Barcode scanner started');
                
            } catch (error) {
                console.error('‚ùå Error starting barcode scanner:', error);
                alert('‚ùå Could not access camera: ' + error.message);
                stopBarcodeScanner();
            }
        }
        
        // Stop Barcode Scanner
        function stopBarcodeScanner() {
            console.log('üõë Stopping barcode scanner...');
            
            if (barcodeStream) {
                barcodeStream.getTracks().forEach(track => track.stop());
                barcodeStream = null;
            }
            
            if (barcodeScanner) {
                clearInterval(barcodeScanner);
                barcodeScanner = null;
            }
            
            document.getElementById('barcodeCameraContainer').style.display = 'none';
            document.getElementById('barcodeScanBtn').textContent = 'üì± Start Scanning';
            document.getElementById('barcodeScanBtn').disabled = false;
            document.getElementById('scanResult').style.display = 'none';
            
            flashlightOn = false;
            document.getElementById('flashBtn').textContent = 'üî¶ Flash';
            
            console.log('‚úÖ Barcode scanner stopped');
        }
        
        // Start Barcode Detection (Simulated)
        function startBarcodeDetection() {
            // Note: Real barcode detection would require a library like QuaggaJS or ZXing
            // For now, we'll simulate with a manual input option
            
            console.log('üîç Barcode detection started (simulated)');
            
            // Add manual barcode input for testing
            setTimeout(() => {
                const manualInput = prompt('üì∑ Barcode Scanner Active!\n\nFor testing, enter a barcode manually:');
                if (manualInput) {
                    processBarcodeResult(manualInput);
                } else {
                    stopBarcodeScanner();
                }
            }, 2000);
        }
        
        // Process Barcode Result
        async function processBarcodeResult(barcode) {
            try {
                console.log('üìä Processing barcode:', barcode);
                
                // Show scanned barcode
                document.getElementById('scanResult').style.display = 'block';
                document.getElementById('scannedBarcode').textContent = barcode;
                
                // Find product by barcode
                const product = await findProductByBarcode(barcode);
                
                if (product) {
                    // Auto-add product to bill
                    await addProductToBillByBarcode(product);
                    
                    // Show success feedback
                    showBarcodeSuccess(product);
                    
                    // Continue scanning after 2 seconds
                    setTimeout(() => {
                        startBarcodeDetection();
                    }, 2000);
                    
                } else {
                    // Product not found
                    showBarcodeError(barcode);
                    
                    // Continue scanning after 3 seconds
                    setTimeout(() => {
                        startBarcodeDetection();
                    }, 3000);
                }
                
            } catch (error) {
                console.error('‚ùå Error processing barcode:', error);
                alert('‚ùå Error processing barcode: ' + error.message);
                stopBarcodeScanner();
            }
        }
        
        // Find Product by Barcode
        async function findProductByBarcode(barcode) {
            try {
                // Search in loaded products first
                let product = billProducts.find(p => p.code === barcode || p.id.toString() === barcode);
                
                if (!product) {
                    // Try API search
                    const response = await fetch(`/api/products/barcode/${barcode}`);
                    if (response.ok) {
                        product = await response.json();
                    }
                }
                
                return product;
                
            } catch (error) {
                console.error('Error finding product by barcode:', error);
                return null;
            }
        }
        
        // Add Product to Bill by Barcode
        async function addProductToBillByBarcode(product) {
            const quantity = 1; // Default quantity for barcode scan
            const price = parseFloat(product.price) || 0;
            const total = price * quantity;
            
            // Check if product already exists in bill
            const existingItemIndex = billItems.findIndex(item => item.id === product.id);
            
            if (existingItemIndex >= 0) {
                // Increase quantity of existing item
                billItems[existingItemIndex].quantity += quantity;
                billItems[existingItemIndex].total = billItems[existingItemIndex].quantity * billItems[existingItemIndex].price;
            } else {
                // Add new item
                billItems.push({
                    id: product.id,
                    name: product.name,
                    quantity: quantity,
                    price: price,
                    total: total
                });
            }
            
            // Update display
            renderBillItems();
            calculateBillTotal();
            
            console.log('‚úÖ Product added via barcode:', product.name);
        }
        
        // Show Barcode Success
        function showBarcodeSuccess(product) {
            // Create success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                z-index: 1000;
                font-weight: 600;
                text-align: center;
                animation: slideDown 0.3s ease;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 18px; margin-bottom: 5px;">‚úÖ Product Added!</div>
                <div style="font-size: 14px; opacity: 0.9;">${product.name}</div>
                <div style="font-size: 12px; opacity: 0.8;">‚Çπ${product.price}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 2 seconds
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }
        
        // Show Barcode Error
        function showBarcodeError(barcode) {
            // Create error notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
                z-index: 1000;
                font-weight: 600;
                text-align: center;
                animation: slideDown 0.3s ease;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 18px; margin-bottom: 5px;">‚ùå Product Not Found</div>
                <div style="font-size: 14px; opacity: 0.9;">Barcode: ${barcode}</div>
                <div style="font-size: 12px; opacity: 0.8;">Please add product to database first</div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Toggle Flashlight
        async function toggleFlashlight() {
            try {
                if (!barcodeStream) return;
                
                const track = barcodeStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                if (capabilities.torch) {
                    flashlightOn = !flashlightOn;
                    await track.applyConstraints({
                        advanced: [{ torch: flashlightOn }]
                    });
                    
                    document.getElementById('flashBtn').textContent = flashlightOn ? 'üî¶ Flash ON' : 'üî¶ Flash';
                    console.log('üî¶ Flashlight:', flashlightOn ? 'ON' : 'OFF');
                } else {
                    alert('‚ùå Flashlight not supported on this device');
                }
                
            } catch (error) {
                console.error('‚ùå Error toggling flashlight:', error);
            }
        }
        
        // Add CSS animation for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateX(-50%) translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
            }
        `;
        document.head.appendChild(style);
        
        // ========== EARNINGS/PROFIT MODULE ==========
        
        let currentEarningsFilter = 'today';
        
        // Load Earnings
        async function loadEarnings() {
            try {
                console.log('üíé Loading earnings...');
                // Get products with cost/price
                const products = await apiCall('/api/products');
                console.log(`‚úÖ Products loaded: ${products.length}`);
                
                // Get sales data
                const sales = await apiCall('/api/sales');
                console.log(`‚úÖ Sales loaded: ${sales.length}`);
                
                // Calculate earnings
                calculateEarnings(products, sales);
            } catch (error) {
                console.error('Error loading earnings:', error);
            }
        }
        
        // Calculate Earnings
        function calculateEarnings(products, sales) {
            // Create product map for quick lookup
            const productMap = {};
            products.forEach(p => {
                productMap[p.id] = p;
            });
            
            let totalSales = 0;
            let totalCost = 0;
            let totalProfit = 0;
            let transactionCount = 0;
            
            // Product-wise profit tracking
            const productProfits = {};
            
            // Calculate from sales
            sales.forEach(sale => {
                const product = productMap[sale.product_id];
                if (!product) return;
                
                const saleAmount = sale.total_price || (sale.quantity * sale.unit_price);
                const costAmount = (product.cost || 0) * (sale.quantity || 0);
                const profit = saleAmount - costAmount;
                
                totalSales += saleAmount;
                totalCost += costAmount;
                totalProfit += profit;
                transactionCount++;
                
                // Track product-wise
                if (!productProfits[product.id]) {
                    productProfits[product.id] = {
                        name: product.name,
                        totalProfit: 0,
                        totalSales: 0,
                        totalCost: 0,
                        quantity: 0,
                        price: product.price,
                        cost: product.cost
                    };
                }
                
                productProfits[product.id].totalProfit += profit;
                productProfits[product.id].totalSales += saleAmount;
                productProfits[product.id].totalCost += costAmount;
                productProfits[product.id].quantity += (sale.quantity || 0);
            });
            
            // Update main summary
            document.getElementById('totalProfit').textContent = '‚Çπ' + totalProfit.toFixed(0);
            document.getElementById('totalSalesValue').textContent = '‚Çπ' + totalSales.toFixed(0);
            document.getElementById('totalCostValue').textContent = '‚Çπ' + totalCost.toFixed(0);
            
            // Calculate margins
            const profitMargin = totalSales > 0 ? ((totalProfit / totalSales) * 100) : 0;
            document.getElementById('profitMarginPercent').textContent = 'Margin: ' + profitMargin.toFixed(1) + '%';
            document.getElementById('profitMargin').textContent = profitMargin.toFixed(1) + '%';
            
            // Metrics
            document.getElementById('grossProfit').textContent = '‚Çπ' + totalProfit.toFixed(0);
            const avgProfit = transactionCount > 0 ? (totalProfit / transactionCount) : 0;
            document.getElementById('avgProfitPerSale').textContent = '‚Çπ' + avgProfit.toFixed(0);
            document.getElementById('totalTransactionsCount').textContent = transactionCount;
            
            // Display product-wise profits
            displayProductProfits(productProfits);
        }
        
        // Display Product-wise Profits
        function displayProductProfits(productProfits) {
            const container = document.getElementById('productProfitList');
            
            // Convert to array and sort by profit
            const profitArray = Object.values(productProfits).sort((a, b) => b.totalProfit - a.totalProfit);
            
            if (profitArray.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">No data available</p>';
                return;
            }
            
            // Update top/least profitable
            if (profitArray.length > 0) {
                const mostProfitable = profitArray[0];
                document.getElementById('mostProfitableProduct').textContent = mostProfitable.name;
                document.getElementById('mostProfitableAmount').textContent = '‚Çπ' + mostProfitable.totalProfit.toFixed(0) + ' profit';
                
                const leastProfitable = profitArray[profitArray.length - 1];
                document.getElementById('leastProfitableProduct').textContent = leastProfitable.name;
                document.getElementById('leastProfitableAmount').textContent = '‚Çπ' + leastProfitable.totalProfit.toFixed(0) + ' profit';
            }
            
            // Display product cards
            let html = '';
            profitArray.forEach(product => {
                const margin = product.totalSales > 0 ? ((product.totalProfit / product.totalSales) * 100) : 0;
                const marginClass = margin >= 30 ? 'margin-high' : (margin >= 15 ? 'margin-medium' : 'margin-low');
                const marginLabel = margin >= 30 ? 'High' : (margin >= 15 ? 'Medium' : 'Low');
                
                html += `
                    <div class="product-profit-card">
                        <div class="product-profit-header">
                            <div class="product-profit-name">
                                ${product.name}
                                <span class="profit-margin-badge ${marginClass}">${margin.toFixed(1)}%</span>
                            </div>
                            <div class="product-profit-amount">‚Çπ${product.totalProfit.toFixed(0)}</div>
                        </div>
                        <div class="product-profit-details">
                            <div class="product-profit-detail">
                                <span class="product-profit-detail-label">Sold</span>
                                <span class="product-profit-detail-value">${product.quantity}</span>
                            </div>
                            <div class="product-profit-detail">
                                <span class="product-profit-detail-label">Revenue</span>
                                <span class="product-profit-detail-value">‚Çπ${product.totalSales.toFixed(0)}</span>
                            </div>
                            <div class="product-profit-detail">
                                <span class="product-profit-detail-label">Cost</span>
                                <span class="product-profit-detail-value">‚Çπ${product.totalCost.toFixed(0)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Display profit trend
            displayProfitTrend(profitArray);
        }
        
        // Display Profit Trend
        function displayProfitTrend(profitArray) {
            const container = document.getElementById('profitTrend');
            
            if (profitArray.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">No data available</p>';
                return;
            }
            
            // Show top 5 products as bars
            const top5 = profitArray.slice(0, 5);
            const maxProfit = Math.max(...top5.map(p => p.totalProfit));
            
            let html = '';
            top5.forEach(product => {
                const percentage = maxProfit > 0 ? (product.totalProfit / maxProfit) * 100 : 0;
                const barColor = percentage >= 80 ? '#4CAF50' : (percentage >= 50 ? '#FF9800' : '#2196F3');
                
                html += `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
                            <span style="color: #666;">${product.name}</span>
                            <span style="color: ${barColor}; font-weight: 600;">‚Çπ${product.totalProfit.toFixed(0)}</span>
                        </div>
                        <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: ${barColor}; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Filter Earnings by Date
        async function filterEarningsByDate(period) {
            currentEarningsFilter = period;
            
            // Update active tab
            const tabs = document.querySelectorAll('#earningsModule .filter-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Reload earnings
            await loadEarnings();
        }
        
        // Refresh Earnings
        async function refreshEarnings() {
            await loadEarnings();
            alert('‚úÖ Earnings data refreshed!');
        }
        
        // Scroll to top
        function scrollToTop() {
            console.log('üè† Home button clicked - showing dashboard');
            
            // Hide all modules
            document.getElementById('productsModule').style.display = 'none';
            document.getElementById('customersModule').style.display = 'none';
            document.getElementById('salesModule').style.display = 'none';
            document.getElementById('earningsModule').style.display = 'none';
            document.getElementById('dataDisplay').style.display = 'none';
            document.getElementById('billingModule').style.display = 'none';
            document.getElementById('settingsModule').style.display = 'none';
            
            // First hide ALL cards including advanced modules
            document.querySelectorAll('.card').forEach(card => {
                card.style.display = 'none';
            });
            
            // Hide all advanced modules specifically
            const advancedModules = ['clientManagementModule', 'userManagementModule', 'staffManagementModule', 'whatsappReportsModule', 'developerToolsModule'];
            advancedModules.forEach(moduleId => {
                const element = document.getElementById(moduleId);
                if (element) element.style.display = 'none';
            });
            
            // Show only the main dashboard cards
            document.querySelectorAll('.card').forEach(card => {
                // Show welcome card, overview card, and quick actions card ONLY
                if (card.classList.contains('welcome-card') || 
                    (card.querySelector('h2') && (
                        card.querySelector('h2').textContent.includes('Overview') ||
                        card.querySelector('h2').textContent.includes('Quick Actions')
                    ))) {
                    card.style.display = 'block';
                }
            });
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            console.log('‚úÖ Dashboard shown via Home button');
        }
        
        // ========== SETTINGS MODULE ==========
        
        // Load Settings
        function loadSettings() {
            console.log('‚öôÔ∏è Loading settings...');
            
            // Load from localStorage
            const settings = JSON.parse(localStorage.getItem('bizpulse_settings') || '{}');
            
            // Business Information
            if (settings.businessName) document.getElementById('businessName').value = settings.businessName;
            if (settings.businessPhone) document.getElementById('businessPhone').value = settings.businessPhone;
            if (settings.businessEmail) document.getElementById('businessEmail').value = settings.businessEmail;
            
            // GST Settings
            if (settings.gstNumber) document.getElementById('gstNumber').value = settings.gstNumber;
            if (settings.defaultGST) document.getElementById('defaultGST').value = settings.defaultGST;
            
            // Invoice Settings
            if (settings.invoicePrefix) document.getElementById('invoicePrefix').value = settings.invoicePrefix;
            if (settings.invoiceStartNumber) document.getElementById('invoiceStartNumber').value = settings.invoiceStartNumber;
            
            // App Settings
            if (settings.appLanguage) document.getElementById('appLanguage').value = settings.appLanguage;
            if (settings.appCurrency) document.getElementById('appCurrency').value = settings.appCurrency;
            if (settings.dateFormat) document.getElementById('dateFormat').value = settings.dateFormat;
            if (settings.timeFormat) document.getElementById('timeFormat').value = settings.timeFormat;
            
            console.log('‚úÖ Settings loaded:', settings);
        }
        
        // Save Settings
        function saveSettings() {
            const settings = {
                businessName: document.getElementById('businessName').value,
                businessPhone: document.getElementById('businessPhone').value,
                businessEmail: document.getElementById('businessEmail').value,
                gstNumber: document.getElementById('gstNumber').value,
                defaultGST: document.getElementById('defaultGST').value,
                invoicePrefix: document.getElementById('invoicePrefix').value,
                invoiceStartNumber: document.getElementById('invoiceStartNumber').value,
                appLanguage: document.getElementById('appLanguage').value,
                appCurrency: document.getElementById('appCurrency').value,
                dateFormat: document.getElementById('dateFormat').value,
                timeFormat: document.getElementById('timeFormat').value,
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('bizpulse_settings', JSON.stringify(settings));
            
            alert('‚úÖ Settings saved successfully!');
            console.log('üíæ Settings saved:', settings);
        }
        
        // Backup Data - Export all data as JSON file
        function backupData() {
            try {
                console.log('üì• Starting backup...');
                
                // Collect all data from localStorage
                const backupData = {
                    settings: JSON.parse(localStorage.getItem('bizpulse_settings') || '{}'),
                    products: JSON.parse(localStorage.getItem('bizpulse_products') || '[]'),
                    customers: JSON.parse(localStorage.getItem('bizpulse_customers') || '[]'),
                    sales: JSON.parse(localStorage.getItem('bizpulse_sales') || '[]'),
                    bills: JSON.parse(localStorage.getItem('bizpulse_bills') || '[]'),
                    backupDate: new Date().toISOString(),
                    version: '1.0.0'
                };
                
                // Convert to JSON string
                const jsonString = JSON.stringify(backupData, null, 2);
                
                // Create blob and download
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bizpulse_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Backup downloaded successfully!\n\nFile: ' + a.download);
                console.log('‚úÖ Backup completed:', backupData);
            } catch (error) {
                console.error('‚ùå Backup failed:', error);
                alert('‚ùå Backup failed: ' + error.message);
            }
        }
        
        // Restore Data - Import data from JSON file
        function restoreData() {
            try {
                console.log('üì§ Starting restore...');
                
                // Create file input
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = async (e) => {
                    try {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        // Read file
                        const text = await file.text();
                        const backupData = JSON.parse(text);
                        
                        // Validate backup data
                        if (!backupData.version || !backupData.backupDate) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        // Confirm restore
                        const confirm = window.confirm(
                            '‚ö†Ô∏è WARNING: This will replace all current data!\n\n' +
                            'Backup Date: ' + new Date(backupData.backupDate).toLocaleString() + '\n' +
                            'Version: ' + backupData.version + '\n\n' +
                            'Do you want to continue?'
                        );
                        
                        if (!confirm) return;
                        
                        // Restore data to localStorage
                        if (backupData.settings) {
                            localStorage.setItem('bizpulse_settings', JSON.stringify(backupData.settings));
                        }
                        if (backupData.products) {
                            localStorage.setItem('bizpulse_products', JSON.stringify(backupData.products));
                        }
                        if (backupData.customers) {
                            localStorage.setItem('bizpulse_customers', JSON.stringify(backupData.customers));
                        }
                        if (backupData.sales) {
                            localStorage.setItem('bizpulse_sales', JSON.stringify(backupData.sales));
                        }
                        if (backupData.bills) {
                            localStorage.setItem('bizpulse_bills', JSON.stringify(backupData.bills));
                        }
                        
                        alert('‚úÖ Data restored successfully!\n\nPlease refresh the page to see changes.');
                        console.log('‚úÖ Restore completed:', backupData);
                        
                        // Reload page after 2 seconds
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                        
                    } catch (error) {
                        console.error('‚ùå Restore failed:', error);
                        alert('‚ùå Restore failed: ' + error.message);
                    }
                };
                
                input.click();
                
            } catch (error) {
                console.error('‚ùå Restore failed:', error);
                alert('‚ùå Restore failed: ' + error.message);
            }
        }
        
        // Change Password
        function changePassword() {
            try {
                console.log('üîë Change password initiated...');
                
                // Get current password from localStorage
                const currentUser = JSON.parse(localStorage.getItem('bizpulse_user') || '{"password":"demo123"}');
                
                // Prompt for current password
                const currentPassword = prompt('üîí Enter current password:');
                if (!currentPassword) return;
                
                if (currentPassword !== currentUser.password) {
                    alert('‚ùå Current password is incorrect!');
                    return;
                }
                
                // Prompt for new password
                const newPassword = prompt('üîë Enter new password:\n(Minimum 6 characters)');
                if (!newPassword) return;
                
                if (newPassword.length < 6) {
                    alert('‚ùå Password must be at least 6 characters long!');
                    return;
                }
                
                // Confirm new password
                const confirmPassword = prompt('üîë Confirm new password:');
                if (!confirmPassword) return;
                
                if (newPassword !== confirmPassword) {
                    alert('‚ùå Passwords do not match!');
                    return;
                }
                
                // Save new password
                currentUser.password = newPassword;
                currentUser.passwordChangedAt = new Date().toISOString();
                localStorage.setItem('bizpulse_user', JSON.stringify(currentUser));
                
                alert('‚úÖ Password changed successfully!\n\nPlease remember your new password.');
                console.log('‚úÖ Password changed at:', currentUser.passwordChangedAt);
                
            } catch (error) {
                console.error('‚ùå Change password failed:', error);
                alert('‚ùå Change password failed: ' + error.message);
            }
        }
        
        // Clear Cache - Remove temporary data
        function clearCache() {
            try {
                console.log('üóëÔ∏è Clearing cache...');
                
                const confirm = window.confirm(
                    'üóëÔ∏è Clear Cache?\n\n' +
                    'This will remove:\n' +
                    '‚Ä¢ Temporary files\n' +
                    '‚Ä¢ Cached images\n' +
                    '‚Ä¢ Session data\n\n' +
                    'Your settings and data will be preserved.\n\n' +
                    'Continue?'
                );
                
                if (!confirm) return;
                
                // Clear specific cache items (not settings/data)
                const keysToKeep = [
                    'bizpulse_settings',
                    'bizpulse_products',
                    'bizpulse_customers',
                    'bizpulse_sales',
                    'bizpulse_bills',
                    'bizpulse_user',
                    'bizpulse_login'
                ];
                
                // Get all keys
                const allKeys = Object.keys(localStorage);
                
                // Remove keys that are not in keysToKeep
                let removedCount = 0;
                allKeys.forEach(key => {
                    if (!keysToKeep.includes(key)) {
                        localStorage.removeItem(key);
                        removedCount++;
                    }
                });
                
                // Clear session storage
                sessionStorage.clear();
                
                alert(`‚úÖ Cache cleared successfully!\n\n${removedCount} temporary items removed.`);
                console.log(`‚úÖ Cache cleared: ${removedCount} items removed`);
                
            } catch (error) {
                console.error('‚ùå Clear cache failed:', error);
                alert('‚ùå Clear cache failed: ' + error.message);
            }
        }
        
        // Reset App - Remove all data and settings
        function resetApp() {
            try {
                console.log('‚ö†Ô∏è Reset app initiated...');
                
                const confirm1 = window.confirm(
                    '‚ö†Ô∏è RESET APP?\n\n' +
                    'This will DELETE ALL DATA:\n' +
                    '‚Ä¢ All settings\n' +
                    '‚Ä¢ All products\n' +
                    '‚Ä¢ All customers\n' +
                    '‚Ä¢ All sales records\n' +
                    '‚Ä¢ All bills\n\n' +
                    '‚ö†Ô∏è THIS CANNOT BE UNDONE!\n\n' +
                    'Are you sure?'
                );
                
                if (!confirm1) return;
                
                // Second confirmation
                const confirm2 = window.confirm(
                    '‚ö†Ô∏è FINAL WARNING!\n\n' +
                    'This is your last chance to cancel.\n\n' +
                    'All data will be permanently deleted.\n\n' +
                    'Type YES in the next prompt to confirm.'
                );
                
                if (!confirm2) return;
                
                // Final confirmation with text input
                const finalConfirm = prompt('‚ö†Ô∏è Type "YES" to confirm reset:');
                
                if (finalConfirm !== 'YES') {
                    alert('‚ùå Reset cancelled. Data is safe.');
                    return;
                }
                
                // Clear all localStorage
                localStorage.clear();
                
                // Clear all sessionStorage
                sessionStorage.clear();
                
                alert('‚úÖ App reset successfully!\n\nThe page will reload now.');
                console.log('‚úÖ App reset completed');
                
                // Reload page after 1 second
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Reset app failed:', error);
                alert('‚ùå Reset app failed: ' + error.message);
            }
        }
        
        // ========== INVOICES MODULE ==========
        
        // Load Invoices - Use existing bills API
        // Invoice Module Variables
        let allInvoices = [];
        let currentInvoiceFilter = 'all';
        
        async function loadInvoices() {
            try {
                console.log('üßæ Loading invoices...');
                
                // Use existing bills API as invoices
                const invoices = await apiCall('/api/invoices');
                allInvoices = invoices;
                
                console.log(`‚úÖ Invoices loaded: ${invoices.length}`);
                
                // Show professional invoice frontend
                document.getElementById('dataDisplay').style.display = 'block';
                document.getElementById('dataTitle').textContent = 'Invoices';
                document.getElementById('dataContent').innerHTML = createInvoiceInterface();
                
                // Update stats and display invoices
                updateInvoiceStats();
                displayInvoices(allInvoices);
                
            } catch (error) {
                console.error('‚ùå Error loading invoices:', error);
                document.getElementById('dataDisplay').style.display = 'block';
                document.getElementById('dataTitle').textContent = 'Invoices';
                document.getElementById('dataContent').innerHTML = '<p style="text-align: center; color: red;">Failed to load invoices. Check connection.</p>';
            }
        }
        
        // Create Professional Invoice Interface
        function createInvoiceInterface() {
            return `
                <!-- Invoice Stats -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(52, 152, 243, 0.3);">
                        <div style="font-size: 24px; font-weight: bold;" id="totalInvoicesCount">0</div>
                        <div style="font-size: 12px; opacity: 0.9;">Total Invoices</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);">
                        <div style="font-size: 24px; font-weight: bold;" id="totalInvoiceAmount">‚Çπ0</div>
                        <div style="font-size: 12px; opacity: 0.9;">Total Amount</div>
                    </div>
                </div>
                
                <!-- Quick Filters -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px;">
                    <button class="filter-tab active" onclick="filterInvoices('all')" id="filterAll">All</button>
                    <button class="filter-tab" onclick="filterInvoices('paid')" id="filterPaid">Paid</button>
                    <button class="filter-tab" onclick="filterInvoices('pending')" id="filterPending">Pending</button>
                    <button class="filter-tab" onclick="filterInvoices('overdue')" id="filterOverdue">Overdue</button>
                    <button class="filter-tab" onclick="filterInvoices('today')" id="filterToday">Today</button>
                </div>
                
                <!-- Search Bar -->
                <div style="margin-bottom: 15px;">
                    <input type="text" id="invoiceSearch" placeholder="üîç Search invoices..." style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;" onkeyup="searchInvoices()">
                </div>
                
                <!-- Invoices List -->
                <div id="invoicesList">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üßæ</div>
                        <h3>Loading Invoices...</h3>
                        <p>Please wait while we fetch invoice data</p>
                    </div>
                </div>
            `;
        }
        
        // Update Invoice Stats
        function updateInvoiceStats() {
            const totalCount = allInvoices.length;
            const totalAmount = allInvoices.reduce((sum, invoice) => sum + (invoice.total_amount || 0), 0);
            
            document.getElementById('totalInvoicesCount').textContent = totalCount;
            document.getElementById('totalInvoiceAmount').textContent = '‚Çπ' + totalAmount.toFixed(0);
        }
        
        // Display Invoices
        function displayInvoices(invoices) {
            const container = document.getElementById('invoicesList');
            
            if (invoices.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No invoices found</p>';
                return;
            }
            
            let html = '';
            invoices.forEach(invoice => {
                const statusClass = invoice.status === 'paid' ? 'payment-cash' : 
                                  invoice.status === 'pending' ? 'payment-upi' : 'payment-card';
                const statusText = invoice.status ? invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1) : 'Pending';
                const isOverdue = invoice.status === 'overdue';
                const invoiceDate = invoice.created_at ? new Date(invoice.created_at).toLocaleDateString() : 'N/A';
                
                html += `
                    <div class="sale-card" onclick="viewInvoiceDetails('${invoice.id}')" style="${isOverdue ? 'border-left-color: #dc3545;' : ''}">
                        <div class="sale-header">
                            <div class="sale-bill-info">
                                <div class="sale-bill-number">INV-${invoice.id}</div>
                                <div class="sale-customer">
                                    üë§ ${invoice.customer_name || 'Walk-in Customer'}
                                    <span class="sale-payment-badge ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                            <div class="sale-amount">
                                <div class="sale-total">‚Çπ${(invoice.total_amount || 0).toFixed(2)}</div>
                                <div class="sale-time">${invoiceDate}</div>
                            </div>
                        </div>
                        <div class="sale-details">
                            <div class="sale-detail-item">
                                üí≥ ${invoice.payment_method || 'Cash'}
                            </div>
                            <div class="sale-detail-item">
                                üì± ${invoice.customer_phone || 'N/A'}
                            </div>
                            <div class="sale-detail-item">
                                üïê ${new Date(invoice.created_at).toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Filter Invoices
        function filterInvoices(filter) {
            currentInvoiceFilter = filter;
            
            // Update active filter button
            document.querySelectorAll('.filter-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('active');
            
            let filtered = allInvoices;
            
            if (filter === 'paid') {
                filtered = allInvoices.filter(invoice => invoice.status === 'paid');
            } else if (filter === 'pending') {
                filtered = allInvoices.filter(invoice => invoice.status === 'pending' || !invoice.status);
            } else if (filter === 'overdue') {
                filtered = allInvoices.filter(invoice => invoice.status === 'overdue');
            } else if (filter === 'today') {
                const today = new Date().toISOString().split('T')[0];
                filtered = allInvoices.filter(invoice => {
                    const invoiceDate = invoice.created_at ? invoice.created_at.split('T')[0] : '';
                    return invoiceDate === today;
                });
            }
            
            displayInvoices(filtered);
        }
        
        // Search Invoices
        function searchInvoices() {
            const searchTerm = document.getElementById('invoiceSearch').value.toLowerCase();
            let filtered = allInvoices;
            
            if (currentInvoiceFilter !== 'all') {
                // Apply current filter first
                if (currentInvoiceFilter === 'paid') {
                    filtered = filtered.filter(invoice => invoice.status === 'paid');
                } else if (currentInvoiceFilter === 'pending') {
                    filtered = filtered.filter(invoice => invoice.status === 'pending' || !invoice.status);
                } else if (currentInvoiceFilter === 'overdue') {
                    filtered = filtered.filter(invoice => invoice.status === 'overdue');
                } else if (currentInvoiceFilter === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    filtered = filtered.filter(invoice => {
                        const invoiceDate = invoice.created_at ? invoice.created_at.split('T')[0] : '';
                        return invoiceDate === today;
                    });
                }
            }
            
            if (searchTerm) {
                filtered = filtered.filter(invoice => 
                    invoice.id.toString().includes(searchTerm) ||
                    (invoice.customer_name && invoice.customer_name.toLowerCase().includes(searchTerm)) ||
                    (invoice.customer_phone && invoice.customer_phone.includes(searchTerm))
                );
            }
            
            displayInvoices(filtered);
        }
        
        // View Invoice Details
        async function viewInvoiceDetails(invoiceId) {
            try {
                console.log('üìÑ Loading invoice details for:', invoiceId);
                
                // Get detailed invoice information
                const response = await fetch(`/api/invoices/${invoiceId}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load invoice details');
                }
                
                const invoice = data.invoice;
                const items = data.items || [];
                const payments = data.payments || [];
                
                const statusClass = invoice.status === 'paid' ? 'payment-cash' : 
                                  invoice.status === 'pending' ? 'payment-upi' : 'payment-card';
                
                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <div class="modal-title">üßæ Invoice Details</div>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h3 style="color: #732C3F; margin-bottom: 5px;">INV-${invoice.id}</h3>
                            <span class="sale-payment-badge ${statusClass}">${(invoice.status || 'pending').toUpperCase()}</span>
                        </div>
                        
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #732C3F;">üë§ Customer Details</h4>
                            <div><strong>Name:</strong> ${invoice.customer_name || 'Walk-in Customer'}</div>
                            <div><strong>Phone:</strong> ${invoice.customer_phone || 'N/A'}</div>
                            <div><strong>Address:</strong> ${invoice.customer_address || 'N/A'}</div>
                        </div>
                        
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #732C3F;">üìÖ Invoice Details</h4>
                            <div><strong>Date:</strong> ${new Date(invoice.created_at).toLocaleDateString()}</div>
                            <div><strong>Time:</strong> ${new Date(invoice.created_at).toLocaleTimeString()}</div>
                            <div><strong>Payment:</strong> ${invoice.payment_method || 'Cash'}</div>
                            <div><strong>Amount:</strong> ‚Çπ${(invoice.total_amount || 0).toFixed(2)}</div>
                        </div>
                        
                        ${items.length > 0 ? `
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #732C3F;">üì¶ Items</h4>
                            ${items.map(item => `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ddd;">
                                    <div>
                                        <div style="font-weight: 600;">${item.product_name || 'Item'}</div>
                                        <div style="font-size: 12px; color: #666;">${item.quantity} √ó ‚Çπ${item.price}</div>
                                    </div>
                                    <div style="font-weight: 600;">‚Çπ${(item.total_price || 0).toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        ${invoice.notes ? `
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #732C3F;">üìù Notes</h4>
                            <p style="margin: 0;">${invoice.notes}</p>
                        </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="downloadInvoice('${invoice.id}')" style="background: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px;">
                                üìÑ Download PDF
                            </button>
                            <button onclick="shareInvoice('${invoice.id}')" style="background: #17a2b8; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px;">
                                üì± Share
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('‚ùå Error loading invoice details:', error);
                alert('‚ùå Error loading invoice details: ' + error.message);
            }
        }
        
        // Download Invoice
        function downloadInvoice(invoiceId) {
            alert('üìÑ PDF download feature coming soon!');
        }
        
        // Share Invoice
        function shareInvoice(invoiceId) {
            if (navigator.share) {
                navigator.share({
                    title: `Invoice INV-${invoiceId}`,
                    text: `Invoice INV-${invoiceId} from BizPulse ERP`,
                    url: window.location.href
                });
            } else {
                alert('üì± Share feature coming soon!');
            }
        }
        
        // ========== MOBILE BILLING MODULE ==========
        
        // Billing Variables
        let mobileBillItems = [];
        let selectedMobileCustomer = null;
        let selectedMobilePaymentMethod = 'cash';
        let mobileBillingProducts = [];
        
        // Load Billing Module
        async function loadBillingModule() {
            console.log('üßæ Loading Mobile Billing Module...');
            
            const billingModule = document.getElementById('billingModule');
            billingModule.innerHTML = `
                <h2>üßæ Mobile Billing</h2>
                
                <!-- Customer Selection -->
                <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <h3 style="margin: 0 0 12px 0; color: #732C3F; font-size: 16px;">üë§ Customer</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="mobileCustomerSelect" style="flex: 1; padding: 12px; border: 2px solid #E8D5DA; border-radius: 8px; font-size: 14px;">
                            <option value="">Select Customer</option>
                        </select>
                        <button onclick="showMobileAddCustomerModal()" style="background: #4CAF50; color: white; border: none; padding: 12px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; white-space: nowrap;">+ Add</button>
                    </div>
                </div>
                
                <!-- Product Search & Add -->
                <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <h3 style="margin: 0 0 12px 0; color: #732C3F; font-size: 16px;">üì¶ Add Products</h3>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <input type="text" id="mobileProductSearch" placeholder="Search products..." style="flex: 1; padding: 12px; border: 2px solid #E8D5DA; border-radius: 8px; font-size: 14px;">
                        <button onclick="openMobileBarcodeScanner()" style="background: #2196F3; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 18px; width: 48px; height: 48px;">üì∑</button>
                    </div>
                    <div id="mobileProductSuggestions" style="background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; display: none;"></div>
                </div>
                
                <!-- Bill Items -->
                <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <h3 style="margin: 0 0 12px 0; color: #732C3F; font-size: 16px;">üßæ Bill Items</h3>
                    <div id="mobileBillItems" style="min-height: 120px;">
                        <div style="text-align: center; padding: 30px 20px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üõí</div>
                            <p>No items added yet</p>
                            <small>Search and add products above</small>
                        </div>
                    </div>
                </div>
                
                <!-- Bill Summary -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #732C3F;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 16px;">
                        <span>Subtotal:</span>
                        <span id="mobileSubtotal">‚Çπ0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 16px;">
                        <span>Tax (18%):</span>
                        <span id="mobileTaxAmount">‚Çπ0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0 8px 0; font-size: 20px; font-weight: bold; color: #732C3F; border-top: 2px solid #E8D5DA; margin-top: 10px;">
                        <span>Total:</span>
                        <span id="mobileTotalAmount">‚Çπ0.00</span>
                    </div>
                </div>
                
                <!-- Payment & Actions -->
                <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="mobile-payment-btn active" data-method="cash" style="flex: 1; padding: 12px 8px; border: 2px solid #732C3F; background: #732C3F; color: white; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">üíµ Cash</button>
                        <button class="mobile-payment-btn" data-method="card" style="flex: 1; padding: 12px 8px; border: 2px solid #E8D5DA; background: white; color: #666; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">üí≥ Card</button>
                        <button class="mobile-payment-btn" data-method="upi" style="flex: 1; padding: 12px 8px; border: 2px solid #E8D5DA; background: white; color: #666; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">üì± UPI</button>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="clearMobileBill()" style="flex: 1; padding: 16px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: #f5f5f5; color: #666;">üóëÔ∏è Clear</button>
                        <button onclick="processMobileBill()" style="flex: 1; padding: 16px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%); color: white; box-shadow: 0 4px 15px rgba(115, 44, 63, 0.3);">üí∞ Process Bill</button>
                    </div>
                </div>
                
                <!-- Add Customer Modal -->
                <div id="mobileAddCustomerModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px;">
                    <div style="background: white; border-radius: 15px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 2px solid #E8D5DA;">
                            <h3 style="font-size: 20px; font-weight: bold; color: #732C3F; margin: 0;">Add New Customer</h3>
                            <button onclick="closeMobileAddCustomerModal()" style="background: none; border: none; font-size: 28px; color: #666; cursor: pointer; padding: 0; width: 30px; height: 30px;">√ó</button>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 18px;">
                                <label style="display: block; font-size: 14px; font-weight: 600; color: #732C3F; margin-bottom: 8px;">Customer Name *</label>
                                <input type="text" id="mobileNewCustomerName" placeholder="Enter customer name" style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 18px;">
                                <label style="display: block; font-size: 14px; font-weight: 600; color: #732C3F; margin-bottom: 8px;">Phone Number</label>
                                <input type="tel" id="mobileNewCustomerPhone" placeholder="Enter phone number" style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 18px;">
                                <label style="display: block; font-size: 14px; font-weight: 600; color: #732C3F; margin-bottom: 8px;">Email</label>
                                <input type="email" id="mobileNewCustomerEmail" placeholder="Enter email" style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;">
                            </div>
                            <button onclick="addMobileNewCustomer()" style="width: 100%; background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%); color: white; border: none; padding: 14px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">Add Customer</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize billing data
            await initializeMobileBilling();
        }
        
        // Initialize Mobile Billing
        async function initializeMobileBilling() {
            try {
                // Load customers
                await loadMobileCustomersForBilling();
                
                // Load products for search
                await loadMobileProductsForBilling();
                
                // Setup event listeners
                setupMobileBillingEventListeners();
                
                console.log('‚úÖ Mobile billing module initialized');
            } catch (error) {
                console.error('‚ùå Mobile billing initialization failed:', error);
                alert('Failed to initialize billing module');
            }
        }
        
        // Load Customers for Mobile Billing
        async function loadMobileCustomersForBilling() {
            try {
                const customers = await apiCall('/api/customers');
                const customerSelect = document.getElementById('mobileCustomerSelect');
                
                customerSelect.innerHTML = '<option value="">Select Customer</option>';
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.name} - ${customer.phone || 'No phone'}`;
                    customerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load customers:', error);
            }
        }
        
        // Load Products for Mobile Billing
        async function loadMobileProductsForBilling() {
            try {
                const products = await apiCall('/api/products');
                mobileBillingProducts = products;
            } catch (error) {
                console.error('Failed to load products:', error);
            }
        }
        
        // Setup Mobile Billing Event Listeners
        function setupMobileBillingEventListeners() {
            // Product search
            const productSearch = document.getElementById('mobileProductSearch');
            productSearch.addEventListener('input', handleMobileProductSearch);
            
            // Customer selection
            const customerSelect = document.getElementById('mobileCustomerSelect');
            customerSelect.addEventListener('change', (e) => {
                selectedMobileCustomer = e.target.value;
            });
            
            // Payment method selection
            document.querySelectorAll('.mobile-payment-btn').forEach(btn => {
                btn.addEventListener('click', handleMobilePaymentMethodSelection);
            });
        }
        
        // Handle Mobile Product Search
        function handleMobileProductSearch(event) {
            const query = event.target.value.toLowerCase();
            const suggestions = document.getElementById('mobileProductSuggestions');
            
            if (query.length < 2) {
                suggestions.style.display = 'none';
                suggestions.innerHTML = '';
                return;
            }
            
            const filteredProducts = mobileBillingProducts.filter(product => 
                product.name.toLowerCase().includes(query) || 
                product.code.toLowerCase().includes(query)
            );
            
            if (filteredProducts.length > 0) {
                suggestions.innerHTML = filteredProducts.slice(0, 5).map(product => `
                    <div onclick="addMobileProductToBill('${product.id}')" style="padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #732C3F; margin-bottom: 4px;">${product.name}</div>
                            <div style="font-size: 12px; color: #666;">Code: ${product.code} | Stock: ${product.stock}</div>
                        </div>
                        <div style="font-weight: bold; color: #4CAF50; font-size: 16px;">‚Çπ${product.price}</div>
                    </div>
                `).join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }
        
        // Add Mobile Product to Bill
        function addMobileProductToBill(productId) {
            const product = mobileBillingProducts.find(p => p.id === productId);
            if (!product) return;
            
            // Check if product already in bill
            const existingItem = mobileBillItems.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity += 1;
                existingItem.total = existingItem.quantity * existingItem.price;
            } else {
                mobileBillItems.push({
                    productId: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    total: product.price
                });
            }
            
            updateMobileBillDisplay();
            document.getElementById('mobileProductSearch').value = '';
            document.getElementById('mobileProductSuggestions').style.display = 'none';
        }
        
        // Update Mobile Bill Display
        function updateMobileBillDisplay() {
            const billItemsContainer = document.getElementById('mobileBillItems');
            
            if (mobileBillItems.length === 0) {
                billItemsContainer.innerHTML = `
                    <div style="text-align: center; padding: 30px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üõí</div>
                        <p>No items added yet</p>
                        <small>Search and add products above</small>
                    </div>
                `;
                updateMobileBillSummary();
                return;
            }
            
            billItemsContainer.innerHTML = mobileBillItems.map((item, index) => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #f0f0f0;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; color: #732C3F; margin-bottom: 4px; font-size: 14px;">${item.name}</div>
                        <div style="font-size: 12px; color: #666;">‚Çπ${item.price} each</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; background: #F7E8EC; border-radius: 8px; padding: 4px;">
                        <button onclick="updateMobileQuantity(${index}, -1)" style="width: 32px; height: 32px; border: none; background: #732C3F; color: white; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">-</button>
                        <span style="min-width: 30px; text-align: center; font-weight: 600; color: #732C3F;">${item.quantity}</span>
                        <button onclick="updateMobileQuantity(${index}, 1)" style="width: 32px; height: 32px; border: none; background: #732C3F; color: white; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">+</button>
                    </div>
                    <div style="font-weight: bold; color: #4CAF50; font-size: 16px; min-width: 70px; text-align: right;">‚Çπ${item.total.toFixed(2)}</div>
                    <button onclick="removeMobileItem(${index})" style="width: 32px; height: 32px; border: none; background: #f44336; color: white; border-radius: 50%; font-size: 18px; cursor: pointer;">√ó</button>
                </div>
            `).join('');
            
            updateMobileBillSummary();
        }
        
        // Update Mobile Quantity
        function updateMobileQuantity(index, change) {
            mobileBillItems[index].quantity += change;
            if (mobileBillItems[index].quantity <= 0) {
                mobileBillItems.splice(index, 1);
            } else {
                mobileBillItems[index].total = mobileBillItems[index].quantity * mobileBillItems[index].price;
            }
            updateMobileBillDisplay();
        }
        
        // Remove Mobile Item
        function removeMobileItem(index) {
            mobileBillItems.splice(index, 1);
            updateMobileBillDisplay();
        }
        
        // Update Mobile Bill Summary
        function updateMobileBillSummary() {
            const subtotal = mobileBillItems.reduce((sum, item) => sum + item.total, 0);
            const taxAmount = subtotal * 0.18;
            const total = subtotal + taxAmount;
            
            document.getElementById('mobileSubtotal').textContent = `‚Çπ${subtotal.toFixed(2)}`;
            document.getElementById('mobileTaxAmount').textContent = `‚Çπ${taxAmount.toFixed(2)}`;
            document.getElementById('mobileTotalAmount').textContent = `‚Çπ${total.toFixed(2)}`;
        }
        
        // Handle Mobile Payment Method Selection
        function handleMobilePaymentMethodSelection(event) {
            document.querySelectorAll('.mobile-payment-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = '#666';
                btn.style.borderColor = '#E8D5DA';
            });
            
            event.target.classList.add('active');
            event.target.style.background = '#732C3F';
            event.target.style.color = 'white';
            event.target.style.borderColor = '#732C3F';
            
            selectedMobilePaymentMethod = event.target.dataset.method;
        }
        
        // Clear Mobile Bill
        function clearMobileBill() {
            if (confirm('Are you sure you want to clear the bill?')) {
                mobileBillItems = [];
                selectedMobileCustomer = null;
                document.getElementById('mobileCustomerSelect').value = '';
                updateMobileBillDisplay();
            }
        }
        
        // Process Mobile Bill
        async function processMobileBill() {
            if (mobileBillItems.length === 0) {
                alert('Please add items to the bill');
                return;
            }
            
            try {
                const subtotal = mobileBillItems.reduce((sum, item) => sum + item.total, 0);
                const taxAmount = subtotal * 0.18;
                const total = subtotal + taxAmount;
                
                const billData = {
                    customer_id: selectedMobileCustomer,
                    business_type: 'retail',
                    subtotal: subtotal,
                    tax_amount: taxAmount,
                    total_amount: total,
                    payment_method: selectedMobilePaymentMethod,
                    items: mobileBillItems.map(item => ({
                        product_id: item.productId,
                        product_name: item.name,
                        quantity: item.quantity,
                        unit_price: item.price,
                        total_price: item.total
                    }))
                };
                
                const response = await apiCall('/api/bills', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(billData)
                });
                
                alert(`‚úÖ Bill created successfully! Bill #${response.bill_number}`);
                
                // Clear bill after success
                mobileBillItems = [];
                selectedMobileCustomer = null;
                document.getElementById('mobileCustomerSelect').value = '';
                updateMobileBillDisplay();
                
            } catch (error) {
                console.error('Failed to process bill:', error);
                alert('‚ùå Failed to process bill. Please try again.');
            }
        }
        
        // Show Mobile Add Customer Modal
        function showMobileAddCustomerModal() {
            document.getElementById('mobileAddCustomerModal').style.display = 'flex';
        }
        
        // Close Mobile Add Customer Modal
        function closeMobileAddCustomerModal() {
            document.getElementById('mobileAddCustomerModal').style.display = 'none';
            document.getElementById('mobileNewCustomerName').value = '';
            document.getElementById('mobileNewCustomerPhone').value = '';
            document.getElementById('mobileNewCustomerEmail').value = '';
        }
        
        // Add Mobile New Customer
        async function addMobileNewCustomer() {
            const name = document.getElementById('mobileNewCustomerName').value.trim();
            const phone = document.getElementById('mobileNewCustomerPhone').value.trim();
            const email = document.getElementById('mobileNewCustomerEmail').value.trim();
            
            if (!name) {
                alert('Customer name is required');
                return;
            }
            
            try {
                const customerData = { name, phone, email };
                const response = await apiCall('/api/customers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customerData)
                });
                
                alert('‚úÖ Customer added successfully!');
                closeMobileAddCustomerModal();
                await loadMobileCustomersForBilling();
                
                // Select the new customer
                document.getElementById('mobileCustomerSelect').value = response.id;
                selectedMobileCustomer = response.id;
                
            } catch (error) {
                console.error('Failed to add customer:', error);
                alert('‚ùå Failed to add customer. Please try again.');
            }
        }
        
        // Open Mobile Barcode Scanner
        function openMobileBarcodeScanner() {
            alert('üì∑ Barcode scanner will be available in the next update!');
        }
        

    </script>
</body>
</html>
