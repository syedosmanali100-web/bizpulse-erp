<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizPulse Mobile</title>
    <!-- Version: 2.0.4 - Fixed Decimal Display - 2026-01-10 -->
    
    <!-- Barcode Scanner Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #F7E8EC 0%, #E8D5DA 100%);
            min-height: 100vh;
        }
        
        /* Top Bar */
        .top-bar {
            background: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .menu-btn {
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            background: #732C3F;
            color: white;
            border-radius: 5px;
        }
        
        .title { color: #732C3F; font-weight: bold; }
        
        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: #732C3F;
            transition: left 0.3s;
            z-index: 200;
            overflow-y: auto;
            color: white;
        }
        
        .side-menu.open { left: 0; }
        
        .menu-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 150;
        }
        
        .overlay.show { display: block; }
        
        /* Content */
        .content {
            padding: 70px 15px 15px 15px;
        }
        
        .card {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .card h2 { 
            color: #732C3F; 
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .welcome-card {
            background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%);
            color: white;
            padding: 25px 20px;
        }
        
        .welcome-card h2 {
            color: white;
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .welcome-card p {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 0;
        }
        
        .stat-box {
            background: white;
            padding: 18px 15px;
            border-radius: 12px;
            border-left: 4px solid #732C3F;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            transition: transform 0.2s;
        }
        
        .stat-box:active {
            transform: scale(0.98);
        }
        
        .stat-box.sales { border-left-color: #4CAF50; }
        .stat-box.products { border-left-color: #2196F3; }
        .stat-box.customers { border-left-color: #FF9800; }
        .stat-box.bills { border-left-color: #9C27B0; }
        
        .stat-icon {
            font-size: 28px;
            margin-bottom: 8px;
            display: block;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .stat-change {
            font-size: 11px;
            color: #4CAF50;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .stat-change.down {
            color: #f44336;
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 0;
        }
        
        .module-box {
            background: white;
            padding: 18px 12px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            transition: all 0.2s;
        }
        
        .module-box:active { 
            transform: scale(0.95);
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        
        .module-icon { 
            font-size: 36px; 
            margin-bottom: 8px;
            display: block;
        }
        
        .module-name { 
            color: #732C3F; 
            font-weight: 600;
            font-size: 13px;
        }
        
        .recent-activity {
            margin-top: 0;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #F7E8EC;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .activity-details {
            flex: 1;
        }
        
        .activity-title {
            font-size: 14px;
            font-weight: 600;
            color: #732C3F;
            margin-bottom: 2px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #666;
        }
        
        .list-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #E8D5DA;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #732C3F;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #732C3F;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E8D5DA;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #732C3F;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #E8D5DA;
            border-radius: 10px;
            font-size: 14px;
            background: white;
        }
        
        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        /* Barcode Scanner Styles */
        .barcode-section {
            margin-bottom: 20px;
        }
        
        .btn-barcode {
            width: 100%;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .btn-barcode:active {
            transform: scale(0.98);
        }
        
        .divider-text {
            text-align: center;
            margin: 20px 0;
            position: relative;
            color: #666;
            font-size: 14px;
        }
        
        .divider-text::before,
        .divider-text::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #E8D5DA;
        }
        
        .divider-text::before { left: 0; }
        .divider-text::after { right: 0; }
        
        .camera-container {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .camera-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-camera {
            flex: 1;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-camera.secondary {
            background: #f44336;
        }
        
        .btn-upload {
            display: inline-block;
            background: #FF9800;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Products Module Styles */
        .product-card {
            background: #F7E8EC;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .product-icon {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-name {
            font-size: 16px;
            font-weight: 600;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .product-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
        }
        
        .product-stock {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .stock-good {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .stock-low {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .stock-out {
            background: #ffebee;
            color: #c62828;
        }
        
        .product-price {
            text-align: right;
        }
        
        .price-value {
            font-size: 20px;
            font-weight: bold;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .product-actions {
            display: flex;
            gap: 6px;
        }
        
        .action-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-edit {
            background: #2196F3;
            color: white;
        }
        
        .btn-delete {
            background: #f44336;
            color: white;
        }
        
        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #E8D5DA;
            border-radius: 8px;
            background: white;
            color: #666;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .filter-tab.active {
            background: #732C3F;
            color: white;
            border-color: #732C3F;
        }
        
        .filter-tab:hover {
            border-color: #732C3F;
        }
        
        /* Report Item Styles */
        .report-item {
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border: 1px solid #e0e0e0;
        }
        
        .report-item:hover {
            background: #732C3F;
            color: white;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(115, 44, 63, 0.3);
        }
        
        .report-item:hover span {
            color: white !important;
        }
        
        .report-item:last-child {
            margin-bottom: 0;
        }
        
        /* Report Category Card Styles */
        .report-category-card {
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid #E8D5DA;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .report-category-card:hover {
            border-color: #732C3F;
            box-shadow: 0 4px 12px rgba(115, 44, 63, 0.2);
            transform: translateY(-2px);
        }
            background: white;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .filter-tab.active {
            background: #732C3F;
            color: white;
            border-color: #732C3F;
        }
        
        /* Customer Card Styles */
        .customer-card {
            background: #F7E8EC;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            gap: 15px;
            align-items: center;
            transition: transform 0.2s;
        }
        
        .customer-card:active {
            transform: scale(0.98);
        }
        
        .customer-avatar {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .customer-info {
            flex: 1;
            min-width: 0;
        }
        
        .customer-name {
            font-size: 16px;
            font-weight: 600;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .customer-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .customer-phone {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .customer-type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .type-regular {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .type-vip {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .type-wholesale {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .customer-stats {
            text-align: right;
        }
        
        .customer-balance {
            font-size: 18px;
            font-weight: bold;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .customer-purchases {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .customer-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }
        
        /* Sales Card Styles */
        .sale-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #732C3F;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        
        .sale-card:active {
            transform: scale(0.98);
        }
        
        .sale-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .sale-bill-info {
            flex: 1;
        }
        
        .sale-bill-number {
            font-size: 16px;
            font-weight: 600;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .sale-customer {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .sale-amount {
            text-align: right;
        }
        
        .sale-total {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 4px;
        }
        
        .sale-time {
            font-size: 11px;
            color: #999;
        }
        
        .sale-details {
            display: flex;
            gap: 15px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
            font-size: 12px;
        }
        
        .sale-detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
        }
        
        .sale-payment-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .payment-cash {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .payment-card {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .payment-upi {
            background: #f3e5f5;
            color: #6a1b9a;
        }
        
        .sale-products {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            font-size: 12px;
        }
        
        .sale-product-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            color: #666;
        }
        
        /* Earnings/Profit Styles */
        .product-profit-card {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #4CAF50;
        }
        
        .product-profit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .product-profit-name {
            font-size: 14px;
            font-weight: 600;
            color: #732C3F;
        }
        
        .product-profit-amount {
            font-size: 16px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .product-profit-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            font-size: 11px;
            color: #666;
        }
        
        .product-profit-detail {
            text-align: center;
            padding: 6px;
            background: white;
            border-radius: 6px;
        }
        
        .product-profit-detail-label {
            display: block;
            margin-bottom: 3px;
            opacity: 0.8;
        }
        
        .product-profit-detail-value {
            display: block;
            font-weight: 600;
            color: #732C3F;
        }
        
        .profit-margin-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .margin-high {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .margin-medium {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .margin-low {
            background: #ffebee;
            color: #c62828;
        }
        
        /* Loading Screen with Rainbow Gradient */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, 
                #667eea 0%, 
                #764ba2 10%, 
                #f093fb 20%, 
                #4facfe 30%, 
                #00f2fe 40%, 
                #43e97b 50%, 
                #fa709a 60%, 
                #fee140 70%,
                #667eea 80%,
                #764ba2 90%,
                #f093fb 100%
            );
            background-size: 400% 400%;
            animation: rainbowShift 8s ease infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        @keyframes rainbowShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Variants Section Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(115, 44, 63, 0.1);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 6px 20px rgba(115, 44, 63, 0.3);
            }
        }
        
        /* Heartbeat Pulse Line Loader */
        .pulse-loader {
            width: 250px;
            height: 100px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .heartbeat-svg {
            width: 100%;
            height: 100%;
        }
        
        .heartbeat-path {
            stroke: white;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.8));
            animation: drawHeartbeat 3s ease-in-out infinite;
        }
        
        @keyframes drawHeartbeat {
            0% {
                stroke-dasharray: 0 1000;
                stroke-dashoffset: 0;
            }
            50% {
                stroke-dasharray: 1000 0;
                stroke-dashoffset: 0;
            }
            100% {
                stroke-dasharray: 1000 0;
                stroke-dashoffset: -1000;
            }
        }
        
        .loading-brand {
            font-size: 36px;
            font-weight: bold;
            color: white;
            margin-bottom: 40px;
            text-shadow: 0 2px 15px rgba(0,0,0,0.3);
            letter-spacing: 2px;
        }
        
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .login-screen.show { display: flex; }
        .login-screen.hidden { display: none; }
        
        .login-card {
            background: white;
            padding: 30px 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .login-logo h1 {
            color: #732C3F;
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .login-logo p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #732C3F;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E8D5DA;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #732C3F;
        }
        
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #732C3F 0%, #8B4A5C 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .login-btn:active {
            transform: scale(0.98);
        }
        
        .login-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
            color: #999;
            font-size: 14px;
        }
        
        .login-divider::before,
        .login-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 42%;
            height: 1px;
            background: #ddd;
        }
        
        .logout-item {
            background: rgba(255,255,255,0.1);
            margin: 10px 15px;
            border-radius: 8px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            gap: 5px;
        }
        
        .bottom-nav::-webkit-scrollbar {
            display: none;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 12px;
            transition: all 0.3s;
            flex: 1;
            max-width: 80px;
            background: transparent;
            color: #666;
        }
        
        .nav-item:active {
            transform: scale(0.95);
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 2px;
        }
        
        .nav-label {
            font-size: 10px;
            color: #666;
            font-weight: 600;
            white-space: nowrap;
        }
        
        /* Active nav item - wine color */
        .nav-item.active-nav {
            background: linear-gradient(135deg, #732C3F 0%, #8B3A47 100%);
            box-shadow: 0 4px 15px rgba(114, 47, 55, 0.4);
        }
        
        .nav-item.active-nav .nav-label {
            color: white;
        }
        
        /* Special Billing Button - Same as others but slightly bigger */
        .nav-item.billing-btn {
            flex: 1.2;
            max-width: 95px;
            padding: 10px 12px;
        }
        
        .nav-item.billing-btn .nav-icon {
            font-size: 26px;
        }
        
        .nav-item.billing-btn .nav-label {
            font-size: 11px;
            font-weight: 700;
        }
        
        /* Billing Product Boxes - Desktop Style */
        .bill-product-box {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .bill-product-box:hover {
            border-color: #732C3F;
            box-shadow: 0 4px 12px rgba(115, 44, 63, 0.2);
            transform: translateY(-2px);
        }
        
        .bill-product-box:active {
            transform: scale(0.95);
        }
        
        .bill-product-name {
            font-size: 11px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            line-height: 1.2;
            height: 28px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .bill-product-price {
            font-size: 14px;
            font-weight: 700;
            color: #732C3F;
            margin-bottom: 4px;
        }
        
        .bill-product-stock {
            font-size: 10px;
            color: #666;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .bill-product-box.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .bill-product-box.out-of-stock:hover {
            border-color: #e0e0e0;
            box-shadow: none;
            transform: none;
        }
        
        /* Bill Items List */
        .bill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            background: white;
        }
        
        .bill-item:last-child {
            border-bottom: none;
        }
        
        .bill-item-info {
            flex: 1;
        }
        
        .bill-item-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .bill-item-details {
            font-size: 12px;
            color: #666;
        }
        
        .bill-item-total {
            font-weight: 700;
            color: #732C3F;
            font-size: 16px;
            margin-right: 10px;
        }
        
        .bill-item-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* Add padding to content for bottom nav */
        .content {
            padding: 70px 15px 80px 15px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-brand">BizPulse</div>
        <div class="pulse-loader">
            <svg class="heartbeat-svg" viewBox="0 0 250 100" xmlns="http://www.w3.org/2000/svg">
                <path class="heartbeat-path" d="M 0,50 L 40,50 L 50,20 L 60,80 L 70,50 L 90,50 L 100,30 L 110,70 L 120,50 L 140,50 L 150,10 L 160,90 L 170,50 L 190,50 L 200,40 L 210,60 L 220,50 L 250,50"/>
            </svg>
        </div>
        <div class="loading-text">Loading...</div>
    </div>
    
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <h1>üè¢ BizPulse</h1>
                <p>Mobile ERP System</p>
            </div>
            
            <!-- Credential Login Form -->
            <form onsubmit="handleLogin(event)" id="credentialLoginForm">
                <div class="form-group">
                    <label>Email or Username</label>
                    <input type="text" id="loginEmail" placeholder="Enter email or username" required>
                    <!-- DEBUG: Input type is TEXT, not EMAIL -->
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" value="demo123" required>
                </div>
                <button type="submit" class="login-btn">üîê Login</button>
            </form>
            

        </div>
    </div>
    
    <!-- Top Bar -->
    <div class="top-bar" id="topBar" style="display: none;">
        <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
        <div class="title">BizPulse</div>
        <div>üë§</div>
    </div>
    
    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeMenu()"></div>
    
    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <h2>BizPulse ERP</h2>
            <p id="userEmail">admin@demo.com</p>
        </div>
        <div id="menuItems">Loading...</div>
        <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px;"></div>
        <div class="menu-item logout-item" onclick="handleLogout()">
            <span>üö™ Logout</span>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav" id="bottomNav" style="display: none;">
        <div class="nav-item" id="nav-home" onclick="showDashboardOnly()">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">Home</div>
        </div>
        <div class="nav-item" id="nav-products" onclick="showModule('products')">
            <div class="nav-icon">üì¶</div>
            <div class="nav-label">Products</div>
        </div>
        
        <!-- BILLING - Special Big Button in Middle -->
        <div class="nav-item billing-btn" id="nav-billing" onclick="showModule('billing')">
            <div class="nav-icon">üí≥</div>
            <div class="nav-label">BILLING</div>
        </div>
        
        <div class="nav-item" id="nav-sales" onclick="showModule('sales')">
            <div class="nav-icon">üí∞</div>
            <div class="nav-label">Sales</div>
        </div>
        <div class="nav-item" id="nav-earnings" onclick="showModule('earnings')">
            <div class="nav-icon">üíé</div>
            <div class="nav-label">Earnings</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="content" id="mainContent" style="display: none;">
        <div class="card welcome-card">
            <h2>üëã Welcome Back!</h2>
            <p>Here's what's happening with your business today</p>
        </div>
        
        <div class="card">
            <h2>üìä Overview</h2>
            <div class="stats" id="stats">
                <div class="stat-box sales">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value" id="totalSales">‚Çπ0</div>
                    <div class="stat-label">Today's Sales</div>
                    <div class="stat-change">‚Üë 12%</div>
                </div>
                <div class="stat-box products">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Products</div>
                    <div class="stat-change">‚Üë 5%</div>
                </div>
                <div class="stat-box customers">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="totalCustomers">0</div>
                    <div class="stat-label">Customers</div>
                    <div class="stat-change">‚Üë 8%</div>
                </div>
                <div class="stat-box bills">
                    <div class="stat-icon">üßæ</div>
                    <div class="stat-value" id="totalBills">0</div>
                    <div class="stat-label">Bills Today</div>
                    <div class="stat-change">‚Üë 15%</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>‚ö° Quick Actions</h2>
            <div class="module-grid">
                <div class="module-box" onclick="showModule('billing')">
                    <div class="module-icon">üßæ</div>
                    <div class="module-name">New Bill</div>
                </div>
                <div class="module-box" onclick="showModule('products')">
                    <div class="module-icon">üì¶</div>
                    <div class="module-name">Products</div>
                </div>
                <div class="module-box" onclick="showModule('customers')">
                    <div class="module-icon">üë•</div>
                    <div class="module-name">Customers</div>
                </div>
                <div class="module-box" onclick="showModule('sales')">
                    <div class="module-icon">üí∞</div>
                    <div class="module-name">Sales</div>
                </div>
                <div class="module-box" onclick="showModule('inventory')">
                    <div class="module-icon">üìä</div>
                    <div class="module-name">Inventory</div>
                </div>
                <div class="module-box" onclick="showModule('reports')">
                    <div class="module-icon">üìà</div>
                    <div class="module-name">Reports</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üïê Recent Activity</h2>
            <div class="recent-activity">
                <div class="activity-item">
                    <div class="activity-icon">üí∞</div>
                    <div class="activity-details">
                        <div class="activity-title">New Sale</div>
                        <div class="activity-time">2 minutes ago</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon">üë•</div>
                    <div class="activity-details">
                        <div class="activity-title">Customer Added</div>
                        <div class="activity-time">15 minutes ago</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon">üì¶</div>
                    <div class="activity-details">
                        <div class="activity-title">Stock Updated</div>
                        <div class="activity-time">1 hour ago</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card" id="dataDisplay" style="display: none;">
            <h2 id="dataTitle">Select a module</h2>
            <div id="dataContent">Click on any module above to view data</div>
        </div>
        
        <!-- Products Module -->
        <div class="card" id="productsModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üì¶ Products</h2>
                <button onclick="showAddProductForm()" style="background: #732C3F; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px;">+ Add</button>
            </div>
            
            <!-- Search Bar -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="productSearch" placeholder="üîç Search products..." style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;" onkeyup="filterProducts()">
            </div>
            
            <!-- Filter Tabs -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto;">
                <button class="filter-tab active" onclick="filterByCategory('all')">All</button>
                <button class="filter-tab" onclick="filterByCategory('Groceries')">Groceries</button>
                <button class="filter-tab" onclick="filterByCategory('Beverages')">Beverages</button>
                <button class="filter-tab" onclick="filterByCategory('Dairy')">Dairy</button>
                <button class="filter-tab" onclick="filterByCategory('Vegetables')">Vegetables</button>
            </div>
            
            <!-- Products List -->
            <div id="productsList"></div>
        </div>
        
        <!-- Customers Module -->
        <div class="card" id="customersModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üë• Customers</h2>
                <button onclick="showAddCustomerForm()" style="background: #732C3F; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;">+ Add</button>
            </div>
            
            <!-- Search Bar -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="customerSearch" placeholder="üîç Search customers..." style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;" onkeyup="filterCustomers()">
            </div>
            
            <!-- Filter Tabs -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px;">
                <button class="filter-tab active" onclick="filterCustomersByType('all')">All</button>
                <button class="filter-tab" onclick="filterCustomersByType('regular')">Regular</button>
                <button class="filter-tab" onclick="filterCustomersByType('vip')">VIP</button>
                <button class="filter-tab" onclick="filterCustomersByType('wholesale')">Wholesale</button>
            </div>
            
            <!-- Stats Summary -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 15px; border-radius: 12px; color: white;">
                    <div style="font-size: 24px; font-weight: bold;" id="totalCustomersCount">0</div>
                    <div style="font-size: 12px; opacity: 0.9;">Total Customers</div>
                </div>
                <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); padding: 15px; border-radius: 12px; color: white;">
                    <div style="font-size: 24px; font-weight: bold;" id="activeCustomersCount">0</div>
                    <div style="font-size: 12px; opacity: 0.9;">Active This Month</div>
                </div>
            </div>
            
            <!-- Customers List -->
            <div id="customersList"></div>
        </div>
        
        <!-- Billing Module - Desktop Style -->
        <div class="card" id="billingModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üí≥ Smart Billing</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="openBillBarcodeScanner()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px;">üì∑ Scan</button>
                    <button onclick="clearBill()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px;">Clear</button>
                </div>
            </div>
            
            <!-- Barcode Scanner Section for Billing -->
            <div id="billBarcodeSection" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #28a745;">üì∑ Scan Product Barcode</h4>
                    <button onclick="closeBillBarcodeScanner()" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">‚úï</button>
                </div>
                <div id="billBarcodeCamera"></div>
            </div>
            
            <!-- Products Grid - Desktop Style -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 16px; color: #732C3F;">üì¶ Select Products</h3>
                    <input type="text" id="billProductSearch" placeholder="üîç Search products..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; width: 200px; font-size: 14px;">
                </div>
                
                <div id="billProductsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 10px;">
                    <!-- Products will be loaded here -->
                </div>
            </div>
            
            <!-- Bill Items -->
            <div style="margin-bottom: 15px;">
                <h3 style="margin-bottom: 10px; font-size: 16px; color: #732C3F;">üõí Bill Items</h3>
                <div id="billItemsList" style="max-height: 200px; overflow-y: auto; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üõí</div>
                        <p>Scan or click products to add</p>
                    </div>
                </div>
            </div>
            
            <!-- Bill Summary & Payment -->
            <div style="background: linear-gradient(135deg, #732C3F 0%, #8B3A47 100%); padding: 20px; border-radius: 10px; color: white;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Subtotal:</span>
                    <span style="font-weight: 600;">‚Çπ<span id="billSubtotal">0</span></span>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>GST (10%):</span>
                    <span style="font-weight: 600;">‚Çπ<span id="billGST">0</span></span>
                </div>
                
                <!-- Discount Section - PROMINENT -->
                <div style="margin-bottom: 15px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 10px; border: 2px solid #FFD700;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 700; font-size: 15px; color: #FFD700;">üí∞ Discount (‚Çπ):</span>
                        <input type="number" id="billDiscount" placeholder="0.00" min="0" step="0.01" value="0"
                               style="width: 130px; padding: 10px 14px; border: 3px solid #FFD700; border-radius: 10px; text-align: right; color: #333; font-weight: 700; font-size: 16px; background: white; box-shadow: 0 2px 8px rgba(255,215,0,0.3);"
                               oninput="calculateBillTotal()">
                    </div>
                    <div id="discountDisplay" style="font-size: 12px; color: #FFD700; text-align: right; display: none; margin-top: 5px; font-weight: 600;">
                        ‚úÖ Discount Applied: -‚Çπ<span id="discountAmount">0</span>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 20px; font-weight: 700; margin-bottom: 15px;">
                    <span>Total:</span>
                    <span>‚Çπ<span id="billTotal">0</span></span>
                </div>
                
                <!-- Payment Method Selection -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">üí≥ Payment Method:</label>
                    <select id="paymentMethod" onchange="handlePaymentMethodChange()" style="width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 14px; color: #333;">
                        <option value="cash">üíµ Cash</option>
                        <option value="card">üí≥ Card</option>
                        <option value="upi">üì± UPI</option>
                        <option value="partial">üí∞ Partial Payment</option>
                        <option value="credit">üìù Full Credit</option>
                    </select>
                </div>
                
                <!-- Partial Payment Section -->
                <div id="partialPaymentSection" style="display: none; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">üí∞ Paying Amount:</label>
                    <input type="number" id="partialAmount" placeholder="Enter amount paying now" min="0" step="0.01"
                           style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 14px; color: #333; margin-bottom: 8px;"
                           oninput="calculatePartialBalance()">
                    <div id="partialBalanceDisplay" style="font-size: 13px; opacity: 0.9;">
                        Remaining Balance: ‚Çπ<span id="partialBalance">0</span>
                    </div>
                </div>
                
                <!-- Customer Details Section (for Credit & Partial) -->
                <div id="customerDetailsSection" style="display: none; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">üë§ Customer Details (Required)</div>
                    <input type="text" id="customerName" placeholder="Customer Name *" required
                           style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 14px; color: #333; margin-bottom: 8px;">
                    <input type="tel" id="customerPhone" placeholder="Customer Phone *" required
                           style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 14px; color: #333;">
                </div>
                
                <!-- Optional Customer Details (for Cash/Card/UPI) -->
                <div id="optionalCustomerSection" style="display: block; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">üë§ Customer Details (Optional)</div>
                    <input type="text" id="optionalCustomerName" placeholder="Customer Name (Optional)"
                           style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 14px; color: #333; margin-bottom: 8px;">
                    <input type="tel" id="optionalCustomerPhone" placeholder="Customer Phone (Optional)"
                           style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 14px; color: #333;">
                </div>
                
                <button onclick="completeBill()" id="completeBillBtn" style="background: #28a745; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 18px; font-weight: 700;" disabled>
                    üí∞ Complete Bill
                </button>
            </div>
            

            </button>
        </div>
        
        <!-- Credit Module -->
        <div class="card" id="creditModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üí≥ Credit Management</h2>
                <button onclick="refreshCredit()" style="background: #732C3F; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;">üîÑ Refresh</button>
            </div>
            
            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Total Outstanding</div>
                    <div style="font-size: 24px; font-weight: bold;" id="totalOutstanding">‚Çπ0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;" id="outstandingBills">0 bills</div>
                </div>
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Collected Today</div>
                    <div style="font-size: 24px; font-weight: bold;" id="collectedToday">‚Çπ0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;" id="paymentsToday">0 payments</div>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="creditSearch" placeholder="üîç Search by customer, bill number..." style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;" onkeyup="filterCreditBills()">
            </div>
            
            <!-- Filter Tabs (Status & Date) -->
            <div style="margin-bottom: 15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <!-- Status Filter -->
                    <div>
                        <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Status Filter</label>
                        <select id="creditStatusFilter" onchange="filterCreditBills()" style="width: 100%; padding: 8px; border: 2px solid #E8D5DA; border-radius: 8px; font-size: 13px;">
                            <option value="all">All Status</option>
                            <option value="unpaid">Unpaid</option>
                            <option value="partial">Partial</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                    
                    <!-- Date Filter -->
                    <div>
                        <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Date Filter</label>
                        <select id="creditDateFilter" onchange="filterCreditBills()" style="width: 100%; padding: 8px; border: 2px solid #E8D5DA; border-radius: 8px; font-size: 13px;">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Credit Bills List -->
            <div id="creditBillsList">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üí≥</div>
                    <p>Loading credit bills...</p>
                </div>
            </div>
        </div>
        
        <!-- Payment Modal -->
        <div class="modal" id="paymentModal">
            <div class="modal-content">
        
        <!-- Bill Details Modal -->
        <div class="modal" id="billDetailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 20px;">
                <div style="padding: 20px; border-bottom: 2px solid #E8D5DA; display: flex; justify-content: space-between; align-items: center; background: #732C3F; color: white; border-radius: 15px 15px 0 0;">
                    <h3 style="margin: 0; font-size: 18px;">Bill Details</h3>
                    <button onclick="closeBillDetailsModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">√ó</button>
                </div>
                <div id="billDetailsContent" style="padding: 20px;">
                    <div style="text-align: center; padding: 40px; color: #999;">
                        Loading...
                    </div>
                </div>
            </div>
        </div>
                <div class="modal-header">
                    <div class="modal-title">üí∞ Record Payment</div>
                    <button class="modal-close" onclick="closePaymentModal()">√ó</button>
                </div>
                
                <form id="paymentForm" onsubmit="recordPayment(event)">
                    <input type="hidden" id="paymentBillId">
                    
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666; font-size: 13px;">Customer:</span>
                            <span style="font-weight: 600; font-size: 14px;" id="paymentCustomer">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666; font-size: 13px;">Bill Number:</span>
                            <span style="font-weight: 600; font-size: 14px;" id="paymentBillNumber">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666; font-size: 13px;">Total Amount:</span>
                            <span style="font-weight: 600; font-size: 14px;" id="paymentTotalAmount">‚Çπ0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #ef4444; font-size: 13px;">Pending:</span>
                            <span style="font-weight: 700; font-size: 16px; color: #ef4444;" id="paymentPendingAmount">‚Çπ0</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Payment Amount *</label>
                        <input type="number" id="paymentAmount" class="form-input" placeholder="Enter amount" step="0.01" required>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button type="button" onclick="setPaymentAmount('full')" style="flex: 1; background: #10b981; color: white; border: none; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">Full Payment</button>
                            <button type="button" onclick="setPaymentAmount('half')" style="flex: 1; background: #f59e0b; color: white; border: none; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">Half Payment</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Payment Method *</label>
                        <select id="paymentMethod" class="form-select" required>
                            <option value="">Select Method</option>
                            <option value="cash">üíµ Cash</option>
                            <option value="upi">üì± UPI</option>
                            <option value="card">üí≥ Card</option>
                            <option value="bank_transfer">üè¶ Bank Transfer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea id="paymentNotes" class="form-input" placeholder="Add payment notes..." rows="2" style="resize: vertical;"></textarea>
                    </div>
                    
                    <button type="submit" class="btn-primary">üí∞ Record Payment</button>
                </form>
            </div>
        </div>
        
        <!-- Sales Module -->
        <div class="card" id="salesModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üí∞ Sales</h2>
                <button onclick="showAddSaleForm()" style="background: #732C3F; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;">+ New Sale</button>
            </div>
            
            <!-- Date Filter -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;">
                    <button class="filter-tab" onclick="filterSalesByDate('today')">Today</button>
                    <button class="filter-tab" onclick="filterSalesByDate('yesterday')">Yesterday</button>
                    <button class="filter-tab active" onclick="filterSalesByDate('week')">This Week</button>
                    <button class="filter-tab" onclick="filterSalesByDate('month')">This Month</button>
                    <button class="filter-tab" onclick="filterSalesByDate('all')">All Time</button>
                </div>
            </div>
            
            <!-- Sales Summary Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Total Revenue</div>
                    <div style="font-size: 24px; font-weight: bold;" id="totalRevenue">‚Çπ0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;" id="revenueChange">‚Üë 0%</div>
                </div>
                <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Transactions</div>
                    <div style="font-size: 24px; font-weight: bold;" id="totalTransactions">0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;" id="transactionChange">‚Üë 0%</div>
                </div>
                <div style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Avg Order Value</div>
                    <div style="font-size: 24px; font-weight: bold;" id="avgOrderValue">‚Çπ0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Per transaction</div>
                </div>
                <div style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Top Product</div>
                    <div style="font-size: 16px; font-weight: bold;" id="topProduct">-</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;" id="topProductQty">0 sold</div>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="salesSearch" placeholder="üîç Search by customer, product, bill..." style="width: 100%; padding: 12px; border: 2px solid #E8D5DA; border-radius: 10px; font-size: 14px;" onkeyup="filterSales()">
            </div>
            
            <!-- Sales Table -->
            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="overflow-x: auto;">
                    <table id="salesTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #732C3F; color: white;">
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; white-space: nowrap;">S.No</th>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; white-space: nowrap;">Bill No.</th>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; white-space: nowrap;">Customer</th>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; white-space: nowrap;">Date</th>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; white-space: nowrap;">Time</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; white-space: nowrap;">Amount</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600; white-space: nowrap;">Payment</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600; white-space: nowrap;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <tr>
                                <td colspan="7" style="padding: 40px; text-align: center; color: #999;">
                                    <div style="font-size: 48px; margin-bottom: 10px;">üí∞</div>
                                    <div>Loading sales...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div id="salesPagination" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-top: 1px solid #E8D5DA; background: #f9f9f9;">
                    <div style="font-size: 13px; color: #666;">
                        Showing <span id="salesShowingStart">0</span>-<span id="salesShowingEnd">0</span> of <span id="salesTotalCount">0</span>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="changeSalesPage('prev')" id="salesPrevBtn" style="padding: 8px 12px; background: white; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; cursor: pointer; color: #666;" disabled>‚Üê Prev</button>
                        <div id="salesPageNumbers" style="display: flex; gap: 5px;"></div>
                        <button onclick="changeSalesPage('next')" id="salesNextBtn" style="padding: 8px 12px; background: white; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; cursor: pointer; color: #666;" disabled>Next ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Earnings/Profit Module -->
        <div class="card" id="earningsModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üíé Earnings & Profit</h2>
                <button onclick="refreshEarnings()" style="background: #732C3F; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;">üîÑ Refresh</button>
            </div>
            
            <!-- Date Filter -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;">
                    <button class="filter-tab active" onclick="filterEarningsByDate('today')">Today</button>
                    <button class="filter-tab" onclick="filterEarningsByDate('yesterday')">Yesterday</button>
                    <button class="filter-tab" onclick="filterEarningsByDate('week')">This Week</button>
                    <button class="filter-tab" onclick="filterEarningsByDate('month')">This Month</button>
                    <button class="filter-tab" onclick="filterEarningsByDate('all')">All Time</button>
                </div>
            </div>
            
            <!-- Main Profit Summary -->
            <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px; box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);">
                <div style="text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üí∞ Total Profit</div>
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;" id="totalProfit">‚Çπ0</div>
                    <div style="font-size: 13px; opacity: 0.9;" id="profitMarginPercent">Margin: 0%</div>
                </div>
            </div>
            
            <!-- Financial Breakdown -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Total Sales</div>
                    <div style="font-size: 22px; font-weight: bold;" id="totalSalesValue">‚Çπ0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Revenue</div>
                </div>
                <div style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">Total Cost</div>
                    <div style="font-size: 22px; font-weight: bold;" id="totalCostValue">‚Çπ0</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Investment</div>
                </div>
            </div>
            
            <!-- Profit Metrics -->
            <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #E8D5DA;">
                <div style="font-size: 14px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üìä Profit Metrics</div>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                        <span style="color: #666; font-size: 13px;">Gross Profit</span>
                        <span style="color: #4CAF50; font-weight: 600; font-size: 14px;" id="grossProfit">‚Çπ0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                        <span style="color: #666; font-size: 13px;">Profit Margin %</span>
                        <span style="color: #2196F3; font-weight: 600; font-size: 14px;" id="profitMargin">0%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                        <span style="color: #666; font-size: 13px;">Avg Profit/Sale</span>
                        <span style="color: #FF9800; font-weight: 600; font-size: 14px;" id="avgProfitPerSale">‚Çπ0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                        <span style="color: #666; font-size: 13px;">Total Transactions</span>
                        <span style="color: #9C27B0; font-weight: 600; font-size: 14px;" id="totalTransactionsCount">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Product-wise Profit Analysis -->
            <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #E8D5DA;">
                <div style="font-size: 14px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üì¶ Product-wise Profit</div>
                <div id="productProfitList"></div>
            </div>
            
            <!-- Top Performers -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">üèÜ Most Profitable</div>
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 3px;" id="mostProfitableProduct">-</div>
                    <div style="font-size: 12px; opacity: 0.9;" id="mostProfitableAmount">‚Çπ0 profit</div>
                </div>
                <div style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">‚ö†Ô∏è Least Profitable</div>
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 3px;" id="leastProfitableProduct">-</div>
                    <div style="font-size: 12px; opacity: 0.9;" id="leastProfitableAmount">‚Çπ0 profit</div>
                </div>
            </div>
            
            <!-- Profit Trend -->
            <div style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #E8D5DA;">
                <div style="font-size: 14px; font-weight: 600; color: #732C3F; margin-bottom: 15px;">üìà Profit Trend</div>
                <div id="profitTrend"></div>
            </div>
        </div>
        
        <!-- Reports Module -->
        <div class="card" id="reportsModule" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üìä Reports</h2>
                <button onclick="refreshReports()" style="background: #732C3F; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;">üîÑ Refresh</button>
            </div>
            
            <!-- Main Report Categories List -->
            <div id="reportCategoriesList" style="display: grid; gap: 12px;">
                <div class="report-category-card" onclick="openReportCategory('sales')">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 32px;">üí∞</span>
                        <div>
                            <div style="font-weight: 600; font-size: 16px; color: #2c3e50; margin-bottom: 4px;">Sales Reports</div>
                            <div style="font-size: 13px; color: #666;">View sales summary, product-wise, customer-wise reports</div>
                        </div>
                    </div>
                    <span style="color: #666; font-size: 20px;">‚Üí</span>
                </div>
                
                <div class="report-category-card" onclick="openReportCategory('inventory')">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 32px;">üì¶</span>
                        <div>
                            <div style="font-weight: 600; font-size: 16px; color: #2c3e50; margin-bottom: 4px;">Inventory Reports</div>
                            <div style="font-size: 13px; color: #666;">Stock summary, low stock, expiry alerts</div>
                        </div>
                    </div>
                    <span style="color: #666; font-size: 20px;">‚Üí</span>
                </div>
                
                <div class="report-category-card" onclick="openReportCategory('financial')">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 32px;">üíé</span>
                        <div>
                            <div style="font-weight: 600; font-size: 16px; color: #2c3e50; margin-bottom: 4px;">Financial Reports</div>
                            <div style="font-size: 13px; color: #666;">Profit & loss, revenue, expense reports</div>
                        </div>
                    </div>
                    <span style="color: #666; font-size: 20px;">‚Üí</span>
                </div>
                
                <div class="report-category-card" onclick="openReportCategory('customer')">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 32px;">üë•</span>
                        <div>
                            <div style="font-weight: 600; font-size: 16px; color: #2c3e50; margin-bottom: 4px;">Customer Reports</div>
                            <div style="font-size: 13px; color: #666;">Customer list, top customers, ledger</div>
                        </div>
                    </div>
                    <span style="color: #666; font-size: 20px;">‚Üí</span>
                </div>
                
                <div class="report-category-card" onclick="openReportCategory('credit')">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 32px;">üí≥</span>
                        <div>
                            <div style="font-weight: 600; font-size: 16px; color: #2c3e50; margin-bottom: 4px;">Credit Reports</div>
                            <div style="font-size: 13px; color: #666;">Outstanding credit, collections, aging</div>
                        </div>
                    </div>
                    <span style="color: #666; font-size: 20px;">‚Üí</span>
                </div>
            </div>
            
            <!-- Report Category Detail View (New Tab) -->
            <div id="reportCategoryDetail" style="display: none;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                    <button onclick="backToReportCategories()" style="background: #f0f0f0; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 16px;">‚Üê Back</button>
                    <h3 id="categoryDetailTitle" style="margin: 0; color: #732C3F;">Reports</h3>
                </div>
                
                <div id="reportOptionsList" style="display: grid; gap: 10px;">
                    <!-- Report options will be populated here -->
                </div>
            </div>
            
            <!-- Individual Report View (New Tab) -->
            <div id="reportViewTab" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button onclick="backToReportOptions()" style="background: #f0f0f0; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 16px;">‚Üê Back</button>
                        <h3 id="reportViewTitle" style="margin: 0; color: #732C3F;">Report</h3>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportReport('pdf')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 600;">üìÑ PDF</button>
                        <button onclick="exportReport('excel')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 600;">üìä Excel</button>
                    </div>
                </div>
                
                <!-- Filters Section -->
                <div id="reportFilters" style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <!-- Date Range Filter -->
                        <div>
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Date Range</label>
                            <select id="reportDateFilter" onchange="applyReportFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="week" selected>This Week</option>
                                <option value="month">This Month</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        
                        <!-- Search Filter -->
                        <div>
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Search</label>
                            <input type="text" id="reportSearchFilter" placeholder="Search..." onkeyup="applyReportFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                        </div>
                        
                        <!-- Sort By Filter -->
                        <div>
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Sort By</label>
                            <select id="reportSortFilter" onchange="applyReportFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                <option value="default">Default</option>
                                <option value="amount_desc">Amount (High to Low)</option>
                                <option value="amount_asc">Amount (Low to High)</option>
                                <option value="date_desc">Date (Newest First)</option>
                                <option value="date_asc">Date (Oldest First)</option>
                            </select>
                        </div>
                        
                        <!-- Clear Filters Button -->
                        <div style="display: flex; align-items: flex-end;">
                            <button onclick="clearReportFilters()" style="width: 100%; padding: 8px; background: #666; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 600;">Clear Filters</button>
                        </div>
                    </div>
                </div>
                
                <!-- Report Table -->
                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="overflow-x: auto;">
                        <table id="reportDataTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead id="reportTableHead">
                                <!-- Table headers will be populated here -->
                            </thead>
                            <tbody id="reportTableBody">
                                <tr>
                                    <td colspan="10" style="padding: 40px; text-align: center; color: #999;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
                                        <div>Loading report...</div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot id="reportTableFoot" style="display: none;">
                                <!-- Summary row will be populated here -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Product Modal -->
    <div class="modal" id="addProductModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title" id="productModalTitle">‚ûï Add New Product</div>
                <button class="modal-close" onclick="closeAddProductModal()">√ó</button>
            </div>
            
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="editProductId" value="">
                
                <!-- ========== MANDATORY FIELDS (Always Visible) ========== -->
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: #333;">Product Name *</label>
                    <input type="text" id="productName" class="form-input" style="padding: 12px; font-size: 14px; border: 2px solid #E8D5DA; border-radius: 10px;" placeholder="e.g., Aata / Flour" required>
                </div>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: #333;">Category *</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="productCategory" class="form-select" style="padding: 12px; font-size: 14px; border: 2px solid #E8D5DA; border-radius: 10px; flex: 1;" required onchange="handleCategoryChange()">
                            <option value="">Select Category</option>
                            <option value="Atta">Atta (Flour)</option>
                            <option value="Rice">Rice</option>
                            <option value="Oil">Oil</option>
                            <option value="Dal">Dal (Lentils)</option>
                            <option value="Sugar">Sugar</option>
                            <option value="Salt">Salt</option>
                            <option value="Spices">Spices</option>
                            <option value="Tea">Tea / Coffee</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Dairy">Dairy</option>
                            <option value="Snacks">Snacks</option>
                            <option value="Other">Other</option>
                            <option value="__add_new__">‚ûï Add New Category</option>
                        </select>
                    </div>
                </div>
                
                <!-- New Category Input (Hidden by default) -->
                <div id="newCategorySection" style="display: none; margin-bottom: 15px;">
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="newCategoryInput" class="form-input" style="padding: 12px; font-size: 14px; border: 2px solid #E8D5DA; border-radius: 10px; flex: 1;" placeholder="Enter new category name">
                        <button type="button" onclick="addNewCategory()" style="background: #4CAF50; color: white; border: none; padding: 12px 18px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer;">‚úì</button>
                        <button type="button" onclick="cancelNewCategory()" style="background: #f44336; color: white; border: none; padding: 12px 18px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer;">‚úï</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 13px; font-weight: 600; color: #333;">Selling Price (‚Çπ) *</label>
                        <input type="number" id="productPrice" class="form-input" style="padding: 12px; font-size: 14px; border: 2px solid #E8D5DA; border-radius: 10px;" placeholder="100" step="0.01" required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 13px; font-weight: 600; color: #333;">Stock Quantity *</label>
                        <input type="number" id="productStock" class="form-input" style="padding: 12px; font-size: 14px; border: 2px solid #E8D5DA; border-radius: 10px;" placeholder="50" step="0.001" required>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: #333;">Unit *</label>
                    <select id="productUnit" class="form-select" style="padding: 12px; font-size: 14px; border: 2px solid #E8D5DA; border-radius: 10px;" required>
                        <option value="">Select Unit</option>
                        <option value="kg">Kg (Kilogram)</option>
                        <option value="gram">Gram</option>
                        <option value="liter">Liter</option>
                        <option value="ml">ML (Milliliter)</option>
                        <option value="piece">Piece</option>
                        <option value="packet">Packet</option>
                        <option value="box">Box</option>
                        <option value="dozen">Dozen</option>
                    </select>
                </div>
                
                <!-- ========== OPTIONAL FIELDS (Collapsible Sections) ========== -->
                
                <!-- Pricing Details Section -->
                <div style="margin-bottom: 12px;">
                    <button type="button" onclick="toggleOptionalSection('pricingDetails')" style="width: 100%; background: #f5f5f5; color: #666; border: 1px solid #ddd; padding: 12px 15px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
                        <span>üí∞ Pricing Details</span>
                        <span id="pricingDetailsIcon" style="font-size: 18px; transition: transform 0.3s;">+</span>
                    </button>
                    <div id="pricingDetailsSection" style="display: none; margin-top: 10px; padding: 15px; background: #f9f9f9; border-radius: 10px; border: 1px solid #e0e0e0;">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label" style="font-size: 12px; color: #666;">Cost Price (‚Çπ)</label>
                            <input type="number" id="productCost" class="form-input" style="padding: 10px; font-size: 13px; border: 1px solid #ddd; border-radius: 8px;" placeholder="70" step="0.01">
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">Purchase or manufacturing cost</div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label" style="font-size: 12px; color: #666;">MRP (‚Çπ)</label>
                            <input type="number" id="productMRP" class="form-input" style="padding: 10px; font-size: 13px; border: 1px solid #ddd; border-radius: 8px;" placeholder="120" step="0.01">
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">Maximum Retail Price</div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="font-size: 12px; color: #666;">Tax / GST (%)</label>
                            <select id="productTax" class="form-select" style="padding: 10px; font-size: 13px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="0">0% - No Tax</option>
                                <option value="5">5% - Essential Goods</option>
                                <option value="12">12% - Standard Goods</option>
                                <option value="18" selected>18% - Most Goods</option>
                                <option value="28">28% - Luxury Items</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Inventory Details Section -->
                <div style="margin-bottom: 12px;">
                    <button type="button" onclick="toggleOptionalSection('inventoryDetails')" style="width: 100%; background: #f5f5f5; color: #666; border: 1px solid #ddd; padding: 12px 15px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
                        <span>üì¶ Inventory Details</span>
                        <span id="inventoryDetailsIcon" style="font-size: 18px; transition: transform 0.3s;">+</span>
                    </button>
                    <div id="inventoryDetailsSection" style="display: none; margin-top: 10px; padding: 15px; background: #f9f9f9; border-radius: 10px; border: 1px solid #e0e0e0;">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label" style="font-size: 12px; color: #666;">Minimum Stock Alert</label>
                            <input type="number" id="productMinStock" class="form-input" style="padding: 10px; font-size: 13px; border: 1px solid #ddd; border-radius: 8px;" placeholder="10" value="5">
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">Get alert when stock goes below this</div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label" style="font-size: 12px; color: #666;">Supplier Name</label>
                            <input type="text" id="productSupplier" class="form-input" style="padding: 10px; font-size: 13px; border: 1px solid #ddd; border-radius: 8px;" placeholder="e.g., ABC Traders">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label" style="font-size: 12px; color: #666;">Product Code / SKU</label>
                            <input type="text" id="productCode" class="form-input" style="padding: 10px; font-size: 13px; border: 1px solid #ddd; border-radius: 8px;" placeholder="Auto-generated">
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">Leave empty for auto-generation</div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="font-size: 12px; color: #666;">Expiry Date</label>
                            <input type="date" id="productExpiryDate" class="form-input" style="padding: 10px; font-size: 13px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>
                </div>
                
                <!-- Product Info Section -->
                <div style="margin-bottom: 12px;">
                    <button type="button" onclick="toggleOptionalSection('productInfo')" style="width: 100%; background: #f5f5f5; color: #666; border: 1px solid #ddd; padding: 12px 15px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
                        <span>‚ÑπÔ∏è Product Info</span>
                        <span id="productInfoIcon" style="font-size: 18px; transition: transform 0.3s;">+</span>
                    </button>
                    <div id="productInfoSection" style="display: none; margin-top: 10px; padding: 15px; background: #f9f9f9; border-radius: 10px; border: 1px solid #e0e0e0;">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label" style="font-size: 12px; color: #666;">Brand</label>
                            <input type="text" id="productBrand" class="form-input" style="padding: 10px; font-size: 13px; border: 1px solid #ddd; border-radius: 8px;" placeholder="e.g., Tata, Amul">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label" style="font-size: 12px; color: #666;">Type / Variant</label>
                            <input type="text" id="productVariant" class="form-input" style="padding: 10px; font-size: 13px; border: 1px solid #ddd; border-radius: 8px;" placeholder="e.g., Wheat Aata, Multigrain">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="font-size: 12px; color: #666;">Description</label>
                            <textarea id="productDescription" class="form-input" style="padding: 10px; font-size: 13px; border: 1px solid #ddd; border-radius: 8px; resize: vertical; min-height: 60px;" placeholder="Additional details about the product" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Image Section -->
                <div style="margin-bottom: 20px;">
                    <button type="button" onclick="toggleOptionalSection('productImage')" style="width: 100%; background: #f5f5f5; color: #666; border: 1px solid #ddd; padding: 12px 15px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
                        <span>üì∑ Product Image</span>
                        <span id="productImageIcon" style="font-size: 18px; transition: transform 0.3s;">+</span>
                    </button>
                    <div id="productImageSection" style="display: none; margin-top: 10px; padding: 15px; background: #f9f9f9; border-radius: 10px; border: 1px solid #e0e0e0;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <label for="productImageUpload" style="display: inline-block; background: #732C3F; color: white; padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                üìÅ Upload Image
                            </label>
                            <input type="file" id="productImageUpload" accept="image/*" style="display: none;" onchange="handleProductImageUpload(event)">
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 12px;">
                            <span style="color: #999; font-size: 12px;">OR</span>
                        </div>
                        
                        <button type="button" onclick="toggleBarcodeSection()" style="width: 100%; background: white; color: #666; border: 1px solid #ddd; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                            üì∑ Scan Barcode
                        </button>
                        
                        <div id="barcodeUploadSection" style="display: none; margin-top: 12px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                            <video id="barcodeVideo" autoplay playsinline style="width: 100%; border-radius: 8px; display: none;"></video>
                            <canvas id="barcodeCanvas" style="display: none;"></canvas>
                            <div id="barcodePreview" style="display: none;">
                                <img id="barcodeImage" style="width: 100%; border-radius: 8px; margin-bottom: 8px;">
                                <div style="text-align: center;">
                                    <span style="background: #4CAF50; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px;">‚úì Captured</span>
                                </div>
                            </div>
                            <div class="camera-buttons" id="cameraButtons" style="display: none; gap: 8px; margin-top: 8px;">
                                <button type="button" class="btn-camera" onclick="captureBarcode()" style="padding: 8px; font-size: 12px;">üì∏ Capture</button>
                                <button type="button" class="btn-camera secondary" onclick="closeBarcodeScanner()" style="padding: 8px; font-size: 12px;">‚úï Close</button>
                            </div>
                            <div style="text-align: center; margin-top: 8px;">
                                <label for="barcodeFileInput" class="btn-upload" style="padding: 8px 16px; font-size: 12px;">
                                    üìÅ Upload Barcode Image
                                </label>
                                <input type="file" id="barcodeFileInput" accept="image/*" style="display: none;" onchange="handleBarcodeUpload(event)">
                            </div>
                        </div>
                        
                        <div id="productImagePreview" style="display: none; margin-top: 12px; text-align: center;">
                            <img id="productImagePreviewImg" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #E8D5DA;">
                            <div style="margin-top: 8px;">
                                <button type="button" onclick="removeProductImage()" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">üóëÔ∏è Remove</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Save Button -->
                <button type="submit" class="btn-primary" style="padding: 14px; font-size: 15px; font-weight: 600; border-radius: 10px; background: #732C3F;">üíæ Save Product</button>
            </form>
            
            <!-- Product Variants Section (After Save) - OUTSIDE FORM -->
            <div id="productVariantsSection" style="display: none; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f9f9f9 0%, #fff5f7 100%); border-radius: 10px; border: 2px solid #732C3F; box-shadow: 0 4px 12px rgba(115, 44, 63, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 2px dashed #E8D5DA;">
                    <h3 style="margin: 0; color: #732C3F; font-size: 17px; font-weight: 700;">üì¶ Product Variants</h3>
                    <button type="button" onclick="openAddVariantModal()" style="background: linear-gradient(135deg, #732C3F 0%, #8B3A4F 100%); color: white; border: none; padding: 10px 18px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(115, 44, 63, 0.3); transition: all 0.3s;">
                        ‚ûï Add Variant
                    </button>
                </div>
                
                <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #732C3F;">
                    <p style="margin: 0; font-size: 13px; color: #666; line-height: 1.5;">
                        üí° <strong>Add different sizes/variants</strong> for this product (e.g., 50g ‚Çπ50, 100g ‚Çπ95, 200g ‚Çπ180)
                    </p>
                </div>
                
                <div id="variantsList" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Variants will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Variant Modal -->
    <div class="modal" id="addVariantModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title" id="variantModalTitle">‚ûï Add Variant</div>
                <button class="modal-close" onclick="closeAddVariantModal()">√ó</button>
            </div>
            
            <form id="variantForm" onsubmit="saveVariant(event)">
                <input type="hidden" id="editVariantId" value="">
                <input type="hidden" id="variantProductId" value="">
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: #333;">Size / Variant Name *</label>
                    <input type="text" id="variantSize" class="form-input" style="padding: 12px; font-size: 14px; border: 2px solid #E8D5DA; border-radius: 10px;" placeholder="e.g., 50g, 100g, 200g" required>
                    <div style="font-size: 11px; color: #999; margin-top: 4px;">Enter size or variant name</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 13px; font-weight: 600; color: #333;">Price (‚Çπ) *</label>
                        <input type="number" id="variantPrice" class="form-input" style="padding: 12px; font-size: 14px; border: 2px solid #E8D5DA; border-radius: 10px;" placeholder="50" step="0.01" required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 13px; font-weight: 600; color: #333;">Stock *</label>
                        <input type="number" id="variantStock" class="form-input" style="padding: 12px; font-size: 14px; border: 2px solid #E8D5DA; border-radius: 10px;" placeholder="100" required>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: #333;">Cost Price (‚Çπ)</label>
                    <input type="number" id="variantCost" class="form-input" style="padding: 12px; font-size: 14px; border: 2px solid #E8D5DA; border-radius: 10px;" placeholder="40" step="0.01">
                    <div style="font-size: 11px; color: #999; margin-top: 4px;">Optional - for profit tracking</div>
                </div>
                
                <button type="submit" class="btn-primary" style="padding: 12px; font-size: 14px; font-weight: 600; border-radius: 10px; background: #732C3F;">üíæ Save Variant</button>
            </form>
        </div>
    </div>
    
    <!-- Add Customer Modal -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üë§ Add New Customer</div>
                <button class="modal-close" onclick="closeAddCustomerModal()">√ó</button>
            </div>
            
            <form id="customerForm" onsubmit="saveCustomer(event)">
                <div class="form-group">
                    <label class="form-label">Customer Name *</label>
                    <input type="text" id="customerName" class="form-input" placeholder="e.g., Rajesh Kumar" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" id="customerPhone" class="form-input" placeholder="e.g., +91 9876543210" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="customerEmail" class="form-input" placeholder="e.g., customer@email.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea id="customerAddress" class="form-input" placeholder="e.g., 123 Main Street, City" rows="3" style="resize: vertical;"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Customer Type *</label>
                    <select id="customerType" class="form-select" required>
                        <option value="">Select Type</option>
                        <option value="regular">Regular</option>
                        <option value="vip">VIP</option>
                        <option value="wholesale">Wholesale</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Credit Limit (‚Çπ)</label>
                    <input type="number" id="customerCreditLimit" class="form-input" placeholder="e.g., 5000" step="0.01" value="0">
                </div>
                
                <button type="submit" class="btn-primary">üíæ Save Customer</button>
            </form>
        </div>
    </div>

    <!-- Settings Module -->
    <div class="card" id="settingsModule" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">‚öôÔ∏è Settings</h2>
        </div>
        
        <!-- Settings Options List -->
        <div style="display: flex; flex-direction: column; gap: 10px;">
            
            <!-- GST Option -->
            <div onclick="toggleSettingSection('gst')" style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #E8D5DA; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">üìã</div>
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: #732C3F;">GST</div>
                        <div style="font-size: 12px; color: #666;">Tax settings and GST number</div>
                    </div>
                </div>
                <div style="font-size: 20px; color: #732C3F;">‚Ä∫</div>
            </div>
            <div id="gstSection" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-top: -10px;">
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">GST Number</label>
                    <input type="text" id="gstNumber" placeholder="Enter GSTIN" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Default GST Rate</label>
                    <select id="defaultGST" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="0">0% - Nil Rated</option>
                        <option value="5">5% - Essential Goods</option>
                        <option value="12">12% - Standard Goods</option>
                        <option value="18" selected>18% - Most Goods</option>
                        <option value="28">28% - Luxury Items</option>
                    </select>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Discount Application</label>
                    <select id="discountTiming" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="before_tax">Before Tax (Discount on Subtotal)</option>
                        <option value="after_tax" selected>After Tax (Discount on Final Amount)</option>
                    </select>
                    <div style="font-size: 11px; color: #999; margin-top: 5px; padding: 8px; background: #fff; border-radius: 6px;">
                        <strong>Before Tax:</strong> ‚Çπ100 - ‚Çπ18 discount = ‚Çπ82 + 18% GST = ‚Çπ96.76<br>
                        <strong>After Tax:</strong> ‚Çπ100 + 18% GST = ‚Çπ118 - ‚Çπ18 discount = ‚Çπ100
                    </div>
                </div>
            </div>
            
            <!-- Payment Option -->
            <div onclick="toggleSettingSection('payment')" style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #E8D5DA; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">üí≥</div>
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: #732C3F;">Payment</div>
                        <div style="font-size: 12px; color: #666;">Payment methods configuration</div>
                    </div>
                </div>
                <div style="font-size: 20px; color: #732C3F;">‚Ä∫</div>
            </div>
            <div id="paymentSection" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-top: -10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">üíµ Cash</div>
                        <div style="font-size: 12px; color: #666;">Accept cash payments</div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                        <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #732C3F; transition: .4s; border-radius: 24px;"></span>
                    </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">üì± UPI</div>
                        <div style="font-size: 12px; color: #666;">PhonePe, GPay, Paytm</div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                        <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #732C3F; transition: .4s; border-radius: 24px;"></span>
                    </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">üí≥ Card</div>
                        <div style="font-size: 12px; color: #666;">Credit/Debit cards</div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                        <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #732C3F; transition: .4s; border-radius: 24px;"></span>
                    </label>
                </div>
            </div>
            
            <!-- Notifications Option -->
            <div onclick="toggleSettingSection('notifications')" style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #E8D5DA; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">üîî</div>
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: #732C3F;">Notifications</div>
                        <div style="font-size: 12px; color: #666;">Alert preferences and frequency</div>
                    </div>
                </div>
                <div style="font-size: 20px; color: #732C3F;">‚Ä∫</div>
            </div>
            <div id="notificationsSection" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-top: -10px;">
                <div id="notificationSettingsList">
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚è≥</div>
                        <p>Loading settings...</p>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Option -->
            <div onclick="toggleSettingSection('invoice')" style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #E8D5DA; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">üßæ</div>
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: #732C3F;">Invoice</div>
                        <div style="font-size: 12px; color: #666;">Invoice numbering and format</div>
                    </div>
                </div>
                <div style="font-size: 20px; color: #732C3F;">‚Ä∫</div>
            </div>
            <div id="invoiceSection" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-top: -10px;">
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Invoice Prefix</label>
                    <input type="text" id="invoicePrefix" value="INV" placeholder="e.g., INV" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Starting Number</label>
                    <input type="number" id="invoiceStartNumber" value="1001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Auto Numbering</div>
                        <div style="font-size: 12px; color: #666;">Generate invoice numbers automatically</div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                        <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #732C3F; transition: .4s; border-radius: 24px;"></span>
                    </label>
                </div>
            </div>
            
            <!-- Security Option -->
            <div onclick="toggleSettingSection('security')" style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #E8D5DA; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">üîí</div>
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: #732C3F;">Security</div>
                        <div style="font-size: 12px; color: #666;">PIN lock and password</div>
                    </div>
                </div>
                <div style="font-size: 20px; color: #732C3F;">‚Ä∫</div>
            </div>
            <div id="securitySection" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-top: -10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">PIN Lock</div>
                        <div style="font-size: 12px; color: #666;">Require PIN to open app</div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                        <input type="checkbox" style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                    </label>
                </div>
                <button onclick="changePassword()" style="background: #dc3545; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-size: 14px; font-weight: 600;">
                    üîë Change Password
                </button>
            </div>
            
            <!-- Backup and Restore Option -->
            <div onclick="toggleSettingSection('backup')" style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #E8D5DA; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">üíæ</div>
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: #732C3F;">Backup and Restore</div>
                        <div style="font-size: 12px; color: #666;">Data backup and recovery</div>
                    </div>
                </div>
                <div style="font-size: 20px; color: #732C3F;">‚Ä∫</div>
            </div>
            <div id="backupSection" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-top: -10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Auto Backup</div>
                        <div style="font-size: 12px; color: #666;">Automatic daily backups</div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                        <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #732C3F; transition: .4s; border-radius: 24px;"></span>
                    </label>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button onclick="backupData()" style="background: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600;">
                        üì• Backup Now
                    </button>
                    <button onclick="restoreData()" style="background: #17a2b8; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600;">
                        üì§ Restore
                    </button>
                </div>
            </div>
            
            <!-- Language and Time Option -->
            <div onclick="toggleSettingSection('language')" style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #E8D5DA; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">üåê</div>
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: #732C3F;">Language and Time</div>
                        <div style="font-size: 12px; color: #666;">Language, currency, date format</div>
                    </div>
                </div>
                <div style="font-size: 20px; color: #732C3F;">‚Ä∫</div>
            </div>
            <div id="languageSection" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-top: -10px;">
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Language</label>
                    <select id="appLanguage" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="en">English</option>
                        <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                        <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                        <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)</option>
                        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                    </select>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Currency</label>
                    <select id="appCurrency" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="INR">‚Çπ INR - Indian Rupee</option>
                        <option value="USD">$ USD - US Dollar</option>
                        <option value="EUR">‚Ç¨ EUR - Euro</option>
                        <option value="GBP">¬£ GBP - British Pound</option>
                    </select>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Date Format</label>
                    <select id="dateFormat" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                        <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                        <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                    </select>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Time Format</label>
                    <select id="timeFormat" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="12">12 Hour (AM/PM)</option>
                        <option value="24">24 Hour</option>
                    </select>
                </div>
            </div>
            
            <!-- Advanced Option -->
            <div onclick="toggleSettingSection('advanced')" style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #E8D5DA; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">‚ö°</div>
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: #732C3F;">Advanced</div>
                        <div style="font-size: 12px; color: #666;">Debug mode and cache</div>
                    </div>
                </div>
                <div style="font-size: 20px; color: #732C3F;">‚Ä∫</div>
            </div>
            <div id="advancedSection" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-top: -10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Debug Mode</div>
                        <div style="font-size: 12px; color: #666;">Show console logs</div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                        <input type="checkbox" style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                    </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Offline Mode</div>
                        <div style="font-size: 12px; color: #666;">Work without internet</div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                        <input type="checkbox" style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                    </label>
                </div>
                <button onclick="clearCache()" style="background: #ffc107; color: #000; border: none; padding: 12px; border-radius: 8px; width: 100%; font-size: 14px; font-weight: 600; margin-bottom: 10px;">
                    üóëÔ∏è Clear Cache
                </button>
                <button onclick="resetApp()" style="background: #dc3545; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-size: 14px; font-weight: 600;">
                    ‚ö†Ô∏è Reset App
                </button>
            </div>
            
        </div>
        
        <!-- Save Button -->
        <button onclick="saveSettings()" style="background: linear-gradient(135deg, #732C3F 0%, #8B3A47 100%); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: 700; box-shadow: 0 4px 15px rgba(114, 47, 55, 0.3); margin-top: 20px;">
            üíæ Save Settings
        </button>
        
        <!-- About Section -->
        <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 10px; text-align: center;">
            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">BizPulse Mobile ERP</div>
            <div style="font-size: 12px; color: #999;">Version 1.0.0</div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">¬© 2025 BizPulse. All rights reserved.</div>
        </div>
    </div>
    


    <script>
        console.log('üöÄ Simple Mobile App Started');
        
        // Helper function to format currency with at least 1 decimal
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '‚Çπ0.0';
            const num = parseFloat(amount);
            if (isNaN(num)) return '‚Çπ0.0';
            
            // Show 1 decimal if it's a whole number, otherwise show 2 decimals
            if (num % 1 === 0) {
                return '‚Çπ' + num.toFixed(1);
            } else {
                return '‚Çπ' + num.toFixed(2);
            }
        }
        
        // Auto-detect API Base URL
        const API_BASE_URL = window.location.origin;
        console.log('üåê API Base URL:', API_BASE_URL);
        
        // Toast notification function
        function showToast(message, type = 'info') {
            // Remove existing toast
            const existingToast = document.getElementById('toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                max-width: 90%;
                text-align: center;
                animation: slideDown 0.3s ease-out;
            `;
            
            // Add animation keyframes
            if (!document.getElementById('toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    @keyframes slideDown {
                        from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
                        to { transform: translateX(-50%) translateY(0); opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateX(-50%) translateY(0); opacity: 1; }
                        to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideUp 0.3s ease-out';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 3000);
            
            console.log(`üì¢ Toast [${type.toUpperCase()}]: ${message}`);
        }
        
        // Helper function for API calls
        async function apiCall(endpoint, options = {}) {
            try {
                const url = `${API_BASE_URL}${endpoint}`;
                console.log('üì° API Call:', url);
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('‚ùå API Error:', error);
                throw error;
            }
        }
        
        // Show loading screen, then check login status
        window.addEventListener('load', async function() {
            console.log('üîç Checking login status...');
            
            // First, verify with server if session is valid
            try {
                const response = await fetch('/api/auth/user-info');
                const userData = await response.json();
                
                if (userData && userData.user_id) {
                    // Valid server session exists
                    console.log('‚úÖ Valid session found:', userData.email || userData.username);
                    
                    // Hide loading screen
                    document.getElementById('loadingScreen').classList.add('hidden');
                    
                    // Show main app
                    document.getElementById('topBar').style.display = 'flex';
                    document.getElementById('bottomNav').style.display = 'flex';
                    document.getElementById('mainContent').style.display = 'block';
                    
                    // Update user email in menu
                    document.getElementById('userEmail').textContent = userData.email || userData.username || 'User';
                    
                    // Save login state
                    localStorage.setItem('bizpulse_login', JSON.stringify({
                        email: userData.email || userData.username,
                        userType: userData.user_type,
                        loginTime: new Date().toISOString()
                    }));
                    
                    // Restore last visited module
                    const lastModule = localStorage.getItem('bizpulse_current_module');
                    if (lastModule && lastModule !== 'dashboard') {
                        console.log('üìç Restoring last module:', lastModule);
                        showModule(lastModule);
                    } else {
                        loadDashboard();
                    }
                } else {
                    // No valid session, clear localStorage and show login
                    console.log('‚ùå No valid session, showing login screen');
                    localStorage.removeItem('bizpulse_login');
                    localStorage.removeItem('bizpulse_current_module');
                    showLoginScreen();
                }
            } catch (error) {
                // Error checking session, clear and show login
                console.error('‚ùå Error checking session:', error);
                localStorage.removeItem('bizpulse_login');
                localStorage.removeItem('bizpulse_current_module');
                showLoginScreen();
            }
            
            function showLoginScreen() {
                setTimeout(function() {
                    // Hide loading screen
                    document.getElementById('loadingScreen').classList.add('hidden');
                    
                    // Show login screen
                    setTimeout(function() {
                        document.getElementById('loginScreen').classList.add('show');
                    }, 500);
                }, 1000);
            }
        });
        
        // Login Handler
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // DEBUG: Log input values and types
            console.log('üîç DEBUG: Login attempt with:', email);
            console.log('üîç DEBUG: Input element type:', document.getElementById('loginEmail').type);
            console.log('üîç DEBUG: Template version: 2.0.2 - NO EMAIL VALIDATION');
            
            if (!email || !password) {
                alert('‚ùå Please enter email and password');
                return;
            }
            
            try {
                // Try employee/client login first
                const response = await fetch('/api/auth/client-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: email, password: password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Employee login successful:', result);
                    performLogin(email, result.user_type || 'employee', result.client_id);
                } else {
                    // Fallback to demo login
                    const savedUser = JSON.parse(localStorage.getItem('bizpulse_user') || '{"password":"demo123"}');
                    
                    if (email === 'bizpulse.erp@gmail.com' && password === savedUser.password) {
                        console.log('‚úÖ Admin login successful');
                        performLogin(email, 'admin', null);
                    } else {
                        alert('‚ùå Invalid credentials!\n\n' + (result.message || 'Please check your username and password'));
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                // Fallback to demo login on error
                const savedUser = JSON.parse(localStorage.getItem('bizpulse_user') || '{"password":"demo123"}');
                
                if (email === 'bizpulse.erp@gmail.com' && password === savedUser.password) {
                    console.log('‚úÖ Admin login successful (fallback)');
                    performLogin(email, 'admin', null);
                } else {
                    alert('‚ùå Login failed. Please try again.');
                }
            }
        }
        

        
        // Perform Login (Common function)
        function performLogin(email, userType = 'admin', clientId = null) {
            console.log('‚úÖ Login successful:', email, userType);
            
            // Save login state with user type and client ID
            localStorage.setItem('bizpulse_login', JSON.stringify({
                email: email,
                userType: userType,
                clientId: clientId,
                loginTime: new Date().toISOString()
            }));
            
            // Set initial module to dashboard
            localStorage.setItem('bizpulse_current_module', 'dashboard');
            
            // Hide login screen
            document.getElementById('loginScreen').classList.remove('show');
            
            // Show main app
            document.getElementById('topBar').style.display = 'flex';
            document.getElementById('bottomNav').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'block';
            
            // Update user email in menu
            document.getElementById('userEmail').textContent = email;
            
            // Load dashboard data
            loadDashboard();
        }
        
        // Logout Handler
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                console.log('üëã Logging out...');
                
                try {
                    // Call server logout API
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                } catch (error) {
                    console.error('Logout API error:', error);
                }
                
                // Clear localStorage
                localStorage.removeItem('bizpulse_login');
                localStorage.removeItem('bizpulse_current_module');
                localStorage.removeItem('bizpulse_user');
                
                // Hide main app
                document.getElementById('topBar').style.display = 'none';
                document.getElementById('bottomNav').style.display = 'none';
                document.getElementById('mainContent').style.display = 'none';
                
                // Close menu
                closeMenu();
                
                // Show login screen
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginScreen').classList.add('show');
                
                // Reset form
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                
                console.log('‚úÖ Logged out successfully');
            }
        }
        
        // Toggle Menu
        function toggleMenu() {
            console.log('Menu toggle clicked');
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('overlay');
            
            if (menu.classList.contains('open')) {
                closeMenu();
            } else {
                menu.classList.add('open');
                overlay.classList.add('show');
                loadMenuItems();
            }
        }
        
        function closeMenu() {
            document.getElementById('sideMenu').classList.remove('open');
            document.getElementById('overlay').classList.remove('show');
        }
        
        // Load Menu Items
        async function loadMenuItems() {
            console.log('Loading menu items...');
            const container = document.getElementById('menuItems');
            
            try {
                console.log('üìã Loading menu...');
                const data = await apiCall('/api/modules');
                console.log('‚úÖ Menu data loaded');
                
                let html = '';
                
                // Core modules
                if (data.core_modules) {
                    html += '<div style="padding: 10px 20px; font-size: 12px; opacity: 0.7;">CORE</div>';
                    data.core_modules.forEach(m => {
                        // Special handling for dashboard
                        if (m.route === 'dashboard') {
                            html += `<div class="menu-item" onclick="showDashboardOnly()">${m.icon} ${m.name}</div>`;
                        } else {
                            html += `<div class="menu-item" onclick="showModule('${m.route}')">${m.icon} ${m.name}</div>`;
                        }
                    });
                }
                
                // Inventory
                if (data.inventory_modules) {
                    html += '<div style="padding: 10px 20px; font-size: 12px; opacity: 0.7;">INVENTORY</div>';
                    data.inventory_modules.forEach(m => {
                        html += `<div class="menu-item" onclick="showModule('${m.route}')">${m.icon} ${m.name}</div>`;
                    });
                }
                
                // Customer
                if (data.customer_modules) {
                    html += '<div style="padding: 10px 20px; font-size: 12px; opacity: 0.7;">CUSTOMER</div>';
                    data.customer_modules.forEach(m => {
                        html += `<div class="menu-item" onclick="showModule('${m.route}')">${m.icon} ${m.name}</div>`;
                    });
                }
                
                // Add Earnings manually (not in API yet)
                html += '<div style="padding: 10px 20px; font-size: 12px; opacity: 0.7;">ANALYTICS</div>';
                html += '<div class="menu-item" onclick="showModule(\'earnings\')">üíé Earnings & Profit</div>';
                html += '<div class="menu-item" onclick="showModule(\'reports\')">üìä Reports</div>';
                
                // Add Settings
                html += '<div style="padding: 10px 20px; font-size: 12px; opacity: 0.7;">SYSTEM</div>';
                html += '<div class="menu-item" onclick="showModule(\'settings\')">‚öôÔ∏è Settings</div>';
                
                container.innerHTML = html;
                console.log('‚úÖ Menu loaded');
            } catch (error) {
                console.error('Menu load error:', error);
                container.innerHTML = '<div style="padding: 20px;">Error loading menu</div>';
            }
        }
        
        // Load Dashboard Data
        async function loadDashboard() {
            console.log('üìä Loading dashboard...');
            
            try {
                // Products
                console.log('üì¶ Fetching products...');
                const products = await apiCall('/api/products');
                document.getElementById('totalProducts').textContent = products.length;
                console.log(`‚úÖ Products loaded: ${products.length}`);
                
                // Customers
                console.log('üë• Fetching customers...');
                const customers = await apiCall('/api/customers');
                document.getElementById('totalCustomers').textContent = customers.length;
                console.log(`‚úÖ Customers loaded: ${customers.length}`);
                
                // Sales
                console.log('üí∞ Fetching sales...');
                const sales = await apiCall('/api/sales/summary');
                document.getElementById('totalSales').textContent = formatCurrency(sales.today?.total || 0);
                document.getElementById('totalBills').textContent = sales.today?.count || 0;
                console.log(`‚úÖ Sales loaded: ${formatCurrency(sales.today?.total || 0)}`);
                
                console.log('‚úÖ Dashboard loaded successfully!');
            } catch (error) {
                console.error('‚ùå Dashboard error:', error);
                alert('Failed to load dashboard. Please check:\n1. Server is running\n2. Same WiFi network\n3. Correct IP address');
            }
        }
        
        let allProducts = [];
        let currentCategory = 'all';
        
        // Show Dashboard Only (Home Button)
        function showDashboardOnly() {
            console.log('üè† Showing dashboard only');
            
            // Save dashboard as current module
            localStorage.setItem('bizpulse_current_module', 'dashboard');
            console.log('üíæ Saved current module: dashboard');
            
            // Hide all modules
            document.getElementById('dataDisplay').style.display = 'none';
            document.getElementById('productsModule').style.display = 'none';
            document.getElementById('customersModule').style.display = 'none';
            document.getElementById('creditModule').style.display = 'none';
            document.getElementById('billingModule').style.display = 'none';
            document.getElementById('salesModule').style.display = 'none';
            document.getElementById('earningsModule').style.display = 'none';
            document.getElementById('reportsModule').style.display = 'none';
            document.getElementById('settingsModule').style.display = 'none';
            
            // Show only dashboard cards
            document.querySelectorAll('.card').forEach(card => {
                if (!card.id || (!card.id.includes('Module') && card.id !== 'dataDisplay')) {
                    card.style.display = 'block';
                }
            });
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Update active nav button
            updateActiveNav('home');
        }
        
        // Update Active Navigation Button
        function updateActiveNav(activeModule) {
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active-nav');
            });
            
            // Add active class to current module
            const activeNav = document.getElementById(`nav-${activeModule}`);
            if (activeNav) {
                activeNav.classList.add('active-nav');
            }
        }
        
        // Show Module Data
        async function showModule(module) {
            console.log('Loading module:', module);
            closeMenu();
            
            // Save current module to localStorage
            localStorage.setItem('bizpulse_current_module', module);
            console.log('üíæ Saved current module:', module);
            
            // Update active navigation
            updateActiveNav(module);
            
            // Hide ALL modules first (comprehensive cleanup)
            const allModules = [
                'dataDisplay',
                'productsModule',
                'customersModule',
                'creditModule',
                'billingModule',
                'salesModule',
                'earningsModule',
                'reportsModule',
                'settingsModule'
            ];
            
            allModules.forEach(moduleId => {
                const element = document.getElementById(moduleId);
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // Also hide all dashboard cards
            document.querySelectorAll('.card').forEach(card => {
                // Only hide cards that are part of dashboard (not module cards)
                if (card.id && allModules.includes(card.id)) {
                    card.style.display = 'none';
                } else if (!card.id) {
                    // Hide cards without IDs (dashboard cards)
                    card.style.display = 'none';
                }
            });
            
            if (module === 'products') {
                document.getElementById('productsModule').style.display = 'block';
                await loadProducts();
                return;
            }
            
            if (module === 'billing') {
                document.getElementById('billingModule').style.display = 'block';
                await loadBillingProducts();
                setupBillingSearch();
                return;
            }
            
            if (module === 'customers') {
                document.getElementById('customersModule').style.display = 'block';
                await loadCustomers();
                return;
            }
            
            if (module === 'credit') {
                document.getElementById('creditModule').style.display = 'block';
                await loadCreditBills();
                return;
            }
            
            if (module === 'sales') {
                document.getElementById('salesModule').style.display = 'block';
                await loadSales();
                return;
            }
            
            if (module === 'earnings') {
                document.getElementById('earningsModule').style.display = 'block';
                await loadEarnings();
                return;
            }
            
            if (module === 'reports') {
                document.getElementById('reportsModule').style.display = 'block';
                // Reports module doesn't need initial data load
                return;
            }
            
            if (module === 'settings') {
                document.getElementById('settingsModule').style.display = 'block';
                loadSettings();
                // Notification settings will load when user clicks on Notifications option
                return;
            }
            
            // For other modules, use old display
            document.getElementById('dataDisplay').style.display = 'block';
            
            const title = document.getElementById('dataTitle');
            const content = document.getElementById('dataContent');
            
            title.textContent = module.charAt(0).toUpperCase() + module.slice(1);
            content.innerHTML = '<p>Loading...</p>';
            
            try {
                let data;
                let html = '';
                
                if (module === 'customers') {
                    data = await fetch('/api/customers').then(r => r.json());
                    html = '<div>';
                    data.forEach(c => {
                        html += `<div class="list-item">
                            <div><strong>${c.name}</strong><br><small>${c.phone}</small></div>
                            <div><small>${c.email || 'No email'}</small></div>
                        </div>`;
                    });
                    html += '</div>';
                } else if (module === 'sales') {
                    data = await fetch('/api/sales/summary').then(r => r.json());
                    html = `<div>
                        <div class="stat-box" style="margin: 10px 0;">
                            <div class="stat-value">${formatCurrency(data.today?.total || 0)}</div>
                            <div class="stat-label">Today's Sales</div>
                        </div>
                        <div class="stat-box" style="margin: 10px 0;">
                            <div class="stat-value">${formatCurrency(data.week?.total || 0)}</div>
                            <div class="stat-label">This Week</div>
                        </div>
                        <div class="stat-box" style="margin: 10px 0;">
                            <div class="stat-value">${formatCurrency(data.month?.total || 0)}</div>
                            <div class="stat-label">This Month</div>
                        </div>
                    </div>`;
                } else {
                    html = '<p>Module coming soon...</p>';
                }
                
                content.innerHTML = html;
                console.log('‚úÖ Module loaded:', module);
            } catch (error) {
                console.error('Module error:', error);
                content.innerHTML = '<p style="color: red;">Error loading data</p>';
            }
        }
        
        // Load Products
        async function loadProducts() {
            try {
                console.log('üì¶ Loading products...');
                allProducts = await apiCall('/api/products');
                console.log(`‚úÖ Products loaded: ${allProducts.length}`);
                displayProducts(allProducts);
            } catch (error) {
                console.error('‚ùå Error loading products:', error);
                document.getElementById('productsList').innerHTML = '<p style="text-align: center; color: red;">Failed to load products. Check connection.</p>';
            }
        }
        
        // Display Products in Table Format with S.No
        function displayProducts(products) {
            const container = document.getElementById('productsList');
            
            if (products.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No products found</p>';
                return;
            }
            
            // Table format - compact and clean with S.No
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px; background: white; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #732C3F; color: white;">
                                <th style="padding: 8px 5px; text-align: center; font-weight: 600; width: 35px;">S.No</th>
                                <th style="padding: 8px 6px; text-align: left; font-weight: 600;">Product</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; width: 60px;">Stock</th>
                                <th style="padding: 8px 6px; text-align: right; font-weight: 600; width: 70px;">Price</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            products.forEach((product, index) => {
                const stockStatus = product.stock === 0 ? 'out' : (product.stock <= product.min_stock ? 'low' : 'good');
                const stockColor = product.stock === 0 ? '#e74c3c' : (product.stock <= product.min_stock ? '#f39c12' : '#27ae60');
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                
                html += `
                    <tr style="background: ${bgColor}; border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 8px 5px; text-align: center; font-weight: 600; color: #7f8c8d;">
                            ${index + 1}
                        </td>
                        <td style="padding: 8px 6px;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 2px; font-size: 13px;">${product.name}</div>
                            <div style="font-size: 10px; color: #7f8c8d;">${product.category}</div>
                        </td>
                        <td style="padding: 8px 6px; text-align: center;">
                            <span style="background: ${stockColor}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                                ${product.stock}
                            </span>
                        </td>
                        <td style="padding: 8px 6px; text-align: right; font-weight: 600; color: #732C3F; font-size: 13px;">
                            ‚Çπ${product.price}
                        </td>
                        <td style="padding: 8px 6px; text-align: center;">
                            <button onclick="editProduct('${product.id}')" style="background: #3498db; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-right: 3px; cursor: pointer;">‚úèÔ∏è Edit</button>
                            <button onclick="deleteProduct('${product.id}')" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">üóëÔ∏è Del</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Filter Products by Search
        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            let filtered = allProducts;
            
            if (currentCategory !== 'all') {
                filtered = filtered.filter(p => p.category === currentCategory);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.category.toLowerCase().includes(searchTerm)
                );
            }
            
            displayProducts(filtered);
        }
        
        // Filter by Category
        function filterByCategory(category) {
            currentCategory = category;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            filterProducts();
        }
        
        let barcodeStream = null;
        let barcodeImageData = null;
        
        // Add Product Form
        function showAddProductForm() {
            document.getElementById('addProductModal').classList.add('show');
            document.getElementById('productForm').reset();
            document.getElementById('editProductId').value = '';
            document.getElementById('productModalTitle').textContent = '‚ûï Add New Product';
            document.getElementById('barcodeUploadSection').style.display = 'none';
            document.getElementById('barcodePreview').style.display = 'none';
            document.getElementById('newCategorySection').style.display = 'none';
            
            // Reset all optional sections to collapsed state
            closeAllOptionalSections();
            
            barcodeImageData = null;
        }
        
        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.remove('show');
            document.getElementById('productVariantsSection').style.display = 'none';
            closeBarcodeScanner();
        }
        
        // ========== PRODUCT VARIANTS FUNCTIONS ==========
        
        let currentProductIdForVariants = null;
        
        // Show variants section after product save
        function showVariantsSection(productId) {
            console.log('[VARIANTS] Showing variants section for product:', productId);
            currentProductIdForVariants = productId;
            const variantsSection = document.getElementById('productVariantsSection');
            if (variantsSection) {
                variantsSection.style.display = 'block';
                console.log('[VARIANTS] Variants section display set to block');
                
                // Add attention-grabbing animation
                variantsSection.style.animation = 'slideInUp 0.5s ease-out';
                
                // Scroll to variants section smoothly
                setTimeout(() => {
                    variantsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                    // Flash animation to grab attention
                    variantsSection.style.animation = 'pulse 0.5s ease-in-out 2';
                }, 300);
                
                loadProductVariants(productId);
            } else {
                console.error('[VARIANTS] Variants section element not found!');
            }
        }
        
        // Load product variants
        async function loadProductVariants(productId) {
            console.log('[VARIANTS] Loading variants for product:', productId);
            try {
                const response = await fetch(`/api/products/${productId}/variants`);
                const data = await response.json();
                console.log('[VARIANTS] API Response:', data);
                
                if (data.success && data.variants) {
                    console.log('[VARIANTS] Found', data.variants.length, 'variants');
                    displayVariants(data.variants);
                } else {
                    console.log('[VARIANTS] No variants found');
                    document.getElementById('variantsList').innerHTML = '<p style="text-align: center; color: #999; padding: 15px; background: white; border-radius: 8px; border: 2px dashed #E8D5DA;">No variants added yet. Click "‚ûï Add Variant" to create one!</p>';
                }
            } catch (error) {
                console.error('[VARIANTS] Error loading variants:', error);
                document.getElementById('variantsList').innerHTML = '<p style="text-align: center; color: #f44336; padding: 10px;">Failed to load variants</p>';
            }
        }
        
        // Display variants list
        function displayVariants(variants) {
            console.log('[VARIANTS] Displaying variants:', variants);
            const container = document.getElementById('variantsList');
            
            if (!variants || variants.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 15px; background: white; border-radius: 8px; border: 2px dashed #E8D5DA;">No variants added yet. Click "‚ûï Add Variant" to create one!</p>';
                return;
            }
            
            let html = '';
            variants.forEach(variant => {
                html += `
                    <div style="background: white; padding: 14px; border-radius: 8px; border: 2px solid #E8D5DA; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #732C3F; margin-bottom: 6px; font-size: 15px;">üì¶ ${variant.variant_name || variant.size}</div>
                            <div style="font-size: 13px; color: #666;">
                                <span style="font-weight: 600; color: #4CAF50;">‚Çπ${variant.price}</span> | Stock: <span style="font-weight: 600;">${variant.stock}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editVariant('${variant.id}')" style="background: #FF9800; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 600;">‚úèÔ∏è</button>
                            <button onclick="deleteVariant('${variant.id}')" style="background: #f44336; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 600;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            console.log('[VARIANTS] Variants displayed successfully');
        }
        
        // Open add variant modal
        function openAddVariantModal() {
            console.log('[VARIANTS] Opening add variant modal for product:', currentProductIdForVariants);
            if (!currentProductIdForVariants) {
                showToast('‚ùå Please save the product first', 'error');
                console.error('[VARIANTS] No product ID set!');
                return;
            }
            
            document.getElementById('addVariantModal').classList.add('show');
            document.getElementById('variantForm').reset();
            document.getElementById('editVariantId').value = '';
            document.getElementById('variantProductId').value = currentProductIdForVariants;
            document.getElementById('variantModalTitle').textContent = '‚ûï Add Variant';
            console.log('[VARIANTS] Variant modal opened');
        }
        
        // Close add variant modal
        function closeAddVariantModal() {
            document.getElementById('addVariantModal').classList.remove('show');
        }
        
        // Save variant
        async function saveVariant(event) {
            event.preventDefault();
            console.log('[VARIANTS] Saving variant...');
            
            const variantId = document.getElementById('editVariantId').value;
            const productId = document.getElementById('variantProductId').value;
            const isEdit = variantId !== '';
            
            const variantData = {
                variant_name: document.getElementById('variantSize').value.trim(),
                size: document.getElementById('variantSize').value.trim(),
                price: parseFloat(document.getElementById('variantPrice').value),
                stock: parseInt(document.getElementById('variantStock').value),
                cost: parseFloat(document.getElementById('variantCost').value) || 0
            };
            
            console.log('[VARIANTS] Variant data:', variantData);
            
            try {
                let response;
                if (isEdit) {
                    console.log('[VARIANTS] Updating variant:', variantId);
                    response = await fetch(`/api/products/variants/${variantId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(variantData)
                    });
                } else {
                    console.log('[VARIANTS] Creating new variant for product:', productId);
                    response = await fetch(`/api/products/${productId}/variants`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(variantData)
                    });
                }
                
                const result = await response.json();
                console.log('[VARIANTS] Save response:', result);
                
                if (response.ok || response.status === 201) {
                    showToast(isEdit ? '‚úÖ Variant updated!' : '‚úÖ Variant added!', 'success');
                    closeAddVariantModal();
                    loadProductVariants(productId);
                } else {
                    showToast('‚ùå ' + (result.error || 'Failed to save variant'), 'error');
                    console.error('[VARIANTS] Save failed:', result);
                }
            } catch (error) {
                console.error('[VARIANTS] Network error:', error);
                showToast('‚ùå Network error', 'error');
            }
        }
        
        // Edit variant
        async function editVariant(variantId) {
            try {
                // For now, just open modal - in production, load variant data
                document.getElementById('addVariantModal').classList.add('show');
                document.getElementById('editVariantId').value = variantId;
                document.getElementById('variantModalTitle').textContent = '‚úèÔ∏è Edit Variant';
                showToast('‚ÑπÔ∏è Edit functionality - load variant data here', 'info');
            } catch (error) {
                console.error('Error editing variant:', error);
            }
        }
        
        // Delete variant
        async function deleteVariant(variantId) {
            if (!confirm('Delete this variant?')) return;
            
            try {
                const response = await fetch(`/api/products/variants/${variantId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('‚úÖ Variant deleted!', 'success');
                    loadProductVariants(currentProductIdForVariants);
                } else {
                    showToast('‚ùå ' + (result.error || 'Failed to delete'), 'error');
                }
            } catch (error) {
                console.error('Error deleting variant:', error);
                showToast('‚ùå Network error', 'error');
            }
        }
        
        // Toggle Optional Sections (Collapsible)
        function toggleOptionalSection(sectionName) {
            const section = document.getElementById(sectionName + 'Section');
            const icon = document.getElementById(sectionName + 'Icon');
            
            if (section.style.display === 'none' || section.style.display === '') {
                // Open section
                section.style.display = 'block';
                icon.textContent = '‚àí';
                icon.style.transform = 'rotate(0deg)';
            } else {
                // Close section
                section.style.display = 'none';
                icon.textContent = '+';
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        // Close all optional sections
        function closeAllOptionalSections() {
            const sections = ['pricingDetails', 'inventoryDetails', 'productInfo', 'productImage'];
            sections.forEach(sectionName => {
                const section = document.getElementById(sectionName + 'Section');
                const icon = document.getElementById(sectionName + 'Icon');
                if (section) {
                    section.style.display = 'none';
                }
                if (icon) {
                    icon.textContent = '+';
                }
            });
        }
        
        // Handle Product Image Upload
        function handleProductImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('productImagePreview');
                const img = document.getElementById('productImagePreviewImg');
                img.src = e.target.result;
                preview.style.display = 'block';
                
                // Store image data for upload
                window.productImageData = e.target.result;
                
                showToast('‚úÖ Image uploaded successfully!', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        // Remove Product Image
        function removeProductImage() {
            document.getElementById('productImagePreview').style.display = 'none';
            document.getElementById('productImagePreviewImg').src = '';
            document.getElementById('productImageUpload').value = '';
            window.productImageData = null;
            showToast('üóëÔ∏è Image removed', 'info');
        }
        
        // Toggle Barcode Scanner Section
        function toggleBarcodeSection() {
            const section = document.getElementById('barcodeUploadSection');
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                openBarcodeScanner();
            } else {
                section.style.display = 'none';
                closeBarcodeScanner();
            }
        }
        
        // Handle Category Change
        function handleCategoryChange() {
            const categorySelect = document.getElementById('productCategory');
            const newCategorySection = document.getElementById('newCategorySection');
            
            if (categorySelect.value === '__add_new__') {
                newCategorySection.style.display = 'block';
                document.getElementById('newCategoryInput').focus();
            } else {
                newCategorySection.style.display = 'none';
            }
        }
        
        // Add New Category
        function addNewCategory() {
            const newCategoryInput = document.getElementById('newCategoryInput');
            const categorySelect = document.getElementById('productCategory');
            const newCategory = newCategoryInput.value.trim();
            
            if (newCategory) {
                // Add new option before "Add New"
                const newOption = document.createElement('option');
                newOption.value = newCategory;
                newOption.textContent = newCategory;
                categorySelect.insertBefore(newOption, categorySelect.lastElementChild);
                
                // Select the new category
                categorySelect.value = newCategory;
                
                // Hide the new category section
                document.getElementById('newCategorySection').style.display = 'none';
                newCategoryInput.value = '';
                
                showToast('‚úì Category added successfully!');
            }
        }
        
        // Cancel New Category
        function cancelNewCategory() {
            document.getElementById('newCategorySection').style.display = 'none';
            document.getElementById('newCategoryInput').value = '';
            document.getElementById('productCategory').value = '';
        }
        
        // Edit Product
        function editProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            // Populate form with product data
            document.getElementById('editProductId').value = product.id;
            document.getElementById('productCode').value = product.code;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productCost').value = product.cost;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productMinStock').value = product.min_stock;
            document.getElementById('productUnit').value = product.unit;
            document.getElementById('productExpiryDate').value = product.expiry_date || '';
            
            // Update modal title
            document.getElementById('productModalTitle').textContent = '‚úèÔ∏è Edit Product';
            
            // Show modal
            document.getElementById('addProductModal').classList.add('show');
        }
        
        // Open Barcode Scanner
        async function openBarcodeScanner() {
            const section = document.getElementById('barcodeUploadSection');
            section.style.display = 'block';
            
            // Check if camera is supported
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showUploadOnlyOption(section);
                return;
            }
            
            // Check if we're on HTTPS or localhost (required for camera)
            const isSecure = window.location.protocol === 'https:' || 
                           window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1';
            
            if (!isSecure) {
                alert('‚ö†Ô∏è Camera requires HTTPS!\n\n' +
                      'üì± Your browser blocks camera on HTTP for security.\n\n' +
                      '‚úÖ Solution: Use "Upload Barcode Image" option below\n\n' +
                      '(Camera works on HTTPS or localhost only)');
                showUploadOnlyOption(section);
                return;
            }
            
            // Show loading message - permission popup will appear automatically
            section.innerHTML = `
                <div style="text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white; margin-bottom: 15px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üì∑</div>
                    <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Requesting Camera Access...</p>
                    <p style="font-size: 13px; opacity: 0.9;">Browser will ask for permission</p>
                    <p style="font-size: 12px; opacity: 0.8; margin-top: 10px;">üëÜ Click "Allow" when popup appears</p>
                </div>
            `;
            
            try {
                // Request camera permission - Browser automatically shows permission popup
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Use back camera on mobile
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                // Success! Show camera preview with payment app style animation
                section.innerHTML = `
                    <div class="camera-container">
                        <div style="position: relative;">
                            <video id="barcodeVideo" autoplay playsinline style="width: 100%; border-radius: 10px; background: #000;"></video>
                            <canvas id="barcodeCanvas" style="display: none;"></canvas>
                            
                            <!-- Scanning Overlay - Payment App Style -->
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 300px; height: 150px; border: 3px solid #4CAF50; border-radius: 10px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); pointer-events: none;">
                                <div style="position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 5px 15px; border-radius: 15px; font-size: 12px; font-weight: 600; white-space: nowrap;">
                                    üì± Align barcode here
                                </div>
                                <!-- Scanning line animation -->
                                <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, #4CAF50, transparent); animation: scan 2s linear infinite;"></div>
                            </div>
                        </div>
                        
                        <style>
                            @keyframes scan {
                                0% { top: 0; }
                                50% { top: 100%; }
                                100% { top: 0; }
                            }
                        </style>
                        
                        <div id="barcodePreview" style="display: none;">
                            <img id="barcodeImage" style="width: 100%; border-radius: 10px; margin-bottom: 10px;">
                            <div style="text-align: center; margin-bottom: 15px;">
                                <span style="background: #4CAF50; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px;">‚úì Barcode Captured</span>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 10px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                            <div style="color: #4CAF50; font-weight: 600; margin-bottom: 5px;">üîç Scanning automatically...</div>
                            <div style="font-size: 12px; color: #666;">Align barcode within the green box</div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 10px;">
                            <button type="button" class="btn-camera secondary" onclick="closeBarcodeScanner()" style="padding: 10px 20px;">‚úï Close Scanner</button>
                        </div>
                        
                        <div style="text-align: center; margin-top: 10px;">
                            <label for="barcodeFileInput" class="btn-upload">
                                üìÅ Or Upload Image
                            </label>
                            <input type="file" id="barcodeFileInput" accept="image/*" style="display: none;" onchange="handleBarcodeUpload(event)">
                        </div>
                    </div>
                    
                    <div class="divider-text">Product Details</div>
                `;
                
                const video = document.getElementById('barcodeVideo');
                barcodeStream = stream;
                video.srcObject = stream;
                
                // Start real-time barcode detection when video loads
                video.addEventListener('loadedmetadata', () => {
                    startBarcodeDetection();
                });
                
                console.log('‚úÖ Camera access granted - live preview active');
            } catch (error) {
                console.error('Camera error:', error);
                handleCameraError(error, section);
            }
        }
        
        // Show upload-only option
        function showUploadOnlyOption(section) {
            section.innerHTML = `
                <div class="camera-container">
                    <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-size: 36px; margin-bottom: 10px;">üìÅ</div>
                        <p style="color: #856404; margin-bottom: 5px; font-weight: 600;">Camera Not Available</p>
                        <p style="font-size: 12px; color: #856404;">Use upload option below</p>
                    </div>
                    
                    <div id="barcodePreview" style="display: none;">
                        <img id="barcodeImage" style="width: 100%; border-radius: 10px; margin-bottom: 10px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <span style="background: #4CAF50; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px;">‚úì Barcode Uploaded</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <label for="barcodeFileInput" class="btn-upload" style="display: inline-block; padding: 14px 24px; font-size: 16px;">
                            üìÅ Upload Barcode Image
                        </label>
                        <input type="file" id="barcodeFileInput" accept="image/*" style="display: none;" onchange="handleBarcodeUpload(event)">
                    </div>
                </div>
                
                <div class="divider-text">Product Details</div>
            `;
        }
        
        // Handle camera errors
        function handleCameraError(error, section) {
            let title = '‚ùå Camera Access Failed';
            let message = '';
            let instructions = '';
            
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                title = 'üîí Permission Denied';
                message = 'You blocked camera access';
                instructions = `
                    <div style="text-align: left; font-size: 12px; color: #666; margin-top: 10px; padding: 10px; background: white; border-radius: 8px;">
                        <strong>To enable camera:</strong><br>
                        1. Tap address bar (üîí icon)<br>
                        2. Find "Camera" permission<br>
                        3. Change to "Allow"<br>
                        4. Refresh page & try again
                    </div>
                `;
            } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                title = 'üì∑ No Camera Found';
                message = 'No camera detected on device';
            } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                title = '‚ö†Ô∏è Camera In Use';
                message = 'Camera is being used by another app';
                instructions = '<div style="font-size: 12px; color: #666; margin-top: 8px;">Close other apps using camera</div>';
            } else {
                message = error.message || 'Unknown error occurred';
            }
            
            // Show error with upload option
            section.innerHTML = `
                <div class="camera-container">
                    <div style="text-align: center; padding: 20px; background: #ffebee; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-size: 36px; margin-bottom: 10px;">üì∑</div>
                        <p style="color: #c62828; margin-bottom: 5px; font-weight: 600;">${title}</p>
                        <p style="font-size: 13px; color: #c62828;">${message}</p>
                        ${instructions}
                    </div>
                    
                    <div id="barcodePreview" style="display: none;">
                        <img id="barcodeImage" style="width: 100%; border-radius: 10px; margin-bottom: 10px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <span style="background: #4CAF50; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px;">‚úì Barcode Uploaded</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <label for="barcodeFileInput" class="btn-upload" style="display: inline-block; padding: 14px 24px; font-size: 16px;">
                            üìÅ Upload Barcode Image Instead
                        </label>
                        <input type="file" id="barcodeFileInput" accept="image/*" style="display: none;" onchange="handleBarcodeUpload(event)">
                    </div>
                </div>
                
                <div class="divider-text">Product Details</div>
            `;
        }
        
        // Capture Barcode
        function captureBarcode() {
            const video = document.getElementById('barcodeVideo');
            const canvas = document.getElementById('barcodeCanvas');
            const preview = document.getElementById('barcodePreview');
            const image = document.getElementById('barcodeImage');
            const buttons = document.getElementById('cameraButtons');
            
            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // Get image data
            barcodeImageData = canvas.toDataURL('image/jpeg');
            
            // Show preview
            image.src = barcodeImageData;
            preview.style.display = 'block';
            video.style.display = 'none';
            buttons.style.display = 'none';
            
            // Stop camera
            if (barcodeStream) {
                barcodeStream.getTracks().forEach(track => track.stop());
                barcodeStream = null;
            }
            
            // Auto-fill barcode to product code (simulate barcode reading)
            try {
                // Generate a sample barcode from timestamp (in real app, use barcode reader library)
                const timestamp = Date.now().toString();
                const barcodeValue = timestamp.slice(-8); // Last 8 digits as barcode
                
                // Auto-fill product code field
                const productCodeField = document.getElementById('productCode');
                if (productCodeField) {
                    productCodeField.value = barcodeValue;
                    
                    // Show success message
                    showToast('‚úÖ Barcode scanned: ' + barcodeValue, 'success');
                    
                    // Focus on next field (product name)
                    const productNameField = document.getElementById('productName');
                    if (productNameField) {
                        setTimeout(() => productNameField.focus(), 500);
                    }
                }
            } catch (error) {
                console.error('Barcode processing error:', error);
                showToast('‚ö†Ô∏è Barcode captured, please enter code manually', 'warning');
            }
            
            console.log('‚úÖ Barcode captured and processed');
        }
        
        // Handle Barcode Upload
        function handleBarcodeUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('‚ùå Please select an image file');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå Image too large!\n\nPlease select an image under 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                barcodeImageData = e.target.result;
                
                const preview = document.getElementById('barcodePreview');
                const image = document.getElementById('barcodeImage');
                const section = document.getElementById('barcodeUploadSection');
                
                if (image && preview) {
                    image.src = barcodeImageData;
                    preview.style.display = 'block';
                    section.style.display = 'block';
                    
                    // Hide camera if it was showing
                    const video = document.getElementById('barcodeVideo');
                    const buttons = document.getElementById('cameraButtons');
                    if (video) video.style.display = 'none';
                    if (buttons) buttons.style.display = 'none';
                    
                    // Stop camera stream if active
                    if (barcodeStream) {
                        barcodeStream.getTracks().forEach(track => track.stop());
                        barcodeStream = null;
                    }
                    
                    console.log('‚úÖ Barcode image uploaded successfully');
                } else {
                    console.error('Preview elements not found');
                    alert('‚ùå Error displaying image. Please try again.');
                }
            };
            
            reader.onerror = function() {
                alert('‚ùå Error reading file. Please try again.');
            };
            
            reader.readAsDataURL(file);
        }
        
        // Close Barcode Scanner
        function closeBarcodeScanner() {
            const video = document.getElementById('barcodeVideo');
            const section = document.getElementById('barcodeUploadSection');
            const buttons = document.getElementById('cameraButtons');
            
            // Stop Quagga if running
            if (typeof Quagga !== 'undefined') {
                Quagga.stop();
            }
            
            if (barcodeStream) {
                barcodeStream.getTracks().forEach(track => track.stop());
                barcodeStream = null;
            }
            
            video.style.display = 'none';
            buttons.style.display = 'none';
            section.style.display = 'none';
        }
        
        // Start Real-time Barcode Detection - Payment App Style
        function startBarcodeDetection() {
            if (typeof Quagga !== 'undefined') {
                const video = document.getElementById('barcodeVideo');
                if (!video) return;
                
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: video,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment"
                        }
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    numOfWorkers: 2,
                    frequency: 10,
                    decoder: {
                        readers: [
                            "code_128_reader",
                            "ean_reader",
                            "ean_8_reader",
                            "code_39_reader",
                            "upc_reader",
                            "upc_e_reader"
                        ]
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.log('Quagga initialization error:', err);
                        return;
                    }
                    console.log("‚úÖ Payment-style barcode detection started");
                    Quagga.start();
                });
                
                // Listen for barcode detection - Payment App Style
                let isProcessingBarcode = false;
                
                Quagga.onDetected(function(data) {
                    const code = data.codeResult.code;
                    
                    // Prevent multiple detections
                    if (isProcessingBarcode) return;
                    
                    // Validate barcode
                    if (!code || code.length < 4) return;
                    
                    isProcessingBarcode = true;
                    console.log('üéØ Payment-style barcode detected:', code);
                    
                    // Show payment app style success animation
                    showBarcodeSuccessAnimation(code);
                    
                    // Process barcode after animation
                    setTimeout(() => {
                        processBarcodeForProduct(code);
                        isProcessingBarcode = false;
                    }, 1500);
                });
            } else {
                console.log('‚ö†Ô∏è Quagga library not loaded, manual capture only');
            }
        }
        
        // Show payment app style success animation
        function showBarcodeSuccessAnimation(code) {
            const section = document.getElementById('barcodeUploadSection');
            const originalContent = section.innerHTML;
            
            // Payment app style success screen
            section.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); border-radius: 15px; color: white; margin-bottom: 15px;">
                    <div style="font-size: 64px; margin-bottom: 20px; animation: bounce 0.6s ease-in-out;">‚úÖ</div>
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 10px;">Barcode Scanned!</div>
                    <div style="font-size: 16px; opacity: 0.9; margin-bottom: 15px;">Processing product details...</div>
                    <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 25px; font-family: monospace; font-size: 14px; font-weight: 600;">
                        ${code}
                    </div>
                </div>
                
                <style>
                    @keyframes bounce {
                        0%, 20%, 60%, 100% { transform: translateY(0); }
                        40% { transform: translateY(-20px); }
                        80% { transform: translateY(-10px); }
                    }
                </style>
            `;
        }
        
        // Process barcode for product - Auto-fill details
        function processBarcodeForProduct(code) {
            console.log('[BARCODE PROCESS] Processing barcode for product:', code);
            
            // Store barcode data globally
            window.detectedBarcodeData = code;
            
            // Auto-fill product code field
            const productCodeField = document.getElementById('productCode');
            if (productCodeField) {
                productCodeField.value = code;
                console.log('[BARCODE PROCESS] Auto-filled product code:', code);
            }
            
            // Try to get product details from barcode (if it's a known format)
            const productDetails = extractProductDetailsFromBarcode(code);
            
            if (productDetails.name) {
                const productNameField = document.getElementById('productName');
                if (productNameField && !productNameField.value) {
                    productNameField.value = productDetails.name;
                    console.log('[BARCODE PROCESS] Auto-filled product name:', productDetails.name);
                }
            }
            
            if (productDetails.category) {
                const categoryField = document.getElementById('productCategory');
                if (categoryField) {
                    categoryField.value = productDetails.category;
                    console.log('[BARCODE PROCESS] Auto-filled category:', productDetails.category);
                }
            }
            
            // Close scanner and show success
            closeBarcodeScanner();
            showToast(`‚úÖ Barcode ${code} captured successfully!`, 'success');
            
            // Focus on next empty field
            setTimeout(() => {
                const nameField = document.getElementById('productName');
                const priceField = document.getElementById('productPrice');
                
                if (nameField && !nameField.value) {
                    nameField.focus();
                } else if (priceField && !priceField.value) {
                    priceField.focus();
                }
            }, 500);
        }
        
        // Extract product details from barcode (basic implementation)
        function extractProductDetailsFromBarcode(barcode) {
            // This is a basic implementation - in real app, you'd use barcode database
            const details = {
                name: '',
                category: 'General'
            };
            
            // Basic pattern matching for common barcodes
            if (barcode.startsWith('890') || barcode.startsWith('891')) {
                details.category = 'Food & Beverages';
            } else if (barcode.startsWith('300') || barcode.startsWith('301')) {
                details.category = 'Personal Care';
            } else if (barcode.startsWith('400') || barcode.startsWith('401')) {
                details.category = 'Health & Beauty';
            }
            
            // You can add more sophisticated barcode-to-product mapping here
            // For now, we'll let user fill the name manually
            
            return details;
        }
        
        // Save Product - Fixed for barcode uniqueness
        async function saveProduct(event) {
            event.preventDefault();
            console.log('[PRODUCT SAVE] Starting product save process');
            
            const editProductId = document.getElementById('editProductId').value;
            const isEdit = editProductId !== '';
            
            // Validate required fields
            const name = document.getElementById('productName').value.trim();
            const price = document.getElementById('productPrice').value;
            const stock = document.getElementById('productStock').value;
            const unit = document.getElementById('productUnit').value;
            const category = document.getElementById('productCategory').value;
            
            if (!name) {
                showToast('‚ùå Product name is required', 'error');
                document.getElementById('productName').focus();
                return;
            }
            
            if (!category) {
                showToast('‚ùå Category is required', 'error');
                document.getElementById('productCategory').focus();
                return;
            }
            
            if (!price || parseFloat(price) <= 0) {
                showToast('‚ùå Valid selling price is required', 'error');
                document.getElementById('productPrice').focus();
                return;
            }
            
            if (!stock || parseFloat(stock) < 0) {
                showToast('‚ùå Valid stock quantity is required', 'error');
                document.getElementById('productStock').focus();
                return;
            }
            
            if (!unit) {
                showToast('‚ùå Unit is required', 'error');
                document.getElementById('productUnit').focus();
                return;
            }
            
            // Get optional fields (with defaults)
            const costInput = document.getElementById('productCost');
            const mrpInput = document.getElementById('productMRP');
            const taxInput = document.getElementById('productTax');
            const minStockInput = document.getElementById('productMinStock');
            const supplierInput = document.getElementById('productSupplier');
            const codeInput = document.getElementById('productCode');
            const expiryInput = document.getElementById('productExpiryDate');
            const brandInput = document.getElementById('productBrand');
            const variantInput = document.getElementById('productVariant');
            const descriptionInput = document.getElementById('productDescription');
            
            // Prepare form data with proper barcode handling
            const formData = {
                code: codeInput ? codeInput.value.trim() : undefined,
                name: name,
                category: category,
                price: parseFloat(price),
                cost: costInput ? parseFloat(costInput.value) || 0 : 0,
                stock: parseFloat(stock),
                min_stock: minStockInput ? parseInt(minStockInput.value) || 5 : 5,
                unit: unit,
                expiry_date: expiryInput ? expiryInput.value || null : null,
                business_type: 'both',
                barcode_data: window.detectedBarcodeData || null,
                barcode_image: barcodeImageData || null,
                // Optional fields
                mrp: mrpInput ? parseFloat(mrpInput.value) || null : null,
                tax: taxInput ? parseFloat(taxInput.value) || 18 : 18,
                supplier: supplierInput ? supplierInput.value.trim() || null : null,
                brand: brandInput ? brandInput.value.trim() || null : null,
                variant: variantInput ? variantInput.value.trim() || null : null,
                description: descriptionInput ? descriptionInput.value.trim() || null : null,
                image_url: window.productImageData || null
            };
            
            console.log('[PRODUCT SAVE] Form data prepared:', {
                ...formData,
                barcode_data: formData.barcode_data ? `"${formData.barcode_data}"` : null,
                barcode_image: formData.barcode_image ? '[IMAGE_DATA]' : null,
                image_url: formData.image_url ? '[IMAGE_DATA]' : null
            });
            
            // Show loading
            const saveBtn = event.target.querySelector('button[type="submit"]') || event.target;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = '‚è≥ Saving...';
            saveBtn.disabled = true;
            
            try {
                console.log('[PRODUCT SAVE] Making API request...');
                
                let response, result;
                
                if (isEdit) {
                    // Update existing product
                    response = await fetch(`/api/products/${editProductId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Add new product
                    response = await fetch('/api/products', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                }
                
                result = await response.json();
                console.log('[PRODUCT SAVE] API Response:', result);
                console.log('[PRODUCT SAVE] Response status:', response.status);
                console.log('[PRODUCT SAVE] Response ok:', response.ok);
                
                // Check for success - handle both 200/201 status codes
                if (response.ok || response.status === 201) {
                    console.log('[PRODUCT SAVE] Success! Result:', result);
                    showToast(isEdit ? '‚úÖ Product updated successfully!' : '‚úÖ Product added successfully!', 'success');
                    
                    await loadProducts(); // Reload products list
                    
                    // Reset form and barcode data (but keep modal open for variants)
                    document.getElementById('productForm').reset();
                    window.detectedBarcodeData = null;
                    barcodeImageData = null;
                    window.productImageData = null;
                    
                    // Show variants section for the saved product
                    const productId = result.product?.id || editProductId;
                    console.log('[PRODUCT SAVE] Product ID for variants:', productId);
                    if (productId) {
                        setTimeout(() => {
                            showVariantsSection(productId);
                        }, 500);
                    } else {
                        console.error('[PRODUCT SAVE] No product ID found in response!');
                    }
                    
                    console.log('[PRODUCT SAVE] Product saved successfully:', result.product);
                    
                } else if (response.status === 409) {
                    // Handle duplicate barcode error
                    const errorMsg = result.error || 'Product with this barcode already exists';
                    showToast('‚ùå ' + errorMsg, 'error');
                    
                    console.log('[PRODUCT SAVE] Duplicate barcode error:', result);
                    
                    if (result.existing_product) {
                        setTimeout(() => {
                            alert(`Product already exists:\n\nName: ${result.existing_product.name}\nBarcode: ${result.barcode}\n\nPlease use a different barcode or edit the existing product.`);
                        }, 1000);
                    }
                } else {
                    const errorMsg = result.error || result.message || 'Failed to save product';
                    showToast('‚ùå ' + errorMsg, 'error');
                    console.log('[PRODUCT SAVE] Save failed:', result);
                }
            } catch (error) {
                console.error('[PRODUCT SAVE] Network error:', error);
                showToast('‚ùå Network error. Please check connection.', 'error');
            } finally {
                // Restore button state
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }
        
        // Edit Product
        function editProduct(id) {
            alert('Edit product: ' + id);
        }
        
        // Delete Product - Fixed implementation
        async function deleteProduct(productId) {
            console.log('[PRODUCT DELETE] Deleting product:', productId);
            
            if (!confirm('Are you sure you want to delete this product?\n\nThis action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/products/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                console.log('[PRODUCT DELETE] API Response:', result);
                
                if (response.ok && result.success) {
                    showToast('‚úÖ Product deleted successfully!', 'success');
                    await loadProducts(); // Reload products list
                    
                    if (result.deleted_product) {
                        console.log(`[PRODUCT DELETE] Deleted: ${result.deleted_product.name} (Barcode: ${result.deleted_product.barcode})`);
                    }
                } else {
                    const errorMsg = result.error || 'Failed to delete product';
                    showToast('‚ùå ' + errorMsg, 'error');
                }
            } catch (error) {
                console.error('[PRODUCT DELETE] Error:', error);
                showToast('‚ùå Network error. Please try again.', 'error');
            }
        }
        
        // ========== CUSTOMERS MODULE ==========
        
        let allCustomers = [];
        let currentCustomerType = 'all';
        
        // Load Customers
        async function loadCustomers() {
            try {
                console.log('üë• Loading customers...');
                allCustomers = await apiCall('/api/customers');
                console.log(`‚úÖ Customers loaded: ${allCustomers.length}`);
                
                // Update stats
                document.getElementById('totalCustomersCount').textContent = allCustomers.length;
                document.getElementById('activeCustomersCount').textContent = allCustomers.filter(c => c.is_active).length;
                
                displayCustomers(allCustomers);
            } catch (error) {
                console.error('Error loading customers:', error);
                document.getElementById('customersList').innerHTML = '<p style="text-align: center; color: #666;">Error loading customers</p>';
            }
        }
        
        // Display Customers
        function displayCustomers(customers) {
            const container = document.getElementById('customersList');
            
            if (customers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No customers found</p>';
                return;
            }
            
            let html = '';
            customers.forEach(customer => {
                const initials = customer.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const typeClass = `type-${customer.customer_type || 'regular'}`;
                const typeName = (customer.customer_type || 'regular').charAt(0).toUpperCase() + (customer.customer_type || 'regular').slice(1);
                
                html += `
                    <div class="customer-card">
                        <div class="customer-avatar">${initials}</div>
                        <div class="customer-info">
                            <div class="customer-name">${customer.name}</div>
                            <div class="customer-details">
                                <span class="customer-phone">üìû ${customer.phone || 'No phone'}</span>
                            </div>
                            <span class="customer-type-badge ${typeClass}">${typeName}</span>
                        </div>
                        <div class="customer-stats">
                            <div class="customer-balance">${formatCurrency(customer.current_balance || 0)}</div>
                            <div class="customer-purchases">${(customer.total_purchases || 0)} purchases</div>
                            <div class="customer-actions">
                                <button class="action-btn btn-edit" onclick="editCustomer('${customer.id}')">Edit</button>
                                <button class="action-btn btn-delete" onclick="deleteCustomer('${customer.id}')">Del</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Filter Customers by Search
        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            let filtered = allCustomers;
            
            if (currentCustomerType !== 'all') {
                filtered = filtered.filter(c => (c.customer_type || 'regular') === currentCustomerType);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) || 
                    (c.phone && c.phone.toLowerCase().includes(searchTerm)) ||
                    (c.email && c.email.toLowerCase().includes(searchTerm))
                );
            }
            
            displayCustomers(filtered);
        }
        
        // Filter by Customer Type
        function filterCustomersByType(type) {
            currentCustomerType = type;
            
            // Update active tab
            const tabs = document.querySelectorAll('#customersModule .filter-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            filterCustomers();
        }
        
        // Show Add Customer Form
        function showAddCustomerForm() {
            document.getElementById('addCustomerModal').classList.add('show');
            document.getElementById('customerForm').reset();
        }
        
        // Close Add Customer Modal
        function closeAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.remove('show');
        }
        
        // Save Customer
        async function saveCustomer(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                email: document.getElementById('customerEmail').value || null,
                address: document.getElementById('customerAddress').value || null,
                customer_type: document.getElementById('customerType').value,
                credit_limit: parseFloat(document.getElementById('customerCreditLimit').value) || 0
            };
            
            try {
                const response = await fetch('/api/customers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Customer added successfully!');
                    closeAddCustomerModal();
                    await loadCustomers(); // Reload customers list
                } else {
                    alert('‚ùå Error: ' + (result.message || 'Failed to add customer'));
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                alert('‚ùå Error saving customer. Please try again.');
            }
        }
        
        // Edit Customer
        function editCustomer(id) {
            alert('Edit customer: ' + id);
        }
        
        // Delete Customer
        function deleteCustomer(id) {
            if (confirm('Delete this customer?')) {
                alert('Delete customer: ' + id);
            }
        }
        
        // ========== CREDIT MODULE ==========
        
        let allCreditBills = [];
        let currentCreditStatus = 'all';
        let currentPaymentBill = null;
        
        // Load Credit Bills
        async function loadCreditBills() {
            try {
                console.log('üí≥ Loading credit bills...');
                const response = await fetch('/api/credit/bills/debug');
                const data = await response.json();
                
                if (data.success) {
                    allCreditBills = data.bills || [];
                    console.log(`‚úÖ Credit bills loaded: ${allCreditBills.length}`);
                    
                    // Update summary
                    updateCreditSummary();
                    
                    // Display bills
                    displayCreditBills(allCreditBills);
                } else {
                    throw new Error(data.error || 'Failed to load credit bills');
                }
            } catch (error) {
                console.error('Error loading credit bills:', error);
                document.getElementById('creditBillsList').innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Error loading credit bills</p>';
                showToast('‚ùå Error loading credit bills', 'error');
            }
        }
        
        // Update Credit Summary (based on filtered bills)
        async function updateCreditSummary(bills = allCreditBills) {
            let totalOutstanding = 0;
            let outstandingCount = 0;
            
            bills.forEach(bill => {
                const pendingAmount = bill.balance_due || bill.credit_balance || bill.remaining_amount || ((bill.total_amount || 0) - (bill.paid_amount || bill.credit_paid_amount || 0));
                
                if (pendingAmount > 0) {
                    totalOutstanding += pendingAmount;
                    outstandingCount++;
                }
            });
            
            document.getElementById('totalOutstanding').textContent = formatCurrency(totalOutstanding);
            document.getElementById('outstandingBills').textContent = outstandingCount + ' bills';
            
            // Fetch today's payments from API
            try {
                const response = await fetch('/api/credit/today-summary');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('collectedToday').textContent = formatCurrency(data.total_amount || 0);
                    document.getElementById('paymentsToday').textContent = (data.payment_count || 0) + ' payments';
                } else {
                    document.getElementById('collectedToday').textContent = '‚Çπ0';
                    document.getElementById('paymentsToday').textContent = '0 payments';
                }
            } catch (error) {
                console.error('Error fetching today\'s summary:', error);
                document.getElementById('collectedToday').textContent = '‚Çπ0';
                document.getElementById('paymentsToday').textContent = '0 payments';
            }
        }
        
        // Credit Bills Pagination
        let currentCreditPage = 1;
        let creditBillsPerPage = 20;
        let filteredCreditBills = [];
        
        // Display Credit Bills with Pagination
        function displayCreditBills(bills) {
            const container = document.getElementById('creditBillsList');
            filteredCreditBills = bills;
            
            if (bills.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No credit bills found</p>';
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(bills.length / creditBillsPerPage);
            const startIndex = (currentCreditPage - 1) * creditBillsPerPage;
            const endIndex = Math.min(startIndex + creditBillsPerPage, bills.length);
            const paginatedBills = bills.slice(startIndex, endIndex);
            
            let html = '';
            paginatedBills.forEach(bill => {
                const pendingAmount = bill.balance_due || bill.credit_balance || bill.remaining_amount || ((bill.total_amount || 0) - (bill.paid_amount || bill.credit_paid_amount || 0));
                const paidAmount = bill.paid_amount || bill.credit_paid_amount || 0;
                const totalAmount = bill.total_amount || 0;
                const paidPercentage = totalAmount > 0 ? (paidAmount / totalAmount * 100) : 0;
                
                let statusBadge = '';
                let statusColor = '';
                
                if (pendingAmount <= 0) {
                    statusBadge = 'Paid';
                    statusColor = '#10b981';
                } else if (paidAmount > 0) {
                    statusBadge = 'Partial';
                    statusColor = '#f59e0b';
                } else {
                    statusBadge = 'Pending';
                    statusColor = '#ef4444';
                }
                
                // Format date and time
                const billDate = new Date(bill.created_at);
                const dateStr = billDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                const timeStr = billDate.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
                
                html += `
                    <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; font-size: 14px; color: #2c3e50; margin-bottom: 4px;">
                                    ${bill.customer_name || 'Walk-in Customer'}
                                </div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 2px;">
                                    üßæ ${bill.bill_number || 'N/A'}
                                </div>
                                <div style="font-size: 11px; color: #999;">
                                    üìÖ ${dateStr} ‚Ä¢ üïê ${timeStr}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; font-size: 16px; color: #2c3e50;">
                                    ${formatCurrency(totalAmount)}
                                </div>
                                <div style="font-size: 11px; padding: 3px 8px; border-radius: 10px; background: ${statusColor}; color: white; display: inline-block; margin-top: 4px;">
                                    ${statusBadge}
                                </div>
                            </div>
                        </div>
                        
                        ${paidAmount > 0 ? `
                            <div style="background: #f9f9f9; padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                                    <span style="color: #666;">Paid:</span>
                                    <span style="color: #10b981; font-weight: 600;">${formatCurrency(paidAmount)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                    <span style="color: #666;">Pending:</span>
                                    <span style="color: #ef4444; font-weight: 600;">${formatCurrency(pendingAmount)}</span>
                                </div>
                                <div style="width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px; overflow: hidden;">
                                    <div style="width: ${paidPercentage}%; height: 100%; background: #10b981;"></div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${pendingAmount > 0 ? `
                            <button onclick="openPaymentModal('${bill.id}')" style="width: 100%; background: #10b981; color: white; border: none; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                üí∞ Record Payment
                            </button>
                        ` : `
                            <div style="text-align: center; padding: 8px; background: #f0fdf4; border-radius: 8px; color: #10b981; font-size: 13px; font-weight: 600;">
                                ‚úì Fully Paid
                            </div>
                        `}
                    </div>
                `;
            });
            
            // Add pagination controls
            if (totalPages > 1) {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 12px; margin-top: 15px;">
                        <button onclick="changeCreditPage(-1)" ${currentCreditPage === 1 ? 'disabled' : ''} 
                                style="padding: 8px 16px; background: ${currentCreditPage === 1 ? '#e5e7eb' : '#732C3F'}; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: ${currentCreditPage === 1 ? 'not-allowed' : 'pointer'};">
                            ‚Üê Previous
                        </button>
                        <div style="font-size: 13px; color: #666;">
                            Page ${currentCreditPage} of ${totalPages} (${startIndex + 1}-${endIndex} of ${bills.length})
                        </div>
                        <button onclick="changeCreditPage(1)" ${currentCreditPage === totalPages ? 'disabled' : ''} 
                                style="padding: 8px 16px; background: ${currentCreditPage === totalPages ? '#e5e7eb' : '#732C3F'}; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: ${currentCreditPage === totalPages ? 'not-allowed' : 'pointer'};">
                            Next ‚Üí
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Change Credit Page
        function changeCreditPage(direction) {
            const totalPages = Math.ceil(filteredCreditBills.length / creditBillsPerPage);
            currentCreditPage += direction;
            
            if (currentCreditPage < 1) currentCreditPage = 1;
            if (currentCreditPage > totalPages) currentCreditPage = totalPages;
            
            displayCreditBills(filteredCreditBills);
            
            // Scroll to top of credit list
            document.getElementById('creditBillsList').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Filter Credit Bills by Search and Filters
        function filterCreditBills() {
            const searchTerm = document.getElementById('creditSearch').value.toLowerCase();
            const statusFilter = document.getElementById('creditStatusFilter').value;
            const dateFilter = document.getElementById('creditDateFilter').value;
            
            let filtered = allCreditBills;
            
            // Apply status filter
            if (statusFilter !== 'all') {
                if (statusFilter === 'unpaid') {
                    filtered = filtered.filter(bill => {
                        const balance = bill.balance_due || bill.credit_balance || 0;
                        const paid = bill.paid_amount || bill.credit_paid_amount || 0;
                        return balance > 0 && paid === 0;
                    });
                } else if (statusFilter === 'partial') {
                    filtered = filtered.filter(bill => {
                        const balance = bill.balance_due || bill.credit_balance || 0;
                        const paid = bill.paid_amount || bill.credit_paid_amount || 0;
                        return balance > 0 && paid > 0;
                    });
                } else if (statusFilter === 'paid') {
                    filtered = filtered.filter(bill => {
                        const balance = bill.balance_due || bill.credit_balance || 0;
                        return balance <= 0;
                    });
                }
            }
            
            // Apply date filter
            if (dateFilter !== 'all') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                const monthAgo = new Date(today);
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                
                filtered = filtered.filter(bill => {
                    const billDate = new Date(bill.created_at);
                    
                    if (dateFilter === 'today') {
                        return billDate >= today;
                    } else if (dateFilter === 'yesterday') {
                        return billDate >= yesterday && billDate < today;
                    } else if (dateFilter === 'week') {
                        return billDate >= weekAgo;
                    } else if (dateFilter === 'month') {
                        return billDate >= monthAgo;
                    }
                    return true;
                });
            }
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(bill => 
                    (bill.customer_name || '').toLowerCase().includes(searchTerm) ||
                    (bill.bill_number || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Reset to page 1 when filtering
            currentCreditPage = 1;
            
            // Update summary based on filtered bills
            updateCreditSummary(filtered);
            
            // Display filtered bills
            displayCreditBills(filtered);
        }
        
        // Open Payment Modal
        function openPaymentModal(billId) {
            const bill = allCreditBills.find(b => b.id === billId);
            if (!bill) return;
            
            currentPaymentBill = bill;
            
            // Get amounts (handle both field names)
            const totalAmount = bill.total_amount || 0;
            const paidAmount = bill.paid_amount || bill.credit_paid_amount || 0;
            const pendingAmount = bill.balance_due || bill.credit_balance || bill.remaining_amount || (totalAmount - paidAmount);
            
            document.getElementById('paymentBillId').value = bill.id;
            document.getElementById('paymentCustomer').textContent = bill.customer_name || 'Unknown';
            document.getElementById('paymentBillNumber').textContent = bill.bill_number || 'N/A';
            document.getElementById('paymentTotalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('paymentPendingAmount').textContent = formatCurrency(pendingAmount);
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentNotes').value = '';
            
            // Reset payment method to default empty option
            const methodSelect = document.getElementById('paymentMethod');
            if (methodSelect) {
                methodSelect.selectedIndex = 0; // Select first option (empty)
            }
            
            document.getElementById('paymentModal').classList.add('show');
        }
        
        // Close Payment Modal
        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('show');
            currentPaymentBill = null;
        }
        
        // Set Payment Amount
        function setPaymentAmount(type) {
            if (!currentPaymentBill) return;
            
            const pendingAmount = (currentPaymentBill.total_amount || 0) - (currentPaymentBill.paid_amount || 0);
            
            if (type === 'full') {
                document.getElementById('paymentAmount').value = pendingAmount.toFixed(2);
            } else if (type === 'half') {
                document.getElementById('paymentAmount').value = (pendingAmount / 2).toFixed(2);
            }
        }
        
        // Record Payment
        async function recordPayment(event) {
            event.preventDefault();
            
            const billId = document.getElementById('paymentBillId').value;
            const amountInput = document.getElementById('paymentAmount').value;
            const amount = parseFloat(amountInput);
            const methodSelect = document.getElementById('paymentMethod');
            const method = methodSelect ? methodSelect.value : '';
            const notes = document.getElementById('paymentNotes').value;
            
            console.log('üîç Payment Form Values:', {
                billId,
                amountInput,
                amount,
                method,
                methodSelect: methodSelect ? 'found' : 'not found',
                notes
            });
            
            // Validate required fields
            if (!billId) {
                showToast('‚ùå Bill ID is missing', 'error');
                return;
            }
            
            if (!amountInput || amountInput.trim() === '') {
                showToast('‚ùå Please enter payment amount', 'error');
                return;
            }
            
            if (isNaN(amount)) {
                showToast('‚ùå Please enter a valid payment amount', 'error');
                return;
            }
            
            if (amount <= 0) {
                showToast('‚ùå Payment amount must be greater than 0', 'error');
                return;
            }
            
            if (!method || method.trim() === '' || method === 'Select Method') {
                showToast('‚ùå Please select a payment method', 'error');
                console.log('‚ùå Method validation failed:', method);
                return;
            }
            
            // Get pending amount from bill (handle both field names)
            const totalAmount = currentPaymentBill.total_amount || 0;
            const paidAmount = currentPaymentBill.paid_amount || currentPaymentBill.credit_paid_amount || 0;
            const pendingAmount = currentPaymentBill.balance_due || currentPaymentBill.credit_balance || currentPaymentBill.remaining_amount || (totalAmount - paidAmount);
            
            if (amount > pendingAmount) {
                showToast(`‚ùå Payment amount (‚Çπ${amount}) cannot exceed pending amount (‚Çπ${pendingAmount.toFixed(2)})`, 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/credit/payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bill_id: billId,
                        payment_amount: amount,
                        payment_method: method,
                        notes: notes
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('‚úÖ Payment recorded successfully!', 'success');
                    closePaymentModal();
                    await loadCreditBills(); // Reload bills
                } else {
                    showToast('‚ùå ' + (result.error || 'Failed to record payment'), 'error');
                }
            } catch (error) {
                console.error('Error recording payment:', error);
                showToast('‚ùå Network error. Please try again.', 'error');
            }
        }
        
        // Refresh Credit
        async function refreshCredit() {
            showToast('üîÑ Refreshing...', 'info');
            await loadCreditBills();
        }
        
        // ========== SALES MODULE ==========
        
        let allSales = [];
        let filteredSales = [];
        let currentDateFilter = 'week';  // Changed from 'today' to 'week' to show recent sales
        let currentSalesSummary = null;  // Store current summary
        let currentSalesPage = 1;
        let salesPerPage = 20;
        
        // Load Sales
        async function loadSales() {
            try {
                console.log('üí∞ Loading sales...');
                
                // Load sales list with current filter
                console.log(`üìã Loading sales list with filter: ${currentDateFilter}...`);
                allSales = await apiCall(`/api/sales?date_filter=${currentDateFilter}`);
                filteredSales = [...allSales];
                console.log(`‚úÖ Sales list loaded: ${allSales.length}`);
                
                // Reset to first page
                currentSalesPage = 1;
                
                // Calculate summary from loaded sales
                calculateSalesSummary(allSales);
                
                // Load top products for current filter
                try {
                    const topProductsData = await apiCall(`/api/sales/top-products?date_filter=${currentDateFilter}&limit=1`);
                    if (topProductsData.success && topProductsData.top_products && topProductsData.top_products.length > 0) {
                        const topProd = topProductsData.top_products[0];
                        document.getElementById('topProduct').textContent = topProd.product_name || '-';
                        document.getElementById('topProductQty').textContent = (topProd.total_quantity || 0) + ' sold';
                    } else {
                        document.getElementById('topProduct').textContent = '-';
                        document.getElementById('topProductQty').textContent = '0 sold';
                    }
                } catch (error) {
                    console.error('Error loading top products:', error);
                    document.getElementById('topProduct').textContent = '-';
                    document.getElementById('topProductQty').textContent = '0 sold';
                }
                
                displaySalesTable();
            } catch (error) {
                console.error('Error loading sales:', error);
                document.getElementById('salesTableBody').innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #ef4444;">Error loading sales</td></tr>';
            }
        }
        
        // Calculate Sales Summary from current data
        function calculateSalesSummary(sales) {
            if (!sales || sales.length === 0) {
                document.getElementById('totalRevenue').textContent = '‚Çπ0';
                document.getElementById('revenueChange').textContent = '‚Üë 0%';
                document.getElementById('totalTransactions').textContent = '0';
                document.getElementById('transactionChange').textContent = '‚Üë 0%';
                document.getElementById('avgOrderValue').textContent = '‚Çπ0';
                return;
            }
            
            // Calculate totals from current filter
            let totalRevenue = 0;
            let totalCount = sales.length;
            
            sales.forEach(sale => {
                totalRevenue += (sale.total_amount || 0);
            });
            
            // Update summary cards with current filter data
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalTransactions').textContent = totalCount;
            
            // Calculate average
            const avgValue = totalCount > 0 ? (totalRevenue / totalCount) : 0;
            document.getElementById('avgOrderValue').textContent = formatCurrency(avgValue);
            
            // For change percentage, compare with previous period
            // For now, show positive indicator
            document.getElementById('revenueChange').textContent = '‚Üë ' + totalCount + ' bills';
            document.getElementById('transactionChange').textContent = '‚Çπ' + (totalRevenue / 1000).toFixed(1) + 'K';
        }
        
        // Display Sales in Table Format with Pagination
        function displaySalesTable() {
            const tbody = document.getElementById('salesTableBody');
            
            if (filteredSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: #999;"><div style="font-size: 48px; margin-bottom: 10px;">üì≠</div><div>No sales found</div></td></tr>';
                updateSalesPagination();
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredSales.length / salesPerPage);
            const startIndex = (currentSalesPage - 1) * salesPerPage;
            const endIndex = Math.min(startIndex + salesPerPage, filteredSales.length);
            const pageSales = filteredSales.slice(startIndex, endIndex);
            
            // Build table rows
            let html = '';
            pageSales.forEach((sale, index) => {
                const saleDate = new Date(sale.created_at);
                const dateStr = saleDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                const timeStr = saleDate.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                
                const paymentMethod = (sale.payment_method || 'cash').toUpperCase();
                const isPartial = paymentMethod === 'PARTIAL';
                const isCredit = paymentMethod === 'CREDIT';
                
                let paymentBadgeColor = '#4CAF50'; // green for cash
                if (paymentMethod === 'UPI') paymentBadgeColor = '#2196F3';
                else if (paymentMethod === 'CARD') paymentBadgeColor = '#FF9800';
                else if (paymentMethod === 'CREDIT' || paymentMethod === 'PARTIAL') paymentBadgeColor = '#ef4444';
                
                const rowBg = index % 2 === 0 ? '#ffffff' : '#f9f9f9';
                const globalIndex = startIndex + index + 1;
                
                // Build amount display with partial payment details
                let amountDisplay = formatCurrency(sale.total_amount || 0);
                if (isPartial || isCredit) {
                    const paidAmount = sale.credit_paid_amount || 0;
                    const dueAmount = sale.credit_balance || 0;
                    amountDisplay = `
                        <div style="font-weight: 700; font-size: 14px; color: #4CAF50;">${formatCurrency(sale.total_amount || 0)}</div>
                        <div style="font-size: 10px; color: #666; margin-top: 2px;">
                            Paid: ${formatCurrency(paidAmount)} | Due: ${formatCurrency(dueAmount)}
                        </div>
                    `;
                }
                
                html += `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 12px 8px; color: #666; font-weight: 500;">${globalIndex}</td>
                        <td style="padding: 12px 8px; color: #2c3e50; font-weight: 600; white-space: nowrap;">${sale.bill_number || 'N/A'}</td>
                        <td style="padding: 12px 8px; color: #2c3e50;">${sale.customer_name || 'Walk-in'}</td>
                        <td style="padding: 12px 8px; color: #666; white-space: nowrap;">${dateStr}</td>
                        <td style="padding: 12px 8px; color: #666; white-space: nowrap;">${timeStr}</td>
                        <td style="padding: 12px 8px; text-align: right;">${amountDisplay}</td>
                        <td style="padding: 12px 8px; text-align: center;">
                            <span style="display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; color: white; background: ${paymentBadgeColor};">
                                ${paymentMethod}
                            </span>
                        </td>
                        <td style="padding: 12px 8px; text-align: center;">
                            <button onclick="window.location.href='/retail/invoice/${sale.bill_id || sale.id}';" style="background: #732C3F; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            updateSalesPagination();
        }
        
        // Update Pagination Controls
        function updateSalesPagination() {
            const totalPages = Math.ceil(filteredSales.length / salesPerPage);
            const startIndex = (currentSalesPage - 1) * salesPerPage + 1;
            const endIndex = Math.min(currentSalesPage * salesPerPage, filteredSales.length);
            
            // Update showing text
            document.getElementById('salesShowingStart').textContent = filteredSales.length > 0 ? startIndex : 0;
            document.getElementById('salesShowingEnd').textContent = endIndex;
            document.getElementById('salesTotalCount').textContent = filteredSales.length;
            
            // Update prev/next buttons
            const prevBtn = document.getElementById('salesPrevBtn');
            const nextBtn = document.getElementById('salesNextBtn');
            
            prevBtn.disabled = currentSalesPage === 1;
            nextBtn.disabled = currentSalesPage === totalPages || totalPages === 0;
            
            prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
            nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
            prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
            nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
            
            // Update page numbers
            const pageNumbersDiv = document.getElementById('salesPageNumbers');
            let pageHtml = '';
            
            // Show max 5 page numbers
            let startPage = Math.max(1, currentSalesPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentSalesPage;
                pageHtml += `
                    <button onclick="goToSalesPage(${i})" style="
                        padding: 8px 12px; 
                        background: ${isActive ? '#732C3F' : 'white'}; 
                        color: ${isActive ? 'white' : '#666'};
                        border: 1px solid ${isActive ? '#732C3F' : '#ddd'}; 
                        border-radius: 6px; 
                        font-size: 12px; 
                        font-weight: ${isActive ? '600' : '400'};
                        cursor: pointer;
                        min-width: 35px;
                    ">${i}</button>
                `;
            }
            
            pageNumbersDiv.innerHTML = pageHtml;
        }
        
        // Change Sales Page
        function changeSalesPage(direction) {
            const totalPages = Math.ceil(filteredSales.length / salesPerPage);
            
            if (direction === 'prev' && currentSalesPage > 1) {
                currentSalesPage--;
            } else if (direction === 'next' && currentSalesPage < totalPages) {
                currentSalesPage++;
            }
            
            displaySalesTable();
            
            // Scroll to top of table
            document.getElementById('salesTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Go to Specific Page
        function goToSalesPage(page) {
            currentSalesPage = page;
            displaySalesTable();
            document.getElementById('salesTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Display Sales (Old function - kept for compatibility)
        function displaySales(sales) {
            // This function is now replaced by displaySalesTable
            // Keeping it for backward compatibility
            displaySalesTable();
        }
        
        // View Bill Details
        window.viewBillDetails = async function(billId) {
            console.log('üîç [VIEW BILL] Viewing bill details for:', billId);
            
            if (!billId) {
                console.error('‚ùå [VIEW BILL] No bill ID provided');
                alert('Error: No bill ID provided');
                return;
            }
            
            const modal = document.getElementById('billDetailsModal');
            const content = document.getElementById('billDetailsContent');
            
            if (!modal || !content) {
                console.error('‚ùå [VIEW BILL] Modal elements not found');
                alert('Error: Modal not found');
                return;
            }
            
            // Show modal with loading state
            modal.style.display = 'flex';
            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><div style="font-size: 48px; margin-bottom: 10px;">‚è≥</div><div>Loading bill details...</div></div>';
            
            try {
                // Fetch bill details
                console.log(`üì° [VIEW BILL] Fetching from: /api/bills/${billId}`);
                const response = await fetch(`/api/bills/${billId}`);
                console.log(`üì° [VIEW BILL] Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì¶ [VIEW BILL] Received data:', data);
                
                if (!data || !data.bill) {
                    throw new Error('Bill not found');
                }
                
                const bill = data.bill;
                const items = data.items || [];
                
                console.log(`‚úÖ [VIEW BILL] Bill loaded: ${bill.bill_number}, Items: ${items.length}`);
                
                // Build bill details HTML
                let html = `
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #666; font-size: 14px;">Bill Number:</span>
                            <span style="font-weight: 700; color: #732C3F; font-size: 14px;">${bill.bill_number}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #666; font-size: 14px;">Customer:</span>
                            <span style="font-weight: 600; color: #333; font-size: 14px;">${bill.customer_name || 'Walk-in Customer'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #666; font-size: 14px;">Date:</span>
                            <span style="font-weight: 600; color: #333; font-size: 14px;">${new Date(bill.created_at).toLocaleString('en-IN')}</span>
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px 0; color: #732C3F; font-size: 16px;">Items</h4>
                    <div style="background: white; border: 1px solid #E8D5DA; border-radius: 10px; overflow: hidden; margin-bottom: 20px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: #f9f9f9; border-bottom: 2px solid #E8D5DA;">
                                    <th style="padding: 10px; text-align: left; font-weight: 600; color: #666;">Product</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600; color: #666;">Qty</th>
                                    <th style="padding: 10px; text-align: right; font-weight: 600; color: #666;">Price</th>
                                    <th style="padding: 10px; text-align: right; font-weight: 600; color: #666;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                items.forEach(item => {
                    html += `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 10px; color: #333;">${item.product_name}</td>
                            <td style="padding: 10px; text-align: center; color: #666;">${item.quantity}</td>
                            <td style="padding: 10px; text-align: right; color: #666;">${formatCurrency(item.unit_price || 0)}</td>
                            <td style="padding: 10px; text-align: right; color: #333; font-weight: 600;">${formatCurrency(item.total_price || 0)}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666; font-size: 14px;">Subtotal:</span>
                            <span style="font-weight: 600; color: #333; font-size: 14px;">${formatCurrency(bill.subtotal || 0)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666; font-size: 14px;">GST (10%):</span>
                            <span style="font-weight: 600; color: #333; font-size: 14px;">${formatCurrency(bill.tax_amount || 0)}</span>
                        </div>
                `;
                
                if (bill.discount_amount && bill.discount_amount > 0) {
                    html += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #ef4444; font-size: 14px;">Discount:</span>
                            <span style="font-weight: 600; color: #ef4444; font-size: 14px;">-${formatCurrency(bill.discount_amount || 0)}</span>
                        </div>
                    `;
                }
                
                html += `
                        <div style="border-top: 2px solid #E8D5DA; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between;">
                            <span style="color: #732C3F; font-size: 16px; font-weight: 700;">Total Amount:</span>
                            <span style="font-weight: 700; color: #732C3F; font-size: 18px;">${formatCurrency(bill.total_amount || 0)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                            <span style="color: #666; font-size: 13px;">Payment Method:</span>
                            <span style="font-weight: 600; color: #333; font-size: 13px; text-transform: uppercase;">${bill.payment_method || 'CASH'}</span>
                        </div>
                    </div>
                `;
                
                content.innerHTML = html;
                console.log('‚úÖ [VIEW BILL] Bill details displayed successfully');
                
            } catch (error) {
                console.error('‚ùå [VIEW BILL] Error loading bill details:', error);
                console.error('‚ùå [VIEW BILL] Error stack:', error.stack);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
                        <div style="font-weight: 600; margin-bottom: 10px;">Failed to load bill details</div>
                        <div style="font-size: 12px; margin-top: 10px; color: #999;">${error.message}</div>
                        <button onclick="closeBillDetailsModal()" style="margin-top: 20px; padding: 10px 20px; background: #732C3F; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
                    </div>
                `;
            }
        }
        
        // Close Bill Details Modal
        window.closeBillDetailsModal = function() {
            document.getElementById('billDetailsModal').style.display = 'none';
        }

        
        // Filter Sales by Search
        function filterSales() {
            const searchTerm = document.getElementById('salesSearch').value.toLowerCase();
            
            if (searchTerm) {
                filteredSales = allSales.filter(s => 
                    (s.bill_number && s.bill_number.toLowerCase().includes(searchTerm)) ||
                    (s.customer_name && s.customer_name.toLowerCase().includes(searchTerm)) ||
                    (s.product_name && s.product_name.toLowerCase().includes(searchTerm))
                );
            } else {
                filteredSales = [...allSales];
            }
            
            // Reset to first page when searching
            currentSalesPage = 1;
            displaySalesTable();
        }
        
        // Filter Sales by Date
        async function filterSalesByDate(period) {
            currentDateFilter = period;
            
            // Update active tab
            const tabs = document.querySelectorAll('#salesModule .filter-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Reload sales with filter
            console.log(`üîÑ Filtering sales by: ${period}`);
            allSales = await apiCall(`/api/sales?date_filter=${period}`);
            filteredSales = [...allSales];
            console.log(`‚úÖ Filtered sales loaded: ${allSales.length}`);
            
            // Reset to first page
            currentSalesPage = 1;
            
            // Recalculate summary for new filter
            calculateSalesSummary(allSales);
            
            // Update top products for new filter
            try {
                const topProductsData = await apiCall(`/api/sales/top-products?date_filter=${period}&limit=1`);
                if (topProductsData.success && topProductsData.top_products && topProductsData.top_products.length > 0) {
                    const topProd = topProductsData.top_products[0];
                    document.getElementById('topProduct').textContent = topProd.product_name || '-';
                    document.getElementById('topProductQty').textContent = (topProd.total_quantity || 0) + ' sold';
                } else {
                    document.getElementById('topProduct').textContent = '-';
                    document.getElementById('topProductQty').textContent = '0 sold';
                }
            } catch (error) {
                console.error('Error loading top products:', error);
            }
            
            // Display filtered sales in table
            displaySalesTable();
        }
        
        // Show Add Sale Form
        function showAddSaleForm() {
            alert('üöß Add Sale form coming soon!\n\nFor now, use the Billing module to create new sales.');
        }
        
        // ========== BILLING MODULE ==========
        
        let billItems = [];
        let billProducts = [];
        
        // Load products for billing - Desktop Grid Style
        async function loadBillingProducts() {
            try {
                console.log('üì¶ Loading products for billing...');
                billProducts = await apiCall('/api/products');
                
                renderBillingProductsGrid(billProducts);
                
                console.log(`‚úÖ Loaded ${billProducts.length} products for billing`);
            } catch (error) {
                console.error('‚ùå Error loading billing products:', error);
                document.getElementById('billProductsGrid').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #666;">Error loading products</div>';
            }
        }
        
        // Render products in grid layout
        function renderBillingProductsGrid(products) {
            const grid = document.getElementById('billProductsGrid');
            
            if (!products || products.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No products available</div>';
                return;
            }
            
            grid.innerHTML = products.map(product => {
                const isOutOfStock = product.stock <= 0;
                const stockClass = isOutOfStock ? 'out-of-stock' : '';
                const stockText = isOutOfStock ? 'Out of Stock' : `Stock: ${product.stock}`;
                
                return `
                    <div class="bill-product-box ${stockClass}" 
                         onclick="${isOutOfStock ? '' : `addProductToBill('${product.id}')`}"
                         data-product-id="${product.id}">
                        <div class="bill-product-name">${product.name}</div>
                        <div class="bill-product-price">‚Çπ${product.price}</div>
                        <div class="bill-product-stock">${stockText}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Search products in billing
        function setupBillingSearch() {
            const searchInput = document.getElementById('billProductSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    const filteredProducts = billProducts.filter(product => 
                        product.name.toLowerCase().includes(query) ||
                        product.code.toLowerCase().includes(query) ||
                        (product.category && product.category.toLowerCase().includes(query))
                    );
                    renderBillingProductsGrid(filteredProducts);
                });
            }
        }
        
        // Update price when product selected
        document.addEventListener('DOMContentLoaded', function() {
            const productSelect = document.getElementById('billProductSelect');
            if (productSelect) {
                productSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const price = selectedOption.dataset.price || 0;
                    document.getElementById('billPrice').value = price;
                });
            }
        });
        
        // Add product to bill
        function addToBillMobile() {
            const productSelect = document.getElementById('billProductSelect');
            const quantity = parseInt(document.getElementById('billQuantity').value) || 1;
            const price = parseFloat(document.getElementById('billPrice').value) || 0;
            
            if (!productSelect.value) {
                alert('‚ùå Please select a product!');
                return;
            }
            
            if (quantity <= 0) {
                alert('‚ùå Quantity must be greater than 0!');
                return;
            }
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const productId = productSelect.value;
            const productName = selectedOption.dataset.name;
            const total = price * quantity;
            
            // Add to bill items
            billItems.push({
                id: productId,
                name: productName,
                quantity: quantity,
                price: price,
                total: total
            });
            
            // Update display
            renderBillItems();
            calculateBillTotal();
            
            // Reset form
            productSelect.value = '';
            document.getElementById('billQuantity').value = 1;
            document.getElementById('billPrice').value = '';
            
            console.log('‚úÖ Product added to bill:', productName);
        }
        
        // Render bill items
        function renderBillItems() {
            const container = document.getElementById('billItemsList');
            
            if (billItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üõí</div>
                        <p>No items added yet</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            billItems.forEach((item, index) => {
                html += `
                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #732C3F; margin-bottom: 4px;">${item.name}</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${item.quantity} √ó ‚Çπ${item.price.toFixed(2)} = ‚Çπ${item.total.toFixed(2)}
                                </div>
                            </div>
                            <button onclick="removeBillItem(${index})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Remove item from bill
        function removeBillItem(index) {
            billItems.splice(index, 1);
            renderBillItems();
            calculateBillTotal();
            console.log('üóëÔ∏è Item removed from bill');
        }
        
        // Calculate bill total
        function calculateBillTotal() {
            const subtotal = billItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('billDiscount')?.value || 0);
            
            // Correct calculation: Subtotal + GST - Discount = Total
            const gst = subtotal * 0.10; // 10% GST on subtotal
            const subtotalWithGST = subtotal + gst;
            const total = Math.max(0, subtotalWithGST - discount); // Apply discount after GST
            
            document.getElementById('billSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('billGST').textContent = gst.toFixed(2);
            document.getElementById('billTotal').textContent = total.toFixed(2);
            
            // Show/hide discount display
            const discountDisplay = document.getElementById('discountDisplay');
            const discountAmount = document.getElementById('discountAmount');
            if (discount > 0) {
                discountDisplay.style.display = 'block';
                discountAmount.textContent = discount.toFixed(2);
            } else {
                discountDisplay.style.display = 'none';
            }
            
            // Update partial balance if partial payment is selected
            if (document.getElementById('paymentMethod')?.value === 'partial') {
                calculatePartialBalance();
            }
            
            // Enable/disable complete bill button
            const completeBtn = document.getElementById('completeBillBtn');
            if (completeBtn) {
                completeBtn.disabled = billItems.length === 0;
            }
        }
        
        // Handle payment method change
        function handlePaymentMethodChange() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const partialSection = document.getElementById('partialPaymentSection');
            const customerSection = document.getElementById('customerDetailsSection');
            const optionalCustomerSection = document.getElementById('optionalCustomerSection');
            
            // Show/hide sections based on payment method
            if (paymentMethod === 'partial') {
                partialSection.style.display = 'block';
                customerSection.style.display = 'block';
                optionalCustomerSection.style.display = 'none';
                calculatePartialBalance();
            } else if (paymentMethod === 'credit') {
                partialSection.style.display = 'none';
                customerSection.style.display = 'block';
                optionalCustomerSection.style.display = 'none';
            } else {
                partialSection.style.display = 'none';
                customerSection.style.display = 'none';
                optionalCustomerSection.style.display = 'block';
            }
        }
        
        // Calculate partial payment balance
        function calculatePartialBalance() {
            const total = parseFloat(document.getElementById('billTotal').textContent || 0);
            const partialAmount = parseFloat(document.getElementById('partialAmount')?.value || 0);
            const balance = Math.max(0, total - partialAmount);
            
            document.getElementById('partialBalance').textContent = balance.toFixed(2);
        }
        
        // Add product to bill from grid
        function addProductToBill(productId) {
            const product = billProducts.find(p => p.id === productId);
            if (!product) {
                showToast('‚ùå Product not found', 'error');
                return;
            }
            
            if (product.stock <= 0) {
                showToast('‚ùå Product out of stock', 'error');
                return;
            }
            
            // Check if product already in bill
            const existingItem = billItems.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
                existingItem.total = existingItem.quantity * existingItem.price;
            } else {
                billItems.push({
                    id: productId,
                    name: product.name,
                    quantity: 1,
                    price: product.price,
                    total: product.price
                });
            }
            
            renderBillItems();
            calculateBillTotal();
            showToast(`‚úÖ ${product.name} added to bill`, 'success');
        }
        
        // Render bill items
        function renderBillItems() {
            const container = document.getElementById('billItemsList');
            
            if (billItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üõí</div>
                        <p>Scan or click products to add</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = billItems.map((item, index) => `
                <div class="bill-item">
                    <div class="bill-item-info">
                        <div class="bill-item-name">${item.name}</div>
                        <div class="bill-item-details">‚Çπ${item.price} √ó ${item.quantity}</div>
                    </div>
                    <div class="bill-item-total">‚Çπ${item.total.toFixed(2)}</div>
                    <button class="bill-item-remove" onclick="removeBillItem(${index})">‚úï</button>
                </div>
            `).join('');
        }
        
        // Remove item from bill
        function removeBillItem(index) {
            billItems.splice(index, 1);
            renderBillItems();
            calculateBillTotal();
            showToast('Item removed from bill', 'info');
        }
        
        // Clear bill
        function clearBill() {
            if (billItems.length === 0) {
                return;
            }
            
            if (confirm('Are you sure you want to clear the bill?')) {
                billItems = [];
                renderBillItems();
                calculateBillTotal();
                
                // Reset discount and customer fields
                document.getElementById('billDiscount').value = '';
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('optionalCustomerName').value = '';
                document.getElementById('optionalCustomerPhone').value = '';
                document.getElementById('partialAmount').value = '';
                document.getElementById('paymentMethod').value = 'cash';
                handlePaymentMethodChange();
                
                console.log('üßπ Bill cleared');
            }
        }
        
        // Barcode Scanner for Billing
        let billBarcodeStream = null;
        
        // Open barcode scanner for billing
        async function openBillBarcodeScanner() {
            const section = document.getElementById('billBarcodeSection');
            const camera = document.getElementById('billBarcodeCamera');
            section.style.display = 'block';
            
            try {
                camera.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #e8f5e9; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-size: 36px; margin-bottom: 10px;">üì∑</div>
                        <p style="color: #2e7d32; margin-bottom: 5px; font-weight: 600;">Requesting Camera Access...</p>
                        <p style="font-size: 12px; color: #2e7d32;">Point camera at product barcode</p>
                    </div>
                `;
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                camera.innerHTML = `
                    <div style="position: relative;">
                        <video id="billBarcodeVideo" autoplay playsinline style="width: 100%; border-radius: 8px; background: #000;"></video>
                        
                        <!-- Scanning Overlay -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 300px; height: 150px; border: 3px solid #28a745; border-radius: 10px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); pointer-events: none;">
                            <div style="position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 5px 15px; border-radius: 15px; font-size: 12px; font-weight: 600; white-space: nowrap;">
                                üì± Point at barcode
                            </div>
                            <!-- Scanning line animation -->
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, #28a745, transparent); animation: scan 2s linear infinite;"></div>
                        </div>
                    </div>
                    
                    <style>
                        @keyframes scan {
                            0% { top: 0; }
                            50% { top: 100%; }
                            100% { top: 0; }
                        }
                    </style>
                    
                    <div style="text-align: center; margin-top: 10px; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
                        <div style="color: #28a745; font-weight: 600; margin-bottom: 5px;">üîç Scanning automatically...</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">Align barcode within the green box</div>
                        <button onclick="closeBillBarcodeScanner()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px;">‚úï Close Scanner</button>
                    </div>
                `;
                
                const video = document.getElementById('billBarcodeVideo');
                billBarcodeStream = stream;
                video.srcObject = stream;
                
                // Start real-time barcode detection for billing
                video.addEventListener('loadedmetadata', () => {
                    startBillBarcodeDetection();
                });
                
                console.log('‚úÖ Billing barcode scanner opened');
                
            } catch (error) {
                console.error('Camera error:', error);
                camera.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 8px;">
                        <div style="font-size: 36px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <p style="color: #856404;">Camera access denied or not available</p>
                        <button onclick="closeBillBarcodeScanner()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 10px;">Close</button>
                    </div>
                `;
            }
        }
        
        // Start barcode detection for billing
        function startBillBarcodeDetection() {
            if (typeof Quagga !== 'undefined') {
                const video = document.getElementById('billBarcodeVideo');
                if (!video) return;
                
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: video,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment"
                        }
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    numOfWorkers: 2,
                    frequency: 10,
                    decoder: {
                        readers: [
                            "code_128_reader",
                            "ean_reader",
                            "ean_8_reader",
                            "code_39_reader",
                            "upc_reader",
                            "upc_e_reader"
                        ]
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.log('Billing barcode detection error:', err);
                        return;
                    }
                    console.log("‚úÖ Billing barcode detection started - Real mart style");
                    Quagga.start();
                });
                
                // Listen for barcode detection - Real mart style (instant detection)
                let isProcessing = false;
                
                Quagga.onDetected(function(data) {
                    const barcode = data.codeResult.code;
                    
                    // Prevent multiple detections while processing
                    if (isProcessing) return;
                    
                    // Validate barcode (minimum length check)
                    if (!barcode || barcode.length < 4) return;
                    
                    isProcessing = true;
                    console.log('üéØ Billing barcode detected:', barcode);
                    
                    // Immediate processing - no delay for real mart experience
                    searchAndAddProductByBarcode(barcode).finally(() => {
                        // Reset processing flag after 2 seconds
                        setTimeout(() => {
                            isProcessing = false;
                        }, 2000);
                    });
                });
            }
        }
        
        // Search product by barcode and add to bill - Real mart style
        async function searchAndAddProductByBarcode(barcode) {
            try {
                console.log('üîç [BILLING BARCODE] Searching for barcode:', barcode);
                
                // Show scanning feedback
                const camera = document.getElementById('billBarcodeCamera');
                const originalContent = camera.innerHTML;
                
                camera.innerHTML = `
                    <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 8px; color: white;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Barcode Detected!</div>
                        <div style="font-size: 14px; opacity: 0.9;">Searching product...</div>
                        <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">Code: ${barcode}</div>
                    </div>
                `;
                
                const apiUrl = `/api/products/search/barcode/${encodeURIComponent(barcode)}`;
                console.log('üì° [BILLING BARCODE] Making API request to:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('üì° [BILLING BARCODE] Response status:', response.status);
                
                const result = await response.json();
                console.log('üì° [BILLING BARCODE] API Response:', result);
                
                if (response.ok && result.success && result.product) {
                    const product = result.product;
                    console.log('‚úÖ [BILLING BARCODE] Product found:', product.name);
                    
                    // Show success feedback
                    camera.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 8px; color: white;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üõí</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${product.name}</div>
                            <div style="font-size: 16px; margin-bottom: 8px;">‚Çπ${product.price}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Added to bill!</div>
                        </div>
                    `;
                    
                    // Add product to bill
                    addProductToBill(product.id);
                    
                    // Close scanner after 2 seconds
                    setTimeout(() => {
                        closeBillBarcodeScanner();
                        showToast(`‚úÖ ${product.name} added to bill!`, 'success');
                    }, 2000);
                    
                } else {
                    console.log('‚ùå [BILLING BARCODE] Product not found for barcode:', barcode);
                    console.log('‚ùå [BILLING BARCODE] Available barcodes:', result.available_barcodes);
                    
                    // Show error feedback
                    camera.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border-radius: 8px; color: white;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Product Not Found</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Barcode: ${barcode}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 15px;">This product is not in your inventory</div>
                            <button onclick="closeBillBarcodeScanner()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 8px;">Try Again</button>
                        </div>
                    `;
                    
                    showToast(`‚ùå Product not found: ${barcode}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå [BILLING BARCODE] Error searching product by barcode:', error);
                console.error('‚ùå [BILLING BARCODE] Error details:', {
                    message: error.message,
                    stack: error.stack,
                    barcode: barcode
                });
                
                // Show detailed error
                const camera = document.getElementById('billBarcodeCamera');
                camera.innerHTML = `
                    <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); border-radius: 8px; color: white;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Connection Error</div>
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Barcode: ${barcode}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 15px;">Error: ${error.message}</div>
                        <button onclick="closeBillBarcodeScanner()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 8px; margin-right: 10px;">Close</button>
                        <button onclick="searchAndAddProductByBarcode('${barcode}')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 8px;">Retry</button>
                    </div>
                `;
                
                showToast(`‚ùå Connection error: ${error.message}`, 'error');
            }
        }
        
        // Close billing barcode scanner
        function closeBillBarcodeScanner() {
            const section = document.getElementById('billBarcodeSection');
            section.style.display = 'none';
            
            // Stop Quagga
            if (typeof Quagga !== 'undefined') {
                Quagga.stop();
            }
            
            // Stop camera stream
            if (billBarcodeStream) {
                billBarcodeStream.getTracks().forEach(track => track.stop());
                billBarcodeStream = null;
            }
        }
        
        // Complete bill
        async function completeBill() {
            if (billItems.length === 0) {
                showToast('‚ùå Please add products to bill', 'error');
                return;
            }
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            const subtotal = billItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('billDiscount')?.value || 0);
            
            // Correct calculation: Subtotal + GST - Discount = Total
            const gst = subtotal * 0.10; // 10% GST on subtotal
            const subtotalWithGST = subtotal + gst;
            const total = Math.max(0, subtotalWithGST - discount); // Apply discount after GST
            
            // Validate customer details for credit and partial payments
            let customerName = '';
            let customerPhone = '';
            
            if (paymentMethod === 'credit' || paymentMethod === 'partial') {
                customerName = document.getElementById('customerName')?.value.trim();
                customerPhone = document.getElementById('customerPhone')?.value.trim();
                
                if (!customerName || !customerPhone) {
                    showToast('‚ùå Customer name and phone are required for credit/partial payments', 'error');
                    return;
                }
            } else {
                // Optional customer details for regular payments
                customerName = document.getElementById('optionalCustomerName')?.value.trim() || 'Walk-in Customer';
                customerPhone = document.getElementById('optionalCustomerPhone')?.value.trim() || '';
            }
            
            // Validate partial payment amount
            let paidAmount = total;
            let creditBalance = 0;
            let isCredit = false;
            let paymentStatus = 'paid';
            
            if (paymentMethod === 'partial') {
                paidAmount = parseFloat(document.getElementById('partialAmount')?.value || 0);
                
                if (paidAmount <= 0 || paidAmount >= total) {
                    showToast('‚ùå Partial payment must be greater than 0 and less than total', 'error');
                    return;
                }
                
                creditBalance = total - paidAmount;
                isCredit = true;
                paymentStatus = 'partial';
            } else if (paymentMethod === 'credit') {
                paidAmount = 0;
                creditBalance = total;
                isCredit = true;
                paymentStatus = 'unpaid';
            }
            
            const billData = {
                business_type: 'retail',
                customer_name: customerName,
                customer_phone: customerPhone,
                items: billItems.map(item => ({
                    product_id: item.id,
                    product_name: item.name,
                    quantity: item.quantity,
                    unit_price: item.price,
                    total_price: item.total
                })),
                subtotal: subtotal,
                discount_amount: discount,
                tax_amount: gst,
                total_amount: total,
                payment_method: paymentMethod,  // Send actual payment method (partial, credit, cash, etc.)
                partial_amount: paymentMethod === 'partial' ? paidAmount : null,  // Add partial_amount field
                is_credit: isCredit,
                credit_paid_amount: paidAmount,
                credit_balance: creditBalance,
                payment_status: paymentStatus
            };
            
            try {
                const btn = document.getElementById('completeBillBtn');
                btn.textContent = '‚è≥ Processing...';
                btn.disabled = true;
                
                const response = await fetch('/api/bills', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(billData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('‚úÖ Bill completed successfully!', 'success');
                    
                    // Build success message
                    let message = `üéâ Bill Completed!\n\n`;
                    message += `Customer: ${customerName}\n`;
                    message += `Subtotal: ‚Çπ${subtotal.toFixed(2)}\n`;
                    if (discount > 0) {
                        message += `Discount: -‚Çπ${discount.toFixed(2)}\n`;
                    }
                    message += `GST (10%): ‚Çπ${gst.toFixed(2)}\n`;
                    message += `Total: ‚Çπ${total.toFixed(2)}\n\n`;
                    
                    if (paymentMethod === 'partial') {
                        message += `Paid Now: ‚Çπ${paidAmount.toFixed(2)}\n`;
                        message += `Remaining: ‚Çπ${creditBalance.toFixed(2)}\n`;
                        message += `Status: Partial Payment\n`;
                    } else if (paymentMethod === 'credit') {
                        message += `Status: Full Credit\n`;
                        message += `Amount Due: ‚Çπ${total.toFixed(2)}\n`;
                    } else {
                        message += `Payment: ${paymentMethod.toUpperCase()}\n`;
                        message += `Status: Paid\n`;
                    }
                    
                    message += `\nThank you!`;
                    
                    // Clear bill
                    billItems = [];
                    renderBillItems();
                    calculateBillTotal();
                    
                    // Reset form fields
                    document.getElementById('billDiscount').value = '';
                    document.getElementById('customerName').value = '';
                    document.getElementById('customerPhone').value = '';
                    document.getElementById('optionalCustomerName').value = '';
                    document.getElementById('optionalCustomerPhone').value = '';
                    document.getElementById('partialAmount').value = '';
                    document.getElementById('paymentMethod').value = 'cash';
                    handlePaymentMethodChange();
                    
                    // Show success message
                    alert(message);
                } else {
                    showToast('‚ùå Error completing bill: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error completing bill:', error);
                showToast('‚ùå Network error. Please try again.', 'error');
            } finally {
                const btn = document.getElementById('completeBillBtn');
                btn.textContent = 'üí∞ Complete Bill';
                btn.disabled = billItems.length === 0;
            }
        }
        

        
        // ========== EARNINGS/PROFIT MODULE ==========
        
        let currentEarningsFilter = 'today';
        
        // Load Earnings
        async function loadEarnings() {
            try {
                console.log('üíé Loading earnings from API...');
                
                // Get current filter (default to 'all')
                const dateFilter = currentEarningsFilter || 'all';
                
                // Call earnings API for summary
                const summaryResponse = await apiCall(`/api/earnings/summary?date_filter=${dateFilter}`);
                console.log('‚úÖ Earnings summary loaded:', summaryResponse);
                
                if (summaryResponse.success) {
                    const summary = summaryResponse.summary;
                    
                    // Update main summary cards
                    document.getElementById('totalProfit').textContent = '‚Çπ' + summary.total_profit.toFixed(0);
                    document.getElementById('totalSalesValue').textContent = '‚Çπ' + summary.total_revenue.toFixed(0);
                    document.getElementById('totalCostValue').textContent = '‚Çπ' + summary.total_cost.toFixed(0);
                    
                    // Update profit margin with pending info
                    const pendingText = summary.pending_profit > 0 ? ` (Pending: ‚Çπ${summary.pending_profit.toFixed(0)})` : '';
                    document.getElementById('profitMarginPercent').textContent = 'Margin: ' + summary.profit_margin.toFixed(1) + '%' + pendingText;
                    document.getElementById('profitMargin').textContent = summary.profit_margin.toFixed(1) + '%';
                    
                    // Update metrics
                    document.getElementById('grossProfit').textContent = '‚Çπ' + summary.gross_profit.toFixed(0);
                    document.getElementById('avgProfitPerSale').textContent = '‚Çπ' + summary.avg_profit_per_sale.toFixed(0);
                    document.getElementById('totalTransactionsCount').textContent = summary.transaction_count;
                }
                
                // Get product-wise earnings
                const productsResponse = await apiCall(`/api/earnings/products?date_filter=${dateFilter}`);
                console.log('‚úÖ Product earnings loaded:', productsResponse);
                
                if (productsResponse.success) {
                    displayProductProfits(productsResponse.products);
                }
                
                // Get top profitable products
                const topResponse = await apiCall(`/api/earnings/top-profitable?date_filter=${dateFilter}&limit=5`);
                console.log('‚úÖ Top profitable products loaded:', topResponse);
                
                if (topResponse.success) {
                    updateTopProfitableProducts(topResponse);
                }
                
            } catch (error) {
                console.error('‚ùå Error loading earnings:', error);
                showToast('Failed to load earnings data', 'error');
            }
        }
        
        // Update Top Profitable Products
        function updateTopProfitableProducts(data) {
            if (data.most_profitable && data.most_profitable.length > 0) {
                const mostProfitable = data.most_profitable[0];
                document.getElementById('mostProfitableProduct').textContent = mostProfitable.name;
                document.getElementById('mostProfitableAmount').textContent = '‚Çπ' + mostProfitable.total_profit.toFixed(0) + ' profit';
            }
            
            if (data.least_profitable && data.least_profitable.length > 0) {
                const leastProfitable = data.least_profitable[0];
                document.getElementById('leastProfitableProduct').textContent = leastProfitable.name;
                document.getElementById('leastProfitableAmount').textContent = '‚Çπ' + leastProfitable.total_profit.toFixed(0) + ' profit';
            }
        }
        
        // Display Product-wise Profits
        function displayProductProfits(products) {
            const container = document.getElementById('productProfitList');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">No data available</p>';
                return;
            }
            
            // Display product cards
            let html = '';
            products.forEach(product => {
                const marginClass = product.margin_class || 'margin-low';
                
                html += `
                    <div class="product-profit-card">
                        <div class="product-profit-header">
                            <div class="product-profit-name">
                                ${product.name}
                                <span class="profit-margin-badge ${marginClass}">${product.profit_margin.toFixed(1)}%</span>
                            </div>
                            <div class="product-profit-amount">‚Çπ${product.total_profit.toFixed(0)}</div>
                        </div>
                        <div class="product-profit-details">
                            <div class="product-profit-detail">
                                <span class="product-profit-detail-label">Sold</span>
                                <span class="product-profit-detail-value">${product.quantity_sold}</span>
                            </div>
                            <div class="product-profit-detail">
                                <span class="product-profit-detail-label">Revenue</span>
                                <span class="product-profit-detail-value">‚Çπ${product.total_sales.toFixed(0)}</span>
                            </div>
                            <div class="product-profit-detail">
                                <span class="product-profit-detail-label">Cost</span>
                                <span class="product-profit-detail-value">‚Çπ${product.total_cost.toFixed(0)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Display profit trend
            displayProfitTrend(products);
        }
        
        // Display Profit Trend
        function displayProfitTrend(products) {
            const container = document.getElementById('profitTrend');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">No data available</p>';
                return;
            }
            
            // Show top 5 products as bars
            const top5 = products.slice(0, 5);
            const maxProfit = Math.max(...top5.map(p => p.total_profit));
            
            let html = '';
            top5.forEach(product => {
                const percentage = maxProfit > 0 ? (product.total_profit / maxProfit) * 100 : 0;
                const barColor = percentage >= 80 ? '#4CAF50' : (percentage >= 50 ? '#FF9800' : '#2196F3');
                
                html += `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
                            <span style="color: #666;">${product.name}</span>
                            <span style="color: ${barColor}; font-weight: 600;">‚Çπ${product.total_profit.toFixed(0)}</span>
                        </div>
                        <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: ${barColor}; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Filter Earnings by Date
        async function filterEarningsByDate(period) {
            currentEarningsFilter = period;
            
            // Update active tab
            const tabs = document.querySelectorAll('#earningsModule .filter-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Reload earnings with new filter
            await loadEarnings();
        }
        
        // Refresh Earnings
        async function refreshEarnings() {
            await loadEarnings();
            showToast('‚úÖ Earnings data refreshed!', 'success');
        }
        
        // ========== REPORTS MODULE ==========
        
        let currentReportType = null;
        let currentReportData = null;
        let currentReportCategory = null;
        let filteredReportData = [];
        
        // Report category data
        const reportCategories = {
            sales: {
                title: 'üí∞ Sales Reports',
                reports: [
                    { id: 'sales_summary', name: 'üìà Sales Summary', desc: 'Daily sales summary for last 30 days' },
                    { id: 'sales_by_product', name: 'üì¶ Product-wise Sales', desc: 'Sales breakdown by products' },
                    { id: 'sales_by_customer', name: 'üë• Customer-wise Sales', desc: 'Sales breakdown by customers' },
                    { id: 'sales_by_payment', name: 'üí≥ Payment Method Report', desc: 'Sales by payment methods' },
                    { id: 'daily_sales', name: 'üìÖ Daily Sales Report', desc: 'Daily sales for last 30 days' }
                ]
            },
            inventory: {
                title: 'üì¶ Inventory Reports',
                reports: [
                    { id: 'stock_summary', name: 'üìä Stock Summary', desc: 'Current stock with valuation' },
                    { id: 'low_stock', name: '‚ö†Ô∏è Low Stock Alert', desc: 'Products below minimum stock' },
                    { id: 'out_of_stock', name: 'üö´ Out of Stock', desc: 'Products with zero stock' },
                    { id: 'expiry_report', name: '‚è∞ Expiry Report', desc: 'Products expiring soon' },
                    { id: 'stock_valuation', name: 'üíµ Stock Valuation', desc: 'Stock value and potential profit' }
                ]
            },
            financial: {
                title: 'üíé Financial Reports',
                reports: [
                    { id: 'profit_loss', name: 'üìä Profit & Loss', desc: 'Profit and loss by date' },
                    { id: 'revenue_report', name: 'üí∞ Revenue Report', desc: 'Revenue breakdown by date' }
                ]
            },
            customer: {
                title: 'üë• Customer Reports',
                reports: [
                    { id: 'customer_list', name: 'üìã Customer List', desc: 'All customers with details' },
                    { id: 'top_customers', name: '‚≠ê Top Customers', desc: 'Top 50 customers by spending' }
                ]
            },
            credit: {
                title: 'üí≥ Credit Reports',
                reports: [
                    { id: 'outstanding_credit', name: 'üìä Outstanding Credit', desc: 'All outstanding credit bills' },
                    { id: 'credit_payment_history', name: 'üí∞ Payment History', desc: 'Complete payment history with all transactions' }
                ]
            }
        };
        
        // Report titles mapping
        const reportTitles = {
            'sales_summary': 'üìà Sales Summary Report',
            'sales_by_product': 'üì¶ Product-wise Sales Report',
            'sales_by_customer': 'üë• Customer-wise Sales Report',
            'sales_by_payment': 'üí≥ Payment Method Report',
            'daily_sales': 'üìÖ Daily Sales Report',
            'stock_summary': 'üìä Stock Summary Report',
            'low_stock': '‚ö†Ô∏è Low Stock Alert Report',
            'out_of_stock': 'üö´ Out of Stock Report',
            'expiry_report': '‚è∞ Product Expiry Report',
            'stock_valuation': 'üíµ Stock Valuation Report',
            'profit_loss': 'üìä Profit & Loss Report',
            'revenue_report': 'üí∞ Revenue Report',
            'customer_list': 'üìã Customer List Report',
            'top_customers': '‚≠ê Top Customers Report',
            'outstanding_credit': 'üìä Outstanding Credit Report',
            'credit_payment_history': 'üí∞ Credit Payment History Report'
        };
        
        // Open Report Category (New Tab)
        function openReportCategory(category) {
            currentReportCategory = category;
            const categoryData = reportCategories[category];
            
            // Hide categories list
            document.getElementById('reportCategoriesList').style.display = 'none';
            
            // Show detail view
            document.getElementById('reportCategoryDetail').style.display = 'block';
            document.getElementById('categoryDetailTitle').textContent = categoryData.title;
            
            // Populate report options
            const optionsList = document.getElementById('reportOptionsList');
            let html = '';
            
            categoryData.reports.forEach(report => {
                html += `
                    <div class="report-item" onclick="generateReport('${report.id}')">
                        <div>
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 3px;">${report.name}</div>
                            <div style="font-size: 12px; color: #666;">${report.desc}</div>
                        </div>
                        <span style="color: #666; font-size: 18px;">‚Üí</span>
                    </div>
                `;
            });
            
            optionsList.innerHTML = html;
        }
        
        // Back to Report Categories
        function backToReportCategories() {
            // Hide detail view
            document.getElementById('reportCategoryDetail').style.display = 'none';
            document.getElementById('reportViewTab').style.display = 'none';
            
            // Show categories list
            document.getElementById('reportCategoriesList').style.display = 'grid';
            
            currentReportCategory = null;
            currentReportType = null;
            currentReportData = null;
        }
        
        // Back to Report Options
        function backToReportOptions() {
            // Hide report view
            document.getElementById('reportViewTab').style.display = 'none';
            
            // Show category detail
            document.getElementById('reportCategoryDetail').style.display = 'block';
            
            currentReportType = null;
            currentReportData = null;
        }
        
        // Generate Report (Opens in New Tab)
        async function generateReport(reportType) {
            currentReportType = reportType;
            
            showToast('üîÑ Generating report...', 'info');
            
            try {
                const response = await fetch(`/api/reports/${reportType}`);
                const data = await response.json();
                
                if (data.success) {
                    currentReportData = data.report_data || [];
                    filteredReportData = [...currentReportData];
                    
                    // Hide category detail, show report view
                    document.getElementById('reportCategoryDetail').style.display = 'none';
                    document.getElementById('reportViewTab').style.display = 'block';
                    
                    // Set report title
                    document.getElementById('reportViewTitle').textContent = reportTitles[reportType] || 'Report';
                    
                    // Display report in table
                    displayReportTable();
                    
                    showToast('‚úÖ Report generated successfully!', 'success');
                } else {
                    showToast('‚ùå ' + (data.error || 'Failed to generate report'), 'error');
                }
            } catch (error) {
                console.error('Error generating report:', error);
                showToast('‚ùå Network error. Please try again.', 'error');
            }
        }
        
        // üî• COMPACT CREDIT PAYMENT HISTORY DISPLAY
        function displayCompactCreditHistory(thead, tbody, tfoot) {
            // Group data by bill_number
            const billsMap = {};
            filteredReportData.forEach(row => {
                const billNum = row.bill_number;
                if (!billsMap[billNum]) {
                    billsMap[billNum] = {
                        bill_number: billNum,
                        customer_name: row.customer_name,
                        bill_amount: row.bill_amount,
                        total_paid: row.total_paid,
                        remaining_balance: row.remaining_balance,
                        bill_date: row.bill_date,
                        payments: []
                    };
                }
                if (row.payment_amount > 0) {
                    billsMap[billNum].payments.push({
                        payment_no: row.payment_no,
                        amount: row.payment_amount,
                        method: row.payment_method,
                        date: row.payment_date,
                        notes: row.payment_notes
                    });
                }
            });
            
            const bills = Object.values(billsMap);
            
            // Compact header
            thead.innerHTML = `
                <tr style="background: #732C3F; color: white;">
                    <th style="padding: 10px 8px; text-align: center; font-weight: 600; width: 50px;">S.NO</th>
                    <th style="padding: 10px 8px; text-align: left; font-weight: 600;">BILL NO</th>
                    <th style="padding: 10px 8px; text-align: left; font-weight: 600;">CUSTOMER</th>
                    <th style="padding: 10px 8px; text-align: right; font-weight: 600;">AMOUNT</th>
                    <th style="padding: 10px 8px; text-align: right; font-weight: 600;">PAID</th>
                    <th style="padding: 10px 8px; text-align: right; font-weight: 600;">DUE</th>
                    <th style="padding: 10px 8px; text-align: center; font-weight: 600; width: 80px;">DETAILS</th>
                </tr>
            `;
            
            // Compact body with expandable rows
            let bodyHtml = '';
            bills.forEach((bill, index) => {
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f9f9f9';
                const hasPayments = bill.payments.length > 0;
                const rowId = `bill-row-${index}`;
                const detailsId = `bill-details-${index}`;
                
                bodyHtml += `
                    <tr id="${rowId}" style="background: ${bgColor}; border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 10px 8px; text-align: center; font-weight: 600; color: #732C3F;">${index + 1}</td>
                        <td style="padding: 10px 8px; color: #2c3e50; font-weight: 600; font-size: 13px;">${bill.bill_number}</td>
                        <td style="padding: 10px 8px; color: #2c3e50; font-size: 13px;">${bill.customer_name}</td>
                        <td style="padding: 10px 8px; text-align: right; color: #2c3e50; font-weight: 600;">‚Çπ${bill.bill_amount.toFixed(0)}</td>
                        <td style="padding: 10px 8px; text-align: right; color: #28a745; font-weight: 600;">‚Çπ${bill.total_paid.toFixed(0)}</td>
                        <td style="padding: 10px 8px; text-align: right; color: ${bill.remaining_balance > 0 ? '#ef4444' : '#28a745'}; font-weight: 600;">‚Çπ${bill.remaining_balance.toFixed(0)}</td>
                        <td style="padding: 10px 8px; text-align: center;">
                            ${hasPayments ? `
                                <button onclick="toggleBillDetails('${detailsId}')" 
                                    style="background: #732C3F; color: white; border: none; padding: 5px 12px; border-radius: 5px; font-size: 11px; cursor: pointer; font-weight: 600;">
                                    ‚ñº ${bill.payments.length}
                                </button>
                            ` : '<span style="color: #999; font-size: 11px;">No Payments</span>'}
                        </td>
                    </tr>
                `;
                
                // Hidden details row
                if (hasPayments) {
                    bodyHtml += `
                        <tr id="${detailsId}" style="display: none; background: #f8f9fa;">
                            <td colspan="7" style="padding: 0;">
                                <div style="padding: 15px; border-left: 4px solid #732C3F;">
                                    <div style="font-weight: 600; color: #732C3F; margin-bottom: 10px; font-size: 13px;">üí∞ Payment History</div>
                                    <table style="width: 100%; font-size: 12px;">
                                        <thead>
                                            <tr style="background: #e9ecef;">
                                                <th style="padding: 6px 8px; text-align: left; font-weight: 600;">#</th>
                                                <th style="padding: 6px 8px; text-align: left; font-weight: 600;">Date</th>
                                                <th style="padding: 6px 8px; text-align: right; font-weight: 600;">Amount</th>
                                                <th style="padding: 6px 8px; text-align: left; font-weight: 600;">Method</th>
                                                <th style="padding: 6px 8px; text-align: left; font-weight: 600;">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;
                    
                    bill.payments.forEach((payment, pIdx) => {
                        const paymentDate = payment.date !== '-' ? new Date(payment.date).toLocaleDateString('en-IN') : '-';
                        bodyHtml += `
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 6px 8px; color: #666;">${pIdx + 1}</td>
                                <td style="padding: 6px 8px; color: #2c3e50;">${paymentDate}</td>
                                <td style="padding: 6px 8px; text-align: right; color: #28a745; font-weight: 600;">‚Çπ${payment.amount.toFixed(0)}</td>
                                <td style="padding: 6px 8px; color: #2c3e50;">
                                    <span style="background: #732C3F; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                                        ${payment.method}
                                    </span>
                                </td>
                                <td style="padding: 6px 8px; color: #666; font-size: 11px;">${payment.notes || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    bodyHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tbody.innerHTML = bodyHtml;
            
            // Summary footer
            const totalBillAmount = bills.reduce((sum, b) => sum + b.bill_amount, 0);
            const totalPaid = bills.reduce((sum, b) => sum + b.total_paid, 0);
            const totalDue = bills.reduce((sum, b) => sum + b.remaining_balance, 0);
            
            tfoot.innerHTML = `
                <tr style="background: #f0f0f0; font-weight: 600; border-top: 2px solid #732C3F;">
                    <td colspan="3" style="padding: 10px 8px; color: #732C3F;">TOTAL (${bills.length} Bills)</td>
                    <td style="padding: 10px 8px; text-align: right; color: #732C3F;">‚Çπ${totalBillAmount.toFixed(0)}</td>
                    <td style="padding: 10px 8px; text-align: right; color: #28a745;">‚Çπ${totalPaid.toFixed(0)}</td>
                    <td style="padding: 10px 8px; text-align: right; color: #ef4444;">‚Çπ${totalDue.toFixed(0)}</td>
                    <td></td>
                </tr>
            `;
            tfoot.style.display = 'table-footer-group';
        }
        
        // Toggle bill payment details
        function toggleBillDetails(detailsId) {
            const detailsRow = document.getElementById(detailsId);
            if (detailsRow) {
                detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
            }
        }
        
        // Display Report in Table Format
        function displayReportTable() {
            const thead = document.getElementById('reportTableHead');
            const tbody = document.getElementById('reportTableBody');
            const tfoot = document.getElementById('reportTableFoot');
            
            if (filteredReportData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="padding: 40px; text-align: center; color: #999;"><div style="font-size: 48px; margin-bottom: 10px;">üì≠</div><div>No data available</div></td></tr>';
                tfoot.style.display = 'none';
                return;
            }
            
            // üî• SPECIAL COMPACT DISPLAY FOR CREDIT PAYMENT HISTORY
            if (currentReportType === 'credit_payment_history') {
                displayCompactCreditHistory(thead, tbody, tfoot);
                return;
            }
            
            // Get column headers (excluding S.No which we'll add)
            const headers = Object.keys(filteredReportData[0]);
            
            // Build table header with S.No as first column
            let headerHtml = '<tr style="background: #732C3F; color: white;">';
            headerHtml += `<th style="padding: 12px 8px; text-align: center; font-weight: 600; white-space: nowrap; width: 60px;">S.NO</th>`;
            headers.forEach(header => {
                const displayName = header.replace(/_/g, ' ').toUpperCase();
                headerHtml += `<th style="padding: 12px 8px; text-align: left; font-weight: 600; white-space: nowrap;">${displayName}</th>`;
            });
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;
            
            // Build table body with S.No
            let bodyHtml = '';
            filteredReportData.forEach((row, index) => {
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f9f9f9';
                bodyHtml += `<tr style="background: ${bgColor}; border-bottom: 1px solid #f0f0f0;">`;
                
                // Add S.No column
                bodyHtml += `<td style="padding: 12px 8px; text-align: center; font-weight: 600; color: #732C3F;">${index + 1}</td>`;
                
                headers.forEach(header => {
                    let value = row[header];
                    
                    // Format currency values
                    if (header.includes('amount') || header.includes('price') || header.includes('total') || 
                        header.includes('revenue') || header.includes('value') || header.includes('cost') || 
                        header.includes('profit') || header.includes('outstanding') || header.includes('paid')) {
                        value = '‚Çπ' + parseFloat(value || 0).toFixed(2);
                    }
                    
                    bodyHtml += `<td style="padding: 12px 8px; color: #2c3e50;">${value || '-'}</td>`;
                });
                
                bodyHtml += '</tr>';
            });
            tbody.innerHTML = bodyHtml;
            
            // Calculate and show summary if applicable
            const summaryRow = calculateReportSummary(headers);
            if (summaryRow) {
                tfoot.innerHTML = summaryRow;
                tfoot.style.display = 'table-footer-group';
            } else {
                tfoot.style.display = 'none';
            }
        }
        
        // Calculate Report Summary
        function calculateReportSummary(headers) {
            if (filteredReportData.length === 0) return null;
            
            let hasSummary = false;
            let summaryHtml = '<tr style="background: #f0f0f0; font-weight: 600; border-top: 2px solid #732C3F;">';
            
            // Add S.No column with "TOTAL" label
            summaryHtml += `<td style="padding: 12px 8px; color: #732C3F; text-align: center;">TOTAL</td>`;
            
            headers.forEach((header, index) => {
                if (index === 0) {
                    summaryHtml += `<td style="padding: 12px 8px; color: #732C3F;">${filteredReportData.length} Records</td>`;
                } else if (header.includes('amount') || header.includes('price') || header.includes('total') || 
                           header.includes('revenue') || header.includes('value') || header.includes('cost') || 
                           header.includes('profit') || header.includes('outstanding') || header.includes('paid')) {
                    // Sum numeric columns
                    const sum = filteredReportData.reduce((acc, row) => acc + parseFloat(row[header] || 0), 0);
                    summaryHtml += `<td style="padding: 12px 8px; color: #732C3F;">‚Çπ${sum.toFixed(2)}</td>`;
                    hasSummary = true;
                } else if (header.includes('quantity') || header.includes('count') || header.includes('bills') || 
                           header.includes('transactions') || header.includes('stock')) {
                    // Sum count columns
                    const sum = filteredReportData.reduce((acc, row) => acc + parseFloat(row[header] || 0), 0);
                    summaryHtml += `<td style="padding: 12px 8px; color: #732C3F;">${sum}</td>`;
                    hasSummary = true;
                } else {
                    summaryHtml += `<td style="padding: 12px 8px;"></td>`;
                }
            });
            
            summaryHtml += '</tr>';
            
            return hasSummary ? summaryHtml : null;
        }
        
        // Apply Report Filters
        function applyReportFilters() {
            if (!currentReportData || currentReportData.length === 0) return;
            
            const searchTerm = document.getElementById('reportSearchFilter').value.toLowerCase();
            const sortBy = document.getElementById('reportSortFilter').value;
            
            // Filter by search
            filteredReportData = currentReportData.filter(row => {
                if (!searchTerm) return true;
                
                return Object.values(row).some(value => 
                    String(value).toLowerCase().includes(searchTerm)
                );
            });
            
            // Sort data
            if (sortBy !== 'default') {
                filteredReportData.sort((a, b) => {
                    if (sortBy === 'amount_desc') {
                        const aVal = Object.values(a).find(v => typeof v === 'number') || 0;
                        const bVal = Object.values(b).find(v => typeof v === 'number') || 0;
                        return bVal - aVal;
                    } else if (sortBy === 'amount_asc') {
                        const aVal = Object.values(a).find(v => typeof v === 'number') || 0;
                        const bVal = Object.values(b).find(v => typeof v === 'number') || 0;
                        return aVal - bVal;
                    } else if (sortBy === 'date_desc' || sortBy === 'date_asc') {
                        const dateKey = Object.keys(a).find(k => k.includes('date'));
                        if (dateKey) {
                            const aDate = new Date(a[dateKey]);
                            const bDate = new Date(b[dateKey]);
                            return sortBy === 'date_desc' ? bDate - aDate : aDate - bDate;
                        }
                    }
                    return 0;
                });
            }
            
            displayReportTable();
        }
        
        // Clear Report Filters
        function clearReportFilters() {
            document.getElementById('reportDateFilter').value = 'week';
            document.getElementById('reportSearchFilter').value = '';
            document.getElementById('reportSortFilter').value = 'default';
            
            filteredReportData = [...currentReportData];
            displayReportTable();
            
            showToast('‚úÖ Filters cleared', 'success');
        }
        
        // Export Report
        function exportReport(format) {
            if (!currentReportType || !currentReportData) {
                showToast('‚ùå No report to export', 'error');
                return;
            }
            
            showToast(`üîÑ Exporting report as ${format.toUpperCase()}...`, 'info');
            
            // Call export API
            window.open(`/api/reports/${currentReportType}/export?format=${format}`, '_blank');
            
            showToast(`‚úÖ Report exported as ${format.toUpperCase()}!`, 'success');
        }
        
        // Refresh Reports
        function refreshReports() {
            // Go back to categories list
            backToReportCategories();
            
            showToast('‚úÖ Reports refreshed!', 'success');
        }
        
        // Scroll to top
        function scrollToTop() {
            // Show dashboard
            document.getElementById('productsModule').style.display = 'none';
            document.getElementById('customersModule').style.display = 'none';
            document.getElementById('salesModule').style.display = 'none';
            document.getElementById('earningsModule').style.display = 'none';
            document.getElementById('dataDisplay').style.display = 'none';
            
            // Show dashboard cards
            document.querySelectorAll('.card').forEach(card => {
                if (!card.id || (card.id !== 'dataDisplay' && card.id !== 'productsModule' && card.id !== 'customersModule' && card.id !== 'salesModule' && card.id !== 'earningsModule')) {
                    card.style.display = 'block';
                }
            });
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ========== SETTINGS MODULE ==========
        
        // Toggle Setting Section
        function toggleSettingSection(sectionName) {
            const section = document.getElementById(sectionName + 'Section');
            
            if (section) {
                if (section.style.display === 'none') {
                    // Close all other sections first
                    document.querySelectorAll('[id$="Section"]').forEach(s => {
                        if (s.id !== sectionName + 'Section') {
                            s.style.display = 'none';
                        }
                    });
                    // Open this section
                    section.style.display = 'block';
                    
                    // Load notification settings if opening notifications
                    if (sectionName === 'notifications') {
                        loadNotificationSettings();
                    }
                } else {
                    // Close this section
                    section.style.display = 'none';
                }
            }
        }
        
        // Load Settings
        function loadSettings() {
            console.log('‚öôÔ∏è Loading settings...');
            
            // Load from localStorage
            const settings = JSON.parse(localStorage.getItem('bizpulse_settings') || '{}');
            
            // GST Settings
            if (settings.gstNumber) document.getElementById('gstNumber').value = settings.gstNumber;
            if (settings.defaultGST) document.getElementById('defaultGST').value = settings.defaultGST;
            if (settings.discountTiming) document.getElementById('discountTiming').value = settings.discountTiming;
            
            // Invoice Settings
            if (settings.invoicePrefix) document.getElementById('invoicePrefix').value = settings.invoicePrefix;
            if (settings.invoiceStartNumber) document.getElementById('invoiceStartNumber').value = settings.invoiceStartNumber;
            
            // App Settings
            if (settings.appLanguage) document.getElementById('appLanguage').value = settings.appLanguage;
            if (settings.appCurrency) document.getElementById('appCurrency').value = settings.appCurrency;
            if (settings.dateFormat) document.getElementById('dateFormat').value = settings.dateFormat;
            if (settings.timeFormat) document.getElementById('timeFormat').value = settings.timeFormat;
            
            console.log('‚úÖ Settings loaded:', settings);
        }
        
        // Save Settings
        function saveSettings() {
            try {
                const settings = {
                    gstNumber: document.getElementById('gstNumber')?.value || '',
                    defaultGST: document.getElementById('defaultGST')?.value || '18',
                    discountTiming: document.getElementById('discountTiming')?.value || 'after_tax',
                    invoicePrefix: document.getElementById('invoicePrefix')?.value || 'INV',
                    invoiceStartNumber: document.getElementById('invoiceStartNumber')?.value || '1001',
                    appLanguage: document.getElementById('appLanguage')?.value || 'en',
                    appCurrency: document.getElementById('appCurrency')?.value || 'INR',
                    dateFormat: document.getElementById('dateFormat')?.value || 'DD/MM/YYYY',
                    timeFormat: document.getElementById('timeFormat')?.value || '12',
                    savedAt: new Date().toISOString()
                };
                
                localStorage.setItem('bizpulse_settings', JSON.stringify(settings));
                
                showToast('‚úÖ Settings saved successfully!', 'success');
                console.log('üíæ Settings saved:', settings);
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('‚ùå Failed to save settings', 'error');
            }
        }
        
        // ========== NOTIFICATION SETTINGS ==========
        
        // Load Notification Settings
        async function loadNotificationSettings() {
            try {
                console.log('üîî Loading notification settings...');
                const response = await fetch('/api/settings/notifications');
                const result = await response.json();
                
                if (result.success) {
                    displayNotificationSettings(result.settings);
                } else {
                    document.getElementById('notificationSettingsList').innerHTML = '<p style="color: red; text-align: center;">Failed to load settings</p>';
                }
            } catch (error) {
                console.error('Error loading notification settings:', error);
                document.getElementById('notificationSettingsList').innerHTML = '<p style="color: red; text-align: center;">Error loading settings</p>';
            }
        }
        
        // Display Notification Settings
        function displayNotificationSettings(settings) {
            const container = document.getElementById('notificationSettingsList');
            
            const settingIcons = {
                'product_expiry': '‚è∞',
                'low_stock': 'üìâ',
                'out_of_stock': '‚ùå',
                'expired_products': 'üö´'
            };
            
            const settingNames = {
                'product_expiry': 'Product Expiry Alerts',
                'low_stock': 'Low Stock Alerts',
                'out_of_stock': 'Out of Stock Alerts',
                'expired_products': 'Expired Products Alerts'
            };
            
            const settingDescriptions = {
                'product_expiry': 'Get notified before products expire',
                'low_stock': 'Alert when stock reaches minimum level',
                'out_of_stock': 'Alert when products are out of stock',
                'expired_products': 'Alert for expired products'
            };
            
            let html = '';
            
            settings.forEach(setting => {
                const icon = settingIcons[setting.setting_type] || 'üîî';
                const name = settingNames[setting.setting_type] || setting.setting_type;
                const description = settingDescriptions[setting.setting_type] || '';
                const showThreshold = setting.setting_type === 'product_expiry';
                
                html += `
                    <div style="background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 2px solid ${setting.enabled ? '#732C3F' : '#ddd'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: #2c3e50; margin-bottom: 3px;">
                                    ${icon} ${name}
                                </div>
                                <div style="font-size: 11px; color: #666;">${description}</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                <input type="checkbox" ${setting.enabled ? 'checked' : ''} 
                                    onchange="toggleNotificationSetting('${setting.id}', this.checked)"
                                    style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
                                    background-color: ${setting.enabled ? '#732C3F' : '#ccc'}; 
                                    transition: .4s; border-radius: 24px;">
                                    <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; 
                                        background-color: white; transition: .4s; border-radius: 50%; 
                                        transform: ${setting.enabled ? 'translateX(26px)' : 'translateX(0)'};"></span>
                                </span>
                            </label>
                        </div>
                        
                        ${setting.enabled ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                ${showThreshold ? `
                                    <div>
                                        <label style="font-size: 11px; color: #666; display: block; margin-bottom: 4px;">Days Before Expiry</label>
                                        <input type="number" value="${setting.threshold_days}" min="1" max="30"
                                            onchange="updateNotificationSetting('${setting.id}', 'threshold_days', this.value)"
                                            style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                    </div>
                                ` : '<div></div>'}
                                <div>
                                    <label style="font-size: 11px; color: #666; display: block; margin-bottom: 4px;">Alerts Per Day</label>
                                    <input type="number" value="${setting.frequency_per_day}" min="1" max="10"
                                        onchange="updateNotificationSetting('${setting.id}', 'frequency_per_day', this.value)"
                                        style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Toggle Notification Setting
        async function toggleNotificationSetting(settingId, enabled) {
            try {
                const response = await fetch(`/api/settings/notifications/${settingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabled ? 1 : 0 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(enabled ? '‚úÖ Notifications enabled' : '‚ö†Ô∏è Notifications disabled', 'success');
                    await loadNotificationSettings(); // Reload to update UI
                } else {
                    showToast('‚ùå Failed to update setting', 'error');
                }
            } catch (error) {
                console.error('Error toggling notification:', error);
                showToast('‚ùå Network error', 'error');
            }
        }
        
        // Update Notification Setting
        let updateTimeout;
        async function updateNotificationSetting(settingId, field, value) {
            // Debounce updates
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(async () => {
                try {
                    const data = {};
                    data[field] = parseInt(value);
                    
                    const response = await fetch(`/api/settings/notifications/${settingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast('‚úÖ Setting updated', 'success');
                    } else {
                        showToast('‚ùå Failed to update', 'error');
                    }
                } catch (error) {
                    console.error('Error updating notification setting:', error);
                    showToast('‚ùå Network error', 'error');
                }
            }, 500);
        }
        
        
        // Backup Data - Export all data as JSON file
        function backupData() {
            try {
                console.log('üì• Starting backup...');
                
                // Collect all data from localStorage
                const backupData = {
                    settings: JSON.parse(localStorage.getItem('bizpulse_settings') || '{}'),
                    products: JSON.parse(localStorage.getItem('bizpulse_products') || '[]'),
                    customers: JSON.parse(localStorage.getItem('bizpulse_customers') || '[]'),
                    sales: JSON.parse(localStorage.getItem('bizpulse_sales') || '[]'),
                    bills: JSON.parse(localStorage.getItem('bizpulse_bills') || '[]'),
                    backupDate: new Date().toISOString(),
                    version: '1.0.0'
                };
                
                // Convert to JSON string
                const jsonString = JSON.stringify(backupData, null, 2);
                
                // Create blob and download
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bizpulse_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Backup downloaded successfully!\n\nFile: ' + a.download);
                console.log('‚úÖ Backup completed:', backupData);
            } catch (error) {
                console.error('‚ùå Backup failed:', error);
                alert('‚ùå Backup failed: ' + error.message);
            }
        }
        
        // Restore Data - Import data from JSON file
        function restoreData() {
            try {
                console.log('üì§ Starting restore...');
                
                // Create file input
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = async (e) => {
                    try {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        // Read file
                        const text = await file.text();
                        const backupData = JSON.parse(text);
                        
                        // Validate backup data
                        if (!backupData.version || !backupData.backupDate) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        // Confirm restore
                        const confirm = window.confirm(
                            '‚ö†Ô∏è WARNING: This will replace all current data!\n\n' +
                            'Backup Date: ' + new Date(backupData.backupDate).toLocaleString() + '\n' +
                            'Version: ' + backupData.version + '\n\n' +
                            'Do you want to continue?'
                        );
                        
                        if (!confirm) return;
                        
                        // Restore data to localStorage
                        if (backupData.settings) {
                            localStorage.setItem('bizpulse_settings', JSON.stringify(backupData.settings));
                        }
                        if (backupData.products) {
                            localStorage.setItem('bizpulse_products', JSON.stringify(backupData.products));
                        }
                        if (backupData.customers) {
                            localStorage.setItem('bizpulse_customers', JSON.stringify(backupData.customers));
                        }
                        if (backupData.sales) {
                            localStorage.setItem('bizpulse_sales', JSON.stringify(backupData.sales));
                        }
                        if (backupData.bills) {
                            localStorage.setItem('bizpulse_bills', JSON.stringify(backupData.bills));
                        }
                        
                        alert('‚úÖ Data restored successfully!\n\nPlease refresh the page to see changes.');
                        console.log('‚úÖ Restore completed:', backupData);
                        
                        // Reload page after 2 seconds
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                        
                    } catch (error) {
                        console.error('‚ùå Restore failed:', error);
                        alert('‚ùå Restore failed: ' + error.message);
                    }
                };
                
                input.click();
                
            } catch (error) {
                console.error('‚ùå Restore failed:', error);
                alert('‚ùå Restore failed: ' + error.message);
            }
        }
        
        // Change Password
        function changePassword() {
            try {
                console.log('üîë Change password initiated...');
                
                // Get current password from localStorage
                const currentUser = JSON.parse(localStorage.getItem('bizpulse_user') || '{"password":"demo123"}');
                
                // Prompt for current password
                const currentPassword = prompt('üîí Enter current password:');
                if (!currentPassword) return;
                
                if (currentPassword !== currentUser.password) {
                    alert('‚ùå Current password is incorrect!');
                    return;
                }
                
                // Prompt for new password
                const newPassword = prompt('üîë Enter new password:\n(Minimum 6 characters)');
                if (!newPassword) return;
                
                if (newPassword.length < 6) {
                    alert('‚ùå Password must be at least 6 characters long!');
                    return;
                }
                
                // Confirm new password
                const confirmPassword = prompt('üîë Confirm new password:');
                if (!confirmPassword) return;
                
                if (newPassword !== confirmPassword) {
                    alert('‚ùå Passwords do not match!');
                    return;
                }
                
                // Save new password
                currentUser.password = newPassword;
                currentUser.passwordChangedAt = new Date().toISOString();
                localStorage.setItem('bizpulse_user', JSON.stringify(currentUser));
                
                alert('‚úÖ Password changed successfully!\n\nPlease remember your new password.');
                console.log('‚úÖ Password changed at:', currentUser.passwordChangedAt);
                
            } catch (error) {
                console.error('‚ùå Change password failed:', error);
                alert('‚ùå Change password failed: ' + error.message);
            }
        }
        
        // Clear Cache - Remove temporary data
        function clearCache() {
            try {
                console.log('üóëÔ∏è Clearing cache...');
                
                const confirm = window.confirm(
                    'üóëÔ∏è Clear Cache?\n\n' +
                    'This will remove:\n' +
                    '‚Ä¢ Temporary files\n' +
                    '‚Ä¢ Cached images\n' +
                    '‚Ä¢ Session data\n\n' +
                    'Your settings and data will be preserved.\n\n' +
                    'Continue?'
                );
                
                if (!confirm) return;
                
                // Clear specific cache items (not settings/data)
                const keysToKeep = [
                    'bizpulse_settings',
                    'bizpulse_products',
                    'bizpulse_customers',
                    'bizpulse_sales',
                    'bizpulse_bills',
                    'bizpulse_user',
                    'bizpulse_login'
                ];
                
                // Get all keys
                const allKeys = Object.keys(localStorage);
                
                // Remove keys that are not in keysToKeep
                let removedCount = 0;
                allKeys.forEach(key => {
                    if (!keysToKeep.includes(key)) {
                        localStorage.removeItem(key);
                        removedCount++;
                    }
                });
                
                // Clear session storage
                sessionStorage.clear();
                
                alert(`‚úÖ Cache cleared successfully!\n\n${removedCount} temporary items removed.`);
                console.log(`‚úÖ Cache cleared: ${removedCount} items removed`);
                
            } catch (error) {
                console.error('‚ùå Clear cache failed:', error);
                alert('‚ùå Clear cache failed: ' + error.message);
            }
        }
        
        // Reset App - Remove all data and settings
        function resetApp() {
            try {
                console.log('‚ö†Ô∏è Reset app initiated...');
                
                const confirm1 = window.confirm(
                    '‚ö†Ô∏è RESET APP?\n\n' +
                    'This will DELETE ALL DATA:\n' +
                    '‚Ä¢ All settings\n' +
                    '‚Ä¢ All products\n' +
                    '‚Ä¢ All customers\n' +
                    '‚Ä¢ All sales records\n' +
                    '‚Ä¢ All bills\n\n' +
                    '‚ö†Ô∏è THIS CANNOT BE UNDONE!\n\n' +
                    'Are you sure?'
                );
                
                if (!confirm1) return;
                
                // Second confirmation
                const confirm2 = window.confirm(
                    '‚ö†Ô∏è FINAL WARNING!\n\n' +
                    'This is your last chance to cancel.\n\n' +
                    'All data will be permanently deleted.\n\n' +
                    'Type YES in the next prompt to confirm.'
                );
                
                if (!confirm2) return;
                
                // Final confirmation with text input
                const finalConfirm = prompt('‚ö†Ô∏è Type "YES" to confirm reset:');
                
                if (finalConfirm !== 'YES') {
                    alert('‚ùå Reset cancelled. Data is safe.');
                    return;
                }
                
                // Clear all localStorage
                localStorage.clear();
                
                // Clear all sessionStorage
                sessionStorage.clear();
                
                alert('‚úÖ App reset successfully!\n\nThe page will reload now.');
                console.log('‚úÖ App reset completed');
                
                // Reload page after 1 second
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Reset app failed:', error);
                alert('‚ùå Reset app failed: ' + error.message);
            }
        }
        

    </script>
</body>
</html>
