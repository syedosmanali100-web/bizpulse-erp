<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Management - BizPulse (Updated v2.0)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            color: #1f2937;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: #732C3F;
        }
        
        .nav-item {
            padding: 12px 20px;
            color: #6b7280;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .nav-item:hover, .nav-item.active {
            background: #f9fafb;
            color: #732C3F;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 24px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #732C3F;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a2332;
        }
        
        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #f9fafb;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 1.875rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .stat-change {
            font-size: 0.875rem;
            color: #10b981;
            font-weight: 500;
        }
        
        .stat-change.negative {
            color: #ef4444;
        }
        
        /* Filters */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            min-width: 150px;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #732C3F;
        }
        
        /* Table */
        .table-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Dark Black Table Headers */
        thead th {
            color: #000000 !important;
            font-weight: 700 !important;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f1f5f9 !important;
            border-bottom: 2px solid #000000;
        }
        
        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .pagination-info {
            color: #6b7280;
            font-size: 14px;
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-numbers {
            display: flex;
            gap: 5px;
        }
        
        .pagination-number {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            min-width: 40px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .pagination-number:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        
        .pagination-number.active {
            background: #732C3F;
            color: white;
            border-color: #732C3F;
        }
        
        th {
            padding: 12px 16px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        td {
            padding: 16px;
            font-size: 0.875rem;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tbody tr:hover {
            background: #f9fafb;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #dc2626;
        }
        
        /* Export Actions */
        .export-actions {
            display: flex;
            justify-content: flex-end;
            margin: 1rem 0;
        }

        .export-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .export-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .pdf-btn {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
        }

        .excel-btn {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
        }

        .csv-btn {
            background: linear-gradient(135deg, #3182ce, #2c5282);
            color: white;
        }

        .whatsapp-btn {
            background: linear-gradient(135deg, #25d366, #128c7e);
            color: white;
        }

        .export-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .export-btn:active {
            transform: translateY(0);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 1rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">BizPulse</div>
        </div>
        <nav>
            <a href="/retail/dashboard" class="nav-item">
                <span>üìä</span> Dashboard
            </a>
            <a href="/retail/sales" class="nav-item active">
                <span>üí∞</span> Sales
            </a>
            <a href="/retail/products" class="nav-item">
                <span>üì¶</span> Products
            </a>
            <a href="/retail/customers" class="nav-item">
                <span>üë•</span> Customers
            </a>
            <a href="/retail/reports" class="nav-item">
                <span>üìà</span> Reports
            </a>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <h1 class="page-title">Sales Management</h1>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">‚úÖ v2.0 - Updated with Pagination & Dark Headers</div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportSales()">
                    üì• Export CSV
                </button>
                <a href="/retail/billing" class="btn btn-primary">
                    ‚ûï New Sale
                </a>
            </div>
                </button>
                <button class="btn btn-primary" onclick="addSale()">
                    ‚ûï New Sale
                </button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Sales</div>
                <div class="stat-value" data-stat="total-sales">‚Çπ0</div>
                <div class="stat-change">Current filter period</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Bills</div>
                <div class="stat-value" data-stat="total-bills">0</div>
                <div class="stat-change">Number of transactions</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Average Sale</div>
                <div class="stat-value" data-stat="avg-sale">‚Çπ0</div>
                <div class="stat-change">Per transaction</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Profit</div>
                <div class="stat-value" data-stat="total-profit">‚Çπ0</div>
                <div class="stat-change">Estimated profit</div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Date Range</label>
                <select class="filter-input" id="dateRange" onchange="filterSales()">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="all">All Time</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            
            <!-- Custom Date Range Inputs (hidden by default) -->
            <div class="filter-group" id="customDateInputs" style="display: none;">
                <label class="filter-label">Start Date</label>
                <input type="date" class="filter-input" id="startDate" onchange="filterSales()">
            </div>
            <div class="filter-group" id="customDateInputsEnd" style="display: none;">
                <label class="filter-label">End Date</label>
                <input type="date" class="filter-input" id="endDate" onchange="filterSales()">
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Payment Method</label>
                <select class="filter-input" id="paymentFilter" onchange="filterSales()">
                    <option value="all">All Methods</option>
                    <option value="cash">Cash</option>
                    <option value="card">Card</option>
                    <option value="upi">UPI</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Search</label>
                <input type="text" class="filter-input" placeholder="Search..." id="searchInput" oninput="filterSales()">
            </div>
            <button class="btn btn-secondary" onclick="resetFilters()" style="margin-top: 22px;">
                üîÑ Reset
            </button>
            <div class="filter-group">
                <div class="filter-label">Filter Info</div>
                <div id="filterInfo" style="font-size: 0.875rem; color: #6b7280; margin-top: 6px;">
                    Loading...
                </div>
            </div>
        </div>
        
        <!-- Export Actions -->
        <div class="export-actions">
            <div class="export-buttons">
                <button class="export-btn pdf-btn" onclick="exportToPDF()" title="Export to PDF">
                    <svg width="20" height="20" viewBox="0 0 240 234" fill="white">
                        <path d="M42.5 0h155C221 0 240 19 240 42.5v149c0 23.5-19 42.5-42.5 42.5h-155C19 234 0 215 0 191.5v-149C0 19 19 0 42.5 0z"/>
                        <path d="M59.5 142.5c4.5 0 8.5-1.5 11.5-4.5s4.5-7 4.5-11.5-1.5-8.5-4.5-11.5-7-4.5-11.5-4.5h-7v32h7zm0-24c2.5 0 4.5.5 6 2s2.5 3.5 2.5 6-.5 4.5-2.5 6-3.5 2-6 2h-1v-16h1z" fill="#DC143C"/>
                        <path d="M95.5 142.5c4.5 0 8.5-1.5 11.5-4.5s4.5-7 4.5-11.5-1.5-8.5-4.5-11.5-7-4.5-11.5-4.5h-7v32h7zm0-24c2.5 0 4.5.5 6 2s2.5 3.5 2.5 6-.5 4.5-2.5 6-3.5 2-6 2h-1v-16h1z" fill="#DC143C"/>
                        <path d="M131.5 142.5h6v-16h8v-6h-8v-4h10v-6h-16v32z" fill="#DC143C"/>
                    </svg>
                </button>
                <button class="export-btn excel-btn" onclick="exportToExcel()" title="Export to Excel">
                    <svg width="20" height="20" viewBox="0 0 2080 2080" fill="white">
                        <path d="M1920 0H160C72 0 0 72 0 160v1760c0 88 72 160 160 160h1760c88 0 160-72 160-160V160c0-88-72-160-160-160z"/>
                        <path d="M1280 640h480v160h-480V640zm0 240h480v160h-480V880zm0 240h480v160h-480v-160zm0 240h480v160h-480v-160z" fill="#107C41"/>
                        <path d="M320 640h800v800H320V640z" fill="#107C41"/>
                        <path d="M480 800l160 160-160 160 80 80 160-160 160 160 80-80-160-160 160-160-80-80-160 160-160-160-80 80z" fill="white"/>
                    </svg>
                </button>
                <button class="export-btn csv-btn" onclick="exportToCSV()" title="Export to CSV">
                    <svg width="20" height="20" viewBox="0 0 384 512" fill="white">
                        <path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm-96 144c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8 8 3.58 8 8zm0 64c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8 8 3.58 8 8zm0 64c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8 8 3.58 8 8zm96-128c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8 8 3.58 8 8zm0 64c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8 8 3.58 8 8zm0 64c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8 8 3.58 8 8zm96-128c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8 8 3.58 8 8zm0 64c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8 8 3.58 8 8zm0 64c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8 8 3.58 8 8zM377 105L279.1 7c-4.5-4.5-10.6-7-17-7H256v128h128v-6.1c0-6.3-2.5-12.4-7-16.9z"/>
                    </svg>
                </button>
                <button class="export-btn whatsapp-btn" onclick="shareViaWhatsApp()" title="Share via WhatsApp">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.516"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Bill No</th>
                        <th>Date & Time</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Amount</th>
                        <th>Payment</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="salesTable">
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <div class="empty-state-text">Loading sales data...</div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination-container" id="paginationContainer" style="display: none;">
            <div class="pagination-info">
                <span id="paginationInfo">Showing 1-10 of 0 transactions</span>
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)" disabled>
                    ‚Üê Previous
                </button>
                <div class="pagination-numbers" id="paginationNumbers">
                    <!-- Page numbers will be inserted here -->
                </div>
                <button class="pagination-btn" id="nextBtn" onclick="changePage(1)" disabled>
                    Next ‚Üí
                </button>
            </div>
        </div>
    </div>
    
    <script>
        let currentFilters = {
            filter: 'today',
            startDate: null,
            endDate: null,
            category: 'all',
            payment_method: 'all',
            search: ''
        };
        
        let currentSales = []; // Store current sales data

        // Get current date in IST timezone (YYYY-MM-DD format)
        function getCurrentDateIST() {
            const now = new Date();
            const istOffset = 5.5 * 60 * 60 * 1000; // IST is UTC+5:30
            const istTime = new Date(now.getTime() + istOffset);
            return istTime.toISOString().split('T')[0];
        }

        function getYesterdayDateIST() {
            const now = new Date();
            const istOffset = 5.5 * 60 * 60 * 1000;
            const yesterday = new Date(now.getTime() + istOffset - 24 * 60 * 60 * 1000);
            return yesterday.toISOString().split('T')[0];
        }

        // Load sales data with proper date handling
        async function loadSales() {
            try {
                showLoading();
                
                const params = new URLSearchParams();
                
                // Handle different filter types
                if (currentFilters.filter === 'today') {
                    params.append('filter', 'today');
                } else if (currentFilters.filter === 'yesterday') {
                    params.append('filter', 'yesterday');
                } else if (currentFilters.filter === 'week') {
                    params.append('filter', 'week');
                } else if (currentFilters.filter === 'month') {
                    params.append('filter', 'month');
                } else if (currentFilters.filter === 'all') {
                    params.append('filter', 'all');
                } else if (currentFilters.filter === 'custom' && currentFilters.startDate && currentFilters.endDate) {
                    params.append('filter', 'custom');
                    params.append('startDate', currentFilters.startDate);
                    params.append('endDate', currentFilters.endDate);
                } else if (currentFilters.startDate && currentFilters.endDate) {
                    // Direct date range
                    params.append('startDate', currentFilters.startDate);
                    params.append('endDate', currentFilters.endDate);
                } else {
                    // Default to today
                    params.append('filter', 'today');
                }
                
                params.append('category', currentFilters.category);
                params.append('payment_method', currentFilters.payment_method);
                params.append('limit', '100');
                
                const response = await fetch(`/api/sales/all?${params.toString()}`);
                const data = await response.json();
                
                if (data.success && data.sales) {
                    currentSales = data.sales;
                    renderSales(currentSales);
                    updateStats(data.summary);
                    updateFilterInfo(data.filters, data.total_records);
                } else {
                    showEmptyState(data.error || 'No sales data available');
                }
            } catch (error) {
                console.error('Error loading sales:', error);
                showEmptyState('Failed to load sales data');
            }
        }

        function showLoading() {
            document.getElementById('salesTable').innerHTML = `
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚è≥</div>
                            <div class="empty-state-text">Loading sales data...</div>
                        </div>
                    </td>
                </tr>
            `;
            document.getElementById('paginationContainer').style.display = 'none';
        }

        function showEmptyState(message) {
            document.getElementById('salesTable').innerHTML = `
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-text">${message}</div>
                        </div>
                    </td>
                </tr>
            `;
            document.getElementById('paginationContainer').style.display = 'none';
        }
        
        // Pagination variables
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalItems = 0;
        let allSales = [];
        
        function renderSales(sales) {
            allSales = sales || [];
            totalItems = allSales.length;
            
            if (!allSales || allSales.length === 0) {
                showEmptyState('No sales found for the selected filters');
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }
            
            // Filter out sales with invalid values
            const validSales = allSales.filter(sale => 
                sale.total_amount !== null && 
                sale.total_amount !== undefined && 
                sale.total_amount !== 'None' &&
                sale.product_name !== null &&
                sale.product_name !== 'None'
            );
            
            if (validSales.length === 0) {
                showEmptyState('No valid sales data found for the selected filters');
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }
            
            allSales = validSales;
            totalItems = allSales.length;
            
            // Calculate pagination
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPageSales = allSales.slice(startIndex, endIndex);
            
            // Render current page sales
            const tbody = document.getElementById('salesTable');
            tbody.innerHTML = currentPageSales.map((sale, index) => {
                const serialNumber = startIndex + index + 1;
                
                // Determine status based on payment method
                let statusClass = 'badge-success';
                let statusText = 'COMPLETED';
                let amountDisplay = `‚Çπ${formatNumber(sale.total_amount || sale.total_price || 0)}`;
                
                if (sale.payment_method === 'credit' || sale.payment_method === 'partial') {
                    const totalAmount = sale.total_amount || sale.total_price || 0;
                    const paidAmount = sale.paid_amount || 0;
                    const dueAmount = sale.balance_due || (totalAmount - paidAmount);
                    
                    if (sale.payment_method === 'partial') {
                        statusClass = 'badge-warning';
                        statusText = 'INCOMPLETE';
                        amountDisplay = `
                            <div style="font-size: 0.85em;">
                                <div><strong>Total: ‚Çπ${formatNumber(totalAmount)}</strong></div>
                                <div style="color: #10b981;">Paid: ‚Çπ${formatNumber(paidAmount)}</div>
                                <div style="color: #ef4444;">Due: ‚Çπ${formatNumber(dueAmount)}</div>
                            </div>
                        `;
                    } else if (dueAmount > 0) {
                        statusClass = 'badge-danger';
                        statusText = 'DUE';
                        amountDisplay = `
                            <div style="font-size: 0.85em;">
                                <div><strong>Total: ‚Çπ${formatNumber(totalAmount)}</strong></div>
                                <div style="color: #ef4444;">Due: ‚Çπ${formatNumber(dueAmount)}</div>
                            </div>
                        `;
                    } else {
                        statusClass = 'badge-success';
                        statusText = 'COMPLETED';
                    }
                }
                
                return `
                <tr>
                    <td><strong>${serialNumber}</strong></td>
                    <td><strong>#${sale.bill_number || sale.id || 'N/A'}</strong></td>
                    <td>
                        ${formatDate(sale.created_at)}<br>
                        <small style="color: #6b7280; font-size: 0.75em;">${formatTime(sale.created_at)}</small>
                    </td>
                    <td>${sale.customer_name || 'Walk-in Customer'}</td>
                    <td>${sale.product_name || 'N/A'} (${sale.quantity || 1}x)</td>
                    <td>${amountDisplay}</td>
                    <td><span class="badge badge-info">${(sale.payment_method || 'cash').toUpperCase()}</span></td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                </tr>
            `}).join('');
            
            // Update pagination
            updatePagination();
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            
            // Update pagination info
            document.getElementById('paginationInfo').textContent = 
                `Showing ${startItem}-${endItem} of ${totalItems} transactions`;
            
            // Update pagination controls
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            // Update page numbers
            const paginationNumbers = document.getElementById('paginationNumbers');
            paginationNumbers.innerHTML = '';
            
            // Show pagination only if there are multiple pages
            if (totalPages > 1) {
                document.getElementById('paginationContainer').style.display = 'flex';
                
                // Calculate which page numbers to show
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);
                
                // Adjust if we're near the beginning or end
                if (currentPage <= 3) {
                    endPage = Math.min(5, totalPages);
                }
                if (currentPage > totalPages - 3) {
                    startPage = Math.max(1, totalPages - 4);
                }
                
                // Add first page and ellipsis if needed
                if (startPage > 1) {
                    paginationNumbers.innerHTML += `<div class="pagination-number" onclick="goToPage(1)">1</div>`;
                    if (startPage > 2) {
                        paginationNumbers.innerHTML += `<div class="pagination-number">...</div>`;
                    }
                }
                
                // Add page numbers
                for (let i = startPage; i <= endPage; i++) {
                    const activeClass = i === currentPage ? 'active' : '';
                    paginationNumbers.innerHTML += 
                        `<div class="pagination-number ${activeClass}" onclick="goToPage(${i})">${i}</div>`;
                }
                
                // Add last page and ellipsis if needed
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        paginationNumbers.innerHTML += `<div class="pagination-number">...</div>`;
                    }
                    paginationNumbers.innerHTML += `<div class="pagination-number" onclick="goToPage(${totalPages})">${totalPages}</div>`;
                }
            } else {
                document.getElementById('paginationContainer').style.display = 'none';
            }
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderSales(allSales);
            }
        }
        
        function goToPage(page) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderSales(allSales);
            }
        }

        function updateStats(summary) {
            if (!summary) return;
            
            const totalSalesEl = document.querySelector('[data-stat="total-sales"]');
            const totalBillsEl = document.querySelector('[data-stat="total-bills"]');
            const avgSaleEl = document.querySelector('[data-stat="avg-sale"]');
            const totalProfitEl = document.querySelector('[data-stat="total-profit"]');
            
            if (totalSalesEl) totalSalesEl.textContent = `‚Çπ${formatNumber(summary.total_sales || 0)}`;
            if (totalBillsEl) totalBillsEl.textContent = summary.total_bills || 0;
            if (avgSaleEl) avgSaleEl.textContent = `‚Çπ${formatNumber(summary.avg_sale_value || 0)}`;
            if (totalProfitEl) totalProfitEl.textContent = `‚Çπ${formatNumber(summary.total_profit || 0)}`;
        }

        function updateFilterInfo(filters, totalRecords) {
            const filterInfoEl = document.getElementById('filterInfo');
            if (filterInfoEl) {
                let filterText = '';
                if (filters.filter) {
                    filterText = `${filters.filter} filter`;
                } else if (filters.startDate && filters.endDate) {
                    filterText = `${filters.startDate} to ${filters.endDate}`;
                }
                filterInfoEl.textContent = `Showing ${totalRecords} records for ${filterText}`;
            }
        }

        // Filter functions with proper date handling
        function filterSales() {
            const dateRange = document.getElementById('dateRange').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            // Show/hide custom date inputs
            const customDateInputs = document.getElementById('customDateInputs');
            const customDateInputsEnd = document.getElementById('customDateInputsEnd');
            
            if (dateRange === 'custom') {
                customDateInputs.style.display = 'flex';
                customDateInputsEnd.style.display = 'flex';
                
                const startDate = document.getElementById('startDate')?.value;
                const endDate = document.getElementById('endDate')?.value;
                
                if (!startDate || !endDate) {
                    // Don't make API call yet if dates are not selected
                    if (startDate || endDate) {
                        // Only show alert if user has started selecting dates
                        console.log('Please select both start and end dates for custom range');
                    }
                    return;
                }
                
                if (startDate > endDate) {
                    alert('Start date cannot be greater than end date');
                    return;
                }
                
                currentFilters.filter = 'custom';
                currentFilters.startDate = startDate;
                currentFilters.endDate = endDate;
            } else {
                customDateInputs.style.display = 'none';
                customDateInputsEnd.style.display = 'none';
                
                currentFilters.filter = dateRange;
                currentFilters.startDate = null;
                currentFilters.endDate = null;
            }
            
            currentFilters.payment_method = paymentFilter;
            currentFilters.search = searchInput;
            
            loadSales();
        }

        function resetFilters() {
            document.getElementById('dateRange').value = 'today';
            document.getElementById('paymentFilter').value = 'all';
            document.getElementById('searchInput').value = '';
            
            // Reset and hide date inputs
            const startDateEl = document.getElementById('startDate');
            const endDateEl = document.getElementById('endDate');
            const customDateInputs = document.getElementById('customDateInputs');
            const customDateInputsEnd = document.getElementById('customDateInputsEnd');
            
            if (startDateEl) startDateEl.value = '';
            if (endDateEl) endDateEl.value = '';
            if (customDateInputs) customDateInputs.style.display = 'none';
            if (customDateInputsEnd) customDateInputsEnd.style.display = 'none';
            
            currentFilters = {
                filter: 'today',
                startDate: null,
                endDate: null,
                category: 'all',
                payment_method: 'all',
                search: ''
            };
            
            loadSales();
        }

        // Utility functions
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                // Parse the date string as local time, not UTC
                // Format: "2026-01-12 00:59:59" or "2026-01-12"
                const parts = dateStr.split(' ')[0].split('-');
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                const day = parseInt(parts[2]);
                
                const date = new Date(year, month, day);
                return date.toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateStr;
            }
        }
        
        function formatTime(timeStr) {
            if (!timeStr) return '';
            try {
                // Parse the timestamp as local time, not UTC
                // Format: "2026-01-12 00:59:59"
                const parts = timeStr.split(' ');
                if (parts.length < 2) return timeStr;
                
                const dateParts = parts[0].split('-');
                const timeParts = parts[1].split(':');
                
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                const day = parseInt(dateParts[2]);
                const hour = parseInt(timeParts[0]);
                const minute = parseInt(timeParts[1]);
                const second = parseInt(timeParts[2] || 0);
                
                const date = new Date(year, month, day, hour, minute, second);
                return date.toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (e) {
                return timeStr;
            }
        }
        
        function formatNumber(num) {
            if (!num) return '0.00';
            return parseFloat(num).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Export functions
        function exportToPDF() {
            console.log('Exporting sales to PDF...');
            const params = new URLSearchParams({
                format: 'pdf',
                date_range: currentFilters.filter || 'all',
                payment_method: currentFilters.payment_method || 'all'
            });
            window.open(`/api/sales/export?${params.toString()}`, '_blank');
        }

        function exportToExcel() {
            console.log('Exporting sales to Excel...');
            const params = new URLSearchParams({
                format: 'excel',
                date_range: currentFilters.filter || 'all',
                payment_method: currentFilters.payment_method || 'all'
            });
            window.open(`/api/sales/export?${params.toString()}`, '_blank');
        }

        function exportToCSV() {
            console.log('Exporting sales to CSV...');
            
            // Use API export for consistency
            const params = new URLSearchParams({
                format: 'csv',
                date_range: currentFilters.filter || 'all',
                payment_method: currentFilters.payment_method || 'all'
            });
            window.open(`/api/sales/export?${params.toString()}`, '_blank');
        }
            window.URL.revokeObjectURL(url);
        }

        function shareViaWhatsApp() {
            console.log('Sharing sales via WhatsApp...');
            const params = new URLSearchParams({
                format: 'whatsapp',
                filter: currentFilters.filter,
                startDate: currentFilters.startDate,
                endDate: currentFilters.endDate,
                payment_method: currentFilters.payment_method,
                limit: 100
            });
            
            fetch(`/api/sales/export?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('üì± WhatsApp report sent successfully!');
                    } else {
                        alert('‚ùå Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('WhatsApp export error:', error);
                    alert('‚ùå Failed to send WhatsApp report');
                });
        }

        function exportSales() {
            exportToCSV();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSales();
            
            // Auto-refresh every 30 seconds
            setInterval(loadSales, 30000);
        });
        
        function addSale() {
            window.location.href = '/retail/billing';
        }
    </script>
</body>
</html>
