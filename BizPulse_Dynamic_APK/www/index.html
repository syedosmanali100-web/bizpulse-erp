<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#732C3F">
    <title>BizPulse ERP - Dynamic</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #F7E8EC 0%, #E8D5DA 50%, #D4C2C8 100%);
            min-height: 100vh;
        }
        
        .loading-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .logo {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .loading-text {
            color: #732C3F;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #732C3F;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-screen {
            display: none;
            text-align: center;
            padding: 20px;
            color: #732C3F;
        }
        
        .retry-btn {
            background: #732C3F;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
        }
        
        #app-container {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="logo">ðŸ›’</div>
        <div class="loading-text">BizPulse ERP</div>
        <div class="loading-text" id="loadingStatus">Connecting to server...</div>
        <div class="spinner"></div>
    </div>
    
    <!-- Error Screen -->
    <div class="error-screen" id="errorScreen">
        <div class="logo">ðŸ›’</div>
        <h2>BizPulse ERP</h2>
        <p id="errorMessage">Unable to connect to server</p>
        <button class="retry-btn" onclick="initializeApp()">Retry Connection</button>
    </div>
    
    <!-- Dynamic App Container -->
    <div id="app-container"></div>

    <script>
        // Dynamic Configuration - This is the magic!
        const DYNAMIC_CONFIG = {
            // Server URLs to try (in order)
            serverUrls: [
                'http://192.168.31.75:5000',  // Your current IP
                'http://192.168.1.100:5000',  // Common router range
                'http://localhost:5000',       // Local development
                'http://127.0.0.1:5000'       // Loopback
            ],
            currentServerUrl: null,
            retryAttempts: 3,
            retryDelay: 2000
        };

        // App State
        let isConnected = false;
        let appContent = null;

        // Utility Functions
        function updateStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        function showError(message) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function showApp() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }

        // Server Connection
        async function findWorkingServer() {
            updateStatus('Finding server...');
            
            for (const url of DYNAMIC_CONFIG.serverUrls) {
                try {
                    updateStatus(`Trying ${url}...`);
                    const response = await fetch(`${url}/api/products`, {
                        method: 'GET',
                        timeout: 5000
                    });
                    
                    if (response.ok) {
                        DYNAMIC_CONFIG.currentServerUrl = url;
                        updateStatus('âœ… Connected to server!');
                        return true;
                    }
                } catch (error) {
                    console.log(`Failed to connect to ${url}:`, error);
                }
            }
            
            return false;
        }       
 // Load Dynamic Content from Server
        async function loadDynamicContent() {
            try {
                updateStatus('Loading app content...');
                
                // Load the main mobile app from server (with cache busting)
                const timestamp = new Date().getTime();
                const response = await fetch(`${DYNAMIC_CONFIG.currentServerUrl}/mobile-pwa?v=${timestamp}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to load app content');
                }
                
                const htmlContent = await response.text();
                
                // Extract the body content (everything inside <body> tags)
                const bodyMatch = htmlContent.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                if (bodyMatch) {
                    appContent = bodyMatch[1];
                } else {
                    // Fallback: use entire content
                    appContent = htmlContent;
                }
                
                return true;
                
            } catch (error) {
                console.error('Failed to load dynamic content:', error);
                return false;
            }
        }

        // Inject Dynamic Content
        function injectDynamicContent() {
            const container = document.getElementById('app-container');
            container.innerHTML = appContent;
            
            // Update all API calls to use current server
            updateApiCalls();
            
            // Re-initialize any scripts
            reinitializeScripts();
        }

        // Update API calls to use current server
        function updateApiCalls() {
            // Override fetch to use current server
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                // If URL starts with /api, prepend current server
                if (typeof url === 'string' && url.startsWith('/api')) {
                    url = DYNAMIC_CONFIG.currentServerUrl + url;
                }
                return originalFetch(url, options);
            };
        }

        // Re-initialize scripts from loaded content
        function reinitializeScripts() {
            const scripts = document.getElementById('app-container').querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                if (script.src) {
                    newScript.src = script.src;
                } else {
                    newScript.textContent = script.textContent;
                }
                document.head.appendChild(newScript);
            });
        }

        // Auto-refresh content periodically (like Instagram)
        function startAutoRefresh() {
            setInterval(async () => {
                try {
                    // Force reload fresh content from server
                    const timestamp = new Date().getTime();
                    const response = await fetch(`${DYNAMIC_CONFIG.currentServerUrl}/mobile-pwa?v=${timestamp}`, {
                        cache: 'no-cache',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    if (response.ok) {
                        const htmlContent = await response.text();
                        const bodyMatch = htmlContent.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                        if (bodyMatch) {
                            // Update content if it's different
                            const newContent = bodyMatch[1];
                            if (newContent !== appContent) {
                                appContent = newContent;
                                injectDynamicContent();
                                console.log('App content updated!');
                            }
                        }
                    }
                } catch (error) {
                    console.log('Auto-refresh failed:', error);
                }
            }, 10000); // Check every 10 seconds for faster updates
        }

        // Main Initialization
        async function initializeApp() {
            try {
                // Reset screens
                document.getElementById('loadingScreen').style.display = 'flex';
                document.getElementById('errorScreen').style.display = 'none';
                document.getElementById('app-container').style.display = 'none';
                
                // Step 1: Find working server
                const serverFound = await findWorkingServer();
                if (!serverFound) {
                    showError('No server available. Please check your connection.');
                    return;
                }
                
                // Step 2: Load dynamic content
                const contentLoaded = await loadDynamicContent();
                if (!contentLoaded) {
                    showError('Failed to load app content from server.');
                    return;
                }
                
                // Step 3: Inject content and show app
                updateStatus('Initializing app...');
                injectDynamicContent();
                
                // Step 4: Start auto-refresh
                startAutoRefresh();
                
                // Step 5: Show the app
                setTimeout(() => {
                    showApp();
                    isConnected = true;
                }, 1000);
                
            } catch (error) {
                console.error('App initialization failed:', error);
                showError('App initialization failed. Please try again.');
            }
        }

        // Handle network changes
        window.addEventListener('online', () => {
            if (!isConnected) {
                initializeApp();
            }
        });

        window.addEventListener('offline', () => {
            isConnected = false;
            // You can show offline message here
        });

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>